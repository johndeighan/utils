"use strict";
// build-dot-symbols.cmd.civet

import {
	undef, assert, hash, isEmpty, nonEmpty,
	} from 'datatypes'
import {getOptions} from 'llutils'
import {OL} from 'to-nice'
import {LOG, DBG, WARN, LOGVALUE, DBGVALUE} from 'logger'
import {barf, allFilesMatching} from 'fsys'
import {allExportsInFile} from 'typescript'

// ---------------------------------------------------------------------------
// --- ASYNC GENERATOR

export const getDotSymbolsLines = async function*(
		path: string,
		hOptions: hash={}
		): AsyncGenerator<string, void, void> {

	type opt = {
		oneIndent: string
		maxLineLen: number
		}
	const {oneIndent, maxLineLen} = getOptions<opt>(hOptions, {
		oneIndent: '\t',
		maxLineLen: 75
		})
	const lSymbols: string[] = []
	let lineLen = 0     // --- always <= maxLineLen
	let pathYielded = false

	for await (const {name, kind} of allExportsInFile(path)) {
		const pos = name.indexOf('<')
		const sym = (pos === -1) ? name : name.substring(0, pos)
		if (lineLen + sym.length + 1 > maxLineLen) {
			if (!pathYielded) {
				yield path.replace('.civet', '.ts')
				pathYielded = true
			}
			yield `${oneIndent}${lSymbols.join(' ')}`
			lSymbols.length = 0
			lineLen = 0
		}
		else {
			lSymbols.push(sym)
			lineLen += sym.length + 1
		}
	}
	if (lSymbols.length > 0) {
		if (!pathYielded) {
			yield path.replace('.civet', '.ts')
			pathYielded = true
		}
		yield `${oneIndent}${lSymbols.join(' ')}`
	}
	return
}

// ---------------------------------------------------------------------------

export const getDotSymbols = async function*(
	hOptions: hash={}
	): AsyncGenerator<string, void, void> {

	for (const {type, relPath} of allFilesMatching('**/*.lib.civet')) {
		assert((type === 'file'), `Not a file: ${relPath}`)
		DBG(`GET symbols from: ${relPath}`)
		for await (const line of getDotSymbolsLines(relPath)) {
			yield line
		}
	}
	return
}

// ---------------------------------------------------------------------------

const lLines = await Array.fromAsync(getDotSymbols())
const contents = lLines.join('\n')
DBGVALUE('contents', contents)
barf('src/.symbols', contents)

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcY21kXFxidWlsZC1kb3Qtc3ltYm9scy5jbWQuY2l2ZXQudHN4Iiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGpvaG5kXFx1dGlsc1xcc3JjXFxjbWRcXGJ1aWxkLWRvdC1zeW1ib2xzLmNtZC5jaXZldCJdLCJtYXBwaW5ncyI6IjtBQUFBLDhCQUE2QjtBQUM3QixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQ3hDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXO0FBQ25CLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNsQyxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRO0FBQ3pELEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNO0FBQzNDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZO0FBQzNDLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBLHNCQUFxQjtBQUNyQixBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBbUIsTUFBbEIsa0JBQWtCLENBQUMsQ0FBRSxDLE1BR1ksUSxDQUhYLENBQUM7QUFDOUIsQUFBQSxFQUFFLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNmLEFBQUEsRUFBRSxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ25CLEVBQUUsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBSSxDQUFBLENBQUE7QUFDMUMsQUFBQTtBQUNBLEFBQUEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2IsQUFBQSxFQUFFLFNBQVMsQ0FBQyxDQUFDLE1BQU07QUFDbkIsQUFBQSxFQUFFLFVBQVUsQ0FBQyxDQUFDLE1BQU07QUFDcEIsRUFBRSxDQUFDO0FBQ0gsQUFBQSxDQUF3QixNQUF2QixDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUEsQUFBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELEFBQUEsRUFBRSxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUE7QUFDakIsQUFBQSxFQUFFLFVBQVUsQ0FBQyxDQUFDLEVBQUU7QUFDaEIsRUFBRSxDQUFDLENBQUE7QUFDSCxBQUFBLENBQW1CLE1BQWxCLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQztBQUN6QixBQUFBLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLDJCQUEwQjtBQUMvQyxBQUFBLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSztBQUN4QixBQUFBO0FBQ0EsQUFBQSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQSxNQUFBLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUNqRCxBQUFBLEVBQUssTUFBSCxHQUFHLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBQzFCLEFBQUEsRUFBSyxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDcEQsQUFBQSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUEsQ0FBQTtBQUM1QyxBQUFBLEdBQUcsR0FBRyxDQUFBLENBQUksV0FBVyxDQUFBLENBQUEsQ0FBQTtBQUNyQixBQUFBLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3ZDLEFBQUEsSUFBSSxXQUFXLEMsQ0FBRSxDQUFDLEk7R0FBSSxDQUFBO0FBQ3RCLEFBQUEsR0FBRyxLQUFLLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUM1QyxBQUFBLEdBQUcsUUFBUSxDQUFDLE1BQU0sQyxDQUFFLENBQUMsQ0FBQztBQUN0QixBQUFBLEdBQUcsT0FBTyxDLENBQUUsQ0FBQyxDO0VBQUMsQ0FBQTtBQUNkLEFBQUEsRUFBRSxJQUFJLENBQUEsQ0FBQTtBQUNOLEFBQUEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFBLEFBQUMsR0FBRyxDQUFBO0FBQ3BCLEFBQUEsR0FBRyxPQUFPLEMsRUFBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEM7RUFBQyxDO0NBQUEsQ0FBQTtBQUM1QixBQUFBLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUE7QUFDekIsQUFBQSxFQUFFLEdBQUcsQ0FBQSxDQUFJLFdBQVcsQ0FBQSxDQUFBLENBQUE7QUFDcEIsQUFBQSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUN0QyxBQUFBLEdBQUcsV0FBVyxDLENBQUUsQ0FBQyxJO0VBQUksQ0FBQTtBQUNyQixBQUFBLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEM7Q0FBQyxDQUFBO0FBQzNDLEFBQUEsQ0FBQyxNO0FBQU0sQ0FBQTtBQUNQLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBYyxNQUFiLGFBQWEsQ0FBQyxDQUFFLEMsTUFFZ0IsUSxDQUZmLENBQUM7QUFDekIsQUFBQSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFJLENBQUEsQ0FBQTtBQUN6QyxBQUFBO0FBQ0EsQUFBQSxDQUFDLEdBQUcsQ0FBQyxDQUFBLE1BQUEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDMUQsQUFBQSxFQUFFLE1BQU0sQ0FBQSxBQUFDLENBQUMsSUFBSSxDQUFDLEdBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7QUFDbkQsQUFBQSxFQUFFLEdBQUcsQ0FBQSxBQUFDLENBQUMsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQTtBQUNwQyxBQUFBLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFBLE1BQUEsSUFBSSxDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDL0MsQUFBQSxHQUFHLEtBQUssQ0FBQyxJO0VBQUksQztDQUFBLENBQUE7QUFDYixBQUFBLENBQUMsTTtBQUFNLENBQUE7QUFDUCxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBTSxNQUFOLE1BQU0sQ0FBQyxDQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztBQUNoRCxBQUFBLEFBQVEsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQzdCLEFBQUEsQUFBQSxRQUFRLENBQUEsQUFBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUE7QUFDN0IsQUFBQSxBQUFBLElBQUksQ0FBQSxBQUFDLGNBQWMsQ0FBQyxDQUFDLFFBQVEsQ0FBQTtBQUM3QiIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBidWlsZC1kb3Qtc3ltYm9scy5jbWQuY2l2ZXRcclxuXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGFzc2VydCwgaGFzaCwgaXNFbXB0eSwgbm9uRW1wdHksXHJcblx0fSBmcm9tICdkYXRhdHlwZXMnXHJcbmltcG9ydCB7Z2V0T3B0aW9uc30gZnJvbSAnbGx1dGlscydcclxuaW1wb3J0IHtPTH0gZnJvbSAndG8tbmljZSdcclxuaW1wb3J0IHtMT0csIERCRywgV0FSTiwgTE9HVkFMVUUsIERCR1ZBTFVFfSBmcm9tICdsb2dnZXInXHJcbmltcG9ydCB7YmFyZiwgYWxsRmlsZXNNYXRjaGluZ30gZnJvbSAnZnN5cydcclxuaW1wb3J0IHthbGxFeHBvcnRzSW5GaWxlfSBmcm9tICd0eXBlc2NyaXB0J1xyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuIyAtLS0gQVNZTkMgR0VORVJBVE9SXHJcblxyXG5leHBvcnQgZ2V0RG90U3ltYm9sc0xpbmVzIDo9IChcclxuXHRcdHBhdGg6IHN0cmluZyxcclxuXHRcdGhPcHRpb25zOiBoYXNoPXt9XHJcblx0XHQpOiBBc3luY0dlbmVyYXRvcjxzdHJpbmcsIHZvaWQsIHZvaWQ+IC0+XHJcblxyXG5cdHR5cGUgb3B0ID0ge1xyXG5cdFx0b25lSW5kZW50OiBzdHJpbmdcclxuXHRcdG1heExpbmVMZW46IG51bWJlclxyXG5cdFx0fVxyXG5cdHtvbmVJbmRlbnQsIG1heExpbmVMZW59IDo9IGdldE9wdGlvbnM8b3B0PiBoT3B0aW9ucywge1xyXG5cdFx0b25lSW5kZW50OiAnXFx0J1xyXG5cdFx0bWF4TGluZUxlbjogNzVcclxuXHRcdH1cclxuXHRsU3ltYm9sczogc3RyaW5nW10gOj0gW11cclxuXHRsZXQgbGluZUxlbiA9IDAgICAgICMgLS0tIGFsd2F5cyA8PSBtYXhMaW5lTGVuXHJcblx0bGV0IHBhdGhZaWVsZGVkID0gZmFsc2VcclxuXHJcblx0Zm9yIGF3YWl0IHtuYW1lLCBraW5kfSBvZiBhbGxFeHBvcnRzSW5GaWxlKHBhdGgpXHJcblx0XHRwb3MgOj0gbmFtZS5pbmRleE9mKCc8JylcclxuXHRcdHN5bSA6PSAocG9zID09IC0xKSA/IG5hbWUgOiBuYW1lLnN1YnN0cmluZygwLCBwb3MpXHJcblx0XHRpZiAobGluZUxlbiArIHN5bS5sZW5ndGggKyAxID4gbWF4TGluZUxlbilcclxuXHRcdFx0aWYgbm90IHBhdGhZaWVsZGVkXHJcblx0XHRcdFx0eWllbGQgcGF0aC5yZXBsYWNlKCcuY2l2ZXQnLCAnLnRzJylcclxuXHRcdFx0XHRwYXRoWWllbGRlZCA9IHRydWVcclxuXHRcdFx0eWllbGQgXCIje29uZUluZGVudH0je2xTeW1ib2xzLmpvaW4oJyAnKX1cIlxyXG5cdFx0XHRsU3ltYm9scy5sZW5ndGggPSAwXHJcblx0XHRcdGxpbmVMZW4gPSAwXHJcblx0XHRlbHNlXHJcblx0XHRcdGxTeW1ib2xzLnB1c2ggc3ltXHJcblx0XHRcdGxpbmVMZW4gKz0gc3ltLmxlbmd0aCArIDFcclxuXHRpZiAobFN5bWJvbHMubGVuZ3RoID4gMClcclxuXHRcdGlmIG5vdCBwYXRoWWllbGRlZFxyXG5cdFx0XHR5aWVsZCBwYXRoLnJlcGxhY2UoJy5jaXZldCcsICcudHMnKVxyXG5cdFx0XHRwYXRoWWllbGRlZCA9IHRydWVcclxuXHRcdHlpZWxkIFwiI3tvbmVJbmRlbnR9I3tsU3ltYm9scy5qb2luKCcgJyl9XCJcclxuXHRyZXR1cm5cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgZ2V0RG90U3ltYm9scyA6PSAoXHJcblx0aE9wdGlvbnM6IGhhc2g9e31cclxuXHQpOiBBc3luY0dlbmVyYXRvcjxzdHJpbmcsIHZvaWQsIHZvaWQ+IC0+XHJcblxyXG5cdGZvciB7dHlwZSwgcmVsUGF0aH0gb2YgYWxsRmlsZXNNYXRjaGluZygnKiovKi5saWIuY2l2ZXQnKVxyXG5cdFx0YXNzZXJ0ICh0eXBlID09ICdmaWxlJyksIFwiTm90IGEgZmlsZTogI3tyZWxQYXRofVwiXHJcblx0XHREQkcgXCJHRVQgc3ltYm9scyBmcm9tOiAje3JlbFBhdGh9XCJcclxuXHRcdGZvciBhd2FpdCBsaW5lIG9mIGdldERvdFN5bWJvbHNMaW5lcyhyZWxQYXRoKVxyXG5cdFx0XHR5aWVsZCBsaW5lXHJcblx0cmV0dXJuXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxubExpbmVzIDo9IGF3YWl0IEFycmF5LmZyb21Bc3luYyhnZXREb3RTeW1ib2xzKCkpXHJcbmNvbnRlbnRzIDo9IGxMaW5lcy5qb2luKCdcXG4nKVxyXG5EQkdWQUxVRSAnY29udGVudHMnLCBjb250ZW50c1xyXG5iYXJmICdzcmMvLnN5bWJvbHMnLCBjb250ZW50c1xyXG4iXX0=