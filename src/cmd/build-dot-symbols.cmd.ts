"use strict";
// build-dot-symbols.cmd.civet

import {
	undef, assert, hash, isEmpty, nonEmpty,
	} from 'datatypes'
import {getOptions, CStringSetMap, keys} from 'llutils'
import {OL} from 'to-nice'
import {LOG, DBG, WARN, LOGVALUE, DBGVALUE} from 'logger'
import {barf, allFilesMatching} from 'fsys'
import {analyze} from 'typescript'

// ---------------------------------------------------------------------------
// --- ASYNC GENERATOR

export const getDotSymbolsLines = function*(
		path: string,
		hOptions: hash={}
		): Generator<string, void, void> {

	type opt = {
		oneIndent: string
		maxLineLen: number
		}
	const {oneIndent, maxLineLen} = getOptions<opt>(hOptions, {
		oneIndent: '\t',
		maxLineLen: 75
		})
	const lSymbols: string[] = []
	let lineLen = 0     // --- always <= maxLineLen
	let pathYielded = false

	const analysis = analyze(path)

	for (const name of keys(analysis.hExports)) {
		const pos = name.indexOf('<')
		const sym = (pos === -1) ? name : name.substring(0, pos)
		if (lineLen + sym.length + 1 > maxLineLen) {
			if (!pathYielded) {
				yield path.replace('.civet', '.ts')
				pathYielded = true
			}
			yield `${oneIndent}${lSymbols.join(' ')}`
			lSymbols.length = 0
			lineLen = 0
		}
		else {
			lSymbols.push(sym)
			lineLen += sym.length + 1
		}
	}
	if (lSymbols.length > 0) {
		if (!pathYielded) {
			yield path.replace('.civet', '.ts')
			pathYielded = true
		}
		yield `${oneIndent}${lSymbols.join(' ')}`
	}
	return
}

// ---------------------------------------------------------------------------

export const getDotSymbols = async function*(
	hOptions: hash={}
	): AsyncGenerator<string, void, void> {

	for (const {type, relPath} of allFilesMatching('**/*.lib.civet')) {
		assert((type === 'file'), `Not a file: ${relPath}`)
		DBG(`GET symbols from: ${relPath}`)
		for await (const line of getDotSymbolsLines(relPath)) {
			yield line
		}
	}
	return
}

// ---------------------------------------------------------------------------

const lLines = await Array.fromAsync(getDotSymbols())
const contents = lLines.join('\n')
DBGVALUE('contents', contents)
barf('src/.symbols', contents)

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcY21kXFxidWlsZC1kb3Qtc3ltYm9scy5jbWQuY2l2ZXQudHN4Iiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGpvaG5kXFx1dGlsc1xcc3JjXFxjbWRcXGJ1aWxkLWRvdC1zeW1ib2xzLmNtZC5jaXZldCJdLCJtYXBwaW5ncyI6IjtBQUFBLDhCQUE2QjtBQUM3QixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQ3hDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXO0FBQ25CLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUN2RCxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRO0FBQ3pELEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNO0FBQzNDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWTtBQUNsQyxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQSxzQkFBcUI7QUFDckIsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQW1CLE1BQWxCLGtCQUFrQixDQUFDLENBQUUsQ0FHTyxRLENBSE4sQ0FBQztBQUM5QixBQUFBLEVBQUUsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2YsQUFBQSxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDbkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFJLENBQUEsQ0FBQTtBQUNyQyxBQUFBO0FBQ0EsQUFBQSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDYixBQUFBLEVBQUUsU0FBUyxDQUFDLENBQUMsTUFBTTtBQUNuQixBQUFBLEVBQUUsVUFBVSxDQUFDLENBQUMsTUFBTTtBQUNwQixFQUFFLENBQUM7QUFDSCxBQUFBLENBQXdCLE1BQXZCLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQSxBQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDdkQsQUFBQSxFQUFFLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQTtBQUNqQixBQUFBLEVBQUUsVUFBVSxDQUFDLENBQUMsRUFBRTtBQUNoQixFQUFFLENBQUMsQ0FBQTtBQUNILEFBQUEsQ0FBbUIsTUFBbEIsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLEFBQUEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssMkJBQTBCO0FBQy9DLEFBQUEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLO0FBQ3hCLEFBQUE7QUFDQSxBQUFBLENBQVMsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDMUIsQUFBQTtBQUNBLEFBQUEsQ0FBQyxHQUFHLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDcEMsQUFBQSxFQUFLLE1BQUgsR0FBRyxDQUFDLENBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztBQUMxQixBQUFBLEVBQUssTUFBSCxHQUFHLENBQUMsQ0FBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ3BELEFBQUEsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFBLENBQUE7QUFDNUMsQUFBQSxHQUFHLEdBQUcsQ0FBQSxDQUFJLFdBQVcsQ0FBQSxDQUFBLENBQUE7QUFDckIsQUFBQSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUN2QyxBQUFBLElBQUksV0FBVyxDLENBQUUsQ0FBQyxJO0dBQUksQ0FBQTtBQUN0QixBQUFBLEdBQUcsS0FBSyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDNUMsQUFBQSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEMsQ0FBRSxDQUFDLENBQUM7QUFDdEIsQUFBQSxHQUFHLE9BQU8sQyxDQUFFLENBQUMsQztFQUFDLENBQUE7QUFDZCxBQUFBLEVBQUUsSUFBSSxDQUFBLENBQUE7QUFDTixBQUFBLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQSxBQUFDLEdBQUcsQ0FBQTtBQUNwQixBQUFBLEdBQUcsT0FBTyxDLEVBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDO0VBQUMsQztDQUFBLENBQUE7QUFDNUIsQUFBQSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQ3pCLEFBQUEsRUFBRSxHQUFHLENBQUEsQ0FBSSxXQUFXLENBQUEsQ0FBQSxDQUFBO0FBQ3BCLEFBQUEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDdEMsQUFBQSxHQUFHLFdBQVcsQyxDQUFFLENBQUMsSTtFQUFJLENBQUE7QUFDckIsQUFBQSxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDO0NBQUMsQ0FBQTtBQUMzQyxBQUFBLENBQUMsTTtBQUFNLENBQUE7QUFDUCxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQWMsTUFBYixhQUFhLENBQUMsQ0FBRSxDLE1BRWdCLFEsQ0FGZixDQUFDO0FBQ3pCLEFBQUEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBSSxDQUFBLENBQUE7QUFDekMsQUFBQTtBQUNBLEFBQUEsQ0FBQyxHQUFHLENBQUMsQ0FBQSxNQUFBLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQzFELEFBQUEsRUFBRSxNQUFNLENBQUEsQUFBQyxDQUFDLElBQUksQ0FBQyxHQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFBO0FBQ25ELEFBQUEsRUFBRSxHQUFHLENBQUEsQUFBQyxDQUFDLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7QUFDcEMsQUFBQSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxFQUFFLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQy9DLEFBQUEsR0FBRyxLQUFLLENBQUMsSTtFQUFJLEM7Q0FBQSxDQUFBO0FBQ2IsQUFBQSxDQUFDLE07QUFBTSxDQUFBO0FBQ1AsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQU0sTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7QUFDaEQsQUFBQSxBQUFRLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUM3QixBQUFBLEFBQUEsUUFBUSxDQUFBLEFBQUMsVUFBVSxDQUFDLENBQUMsUUFBUSxDQUFBO0FBQzdCLEFBQUEsQUFBQSxJQUFJLENBQUEsQUFBQyxjQUFjLENBQUMsQ0FBQyxRQUFRLENBQUE7QUFDN0IiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgYnVpbGQtZG90LXN5bWJvbHMuY21kLmNpdmV0XHJcblxyXG5pbXBvcnQge1xyXG5cdHVuZGVmLCBhc3NlcnQsIGhhc2gsIGlzRW1wdHksIG5vbkVtcHR5LFxyXG5cdH0gZnJvbSAnZGF0YXR5cGVzJ1xyXG5pbXBvcnQge2dldE9wdGlvbnMsIENTdHJpbmdTZXRNYXAsIGtleXN9IGZyb20gJ2xsdXRpbHMnXHJcbmltcG9ydCB7T0x9IGZyb20gJ3RvLW5pY2UnXHJcbmltcG9ydCB7TE9HLCBEQkcsIFdBUk4sIExPR1ZBTFVFLCBEQkdWQUxVRX0gZnJvbSAnbG9nZ2VyJ1xyXG5pbXBvcnQge2JhcmYsIGFsbEZpbGVzTWF0Y2hpbmd9IGZyb20gJ2ZzeXMnXHJcbmltcG9ydCB7YW5hbHl6ZX0gZnJvbSAndHlwZXNjcmlwdCdcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiMgLS0tIEFTWU5DIEdFTkVSQVRPUlxyXG5cclxuZXhwb3J0IGdldERvdFN5bWJvbHNMaW5lcyA6PSAoXHJcblx0XHRwYXRoOiBzdHJpbmcsXHJcblx0XHRoT3B0aW9uczogaGFzaD17fVxyXG5cdFx0KTogR2VuZXJhdG9yPHN0cmluZywgdm9pZCwgdm9pZD4gLT5cclxuXHJcblx0dHlwZSBvcHQgPSB7XHJcblx0XHRvbmVJbmRlbnQ6IHN0cmluZ1xyXG5cdFx0bWF4TGluZUxlbjogbnVtYmVyXHJcblx0XHR9XHJcblx0e29uZUluZGVudCwgbWF4TGluZUxlbn0gOj0gZ2V0T3B0aW9uczxvcHQ+IGhPcHRpb25zLCB7XHJcblx0XHRvbmVJbmRlbnQ6ICdcXHQnXHJcblx0XHRtYXhMaW5lTGVuOiA3NVxyXG5cdFx0fVxyXG5cdGxTeW1ib2xzOiBzdHJpbmdbXSA6PSBbXVxyXG5cdGxldCBsaW5lTGVuID0gMCAgICAgIyAtLS0gYWx3YXlzIDw9IG1heExpbmVMZW5cclxuXHRsZXQgcGF0aFlpZWxkZWQgPSBmYWxzZVxyXG5cclxuXHRhbmFseXNpcyA6PSBhbmFseXplKHBhdGgpXHJcblxyXG5cdGZvciBuYW1lIG9mIGtleXMoYW5hbHlzaXMuaEV4cG9ydHMpXHJcblx0XHRwb3MgOj0gbmFtZS5pbmRleE9mKCc8JylcclxuXHRcdHN5bSA6PSAocG9zID09IC0xKSA/IG5hbWUgOiBuYW1lLnN1YnN0cmluZygwLCBwb3MpXHJcblx0XHRpZiAobGluZUxlbiArIHN5bS5sZW5ndGggKyAxID4gbWF4TGluZUxlbilcclxuXHRcdFx0aWYgbm90IHBhdGhZaWVsZGVkXHJcblx0XHRcdFx0eWllbGQgcGF0aC5yZXBsYWNlKCcuY2l2ZXQnLCAnLnRzJylcclxuXHRcdFx0XHRwYXRoWWllbGRlZCA9IHRydWVcclxuXHRcdFx0eWllbGQgXCIje29uZUluZGVudH0je2xTeW1ib2xzLmpvaW4oJyAnKX1cIlxyXG5cdFx0XHRsU3ltYm9scy5sZW5ndGggPSAwXHJcblx0XHRcdGxpbmVMZW4gPSAwXHJcblx0XHRlbHNlXHJcblx0XHRcdGxTeW1ib2xzLnB1c2ggc3ltXHJcblx0XHRcdGxpbmVMZW4gKz0gc3ltLmxlbmd0aCArIDFcclxuXHRpZiAobFN5bWJvbHMubGVuZ3RoID4gMClcclxuXHRcdGlmIG5vdCBwYXRoWWllbGRlZFxyXG5cdFx0XHR5aWVsZCBwYXRoLnJlcGxhY2UoJy5jaXZldCcsICcudHMnKVxyXG5cdFx0XHRwYXRoWWllbGRlZCA9IHRydWVcclxuXHRcdHlpZWxkIFwiI3tvbmVJbmRlbnR9I3tsU3ltYm9scy5qb2luKCcgJyl9XCJcclxuXHRyZXR1cm5cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgZ2V0RG90U3ltYm9scyA6PSAoXHJcblx0aE9wdGlvbnM6IGhhc2g9e31cclxuXHQpOiBBc3luY0dlbmVyYXRvcjxzdHJpbmcsIHZvaWQsIHZvaWQ+IC0+XHJcblxyXG5cdGZvciB7dHlwZSwgcmVsUGF0aH0gb2YgYWxsRmlsZXNNYXRjaGluZygnKiovKi5saWIuY2l2ZXQnKVxyXG5cdFx0YXNzZXJ0ICh0eXBlID09ICdmaWxlJyksIFwiTm90IGEgZmlsZTogI3tyZWxQYXRofVwiXHJcblx0XHREQkcgXCJHRVQgc3ltYm9scyBmcm9tOiAje3JlbFBhdGh9XCJcclxuXHRcdGZvciBhd2FpdCBsaW5lIG9mIGdldERvdFN5bWJvbHNMaW5lcyhyZWxQYXRoKVxyXG5cdFx0XHR5aWVsZCBsaW5lXHJcblx0cmV0dXJuXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxubExpbmVzIDo9IGF3YWl0IEFycmF5LmZyb21Bc3luYyhnZXREb3RTeW1ib2xzKCkpXHJcbmNvbnRlbnRzIDo9IGxMaW5lcy5qb2luKCdcXG4nKVxyXG5EQkdWQUxVRSAnY29udGVudHMnLCBjb250ZW50c1xyXG5iYXJmICdzcmMvLnN5bWJvbHMnLCBjb250ZW50c1xyXG4iXX0=