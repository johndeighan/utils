"use strict";
// build-dot-symbols.cmd.civet

import {
	undef, assert, hash, isEmpty, nonEmpty,
	} from 'datatypes'
import {getOptions, KeyedStringSet} from 'llutils'
import {OL} from 'to-nice'
import {LOG, DBG, WARN, LOGVALUE, DBGVALUE} from 'logger'
import {barf, allFilesMatching} from 'fsys'
import {analyze} from 'typescript'

// ---------------------------------------------------------------------------
// --- ASYNC GENERATOR

export const getDotSymbolsLines = function*(
		path: string,
		hOptions: hash={}
		): Generator<string, void, void> {

	type opt = {
		oneIndent: string
		maxLineLen: number
		}
	const {oneIndent, maxLineLen} = getOptions<opt>(hOptions, {
		oneIndent: '\t',
		maxLineLen: 75
		})
	const lSymbols: string[] = []
	let lineLen = 0     // --- always <= maxLineLen
	let pathYielded = false

	const analysis = analyze(path)
	const exports = analysis.exports

	for (const lib of exports.allKeys()) {
		for (const name of exports.allValues(lib)) {
			const pos = name.indexOf('<')
			const sym = (pos === -1) ? name : name.substring(0, pos)
			if (lineLen + sym.length + 1 > maxLineLen) {
				if (!pathYielded) {
					yield path.replace('.civet', '.ts')
					pathYielded = true
				}
				yield `${oneIndent}${lSymbols.join(' ')}`
				lSymbols.length = 0
				lineLen = 0
			}
			else {
				lSymbols.push(sym)
				lineLen += sym.length + 1
			}
		}
	}
	if (lSymbols.length > 0) {
		if (!pathYielded) {
			yield path.replace('.civet', '.ts')
			pathYielded = true
		}
		yield `${oneIndent}${lSymbols.join(' ')}`
	}
	return
}

// ---------------------------------------------------------------------------

export const getDotSymbols = async function*(
	hOptions: hash={}
	): AsyncGenerator<string, void, void> {

	for (const {type, relPath} of allFilesMatching('**/*.lib.civet')) {
		assert((type === 'file'), `Not a file: ${relPath}`)
		DBG(`GET symbols from: ${relPath}`)
		for await (const line of getDotSymbolsLines(relPath)) {
			yield line
		}
	}
	return
}

// ---------------------------------------------------------------------------

const lLines = await Array.fromAsync(getDotSymbols())
const contents = lLines.join('\n')
DBGVALUE('contents', contents)
barf('src/.symbols', contents)

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcY21kXFxidWlsZC1kb3Qtc3ltYm9scy5jbWQuY2l2ZXQudHN4Iiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGpvaG5kXFx1dGlsc1xcc3JjXFxjbWRcXGJ1aWxkLWRvdC1zeW1ib2xzLmNtZC5jaXZldCJdLCJtYXBwaW5ncyI6IjtBQUFBLDhCQUE2QjtBQUM3QixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQ3hDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXO0FBQ25CLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNsRCxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRO0FBQ3pELEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNO0FBQzNDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWTtBQUNsQyxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQSxzQkFBcUI7QUFDckIsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQW1CLE1BQWxCLGtCQUFrQixDQUFDLENBQUUsQ0FHTyxRLENBSE4sQ0FBQztBQUM5QixBQUFBLEVBQUUsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2YsQUFBQSxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDbkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFJLENBQUEsQ0FBQTtBQUNyQyxBQUFBO0FBQ0EsQUFBQSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDYixBQUFBLEVBQUUsU0FBUyxDQUFDLENBQUMsTUFBTTtBQUNuQixBQUFBLEVBQUUsVUFBVSxDQUFDLENBQUMsTUFBTTtBQUNwQixFQUFFLENBQUM7QUFDSCxBQUFBLENBQXdCLE1BQXZCLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQSxBQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDdkQsQUFBQSxFQUFFLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQTtBQUNqQixBQUFBLEVBQUUsVUFBVSxDQUFDLENBQUMsRUFBRTtBQUNoQixFQUFFLENBQUMsQ0FBQTtBQUNILEFBQUEsQ0FBbUIsTUFBbEIsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLEFBQUEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssMkJBQTBCO0FBQy9DLEFBQUEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLO0FBQ3hCLEFBQUE7QUFDQSxBQUFBLENBQVMsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDMUIsQUFBQSxDQUFRLE1BQVAsT0FBTyxDQUFDLENBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTztBQUM1QixBQUFBO0FBQ0EsQUFBQSxDQUFDLEdBQUcsQ0FBQyxDQUFBLE1BQUEsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDN0IsQUFBQSxFQUFFLEdBQUcsQ0FBQyxDQUFBLE1BQUEsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUNwQyxBQUFBLEdBQU0sTUFBSCxHQUFHLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBQzNCLEFBQUEsR0FBTSxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDckQsQUFBQSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUEsQ0FBQTtBQUM3QyxBQUFBLElBQUksR0FBRyxDQUFBLENBQUksV0FBVyxDQUFBLENBQUEsQ0FBQTtBQUN0QixBQUFBLEtBQUssS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3hDLEFBQUEsS0FBSyxXQUFXLEMsQ0FBRSxDQUFDLEk7SUFBSSxDQUFBO0FBQ3ZCLEFBQUEsSUFBSSxLQUFLLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUM3QyxBQUFBLElBQUksUUFBUSxDQUFDLE1BQU0sQyxDQUFFLENBQUMsQ0FBQztBQUN2QixBQUFBLElBQUksT0FBTyxDLENBQUUsQ0FBQyxDO0dBQUMsQ0FBQTtBQUNmLEFBQUEsR0FBRyxJQUFJLENBQUEsQ0FBQTtBQUNQLEFBQUEsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFBLEFBQUMsR0FBRyxDQUFBO0FBQ3JCLEFBQUEsSUFBSSxPQUFPLEMsRUFBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEM7R0FBQyxDO0VBQUEsQztDQUFBLENBQUE7QUFDN0IsQUFBQSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQ3pCLEFBQUEsRUFBRSxHQUFHLENBQUEsQ0FBSSxXQUFXLENBQUEsQ0FBQSxDQUFBO0FBQ3BCLEFBQUEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDdEMsQUFBQSxHQUFHLFdBQVcsQyxDQUFFLENBQUMsSTtFQUFJLENBQUE7QUFDckIsQUFBQSxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDO0NBQUMsQ0FBQTtBQUMzQyxBQUFBLENBQUMsTTtBQUFNLENBQUE7QUFDUCxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQWMsTUFBYixhQUFhLENBQUMsQ0FBRSxDLE1BRWdCLFEsQ0FGZixDQUFDO0FBQ3pCLEFBQUEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBSSxDQUFBLENBQUE7QUFDekMsQUFBQTtBQUNBLEFBQUEsQ0FBQyxHQUFHLENBQUMsQ0FBQSxNQUFBLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQzFELEFBQUEsRUFBRSxNQUFNLENBQUEsQUFBQyxDQUFDLElBQUksQ0FBQyxHQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFBO0FBQ25ELEFBQUEsRUFBRSxHQUFHLENBQUEsQUFBQyxDQUFDLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7QUFDcEMsQUFBQSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxFQUFFLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQy9DLEFBQUEsR0FBRyxLQUFLLENBQUMsSTtFQUFJLEM7Q0FBQSxDQUFBO0FBQ2IsQUFBQSxDQUFDLE07QUFBTSxDQUFBO0FBQ1AsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQU0sTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7QUFDaEQsQUFBQSxBQUFRLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUM3QixBQUFBLEFBQUEsUUFBUSxDQUFBLEFBQUMsVUFBVSxDQUFDLENBQUMsUUFBUSxDQUFBO0FBQzdCLEFBQUEsQUFBQSxJQUFJLENBQUEsQUFBQyxjQUFjLENBQUMsQ0FBQyxRQUFRLENBQUE7QUFDN0IiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgYnVpbGQtZG90LXN5bWJvbHMuY21kLmNpdmV0XHJcblxyXG5pbXBvcnQge1xyXG5cdHVuZGVmLCBhc3NlcnQsIGhhc2gsIGlzRW1wdHksIG5vbkVtcHR5LFxyXG5cdH0gZnJvbSAnZGF0YXR5cGVzJ1xyXG5pbXBvcnQge2dldE9wdGlvbnMsIEtleWVkU3RyaW5nU2V0fSBmcm9tICdsbHV0aWxzJ1xyXG5pbXBvcnQge09MfSBmcm9tICd0by1uaWNlJ1xyXG5pbXBvcnQge0xPRywgREJHLCBXQVJOLCBMT0dWQUxVRSwgREJHVkFMVUV9IGZyb20gJ2xvZ2dlcidcclxuaW1wb3J0IHtiYXJmLCBhbGxGaWxlc01hdGNoaW5nfSBmcm9tICdmc3lzJ1xyXG5pbXBvcnQge2FuYWx5emV9IGZyb20gJ3R5cGVzY3JpcHQnXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4jIC0tLSBBU1lOQyBHRU5FUkFUT1JcclxuXHJcbmV4cG9ydCBnZXREb3RTeW1ib2xzTGluZXMgOj0gKFxyXG5cdFx0cGF0aDogc3RyaW5nLFxyXG5cdFx0aE9wdGlvbnM6IGhhc2g9e31cclxuXHRcdCk6IEdlbmVyYXRvcjxzdHJpbmcsIHZvaWQsIHZvaWQ+IC0+XHJcblxyXG5cdHR5cGUgb3B0ID0ge1xyXG5cdFx0b25lSW5kZW50OiBzdHJpbmdcclxuXHRcdG1heExpbmVMZW46IG51bWJlclxyXG5cdFx0fVxyXG5cdHtvbmVJbmRlbnQsIG1heExpbmVMZW59IDo9IGdldE9wdGlvbnM8b3B0PiBoT3B0aW9ucywge1xyXG5cdFx0b25lSW5kZW50OiAnXFx0J1xyXG5cdFx0bWF4TGluZUxlbjogNzVcclxuXHRcdH1cclxuXHRsU3ltYm9sczogc3RyaW5nW10gOj0gW11cclxuXHRsZXQgbGluZUxlbiA9IDAgICAgICMgLS0tIGFsd2F5cyA8PSBtYXhMaW5lTGVuXHJcblx0bGV0IHBhdGhZaWVsZGVkID0gZmFsc2VcclxuXHJcblx0YW5hbHlzaXMgOj0gYW5hbHl6ZShwYXRoKVxyXG5cdGV4cG9ydHMgOj0gYW5hbHlzaXMuZXhwb3J0c1xyXG5cclxuXHRmb3IgbGliIG9mIGV4cG9ydHMuYWxsS2V5cygpXHJcblx0XHRmb3IgbmFtZSBvZiBleHBvcnRzLmFsbFZhbHVlcyhsaWIpXHJcblx0XHRcdHBvcyA6PSBuYW1lLmluZGV4T2YoJzwnKVxyXG5cdFx0XHRzeW0gOj0gKHBvcyA9PSAtMSkgPyBuYW1lIDogbmFtZS5zdWJzdHJpbmcoMCwgcG9zKVxyXG5cdFx0XHRpZiAobGluZUxlbiArIHN5bS5sZW5ndGggKyAxID4gbWF4TGluZUxlbilcclxuXHRcdFx0XHRpZiBub3QgcGF0aFlpZWxkZWRcclxuXHRcdFx0XHRcdHlpZWxkIHBhdGgucmVwbGFjZSgnLmNpdmV0JywgJy50cycpXHJcblx0XHRcdFx0XHRwYXRoWWllbGRlZCA9IHRydWVcclxuXHRcdFx0XHR5aWVsZCBcIiN7b25lSW5kZW50fSN7bFN5bWJvbHMuam9pbignICcpfVwiXHJcblx0XHRcdFx0bFN5bWJvbHMubGVuZ3RoID0gMFxyXG5cdFx0XHRcdGxpbmVMZW4gPSAwXHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHRsU3ltYm9scy5wdXNoIHN5bVxyXG5cdFx0XHRcdGxpbmVMZW4gKz0gc3ltLmxlbmd0aCArIDFcclxuXHRpZiAobFN5bWJvbHMubGVuZ3RoID4gMClcclxuXHRcdGlmIG5vdCBwYXRoWWllbGRlZFxyXG5cdFx0XHR5aWVsZCBwYXRoLnJlcGxhY2UoJy5jaXZldCcsICcudHMnKVxyXG5cdFx0XHRwYXRoWWllbGRlZCA9IHRydWVcclxuXHRcdHlpZWxkIFwiI3tvbmVJbmRlbnR9I3tsU3ltYm9scy5qb2luKCcgJyl9XCJcclxuXHRyZXR1cm5cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgZ2V0RG90U3ltYm9scyA6PSAoXHJcblx0aE9wdGlvbnM6IGhhc2g9e31cclxuXHQpOiBBc3luY0dlbmVyYXRvcjxzdHJpbmcsIHZvaWQsIHZvaWQ+IC0+XHJcblxyXG5cdGZvciB7dHlwZSwgcmVsUGF0aH0gb2YgYWxsRmlsZXNNYXRjaGluZygnKiovKi5saWIuY2l2ZXQnKVxyXG5cdFx0YXNzZXJ0ICh0eXBlID09ICdmaWxlJyksIFwiTm90IGEgZmlsZTogI3tyZWxQYXRofVwiXHJcblx0XHREQkcgXCJHRVQgc3ltYm9scyBmcm9tOiAje3JlbFBhdGh9XCJcclxuXHRcdGZvciBhd2FpdCBsaW5lIG9mIGdldERvdFN5bWJvbHNMaW5lcyhyZWxQYXRoKVxyXG5cdFx0XHR5aWVsZCBsaW5lXHJcblx0cmV0dXJuXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxubExpbmVzIDo9IGF3YWl0IEFycmF5LmZyb21Bc3luYyhnZXREb3RTeW1ib2xzKCkpXHJcbmNvbnRlbnRzIDo9IGxMaW5lcy5qb2luKCdcXG4nKVxyXG5EQkdWQUxVRSAnY29udGVudHMnLCBjb250ZW50c1xyXG5iYXJmICdzcmMvLnN5bWJvbHMnLCBjb250ZW50c1xyXG4iXX0=