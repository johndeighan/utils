"use strict";
// exec-utils.civet

type AutoPromise<T> = Promise<Awaited<T>>;
import {stripAnsiCode} from "@std/fmt/colors"

import {
	undef, defined, notdefined,
	isString, isArray, isArrayOfStrings,
	hash, optionspec,
	} from './datatypes.ts'
import {
	getOptions, croak, assert, OL,
	} from './llutils.ts'
import {
	curLogLevel, pushLogLevel, popLogLevel,
	INDENT, UNDENT,
	DBG, LOG, WARN, ERR,
	} from './logger.ts'

/**
 * @module exec-utils - utilities for executing external code
 */

const textDecoder = new TextDecoder()

// ---------------------------------------------------------------------------

/**
 * convert ArrayBuffer, Int8Array, etc. to a string
 */

export const mkstr = (item: any): string => {

	if (defined(item)) {
		if (isString(item)) {
			return stripAnsiCode(item)
		}
		else if (isArray(item)) {
			return stripAnsiCode(item.join(''))
		}
		else {
			return stripAnsiCode(textDecoder.decode(item))
		}
	}
	else {
		return ''
	}
}

// ---------------------------------------------------------------------------

/**
 * build a command line from a command name and array of arguments
 */

export const getCmdLine = (cmdName: string, lArgs: string[]): string => {

	assert(isString(cmdName), `cmdName not a string: ${OL(cmdName)}`)
	assert(isArrayOfStrings(lArgs), `not an array of strings: ${OL(lArgs)}`)
	const cmdLine = `${cmdName} ${lArgs.join(' ')}`
	DBG(`cmdLine = ${OL(cmdLine)}`)
	return cmdLine
}

// ---------------------------------------------------------------------------

/**
 * build result hash to be returned by execCmd() or execCmdSync()
 */

export type execCmdResult = {
	success: boolean
	code: number
	signal: (string | undefined)
	stdout: (string | undefined)
	stderr: (string | undefined)
	}

export const getFinalResult = (
	hResult: hash,
	collect: boolean
	): execCmdResult => {

	let ref;if (collect) {
		ref = ({
			success: hResult.success,
			code:    hResult.code,
			signal:  hResult.signal,
			stdout:  mkstr(hResult.stdout),
			stderr:  mkstr(hResult.stderr)
			})
	}
	else {
		ref = ({
			success: hResult.success,
			code:    hResult.code,
			signal:  hResult.signal,
			stdout:  undef,
			stderr:  undef
			})
	};const hRes =ref
	DBG(`hResult = ${OL(hRes)}`)
	return hRes
}

// ---------------------------------------------------------------------------

/**
 * get options to pass to Deno.Command constructor
 * 2nd argument determines whether stdout and stderr are
 * sent to parent process's stdout and stderr or are
 * collected to be returned to the caller
 */

export const getProcOpt = (
	lArgs: string[],
	collect: boolean
	): Deno.CommandOptions => {

	const hEnv: hash = {
		DEFAULT_LOGGER: curLogLevel()
		}

	return (collect?
		({
			args: lArgs,
			env: hEnv,
			stdout: 'piped',
			stderr: 'piped'
			})
	:
		({
			args: lArgs,
			env: hEnv,
			stdout: 'inherit',
			stderr: 'inherit'
			}))
}

// ---------------------------------------------------------------------------
// ASYNC

export const execCmd = async (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): AutoPromise<execCmdResult> => {

	const {collect, nolog} = getOptions(hOptions, {
		collect: false,
		nolog: false
		})
	if (nolog) {
		pushLogLevel('silent')
	}
	DBG(`EXEC: ${OL(getCmdLine(cmdName, lArgs))}`)
	DBG(INDENT)
	const hProcOpt = getProcOpt(lArgs, collect)
	const child = new Deno.Command(cmdName, hProcOpt)
	DBG(UNDENT)
	const hResult = await child.output()
	const hFinalResult = getFinalResult(hResult, collect)
	if (nolog) {
		popLogLevel()
	}
	return hFinalResult
}

// ---------------------------------------------------------------------------

export const execCmdSync = (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): execCmdResult => {

	const {collect, nolog} = getOptions(hOptions, {
		collect: false,
		nolog: false
		})
	if (nolog) {
		pushLogLevel('silent')
	}
	DBG(`EXEC SYNC: ${OL(getCmdLine(cmdName, lArgs))}`)
	DBG(INDENT)
	const hProcOpt = getProcOpt(lArgs, collect)
	const child = new Deno.Command(cmdName, hProcOpt)
	DBG(UNDENT)
	const hResult = child.outputSync()
	const hFinalResult = getFinalResult(hResult, collect)
	if (nolog) {
		popLogLevel()
	}
	return hFinalResult
}

// ---------------------------------------------------------------------------

export const cmdSucceeds = (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): boolean => {

	const {quiet} = getOptions(hOptions, {
		quiet: true
		})
	try {
		const h = quiet ? {collect: true, nolog: true} : {}
		execCmdSync(cmdName, lArgs, h)
		return true
	}
	catch (err) {
		return false
	}
}

// ---------------------------------------------------------------------------

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9leGVjLXV0aWxzLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2xpYi9leGVjLXV0aWxzLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxLLFcseUI7QUFBQSxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCO0FBQzdDLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUM1QixDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDO0FBQ3JDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0I7QUFDeEIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWM7QUFDdEIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDeEMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWE7QUFDckIsQUFBQTtBQUNBLEFBQUE7QUFDQTtBQUNBLEdBQUc7QUFDSCxBQUFBO0FBQ0EsQUFBQSxBQUFXLE1BQVgsV0FBVyxDQUFDLENBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDaEMsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQU0sTUFBTCxLQUFLLENBQUMsQ0FBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDdEMsQUFBQTtBQUNBLEFBQUEsQ0FBQyxHQUFHLENBQUEsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUNqQixBQUFBLEVBQUUsR0FBRyxDQUFBLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDbkIsQUFBQSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDO0VBQUMsQ0FBQTtBQUM3QixBQUFBLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQ3ZCLEFBQUEsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEM7RUFBQyxDQUFBO0FBQ3RDLEFBQUEsRUFBRSxJQUFJLENBQUEsQ0FBQTtBQUNOLEFBQUEsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEM7RUFBQyxDO0NBQUEsQ0FBQTtBQUNqRCxBQUFBLENBQUMsSUFBSSxDQUFBLENBQUE7QUFDTCxBQUFBLEVBQUUsTUFBTSxDQUFDLEU7Q0FBRSxDO0FBQUEsQ0FBQTtBQUNYLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQTtBQUNBO0FBQ0EsR0FBRztBQUNILEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFXLE1BQVYsVUFBVSxDQUFDLENBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUNsRSxBQUFBO0FBQ0EsQUFBQSxDQUFDLE1BQU0sQ0FBQSxBQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUNqRSxBQUFBLENBQUMsTUFBTSxDQUFBLEFBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDeEUsQUFBQSxDQUFRLE1BQVAsT0FBTyxDQUFDLENBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDM0MsQUFBQSxDQUFDLEdBQUcsQ0FBQSxBQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDL0IsQUFBQSxDQUFDLE1BQU0sQ0FBQyxPO0FBQU8sQ0FBQTtBQUNmLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQTtBQUNBO0FBQ0EsR0FBRztBQUNILEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDN0IsQUFBQSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU87QUFDakIsQUFBQSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07QUFDYixBQUFBLENBQUMsTUFBTSxDLEMsQ0FBQyxBQUFDLE0sWSxDQUFPO0FBQ2hCLEFBQUEsQ0FBQyxNQUFNLEMsQyxDQUFDLEFBQUMsTSxZLENBQU87QUFDaEIsQUFBQSxDQUFDLE1BQU0sQyxDLENBQUMsQUFBQyxNLFksQ0FBTztBQUNoQixDQUFDLENBQUM7QUFDRixBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBZSxNQUFkLGNBQWMsQ0FBQyxDQUFFLENBQUMsQ0FBQztBQUMxQixBQUFBLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2YsQUFBQSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU87QUFDakIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDcEIsQUFBQTtBQUNBLEFBQUEsQyxJLEcsQ0FBUyxHQUFHLENBQUEsT0FBTyxDQUFBLENBQUEsQ0FBQTtBQUNuQixBQUFBLEUsRyxHLENBQUUsQ0FBQztBQUNILEFBQUEsR0FBRyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFBO0FBQzNCLEFBQUEsR0FBRyxJQUFJLENBQUMsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFBO0FBQ3hCLEFBQUEsR0FBRyxNQUFNLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFBO0FBQzFCLEFBQUEsR0FBRyxNQUFNLENBQUMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBQ2pDLEFBQUEsR0FBRyxNQUFNLENBQUMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUNqQyxHQUFHLEMsQztDQUFDLENBQUE7QUFDSixBQUFBLENBQUMsSUFBSSxDQUFBLENBQUE7QUFDTCxBQUFBLEUsRyxHLENBQUUsQ0FBQztBQUNILEFBQUEsR0FBRyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFBO0FBQzNCLEFBQUEsR0FBRyxJQUFJLENBQUMsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFBO0FBQ3hCLEFBQUEsR0FBRyxNQUFNLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFBO0FBQzFCLEFBQUEsR0FBRyxNQUFNLENBQUMsRUFBRSxLQUFLLENBQUE7QUFDakIsQUFBQSxHQUFHLE1BQU0sQ0FBQyxFQUFFLEtBQUs7QUFDakIsR0FBRyxDLEM7Q0FBQyxDLENBZkMsTUFBSixJQUFJLENBQUMsQyxHQWVGO0FBQ0osQUFBQSxDQUFDLEdBQUcsQ0FBQSxBQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDNUIsQUFBQSxDQUFDLE1BQU0sQ0FBQyxJO0FBQUksQ0FBQTtBQUNaLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNILEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFXLE1BQVYsVUFBVSxDQUFDLENBQUUsQ0FBQyxDQUFDO0FBQ3RCLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ2pCLEFBQUEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPO0FBQ2pCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUMxQixBQUFBO0FBQ0EsQUFBQSxDQUFXLE1BQVYsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUUsQ0FBQyxDQUFDO0FBQ2hCLEFBQUEsRUFBRSxjQUFjLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUMvQixFQUFFLENBQUM7QUFDSCxBQUFBO0FBQ0EsQUFBQSxDQUFDLE1BQU0sQ0FBSSxDQUFBLE8sQ0FBTztBQUNsQixBQUFBLEUsQ0FBRSxDQUFDO0FBQ0gsQUFBQSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNmLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUE7QUFDWixBQUFBLEdBQUcsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFBO0FBQ2xCLEFBQUEsR0FBRyxNQUFNLENBQUMsQ0FBQyxPQUFPO0FBQ2xCLEdBQUcsQyxDQUFDO0FBQ0osQUFBQSxDLENBQUs7QUFDTCxBQUFBLEUsQ0FBRSxDQUFDO0FBQ0gsQUFBQSxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNmLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUE7QUFDWixBQUFBLEdBQUcsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFBO0FBQ3BCLEFBQUEsR0FBRyxNQUFNLENBQUMsQ0FBQyxTQUFTO0FBQ3BCLEdBQUcsQyxDQWJlLEM7QUFhZCxDQUFBO0FBQ0osQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUEsUUFBTztBQUNQLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFRLE1BQVAsT0FBTyxDQUFDLENBQUUsQyxNQUFDLENBQUM7QUFDbkIsQUFBQSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNqQixBQUFBLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEIsQUFBQSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFCLENBQUMsQ0FBQyxDLEMsVyxDQUFDLEFBQUMsYSxDQUFhLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDcEIsQUFBQTtBQUNBLEFBQUEsQ0FBaUIsTUFBaEIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFFLENBQUMsVUFBVSxDQUFBLEFBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUMzQyxBQUFBLEVBQUUsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFBO0FBQ2hCLEFBQUEsRUFBRSxLQUFLLENBQUMsQ0FBQyxLQUFLO0FBQ2QsRUFBRSxDQUFDLENBQUE7QUFDSCxBQUFBLENBQUMsR0FBRyxDQUFBLEtBQUssQ0FBQSxDQUFBLENBQUE7QUFDVCxBQUFBLEVBQUUsWUFBWSxDQUFBLEFBQUMsUUFBUSxDO0NBQUEsQ0FBQTtBQUN2QixBQUFBLENBQUMsR0FBRyxDQUFBLEFBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUM5QyxBQUFBLENBQUMsR0FBRyxDQUFBLEFBQUMsTUFBTSxDQUFBO0FBQ1gsQUFBQSxDQUFTLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDO0FBQ3ZDLEFBQUEsQ0FBTSxNQUFMLEtBQUssQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQzdDLEFBQUEsQ0FBQyxHQUFHLENBQUEsQUFBQyxNQUFNLENBQUE7QUFDWCxBQUFBLENBQVEsTUFBUCxPQUFPLENBQUMsQ0FBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDaEMsQUFBQSxDQUFhLE1BQVosWUFBWSxDQUFDLENBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDO0FBQ2pELEFBQUEsQ0FBQyxHQUFHLENBQUEsS0FBSyxDQUFBLENBQUEsQ0FBQTtBQUNULEFBQUEsRUFBRSxXQUFXLENBQUMsQztDQUFDLENBQUE7QUFDZixBQUFBLENBQUMsTUFBTSxDQUFDLFk7QUFBWSxDQUFBO0FBQ3BCLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBWSxNQUFYLFdBQVcsQ0FBQyxDQUFFLENBQUMsQ0FBQztBQUN2QixBQUFBLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2pCLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QixBQUFBLENBQUMsUUFBUSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDcEIsQUFBQTtBQUNBLEFBQUEsQ0FBaUIsTUFBaEIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFFLENBQUMsVUFBVSxDQUFBLEFBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUMzQyxBQUFBLEVBQUUsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFBO0FBQ2hCLEFBQUEsRUFBRSxLQUFLLENBQUMsQ0FBQyxLQUFLO0FBQ2QsRUFBRSxDQUFDLENBQUE7QUFDSCxBQUFBLENBQUMsR0FBRyxDQUFBLEtBQUssQ0FBQSxDQUFBLENBQUE7QUFDVCxBQUFBLEVBQUUsWUFBWSxDQUFBLEFBQUMsUUFBUSxDO0NBQUEsQ0FBQTtBQUN2QixBQUFBLENBQUMsR0FBRyxDQUFBLEFBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUNuRCxBQUFBLENBQUMsR0FBRyxDQUFBLEFBQUMsTUFBTSxDQUFBO0FBQ1gsQUFBQSxDQUFTLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDO0FBQ3ZDLEFBQUEsQ0FBTSxNQUFMLEtBQUssQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQzdDLEFBQUEsQ0FBQyxHQUFHLENBQUEsQUFBQyxNQUFNLENBQUE7QUFDWCxBQUFBLENBQVEsTUFBUCxPQUFPLENBQUMsQ0FBRSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUM5QixBQUFBLENBQWEsTUFBWixZQUFZLENBQUMsQ0FBRSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDakQsQUFBQSxDQUFDLEdBQUcsQ0FBQSxLQUFLLENBQUEsQ0FBQSxDQUFBO0FBQ1QsQUFBQSxFQUFFLFdBQVcsQ0FBQyxDO0NBQUMsQ0FBQTtBQUNmLEFBQUEsQ0FBQyxNQUFNLENBQUMsWTtBQUFZLENBQUE7QUFDcEIsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFZLE1BQVgsV0FBVyxDQUFDLENBQUUsQ0FBQyxDQUFDO0FBQ3ZCLEFBQUEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDakIsQUFBQSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RCLEFBQUEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMxQixDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUNkLEFBQUE7QUFDQSxBQUFBLENBQVEsTUFBUCxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUUsQ0FBQyxVQUFVLENBQUEsQUFBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ2xDLEFBQUEsRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJO0FBQ2IsRUFBRSxDQUFDLENBQUE7QUFDSCxBQUFBLENBQUMsR0FBRyxDQUFBLENBQUE7QUFDSixBQUFBLEVBQUcsTUFBRCxDQUFDLENBQUMsQ0FBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hELEFBQUEsRUFBRSxXQUFXLENBQUEsQUFBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDL0IsQUFBQSxFQUFFLE1BQU0sQ0FBQyxJO0NBQUksQ0FBQTtBQUNiLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ1YsQUFBQSxFQUFFLE1BQU0sQ0FBQyxLO0NBQUssQztBQUFBLENBQUE7QUFDZDtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIGV4ZWMtdXRpbHMuY2l2ZXRcblxuaW1wb3J0IHtzdHJpcEFuc2lDb2RlfSBmcm9tIFwiQHN0ZC9mbXQvY29sb3JzXCJcblxuaW1wb3J0IHtcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsXG5cdGlzU3RyaW5nLCBpc0FycmF5LCBpc0FycmF5T2ZTdHJpbmdzLFxuXHRoYXNoLCBvcHRpb25zcGVjLFxuXHR9IGZyb20gJy4vZGF0YXR5cGVzLnRzJ1xuaW1wb3J0IHtcblx0Z2V0T3B0aW9ucywgY3JvYWssIGFzc2VydCwgT0wsXG5cdH0gZnJvbSAnLi9sbHV0aWxzLnRzJ1xuaW1wb3J0IHtcblx0Y3VyTG9nTGV2ZWwsIHB1c2hMb2dMZXZlbCwgcG9wTG9nTGV2ZWwsXG5cdElOREVOVCwgVU5ERU5ULFxuXHREQkcsIExPRywgV0FSTiwgRVJSLFxuXHR9IGZyb20gJy4vbG9nZ2VyLnRzJ1xuXG4vKipcbiAqIEBtb2R1bGUgZXhlYy11dGlscyAtIHV0aWxpdGllcyBmb3IgZXhlY3V0aW5nIGV4dGVybmFsIGNvZGVcbiAqL1xuXG50ZXh0RGVjb2RlciA6PSBuZXcgVGV4dERlY29kZXIoKVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIGNvbnZlcnQgQXJyYXlCdWZmZXIsIEludDhBcnJheSwgZXRjLiB0byBhIHN0cmluZ1xuICovXG5cbmV4cG9ydCBta3N0ciA6PSAoaXRlbTogYW55KTogc3RyaW5nID0+XG5cblx0aWYgZGVmaW5lZChpdGVtKVxuXHRcdGlmIGlzU3RyaW5nKGl0ZW0pXG5cdFx0XHRyZXR1cm4gc3RyaXBBbnNpQ29kZShpdGVtKVxuXHRcdGVsc2UgaWYgaXNBcnJheShpdGVtKVxuXHRcdFx0cmV0dXJuIHN0cmlwQW5zaUNvZGUoaXRlbS5qb2luKCcnKSlcblx0XHRlbHNlXG5cdFx0XHRyZXR1cm4gc3RyaXBBbnNpQ29kZSh0ZXh0RGVjb2Rlci5kZWNvZGUoaXRlbSkpXG5cdGVsc2Vcblx0XHRyZXR1cm4gJydcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBidWlsZCBhIGNvbW1hbmQgbGluZSBmcm9tIGEgY29tbWFuZCBuYW1lIGFuZCBhcnJheSBvZiBhcmd1bWVudHNcbiAqL1xuXG5leHBvcnQgZ2V0Q21kTGluZSA6PSAoY21kTmFtZTogc3RyaW5nLCBsQXJnczogc3RyaW5nW10pOiBzdHJpbmcgPT5cblxuXHRhc3NlcnQgaXNTdHJpbmcoY21kTmFtZSksIFwiY21kTmFtZSBub3QgYSBzdHJpbmc6ICN7T0woY21kTmFtZSl9XCJcblx0YXNzZXJ0IGlzQXJyYXlPZlN0cmluZ3MobEFyZ3MpLCBcIm5vdCBhbiBhcnJheSBvZiBzdHJpbmdzOiAje09MKGxBcmdzKX1cIlxuXHRjbWRMaW5lIDo9IFwiI3tjbWROYW1lfSAje2xBcmdzLmpvaW4oJyAnKX1cIlxuXHREQkcgXCJjbWRMaW5lID0gI3tPTChjbWRMaW5lKX1cIlxuXHRyZXR1cm4gY21kTGluZVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIGJ1aWxkIHJlc3VsdCBoYXNoIHRvIGJlIHJldHVybmVkIGJ5IGV4ZWNDbWQoKSBvciBleGVjQ21kU3luYygpXG4gKi9cblxuZXhwb3J0IHR5cGUgZXhlY0NtZFJlc3VsdCA9IHtcblx0c3VjY2VzczogYm9vbGVhblxuXHRjb2RlOiBudW1iZXJcblx0c2lnbmFsOiBzdHJpbmc/XG5cdHN0ZG91dDogc3RyaW5nP1xuXHRzdGRlcnI6IHN0cmluZz9cblx0fVxuXG5leHBvcnQgZ2V0RmluYWxSZXN1bHQgOj0gKFxuXHRoUmVzdWx0OiBoYXNoLFxuXHRjb2xsZWN0OiBib29sZWFuXG5cdCk6IGV4ZWNDbWRSZXN1bHQgPT5cblxuXHRoUmVzIDo9IGlmIGNvbGxlY3Rcblx0XHR7XG5cdFx0XHRzdWNjZXNzOiBoUmVzdWx0LnN1Y2Nlc3Ncblx0XHRcdGNvZGU6ICAgIGhSZXN1bHQuY29kZVxuXHRcdFx0c2lnbmFsOiAgaFJlc3VsdC5zaWduYWxcblx0XHRcdHN0ZG91dDogIG1rc3RyKGhSZXN1bHQuc3Rkb3V0KVxuXHRcdFx0c3RkZXJyOiAgbWtzdHIoaFJlc3VsdC5zdGRlcnIpXG5cdFx0XHR9XG5cdGVsc2Vcblx0XHR7XG5cdFx0XHRzdWNjZXNzOiBoUmVzdWx0LnN1Y2Nlc3Ncblx0XHRcdGNvZGU6ICAgIGhSZXN1bHQuY29kZVxuXHRcdFx0c2lnbmFsOiAgaFJlc3VsdC5zaWduYWxcblx0XHRcdHN0ZG91dDogIHVuZGVmXG5cdFx0XHRzdGRlcnI6ICB1bmRlZlxuXHRcdFx0fVxuXHREQkcgXCJoUmVzdWx0ID0gI3tPTChoUmVzKX1cIlxuXHRyZXR1cm4gaFJlc1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIGdldCBvcHRpb25zIHRvIHBhc3MgdG8gRGVuby5Db21tYW5kIGNvbnN0cnVjdG9yXG4gKiAybmQgYXJndW1lbnQgZGV0ZXJtaW5lcyB3aGV0aGVyIHN0ZG91dCBhbmQgc3RkZXJyIGFyZVxuICogc2VudCB0byBwYXJlbnQgcHJvY2VzcydzIHN0ZG91dCBhbmQgc3RkZXJyIG9yIGFyZVxuICogY29sbGVjdGVkIHRvIGJlIHJldHVybmVkIHRvIHRoZSBjYWxsZXJcbiAqL1xuXG5leHBvcnQgZ2V0UHJvY09wdCA6PSAoXG5cdGxBcmdzOiBzdHJpbmdbXSxcblx0Y29sbGVjdDogYm9vbGVhblxuXHQpOiBEZW5vLkNvbW1hbmRPcHRpb25zID0+XG5cblx0aEVudjogaGFzaCA6PSB7XG5cdFx0REVGQVVMVF9MT0dHRVI6IGN1ckxvZ0xldmVsKClcblx0XHR9XG5cblx0cmV0dXJuIGlmIGNvbGxlY3Rcblx0XHR7XG5cdFx0XHRhcmdzOiBsQXJncyxcblx0XHRcdGVudjogaEVudlxuXHRcdFx0c3Rkb3V0OiAncGlwZWQnXG5cdFx0XHRzdGRlcnI6ICdwaXBlZCdcblx0XHRcdH1cblx0ZWxzZVxuXHRcdHtcblx0XHRcdGFyZ3M6IGxBcmdzLFxuXHRcdFx0ZW52OiBoRW52XG5cdFx0XHRzdGRvdXQ6ICdpbmhlcml0J1xuXHRcdFx0c3RkZXJyOiAnaW5oZXJpdCdcblx0XHRcdH1cblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgQVNZTkNcblxuZXhwb3J0IGV4ZWNDbWQgOj0gKFxuXHRjbWROYW1lOiBzdHJpbmcsXG5cdGxBcmdzOiBzdHJpbmdbXSA9IFtdLFxuXHRoT3B0aW9uczogb3B0aW9uc3BlYyA9IHt9XG5cdCk6IGV4ZWNDbWRSZXN1bHQgPT5cblxuXHR7Y29sbGVjdCwgbm9sb2d9IDo9IGdldE9wdGlvbnMgaE9wdGlvbnMsIHtcblx0XHRjb2xsZWN0OiBmYWxzZVxuXHRcdG5vbG9nOiBmYWxzZVxuXHRcdH1cblx0aWYgbm9sb2dcblx0XHRwdXNoTG9nTGV2ZWwgJ3NpbGVudCdcblx0REJHIFwiRVhFQzogI3tPTChnZXRDbWRMaW5lKGNtZE5hbWUsIGxBcmdzKSl9XCJcblx0REJHIElOREVOVFxuXHRoUHJvY09wdCA6PSBnZXRQcm9jT3B0KGxBcmdzLCBjb2xsZWN0KVxuXHRjaGlsZCA6PSBuZXcgRGVuby5Db21tYW5kKGNtZE5hbWUsIGhQcm9jT3B0KVxuXHREQkcgVU5ERU5UXG5cdGhSZXN1bHQgOj0gYXdhaXQgY2hpbGQub3V0cHV0KClcblx0aEZpbmFsUmVzdWx0IDo9IGdldEZpbmFsUmVzdWx0KGhSZXN1bHQsIGNvbGxlY3QpXG5cdGlmIG5vbG9nXG5cdFx0cG9wTG9nTGV2ZWwoKVxuXHRyZXR1cm4gaEZpbmFsUmVzdWx0XG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBleGVjQ21kU3luYyA6PSAoXG5cdGNtZE5hbWU6IHN0cmluZyxcblx0bEFyZ3M6IHN0cmluZ1tdID0gW10sXG5cdGhPcHRpb25zOiBvcHRpb25zcGVjID0ge31cblx0KTogZXhlY0NtZFJlc3VsdCA9PlxuXG5cdHtjb2xsZWN0LCBub2xvZ30gOj0gZ2V0T3B0aW9ucyBoT3B0aW9ucywge1xuXHRcdGNvbGxlY3Q6IGZhbHNlXG5cdFx0bm9sb2c6IGZhbHNlXG5cdFx0fVxuXHRpZiBub2xvZ1xuXHRcdHB1c2hMb2dMZXZlbCAnc2lsZW50J1xuXHREQkcgXCJFWEVDIFNZTkM6ICN7T0woZ2V0Q21kTGluZShjbWROYW1lLCBsQXJncykpfVwiXG5cdERCRyBJTkRFTlRcblx0aFByb2NPcHQgOj0gZ2V0UHJvY09wdChsQXJncywgY29sbGVjdClcblx0Y2hpbGQgOj0gbmV3IERlbm8uQ29tbWFuZChjbWROYW1lLCBoUHJvY09wdClcblx0REJHIFVOREVOVFxuXHRoUmVzdWx0IDo9IGNoaWxkLm91dHB1dFN5bmMoKVxuXHRoRmluYWxSZXN1bHQgOj0gZ2V0RmluYWxSZXN1bHQoaFJlc3VsdCwgY29sbGVjdClcblx0aWYgbm9sb2dcblx0XHRwb3BMb2dMZXZlbCgpXG5cdHJldHVybiBoRmluYWxSZXN1bHRcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGNtZFN1Y2NlZWRzIDo9IChcblx0Y21kTmFtZTogc3RyaW5nLFxuXHRsQXJnczogc3RyaW5nW10gPSBbXSxcblx0aE9wdGlvbnM6IG9wdGlvbnNwZWMgPSB7fVxuXHQpOiBib29sZWFuID0+XG5cblx0e3F1aWV0fSA6PSBnZXRPcHRpb25zIGhPcHRpb25zLCB7XG5cdFx0cXVpZXQ6IHRydWVcblx0XHR9XG5cdHRyeVxuXHRcdGggOj0gcXVpZXQgPyB7Y29sbGVjdDogdHJ1ZSwgbm9sb2c6IHRydWV9IDoge31cblx0XHRleGVjQ21kU3luYyBjbWROYW1lLCBsQXJncywgaFxuXHRcdHJldHVybiB0cnVlXG5cdGNhdGNoIGVyclxuXHRcdHJldHVybiBmYWxzZVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIl19