"use strict";
// exec-utils.civet

type AutoPromise<T> = T extends Promise<unknown> ? T : Promise<T>;
import {stripAnsiCode} from "jsr:@std/fmt/colors"

import {
	undef, defined, notdefined,
	isString, isArray, isArrayOfStrings,
	hash, optionspec,
	} from './datatypes.ts'
import {
	getOptions, croak, assert, OL,
	} from './llutils.ts'
import {
	curLogLevel, pushLogLevel, popLogLevel,
	INDENT, UNDENT,
	DBG, LOG, WARN, ERR,
	} from './logger.ts'

const textDecoder = new TextDecoder()

// ---------------------------------------------------------------------------

/**
 * convert ArrayBuffer, Int8Array, etc. to a string
 */

export const mkstr = (item: any): string => {

	if (defined(item)) {
		if (isString(item)) {
			return stripAnsiCode(item)
		}
		else if (isArray(item)) {
			return stripAnsiCode(item.join(''))
		}
		else {
			return stripAnsiCode(textDecoder.decode(item))
		}
	}
	else {
		return ''
	}
}

// ---------------------------------------------------------------------------

/**
 * build a command line from a command name and array of arguments
 */

export const getCmdLine = (cmdName: string, lArgs: string[]): string => {

	assert(isString(cmdName), `cmdName not a string: ${OL(cmdName)}`)
	assert(isArrayOfStrings(lArgs), `not an array of strings: ${OL(lArgs)}`)
	const cmdLine = `${cmdName} ${lArgs.join(' ')}`
	DBG(`cmdLine = ${OL(cmdLine)}`)
	return cmdLine
}

// ---------------------------------------------------------------------------

/**
 * build result hash to be returned by execCmd() or execCmdSync()
 */

export type execCmdResult = {
	success: boolean
	code: number
	signal: (string | undefined)
	stdout: (string | undefined)
	stderr: (string | undefined)
	}

export const getFinalResult = (
	hResult: hash,
	collect: boolean
	): execCmdResult => {

	let ref;if (collect) {
		ref = ({
			success: hResult.success,
			code:    hResult.code,
			signal:  hResult.signal,
			stdout:  mkstr(hResult.stdout),
			stderr:  mkstr(hResult.stderr)
			})
	}
	else {
		ref = ({
			success: hResult.success,
			code:    hResult.code,
			signal:  hResult.signal,
			stdout:  undef,
			stderr:  undef
			})
	};const hRes =ref
	DBG(`hResult = ${OL(hRes)}`)
	return hRes
}

// ---------------------------------------------------------------------------

/**
 * get options to pass to Deno.Command constructor
 * 2nd argument determines whether stdout and stderr are
 * sent to parent process's stdout and stderr or are
 * collected to be returned to the caller
 */

export const getProcOpt = (
	lArgs: string[],
	collect: boolean
	): Deno.CommandOptions => {

	const hEnv: hash = {
		DEFAULT_LOGGER: curLogLevel()
		}

	return (collect?
		({
			args: lArgs,
			env: hEnv,
			stdout: 'piped',
			stderr: 'piped'
			})
	:
		({
			args: lArgs,
			env: hEnv,
			stdout: 'inherit',
			stderr: 'inherit'
			}))
}

// ---------------------------------------------------------------------------
// ASYNC

export const execCmd = async (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): AutoPromise<execCmdResult> => {

	const {collect, nolog} = getOptions(hOptions, {
		collect: false,
		nolog: false
		})
	if (nolog) {
		pushLogLevel('silent')
	}
	DBG(`EXEC: ${OL(getCmdLine(cmdName, lArgs))}`)
	DBG(INDENT)
	const hProcOpt = getProcOpt(lArgs, collect)
	const child = new Deno.Command(cmdName, hProcOpt)
	DBG(UNDENT)
	const hResult = await child.output()
	const hFinalResult = getFinalResult(hResult, collect)
	if (nolog) {
		popLogLevel()
	}
	return hFinalResult
}

// ---------------------------------------------------------------------------

export const execCmdSync = (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): execCmdResult => {

	const {collect, nolog} = getOptions(hOptions, {
		collect: false,
		nolog: false
		})
	if (nolog) {
		pushLogLevel('silent')
	}
	DBG(`EXEC SYNC: ${OL(getCmdLine(cmdName, lArgs))}`)
	DBG(INDENT)
	const hProcOpt = getProcOpt(lArgs, collect)
	const child = new Deno.Command(cmdName, hProcOpt)
	DBG(UNDENT)
	const hResult = child.outputSync()
	const hFinalResult = getFinalResult(hResult, collect)
	if (nolog) {
		popLogLevel()
	}
	return hFinalResult
}

// ---------------------------------------------------------------------------

export const cmdSucceeds = (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): boolean => {

	const {quiet} = getOptions(hOptions, {
		quiet: true
		})
	try {
		const h = quiet ? {collect: true, nolog: true} : {}
		execCmdSync(cmdName, lArgs, h)
		return true
	}
	catch (err) {
		return false
	}
}

// ---------------------------------------------------------------------------

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9leGVjLXV0aWxzLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2xpYi9leGVjLXV0aWxzLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxLLFcsaUQ7QUFBQSxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMscUJBQXFCO0FBQ2pELEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUM1QixDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDO0FBQ3JDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0I7QUFDeEIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWM7QUFDdEIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDeEMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWE7QUFDckIsQUFBQTtBQUNBLEFBQUEsQUFBVyxNQUFYLFdBQVcsQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ2hDLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQTtBQUNBO0FBQ0EsR0FBRztB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LEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QixBQUFBLENBQUMsUUFBUSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDZCxBQUFBO0FBQ0EsQUFBQSxDQUFRLE1BQVAsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFFLENBQUMsVUFBVSxDQUFBLEFBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNsQyxBQUFBLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSTtBQUNiLEVBQUUsQ0FBQyxDQUFBO0FBQ0gsQUFBQSxDQUFDLEdBQUcsQ0FBQSxDQUFBO0FBQ0osQUFBQSxFQUFHLE1BQUQsQ0FBQyxDQUFDLENBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoRCxBQUFBLEVBQUUsV0FBVyxDQUFBLEFBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQy9CLEFBQUEsRUFBRSxNQUFNLENBQUMsSTtDQUFJLENBQUE7QUFDYixBQUFBLENBQUMsS0FBSyxDQUFDLENBQUEsR0FBRyxDQUFBLENBQUEsQ0FBQTtBQUNWLEFBQUEsRUFBRSxNQUFNLENBQUMsSztDQUFLLEM7QUFBQSxDQUFBO0FBQ2Q7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBleGVjLXV0aWxzLmNpdmV0XG5cbmltcG9ydCB7c3RyaXBBbnNpQ29kZX0gZnJvbSBcImpzcjpAc3RkL2ZtdC9jb2xvcnNcIlxuXG5pbXBvcnQge1xuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCxcblx0aXNTdHJpbmcsIGlzQXJyYXksIGlzQXJyYXlPZlN0cmluZ3MsXG5cdGhhc2gsIG9wdGlvbnNwZWMsXG5cdH0gZnJvbSAnLi9kYXRhdHlwZXMudHMnXG5pbXBvcnQge1xuXHRnZXRPcHRpb25zLCBjcm9haywgYXNzZXJ0LCBPTCxcblx0fSBmcm9tICcuL2xsdXRpbHMudHMnXG5pbXBvcnQge1xuXHRjdXJMb2dMZXZlbCwgcHVzaExvZ0xldmVsLCBwb3BMb2dMZXZlbCxcblx0SU5ERU5ULCBVTkRFTlQsXG5cdERCRywgTE9HLCBXQVJOLCBFUlIsXG5cdH0gZnJvbSAnLi9sb2dnZXIudHMnXG5cbnRleHREZWNvZGVyIDo9IG5ldyBUZXh0RGVjb2RlcigpXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogY29udmVydCBBcnJheUJ1ZmZlciwgSW50OEFycmF5LCBldGMuIHRvIGEgc3RyaW5nXG4gKi9cblxuZXhwb3J0IG1rc3RyIDo9IChpdGVtOiBhbnkpOiBzdHJpbmcgPT5cblxuXHRpZiBkZWZpbmVkKGl0ZW0pXG5cdFx0aWYgaXNTdHJpbmcoaXRlbSlcblx0XHRcdHJldHVybiBzdHJpcEFuc2lDb2RlKGl0ZW0pXG5cdFx0ZWxzZSBpZiBpc0FycmF5KGl0ZW0pXG5cdFx0XHRyZXR1cm4gc3RyaXBBbnNpQ29kZShpdGVtLmpvaW4oJycpKVxuXHRcdGVsc2Vcblx0XHRcdHJldHVybiBzdHJpcEFuc2lDb2RlKHRleHREZWNvZGVyLmRlY29kZShpdGVtKSlcblx0ZWxzZVxuXHRcdHJldHVybiAnJ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIGJ1aWxkIGEgY29tbWFuZCBsaW5lIGZyb20gYSBjb21tYW5kIG5hbWUgYW5kIGFycmF5IG9mIGFyZ3VtZW50c1xuICovXG5cbmV4cG9ydCBnZXRDbWRMaW5lIDo9IChjbWROYW1lOiBzdHJpbmcsIGxBcmdzOiBzdHJpbmdbXSk6IHN0cmluZyA9PlxuXG5cdGFzc2VydCBpc1N0cmluZyhjbWROYW1lKSwgXCJjbWROYW1lIG5vdCBhIHN0cmluZzogI3tPTChjbWROYW1lKX1cIlxuXHRhc3NlcnQgaXNBcnJheU9mU3RyaW5ncyhsQXJncyksIFwibm90IGFuIGFycmF5IG9mIHN0cmluZ3M6ICN7T0wobEFyZ3MpfVwiXG5cdGNtZExpbmUgOj0gXCIje2NtZE5hbWV9ICN7bEFyZ3Muam9pbignICcpfVwiXG5cdERCRyBcImNtZExpbmUgPSAje09MKGNtZExpbmUpfVwiXG5cdHJldHVybiBjbWRMaW5lXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogYnVpbGQgcmVzdWx0IGhhc2ggdG8gYmUgcmV0dXJuZWQgYnkgZXhlY0NtZCgpIG9yIGV4ZWNDbWRTeW5jKClcbiAqL1xuXG5leHBvcnQgdHlwZSBleGVjQ21kUmVzdWx0ID0ge1xuXHRzdWNjZXNzOiBib29sZWFuXG5cdGNvZGU6IG51bWJlclxuXHRzaWduYWw6IHN0cmluZz9cblx0c3Rkb3V0OiBzdHJpbmc/XG5cdHN0ZGVycjogc3RyaW5nP1xuXHR9XG5cbmV4cG9ydCBnZXRGaW5hbFJlc3VsdCA6PSAoXG5cdGhSZXN1bHQ6IGhhc2gsXG5cdGNvbGxlY3Q6IGJvb2xlYW5cblx0KTogZXhlY0NtZFJlc3VsdCA9PlxuXG5cdGhSZXMgOj0gaWYgY29sbGVjdFxuXHRcdHtcblx0XHRcdHN1Y2Nlc3M6IGhSZXN1bHQuc3VjY2Vzc1xuXHRcdFx0Y29kZTogICAgaFJlc3VsdC5jb2RlXG5cdFx0XHRzaWduYWw6ICBoUmVzdWx0LnNpZ25hbFxuXHRcdFx0c3Rkb3V0OiAgbWtzdHIoaFJlc3VsdC5zdGRvdXQpXG5cdFx0XHRzdGRlcnI6ICBta3N0cihoUmVzdWx0LnN0ZGVycilcblx0XHRcdH1cblx0ZWxzZVxuXHRcdHtcblx0XHRcdHN1Y2Nlc3M6IGhSZXN1bHQuc3VjY2Vzc1xuXHRcdFx0Y29kZTogICAgaFJlc3VsdC5jb2RlXG5cdFx0XHRzaWduYWw6ICBoUmVzdWx0LnNpZ25hbFxuXHRcdFx0c3Rkb3V0OiAgdW5kZWZcblx0XHRcdHN0ZGVycjogIHVuZGVmXG5cdFx0XHR9XG5cdERCRyBcImhSZXN1bHQgPSAje09MKGhSZXMpfVwiXG5cdHJldHVybiBoUmVzXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogZ2V0IG9wdGlvbnMgdG8gcGFzcyB0byBEZW5vLkNvbW1hbmQgY29uc3RydWN0b3JcbiAqIDJuZCBhcmd1bWVudCBkZXRlcm1pbmVzIHdoZXRoZXIgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlXG4gKiBzZW50IHRvIHBhcmVudCBwcm9jZXNzJ3Mgc3Rkb3V0IGFuZCBzdGRlcnIgb3IgYXJlXG4gKiBjb2xsZWN0ZWQgdG8gYmUgcmV0dXJuZWQgdG8gdGhlIGNhbGxlclxuICovXG5cbmV4cG9ydCBnZXRQcm9jT3B0IDo9IChcblx0bEFyZ3M6IHN0cmluZ1tdLFxuXHRjb2xsZWN0OiBib29sZWFuXG5cdCk6IERlbm8uQ29tbWFuZE9wdGlvbnMgPT5cblxuXHRoRW52OiBoYXNoIDo9IHtcblx0XHRERUZBVUxUX0xPR0dFUjogY3VyTG9nTGV2ZWwoKVxuXHRcdH1cblxuXHRyZXR1cm4gaWYgY29sbGVjdFxuXHRcdHtcblx0XHRcdGFyZ3M6IGxBcmdzLFxuXHRcdFx0ZW52OiBoRW52XG5cdFx0XHRzdGRvdXQ6ICdwaXBlZCdcblx0XHRcdHN0ZGVycjogJ3BpcGVkJ1xuXHRcdFx0fVxuXHRlbHNlXG5cdFx0e1xuXHRcdFx0YXJnczogbEFyZ3MsXG5cdFx0XHRlbnY6IGhFbnZcblx0XHRcdHN0ZG91dDogJ2luaGVyaXQnXG5cdFx0XHRzdGRlcnI6ICdpbmhlcml0J1xuXHRcdFx0fVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIyBBU1lOQ1xuXG5leHBvcnQgZXhlY0NtZCA6PSAoXG5cdGNtZE5hbWU6IHN0cmluZyxcblx0bEFyZ3M6IHN0cmluZ1tdID0gW10sXG5cdGhPcHRpb25zOiBvcHRpb25zcGVjID0ge31cblx0KTogZXhlY0NtZFJlc3VsdCA9PlxuXG5cdHtjb2xsZWN0LCBub2xvZ30gOj0gZ2V0T3B0aW9ucyBoT3B0aW9ucywge1xuXHRcdGNvbGxlY3Q6IGZhbHNlXG5cdFx0bm9sb2c6IGZhbHNlXG5cdFx0fVxuXHRpZiBub2xvZ1xuXHRcdHB1c2hMb2dMZXZlbCAnc2lsZW50J1xuXHREQkcgXCJFWEVDOiAje09MKGdldENtZExpbmUoY21kTmFtZSwgbEFyZ3MpKX1cIlxuXHREQkcgSU5ERU5UXG5cdGhQcm9jT3B0IDo9IGdldFByb2NPcHQobEFyZ3MsIGNvbGxlY3QpXG5cdGNoaWxkIDo9IG5ldyBEZW5vLkNvbW1hbmQoY21kTmFtZSwgaFByb2NPcHQpXG5cdERCRyBVTkRFTlRcblx0aFJlc3VsdCA6PSBhd2FpdCBjaGlsZC5vdXRwdXQoKVxuXHRoRmluYWxSZXN1bHQgOj0gZ2V0RmluYWxSZXN1bHQoaFJlc3VsdCwgY29sbGVjdClcblx0aWYgbm9sb2dcblx0XHRwb3BMb2dMZXZlbCgpXG5cdHJldHVybiBoRmluYWxSZXN1bHRcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGV4ZWNDbWRTeW5jIDo9IChcblx0Y21kTmFtZTogc3RyaW5nLFxuXHRsQXJnczogc3RyaW5nW10gPSBbXSxcblx0aE9wdGlvbnM6IG9wdGlvbnNwZWMgPSB7fVxuXHQpOiBleGVjQ21kUmVzdWx0ID0+XG5cblx0e2NvbGxlY3QsIG5vbG9nfSA6PSBnZXRPcHRpb25zIGhPcHRpb25zLCB7XG5cdFx0Y29sbGVjdDogZmFsc2Vcblx0XHRub2xvZzogZmFsc2Vcblx0XHR9XG5cdGlmIG5vbG9nXG5cdFx0cHVzaExvZ0xldmVsICdzaWxlbnQnXG5cdERCRyBcIkVYRUMgU1lOQzogI3tPTChnZXRDbWRMaW5lKGNtZE5hbWUsIGxBcmdzKSl9XCJcblx0REJHIElOREVOVFxuXHRoUHJvY09wdCA6PSBnZXRQcm9jT3B0KGxBcmdzLCBjb2xsZWN0KVxuXHRjaGlsZCA6PSBuZXcgRGVuby5Db21tYW5kKGNtZE5hbWUsIGhQcm9jT3B0KVxuXHREQkcgVU5ERU5UXG5cdGhSZXN1bHQgOj0gY2hpbGQub3V0cHV0U3luYygpXG5cdGhGaW5hbFJlc3VsdCA6PSBnZXRGaW5hbFJlc3VsdChoUmVzdWx0LCBjb2xsZWN0KVxuXHRpZiBub2xvZ1xuXHRcdHBvcExvZ0xldmVsKClcblx0cmV0dXJuIGhGaW5hbFJlc3VsdFxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgY21kU3VjY2VlZHMgOj0gKFxuXHRjbWROYW1lOiBzdHJpbmcsXG5cdGxBcmdzOiBzdHJpbmdbXSA9IFtdLFxuXHRoT3B0aW9uczogb3B0aW9uc3BlYyA9IHt9XG5cdCk6IGJvb2xlYW4gPT5cblxuXHR7cXVpZXR9IDo9IGdldE9wdGlvbnMgaE9wdGlvbnMsIHtcblx0XHRxdWlldDogdHJ1ZVxuXHRcdH1cblx0dHJ5XG5cdFx0aCA6PSBxdWlldCA/IHtjb2xsZWN0OiB0cnVlLCBub2xvZzogdHJ1ZX0gOiB7fVxuXHRcdGV4ZWNDbWRTeW5jIGNtZE5hbWUsIGxBcmdzLCBoXG5cdFx0cmV0dXJuIHRydWVcblx0Y2F0Y2ggZXJyXG5cdFx0cmV0dXJuIGZhbHNlXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4iXX0=