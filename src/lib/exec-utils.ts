"use strict";
// exec-utils.civet

type AutoPromise<T> = Promise<Awaited<T>>;
import {compile} from 'npm:@danielx/civet'
import {stripAnsiCode} from "jsr:@std/fmt/colors"

import {
	undef, defined, notdefined,
	isString, isArray, isArrayOfStrings,
	hash, optionspec,
	} from './datatypes.ts'
import {
	getOptions, croak, assert, OL,
	} from './llutils.ts'
import {
	curLogLevel, pushLogLevel, popLogLevel,
	INDENT, UNDENT,
	DBG, LOG, WARN, ERR,
	} from './logger.ts'

const textDecoder = new TextDecoder()

// ---------------------------------------------------------------------------

/**
 * convert ArrayBuffer, Int8Array, etc. to a string
 */

export const mkstr = (item: any): string => {

	if (defined(item)) {
		if (isString(item)) {
			return stripAnsiCode(item)
		}
		else if (isArray(item)) {
			return stripAnsiCode(item.join(''))
		}
		else {
			return stripAnsiCode(textDecoder.decode(item))
		}
	}
	else {
		return ''
	}
}

// ---------------------------------------------------------------------------

/**
 * build a command line from a command name and array of arguments
 */

export const getCmdLine = (cmdName: string, lArgs: string[]): string => {

	assert(isString(cmdName), `cmdName not a string: ${OL(cmdName)}`)
	assert(isArrayOfStrings(lArgs), `not an array of strings: ${OL(lArgs)}`)
	const cmdLine = `${cmdName} ${lArgs.join(' ')}`
	DBG(`cmdLine = ${OL(cmdLine)}`)
	return cmdLine
}

// ---------------------------------------------------------------------------

/**
 * build result hash to be returned by execCmd() or execCmdSync()
 */

export type execCmdResult = {
	success: boolean
	code: number
	signal: (string | undefined)
	stdout: (string | undefined)
	stderr: (string | undefined)
	}

export const getFinalResult = (
	hResult: hash,
	collect: boolean
	): execCmdResult => {

	let ref;if (collect) {
		ref = ({
			success: hResult.success,
			code:    hResult.code,
			signal:  hResult.signal,
			stdout:  mkstr(hResult.stdout),
			stderr:  mkstr(hResult.stderr)
			})
	}
	else {
		ref = ({
			success: hResult.success,
			code:    hResult.code,
			signal:  hResult.signal,
			stdout:  undef,
			stderr:  undef
			})
	};const hRes =ref
	DBG(`hResult = ${OL(hRes)}`)
	return hRes
}

// ---------------------------------------------------------------------------

/**
 * get options to pass to Deno.Command constructor
 * 2nd argument determines whether stdout and stderr are
 * sent to parent process's stdout and stderr or are
 * collected to be returned to the caller
 */

export const getProcOpt = (
	lArgs: string[],
	collect: boolean
	): Deno.CommandOptions => {

	const hEnv: hash = {
		DEFAULT_LOGGER: curLogLevel()
		}

	return (collect?
		({
			args: lArgs,
			env: hEnv,
			stdout: 'piped',
			stderr: 'piped'
			})
	:
		({
			args: lArgs,
			env: hEnv,
			stdout: 'inherit',
			stderr: 'inherit'
			}))
}

// ---------------------------------------------------------------------------
// ASYNC

export const execCmd = async (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): AutoPromise<execCmdResult> => {

	const {collect, nolog} = getOptions(hOptions, {
		collect: false,
		nolog: false
		})
	if (nolog) {
		pushLogLevel('silent')
	}
	DBG(`EXEC: ${OL(getCmdLine(cmdName, lArgs))}`)
	DBG(INDENT)
	const hProcOpt = getProcOpt(lArgs, collect)
	const child = new Deno.Command(cmdName, hProcOpt)
	DBG(UNDENT)
	const hResult = await child.output()
	const hFinalResult = getFinalResult(hResult, collect)
	if (nolog) {
		popLogLevel()
	}
	return hFinalResult
}

// ---------------------------------------------------------------------------

export const execCmdSync = (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): execCmdResult => {

	const {collect, nolog} = getOptions(hOptions, {
		collect: false,
		nolog: false
		})
	if (nolog) {
		pushLogLevel('silent')
	}
	DBG(`EXEC SYNC: ${OL(getCmdLine(cmdName, lArgs))}`)
	DBG(INDENT)
	const hProcOpt = getProcOpt(lArgs, collect)
	const child = new Deno.Command(cmdName, hProcOpt)
	DBG(UNDENT)
	const hResult = child.outputSync()
	const hFinalResult = getFinalResult(hResult, collect)
	if (nolog) {
		popLogLevel()
	}
	return hFinalResult
}

// ---------------------------------------------------------------------------

export const cmdSucceeds = (
	cmdName: string,
	lArgs: string[] = [],
	hOptions: optionspec = {}
	): boolean => {

	const {quiet} = getOptions(hOptions, {
		quiet: true
		})
	try {
		const h = quiet ? {collect: true, nolog: true} : {}
		execCmdSync(cmdName, lArgs, h)
		return true
	}
	catch (err) {
		return false
	}
}

// ---------------------------------------------------------------------------

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9leGVjLXV0aWxzLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2xpYi9leGVjLXV0aWxzLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxLLFcseUI7QUFBQSxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CO0FBQzFDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMscUJBQXFCO0FBQ2pELEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUM1QixDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDO0FBQ3JDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0I7QUFDeEIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWM7QUFDdEIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDeEMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWE7QUFDckIsQUFBQTtBQUNBLEFBQUEsQUFBVyxNQUFYLFdBQVcsQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FB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QyxDQUFFLENBQUMsQ0FBQztBQUN2QixBQUFBLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2pCLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QixBQUFBLENBQUMsUUFBUSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDZCxBQUFBO0FBQ0EsQUFBQSxDQUFRLE1BQVAsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFFLENBQUMsVUFBVSxDQUFBLEFBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNsQyxBQUFBLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSTtBQUNiLEVBQUUsQ0FBQyxDQUFBO0FBQ0gsQUFBQSxDQUFDLEdBQUcsQ0FBQSxDQUFBO0FBQ0osQUFBQSxFQUFHLE1BQUQsQ0FBQyxDQUFDLENBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoRCxBQUFBLEVBQUUsV0FBVyxDQUFBLEFBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQy9CLEFBQUEsRUFBRSxNQUFNLENBQUMsSTtDQUFJLENBQUE7QUFDYixBQUFBLENBQUMsS0FBSyxDQUFDLENBQUEsR0FBRyxDQUFBLENBQUEsQ0FBQTtBQUNWLEFBQUEsRUFBRSxNQUFNLENBQUMsSztDQUFLLEM7QUFBQSxDQUFBO0FBQ2Q7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBleGVjLXV0aWxzLmNpdmV0XG5cbmltcG9ydCB7Y29tcGlsZX0gZnJvbSAnbnBtOkBkYW5pZWx4L2NpdmV0J1xuaW1wb3J0IHtzdHJpcEFuc2lDb2RlfSBmcm9tIFwianNyOkBzdGQvZm10L2NvbG9yc1wiXG5cbmltcG9ydCB7XG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLFxuXHRpc1N0cmluZywgaXNBcnJheSwgaXNBcnJheU9mU3RyaW5ncyxcblx0aGFzaCwgb3B0aW9uc3BlYyxcblx0fSBmcm9tICcuL2RhdGF0eXBlcy50cydcbmltcG9ydCB7XG5cdGdldE9wdGlvbnMsIGNyb2FrLCBhc3NlcnQsIE9MLFxuXHR9IGZyb20gJy4vbGx1dGlscy50cydcbmltcG9ydCB7XG5cdGN1ckxvZ0xldmVsLCBwdXNoTG9nTGV2ZWwsIHBvcExvZ0xldmVsLFxuXHRJTkRFTlQsIFVOREVOVCxcblx0REJHLCBMT0csIFdBUk4sIEVSUixcblx0fSBmcm9tICcuL2xvZ2dlci50cydcblxudGV4dERlY29kZXIgOj0gbmV3IFRleHREZWNvZGVyKClcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBjb252ZXJ0IEFycmF5QnVmZmVyLCBJbnQ4QXJyYXksIGV0Yy4gdG8gYSBzdHJpbmdcbiAqL1xuXG5leHBvcnQgbWtzdHIgOj0gKGl0ZW06IGFueSk6IHN0cmluZyA9PlxuXG5cdGlmIGRlZmluZWQoaXRlbSlcblx0XHRpZiBpc1N0cmluZyhpdGVtKVxuXHRcdFx0cmV0dXJuIHN0cmlwQW5zaUNvZGUoaXRlbSlcblx0XHRlbHNlIGlmIGlzQXJyYXkoaXRlbSlcblx0XHRcdHJldHVybiBzdHJpcEFuc2lDb2RlKGl0ZW0uam9pbignJykpXG5cdFx0ZWxzZVxuXHRcdFx0cmV0dXJuIHN0cmlwQW5zaUNvZGUodGV4dERlY29kZXIuZGVjb2RlKGl0ZW0pKVxuXHRlbHNlXG5cdFx0cmV0dXJuICcnXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogYnVpbGQgYSBjb21tYW5kIGxpbmUgZnJvbSBhIGNvbW1hbmQgbmFtZSBhbmQgYXJyYXkgb2YgYXJndW1lbnRzXG4gKi9cblxuZXhwb3J0IGdldENtZExpbmUgOj0gKGNtZE5hbWU6IHN0cmluZywgbEFyZ3M6IHN0cmluZ1tdKTogc3RyaW5nID0+XG5cblx0YXNzZXJ0IGlzU3RyaW5nKGNtZE5hbWUpLCBcImNtZE5hbWUgbm90IGEgc3RyaW5nOiAje09MKGNtZE5hbWUpfVwiXG5cdGFzc2VydCBpc0FycmF5T2ZTdHJpbmdzKGxBcmdzKSwgXCJub3QgYW4gYXJyYXkgb2Ygc3RyaW5nczogI3tPTChsQXJncyl9XCJcblx0Y21kTGluZSA6PSBcIiN7Y21kTmFtZX0gI3tsQXJncy5qb2luKCcgJyl9XCJcblx0REJHIFwiY21kTGluZSA9ICN7T0woY21kTGluZSl9XCJcblx0cmV0dXJuIGNtZExpbmVcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBidWlsZCByZXN1bHQgaGFzaCB0byBiZSByZXR1cm5lZCBieSBleGVjQ21kKCkgb3IgZXhlY0NtZFN5bmMoKVxuICovXG5cbmV4cG9ydCB0eXBlIGV4ZWNDbWRSZXN1bHQgPSB7XG5cdHN1Y2Nlc3M6IGJvb2xlYW5cblx0Y29kZTogbnVtYmVyXG5cdHNpZ25hbDogc3RyaW5nP1xuXHRzdGRvdXQ6IHN0cmluZz9cblx0c3RkZXJyOiBzdHJpbmc/XG5cdH1cblxuZXhwb3J0IGdldEZpbmFsUmVzdWx0IDo9IChcblx0aFJlc3VsdDogaGFzaCxcblx0Y29sbGVjdDogYm9vbGVhblxuXHQpOiBleGVjQ21kUmVzdWx0ID0+XG5cblx0aFJlcyA6PSBpZiBjb2xsZWN0XG5cdFx0e1xuXHRcdFx0c3VjY2VzczogaFJlc3VsdC5zdWNjZXNzXG5cdFx0XHRjb2RlOiAgICBoUmVzdWx0LmNvZGVcblx0XHRcdHNpZ25hbDogIGhSZXN1bHQuc2lnbmFsXG5cdFx0XHRzdGRvdXQ6ICBta3N0cihoUmVzdWx0LnN0ZG91dClcblx0XHRcdHN0ZGVycjogIG1rc3RyKGhSZXN1bHQuc3RkZXJyKVxuXHRcdFx0fVxuXHRlbHNlXG5cdFx0e1xuXHRcdFx0c3VjY2VzczogaFJlc3VsdC5zdWNjZXNzXG5cdFx0XHRjb2RlOiAgICBoUmVzdWx0LmNvZGVcblx0XHRcdHNpZ25hbDogIGhSZXN1bHQuc2lnbmFsXG5cdFx0XHRzdGRvdXQ6ICB1bmRlZlxuXHRcdFx0c3RkZXJyOiAgdW5kZWZcblx0XHRcdH1cblx0REJHIFwiaFJlc3VsdCA9ICN7T0woaFJlcyl9XCJcblx0cmV0dXJuIGhSZXNcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBnZXQgb3B0aW9ucyB0byBwYXNzIHRvIERlbm8uQ29tbWFuZCBjb25zdHJ1Y3RvclxuICogMm5kIGFyZ3VtZW50IGRldGVybWluZXMgd2hldGhlciBzdGRvdXQgYW5kIHN0ZGVyciBhcmVcbiAqIHNlbnQgdG8gcGFyZW50IHByb2Nlc3MncyBzdGRvdXQgYW5kIHN0ZGVyciBvciBhcmVcbiAqIGNvbGxlY3RlZCB0byBiZSByZXR1cm5lZCB0byB0aGUgY2FsbGVyXG4gKi9cblxuZXhwb3J0IGdldFByb2NPcHQgOj0gKFxuXHRsQXJnczogc3RyaW5nW10sXG5cdGNvbGxlY3Q6IGJvb2xlYW5cblx0KTogRGVuby5Db21tYW5kT3B0aW9ucyA9PlxuXG5cdGhFbnY6IGhhc2ggOj0ge1xuXHRcdERFRkFVTFRfTE9HR0VSOiBjdXJMb2dMZXZlbCgpXG5cdFx0fVxuXG5cdHJldHVybiBpZiBjb2xsZWN0XG5cdFx0e1xuXHRcdFx0YXJnczogbEFyZ3MsXG5cdFx0XHRlbnY6IGhFbnZcblx0XHRcdHN0ZG91dDogJ3BpcGVkJ1xuXHRcdFx0c3RkZXJyOiAncGlwZWQnXG5cdFx0XHR9XG5cdGVsc2Vcblx0XHR7XG5cdFx0XHRhcmdzOiBsQXJncyxcblx0XHRcdGVudjogaEVudlxuXHRcdFx0c3Rkb3V0OiAnaW5oZXJpdCdcblx0XHRcdHN0ZGVycjogJ2luaGVyaXQnXG5cdFx0XHR9XG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4jIEFTWU5DXG5cbmV4cG9ydCBleGVjQ21kIDo9IChcblx0Y21kTmFtZTogc3RyaW5nLFxuXHRsQXJnczogc3RyaW5nW10gPSBbXSxcblx0aE9wdGlvbnM6IG9wdGlvbnNwZWMgPSB7fVxuXHQpOiBleGVjQ21kUmVzdWx0ID0+XG5cblx0e2NvbGxlY3QsIG5vbG9nfSA6PSBnZXRPcHRpb25zIGhPcHRpb25zLCB7XG5cdFx0Y29sbGVjdDogZmFsc2Vcblx0XHRub2xvZzogZmFsc2Vcblx0XHR9XG5cdGlmIG5vbG9nXG5cdFx0cHVzaExvZ0xldmVsICdzaWxlbnQnXG5cdERCRyBcIkVYRUM6ICN7T0woZ2V0Q21kTGluZShjbWROYW1lLCBsQXJncykpfVwiXG5cdERCRyBJTkRFTlRcblx0aFByb2NPcHQgOj0gZ2V0UHJvY09wdChsQXJncywgY29sbGVjdClcblx0Y2hpbGQgOj0gbmV3IERlbm8uQ29tbWFuZChjbWROYW1lLCBoUHJvY09wdClcblx0REJHIFVOREVOVFxuXHRoUmVzdWx0IDo9IGF3YWl0IGNoaWxkLm91dHB1dCgpXG5cdGhGaW5hbFJlc3VsdCA6PSBnZXRGaW5hbFJlc3VsdChoUmVzdWx0LCBjb2xsZWN0KVxuXHRpZiBub2xvZ1xuXHRcdHBvcExvZ0xldmVsKClcblx0cmV0dXJuIGhGaW5hbFJlc3VsdFxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgZXhlY0NtZFN5bmMgOj0gKFxuXHRjbWROYW1lOiBzdHJpbmcsXG5cdGxBcmdzOiBzdHJpbmdbXSA9IFtdLFxuXHRoT3B0aW9uczogb3B0aW9uc3BlYyA9IHt9XG5cdCk6IGV4ZWNDbWRSZXN1bHQgPT5cblxuXHR7Y29sbGVjdCwgbm9sb2d9IDo9IGdldE9wdGlvbnMgaE9wdGlvbnMsIHtcblx0XHRjb2xsZWN0OiBmYWxzZVxuXHRcdG5vbG9nOiBmYWxzZVxuXHRcdH1cblx0aWYgbm9sb2dcblx0XHRwdXNoTG9nTGV2ZWwgJ3NpbGVudCdcblx0REJHIFwiRVhFQyBTWU5DOiAje09MKGdldENtZExpbmUoY21kTmFtZSwgbEFyZ3MpKX1cIlxuXHREQkcgSU5ERU5UXG5cdGhQcm9jT3B0IDo9IGdldFByb2NPcHQobEFyZ3MsIGNvbGxlY3QpXG5cdGNoaWxkIDo9IG5ldyBEZW5vLkNvbW1hbmQoY21kTmFtZSwgaFByb2NPcHQpXG5cdERCRyBVTkRFTlRcblx0aFJlc3VsdCA6PSBjaGlsZC5vdXRwdXRTeW5jKClcblx0aEZpbmFsUmVzdWx0IDo9IGdldEZpbmFsUmVzdWx0KGhSZXN1bHQsIGNvbGxlY3QpXG5cdGlmIG5vbG9nXG5cdFx0cG9wTG9nTGV2ZWwoKVxuXHRyZXR1cm4gaEZpbmFsUmVzdWx0XG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBjbWRTdWNjZWVkcyA6PSAoXG5cdGNtZE5hbWU6IHN0cmluZyxcblx0bEFyZ3M6IHN0cmluZ1tdID0gW10sXG5cdGhPcHRpb25zOiBvcHRpb25zcGVjID0ge31cblx0KTogYm9vbGVhbiA9PlxuXG5cdHtxdWlldH0gOj0gZ2V0T3B0aW9ucyBoT3B0aW9ucywge1xuXHRcdHF1aWV0OiB0cnVlXG5cdFx0fVxuXHR0cnlcblx0XHRoIDo9IHF1aWV0ID8ge2NvbGxlY3Q6IHRydWUsIG5vbG9nOiB0cnVlfSA6IHt9XG5cdFx0ZXhlY0NtZFN5bmMgY21kTmFtZSwgbEFyZ3MsIGhcblx0XHRyZXR1cm4gdHJ1ZVxuXHRjYXRjaCBlcnJcblx0XHRyZXR1cm4gZmFsc2VcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiJdfQ==