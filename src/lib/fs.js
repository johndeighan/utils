// fs.civet

import pathLib from 'path'
import urlLib from 'url'
import fs from 'fs'

import {
	undef, defined, notdefined, OL, getOptions,
	assert, croak, words,
	isString, isNonEmptyString, isArrayOfStrings,
	isFile, isDir, normalizePath, mkpath, relpath,
	fileExt, withExt, globFiles, allLinesIn, newerDestFileExists,
	pathSubDirs, mkDirsForFile, slurp, barf,
	pathType, getFileStats, parsePath,
	} from '@jdeighan/utils/llutils.js'

export {
	isFile, isDir, normalizePath, mkpath, relpath,
	fileExt, withExt, globFiles, allLinesIn, newerDestFileExists,
	pathSubDirs, mkDirsForFile, slurp, barf,
	pathType, getFileStats, parsePath,
	}

export const lStatFields = words(
	'dev ino mode nlink uid gid rdev size blksize blocks',
	'atimeMs mtimeMs ctimeMs birthtimeMs',
	'atime mtime ctime birthtime',
	)

// ---------------------------------------------------------------------------

export const mkDir = (dirPath, hOptions={}) => {

	const {clear} = getOptions(hOptions, {
		clear: false
		})

	try {
		fs.mkdirSync(dirPath)
		return true
	}
	catch (err) {
		if (err.code === 'EEXIST') {
			if (!clear) {
				return false
			}
			try {
				clearDir(dirPath)
				return true
			}
			catch (err) {
				return false
			}
		}
		else {
			throw err
		}
	}
}

// ---------------------------------------------------------------------------

export const clearDir = (dirPath) => {

	const hOptions = {
		withFileTypes: true,
		recursive: true
		}
	for (const ent in fs.readdirSync(dirPath, hOptions)) {
		if (ent.isFile()) {
			fs.rmSync(mkpath(ent.path, ent.name))
		}
		else if (ent.isDirectory()) {
			clearDir(mkpath(ent.path, ent.name))
		}
	}
	return
}

// ---------------------------------------------------------------------------

export const needDestFile = (srcPath, destPath) => {

	return !newerDestFileExists(srcPath, destPath)
}

// ---------------------------------------------------------------------------
// --- Should be called like: myself(import.meta.url)
//     returns full path of current file

export const myself = (url) => {

	return normalizePath(urlLib.fileURLToPath(url))
}

// ---------------------------------------------------------------------------

export const allFilesMatching = function*(pattern='*', hOptions={}) {
	// --- yields hFile with keys:
	//        path, filePath,
	//        type, root, dir, base, fileName,
	//        name, stub, ext, purpose
	//        (if eager) hMetaData, lLines
	// --- Valid options:
	//        hGlobOptions - options to pass to globFiles
	//        fileFilter - return path iff fileFilter(filePath) returns true
	//        eager - read the file and add keys hMetaData, lLines
	// --- Valid glob options:
	//        ignore - glob pattern for files to ignore
	//        dot - include dot files/directories (default: false)
	//        cwd - change working directory

	const {fileFilter} = getOptions(hOptions, {
		fileFilter: (h) => { return true }
		})

	for (const h of globFiles(pattern)) {
		const path = h.path
		const hResult = parsePath(path)
		if (fileFilter(hResult)) {
			yield hResult
		}
	}
	return
}

// ---------------------------------------------------------------------------
// --- fileFilter, if defined, gets (filePath)

export const deleteFilesMatching = (pattern, hOptions={}) => {

	assert((pattern !== '*'), "Can't delete files matching '*'")
	for (const {relPath} of allFilesMatching(pattern, hOptions)) {
		fs.rmSync(relPath)
	}
	return
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9mcy5jaXZldC50c3giLCJzb3VyY2VzIjpbInNyYy9saWIvZnMuY2l2ZXQiXSwibWFwcGluZ3MiOiJBQUFBLFdBQVU7QUFDVixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNO0FBQzFCLEFBQUEsQUFBQSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLO0FBQ3hCLEFBQUEsQUFBQSxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJO0FBQ25CLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUM1QyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUN0QixDQUFDLFFBQVEsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsZ0JBQWdCLENBQUM7QUFDOUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDL0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQztBQUM5RCxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQztBQUN6QyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNuQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsNEJBQTRCO0FBQ3BDLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0s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TTtBQUFNLENBQUE7QUFDUCxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQSw4Q0FBNkM7QUFDN0MsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQW9CLE1BQW5CLG1CQUFtQixDQUFDLENBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ3ZELEFBQUE7QUFDQSxBQUFBLENBQUMsTUFBTSxDQUFBLEFBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsaUNBQWlDLENBQUE7QUFDM0QsQUFBQSxDQUFDLEdBQUcsQ0FBQyxDQUFBLE1BQUEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQ3JELEFBQUEsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFBLEFBQUMsT0FBTyxDO0NBQUEsQ0FBQTtBQUNuQixBQUFBLENBQUMsTTtBQUFNLENBQUE7QUFDUCIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBmcy5jaXZldFxuXG5pbXBvcnQgcGF0aExpYiBmcm9tICdwYXRoJ1xuaW1wb3J0IHVybExpYiBmcm9tICd1cmwnXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5cbmltcG9ydCB7XG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLCBPTCwgZ2V0T3B0aW9ucyxcblx0YXNzZXJ0LCBjcm9haywgd29yZHMsXG5cdGlzU3RyaW5nLCBpc05vbkVtcHR5U3RyaW5nLCBpc0FycmF5T2ZTdHJpbmdzLFxuXHRpc0ZpbGUsIGlzRGlyLCBub3JtYWxpemVQYXRoLCBta3BhdGgsIHJlbHBhdGgsXG5cdGZpbGVFeHQsIHdpdGhFeHQsIGdsb2JGaWxlcywgYWxsTGluZXNJbiwgbmV3ZXJEZXN0RmlsZUV4aXN0cyxcblx0cGF0aFN1YkRpcnMsIG1rRGlyc0ZvckZpbGUsIHNsdXJwLCBiYXJmLFxuXHRwYXRoVHlwZSwgZ2V0RmlsZVN0YXRzLCBwYXJzZVBhdGgsXG5cdH0gZnJvbSAnQGpkZWlnaGFuL3V0aWxzL2xsdXRpbHMuanMnXG5cbmV4cG9ydCB7XG5cdGlzRmlsZSwgaXNEaXIsIG5vcm1hbGl6ZVBhdGgsIG1rcGF0aCwgcmVscGF0aCxcblx0ZmlsZUV4dCwgd2l0aEV4dCwgZ2xvYkZpbGVzLCBhbGxMaW5lc0luLCBuZXdlckRlc3RGaWxlRXhpc3RzLFxuXHRwYXRoU3ViRGlycywgbWtEaXJzRm9yRmlsZSwgc2x1cnAsIGJhcmYsXG5cdHBhdGhUeXBlLCBnZXRGaWxlU3RhdHMsIHBhcnNlUGF0aCxcblx0fVxuXG5leHBvcnQgbFN0YXRGaWVsZHMgOj0gd29yZHMoXG5cdCdkZXYgaW5vIG1vZGUgbmxpbmsgdWlkIGdpZCByZGV2IHNpemUgYmxrc2l6ZSBibG9ja3MnLFxuXHQnYXRpbWVNcyBtdGltZU1zIGN0aW1lTXMgYmlydGh0aW1lTXMnLFxuXHQnYXRpbWUgbXRpbWUgY3RpbWUgYmlydGh0aW1lJyxcblx0KVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgbWtEaXIgOj0gKGRpclBhdGgsIGhPcHRpb25zPXt9KSA9PlxuXG5cdHtjbGVhcn0gOj0gZ2V0T3B0aW9ucyBoT3B0aW9ucywge1xuXHRcdGNsZWFyOiBmYWxzZVxuXHRcdH1cblxuXHR0cnlcblx0XHRmcy5ta2RpclN5bmMgZGlyUGF0aFxuXHRcdHJldHVybiB0cnVlXG5cdGNhdGNoIGVyclxuXHRcdGlmIChlcnIuY29kZSA9PSAnRUVYSVNUJylcblx0XHRcdGlmIG5vdCBjbGVhclxuXHRcdFx0XHRyZXR1cm4gZmFsc2Vcblx0XHRcdHRyeVxuXHRcdFx0XHRjbGVhckRpciBkaXJQYXRoXG5cdFx0XHRcdHJldHVybiB0cnVlXG5cdFx0XHRjYXRjaCBlcnJcblx0XHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0ZWxzZVxuXHRcdFx0dGhyb3cgZXJyXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBjbGVhckRpciA6PSAoZGlyUGF0aCkgPT5cblxuXHRoT3B0aW9ucyA6PSB7XG5cdFx0d2l0aEZpbGVUeXBlczogdHJ1ZVxuXHRcdHJlY3Vyc2l2ZTogdHJ1ZVxuXHRcdH1cblx0Zm9yIGVudCBpbiBmcy5yZWFkZGlyU3luYyhkaXJQYXRoLCBoT3B0aW9ucylcblx0XHRpZiBlbnQuaXNGaWxlKClcblx0XHRcdGZzLnJtU3luYyBta3BhdGgoZW50LnBhdGgsIGVudC5uYW1lKVxuXHRcdGVsc2UgaWYgZW50LmlzRGlyZWN0b3J5KClcblx0XHRcdGNsZWFyRGlyIG1rcGF0aChlbnQucGF0aCwgZW50Lm5hbWUpXG5cdHJldHVyblxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgbmVlZERlc3RGaWxlIDo9IChzcmNQYXRoLCBkZXN0UGF0aCkgPT5cblxuXHRyZXR1cm4gbm90IG5ld2VyRGVzdEZpbGVFeGlzdHMoc3JjUGF0aCwgZGVzdFBhdGgpXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4jIC0tLSBTaG91bGQgYmUgY2FsbGVkIGxpa2U6IG15c2VsZihpbXBvcnQubWV0YS51cmwpXG4jICAgICByZXR1cm5zIGZ1bGwgcGF0aCBvZiBjdXJyZW50IGZpbGVcblxuZXhwb3J0IG15c2VsZiA6PSAodXJsKSA9PlxuXG5cdHJldHVybiBub3JtYWxpemVQYXRoIHVybExpYi5maWxlVVJMVG9QYXRoKHVybClcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGFsbEZpbGVzTWF0Y2hpbmcgOj0gKHBhdHRlcm49JyonLCBoT3B0aW9ucz17fSkgLT5cblx0IyAtLS0geWllbGRzIGhGaWxlIHdpdGgga2V5czpcblx0IyAgICAgICAgcGF0aCwgZmlsZVBhdGgsXG5cdCMgICAgICAgIHR5cGUsIHJvb3QsIGRpciwgYmFzZSwgZmlsZU5hbWUsXG5cdCMgICAgICAgIG5hbWUsIHN0dWIsIGV4dCwgcHVycG9zZVxuXHQjICAgICAgICAoaWYgZWFnZXIpIGhNZXRhRGF0YSwgbExpbmVzXG5cdCMgLS0tIFZhbGlkIG9wdGlvbnM6XG5cdCMgICAgICAgIGhHbG9iT3B0aW9ucyAtIG9wdGlvbnMgdG8gcGFzcyB0byBnbG9iRmlsZXNcblx0IyAgICAgICAgZmlsZUZpbHRlciAtIHJldHVybiBwYXRoIGlmZiBmaWxlRmlsdGVyKGZpbGVQYXRoKSByZXR1cm5zIHRydWVcblx0IyAgICAgICAgZWFnZXIgLSByZWFkIHRoZSBmaWxlIGFuZCBhZGQga2V5cyBoTWV0YURhdGEsIGxMaW5lc1xuXHQjIC0tLSBWYWxpZCBnbG9iIG9wdGlvbnM6XG5cdCMgICAgICAgIGlnbm9yZSAtIGdsb2IgcGF0dGVybiBmb3IgZmlsZXMgdG8gaWdub3JlXG5cdCMgICAgICAgIGRvdCAtIGluY2x1ZGUgZG90IGZpbGVzL2RpcmVjdG9yaWVzIChkZWZhdWx0OiBmYWxzZSlcblx0IyAgICAgICAgY3dkIC0gY2hhbmdlIHdvcmtpbmcgZGlyZWN0b3J5XG5cblx0e2ZpbGVGaWx0ZXJ9IDo9IGdldE9wdGlvbnMgaE9wdGlvbnMsIHtcblx0XHRmaWxlRmlsdGVyOiAoaCkgPT4gcmV0dXJuIHRydWVcblx0XHR9XG5cblx0Zm9yIGggb2YgZ2xvYkZpbGVzKHBhdHRlcm4pXG5cdFx0cGF0aCA6PSBoLnBhdGhcblx0XHRoUmVzdWx0IDo9IHBhcnNlUGF0aChwYXRoKVxuXHRcdGlmIGZpbGVGaWx0ZXIoaFJlc3VsdClcblx0XHRcdHlpZWxkIGhSZXN1bHRcblx0cmV0dXJuXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4jIC0tLSBmaWxlRmlsdGVyLCBpZiBkZWZpbmVkLCBnZXRzIChmaWxlUGF0aClcblxuZXhwb3J0IGRlbGV0ZUZpbGVzTWF0Y2hpbmcgOj0gKHBhdHRlcm4sIGhPcHRpb25zPXt9KSA9PlxuXG5cdGFzc2VydCAocGF0dGVybiAhPSAnKicpLCBcIkNhbid0IGRlbGV0ZSBmaWxlcyBtYXRjaGluZyAnKidcIlxuXHRmb3Ige3JlbFBhdGh9IG9mIGFsbEZpbGVzTWF0Y2hpbmcocGF0dGVybiwgaE9wdGlvbnMpXG5cdFx0ZnMucm1TeW5jIHJlbFBhdGhcblx0cmV0dXJuXG4iXX0=