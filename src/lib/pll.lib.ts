"use strict";
// pll.lib.civet

import {
	undef, defined, notdefined, hash, isEmpty, nonEmpty,
	} from 'datatypes'
import {
	getOptions, allLinesInBlock, escapeStr,
	} from 'llutils'
import {DBG, DBGVALUE} from 'logger'
import {
	oneIndent, indentLevel, splitLine,
	} from 'indent'
import {TextTable} from 'text-table'
import {slurp} from 'fsys'

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
// --- Common token types:
//        'line', 'empty', 'indent', 'undent', 'eof'

export type TPLLToken = {
	kind: string
	str?: string
	name?: string
	value?: unknown
	}

export const tkIndent = {kind: 'indent'}
export const tkUndent = {kind: 'undent'}
export const tkEOF    = {kind: 'eof'}

export const isKind = (tk: TPLLToken, kindStr: string) => {
	return (tk.kind === kindStr)
}

export const tokenWith = (tk: TPLLToken, s: string) => {
	return {...tk, str: s}
}

// ---------------------------------------------------------------------------

export type TTokenGenerator = (
		line: string
		) => Generator<TPLLToken, void, void>

const identTokenGen: TTokenGenerator = function*(line: string) {
	yield {kind: 'line', str: line}
	return
}

// ---------------------------------------------------------------------------

export const allTokensIn = function*(
		iterable: Iterable<string>,
		gen: TTokenGenerator = identTokenGen,
		hOptions: hash={}
		): Generator<TPLLToken, void, void> {

	type opt = {
		lTypes: string[]
		}
	const {lTypes} = getOptions<opt>(hOptions, {
		lTypes: ['indent','undent','empty']
		})
	let level = 0
	for (const str of iterable) {
		DBG(`LINE: '${escapeStr(str)}'`)
		if (isEmpty(str)) {
			if (lTypes.includes('empty')) {
				yield {kind: 'empty'}
			}
		}
		else {
			// --- NOTE: If indent > 0, oneIndent will be set
			const [indent, line] = splitLine(str)
			if (lTypes.includes('indent') && (indent > level)) {
				level += 1
				yield tkIndent
				while (indent > level) {
					level += 1
					yield tkIndent
				}
			}
			if (lTypes.includes('undent') && (indent < level)) {
				level -= 1
				yield tkUndent
				while (indent < level) {
					level -= 1
					yield tkUndent
				}
			}
			for (const tok of gen(line)) {
				yield tok
			}
		}
	}
	if (lTypes.includes('undent')) {
		while (level > 0) {
			yield tkUndent
			level -= 1
		}
	}
	return
}

// ---------------------------------------------------------------------------

export const allTokensInBlock = function*(
		block: string,
		gen: TTokenGenerator = identTokenGen
		): Generator<TPLLToken, void, void> {

	for (const tok of allTokensIn(allLinesInBlock(block), gen)) {
		yield tok
	}
	return
}

// ---------------------------------------------------------------------------

export const allTokensInFile = function*(
		path: string
		): Generator<TPLLToken, void, void> {

	for (const tok of allTokensInBlock(slurp(path))) {
		yield tok
	}
	return
}

// ---------------------------------------------------------------------------

export const tokenTable = (
		lTokens: Iterable<TPLLToken>,
		title='Tokens'
		): string => {

	const table = new TextTable('l l')
	table.fullsep('=')
	table.title(title)
	table.fullsep('=')
	table.labels(['kind', 'str'])
	table.sep()
	for (const tok of lTokens) {
		table.data([tok.kind, tok.str])
	}
	table.fullsep('=')
	return table.asString()
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwbGwubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwbGwubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsZ0JBQWU7QUFDZixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQ3JELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXO0FBQ25CLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsVUFBVSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDO0FBQ3hDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQ2pCLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNwQyxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNuQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNoQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVk7QUFDcEMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNO0FBQzFCLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBLDBCQUF5QjtBQUN6QixBQUFBLG9EQUFtRDtBQUNuRCxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENB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QztBQUNkLEFBQUEsSUFBSSxLQUFLLENBQUMsUUFBUTtBQUNsQixBQUFBLElBQUksS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQSxDQUFBO0FBQzFCLEFBQUEsS0FBSyxLQUFLLEMsRUFBRyxDQUFDLENBQUM7QUFDZixBQUFBLEtBQUssS0FBSyxDQUFDLFE7SUFBUSxDO0dBQUEsQ0FBQTtBQUNuQixBQUFBLEdBQUcsR0FBRyxDQUFBLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDbkQsQUFBQSxJQUFJLEtBQUssQyxFQUFHLENBQUMsQ0FBQztBQUNkLEFBQUEsSUFBSSxLQUFLLENBQUMsUUFBUTtBQUNsQixBQUFBLElBQUksS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQSxDQUFBO0FBQzFCLEFBQUEsS0FBSyxLQUFLLEMsRUFBRyxDQUFDLENBQUM7QUFDZixBQUFBLEtBQUssS0FBSyxDQUFDLFE7SUFBUSxDO0dBQUEsQ0FBQTtBQUNuQixBQUFBLEdBQUcsR0FBRyxDQUFDLENBQUEsTUFBQSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDdkIsQUFBQSxJQUFJLEtBQUssQ0FBQyxHO0dBQUcsQztFQUFBLEM7Q0FBQSxDQUFBO0FBQ2IsQUFBQSxDQUFDLEdBQUcsQ0FBQSxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUM3QixBQUFBLEVBQUUsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQ25CLEFBQUEsR0FBRyxLQUFLLENBQUMsUUFBUTtBQUNqQixBQUFBLEdBQUcsS0FBSyxDLEVBQUcsQ0FBQyxDO0VBQUMsQztDQUFBLENBQUE7QUFDYixB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c291cmNlc0NvbnRlbnQiOlsiIyBwbGwubGliLmNpdmV0XHJcblxyXG5pbXBvcnQge1xyXG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLCBoYXNoLCBpc0VtcHR5LCBub25FbXB0eSxcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtcclxuXHRnZXRPcHRpb25zLCBhbGxMaW5lc0luQmxvY2ssIGVzY2FwZVN0cixcclxuXHR9IGZyb20gJ2xsdXRpbHMnXHJcbmltcG9ydCB7REJHLCBEQkdWQUxVRX0gZnJvbSAnbG9nZ2VyJ1xyXG5pbXBvcnQge1xyXG5cdG9uZUluZGVudCwgaW5kZW50TGV2ZWwsIHNwbGl0TGluZSxcclxuXHR9IGZyb20gJ2luZGVudCdcclxuaW1wb3J0IHtUZXh0VGFibGV9IGZyb20gJ3RleHQtdGFibGUnXHJcbmltcG9ydCB7c2x1cnB9IGZyb20gJ2ZzeXMnXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4jIC0tLSBDb21tb24gdG9rZW4gdHlwZXM6XHJcbiMgICAgICAgICdsaW5lJywgJ2VtcHR5JywgJ2luZGVudCcsICd1bmRlbnQnLCAnZW9mJ1xyXG5cclxuZXhwb3J0IHR5cGUgVFBMTFRva2VuID0ge1xyXG5cdGtpbmQ6IHN0cmluZ1xyXG5cdHN0cj86IHN0cmluZ1xyXG5cdG5hbWU/OiBzdHJpbmdcclxuXHR2YWx1ZT86IHVua25vd25cclxuXHR9XHJcblxyXG5leHBvcnQgdGtJbmRlbnQgOj0ge2tpbmQ6ICdpbmRlbnQnfVxyXG5leHBvcnQgdGtVbmRlbnQgOj0ge2tpbmQ6ICd1bmRlbnQnfVxyXG5leHBvcnQgdGtFT0YgICAgOj0ge2tpbmQ6ICdlb2YnfVxyXG5cclxuZXhwb3J0IGlzS2luZCA6PSAodGs6IFRQTExUb2tlbiwga2luZFN0cjogc3RyaW5nKSA9PlxyXG5cdHJldHVybiAodGsua2luZCA9PSBraW5kU3RyKVxyXG5cclxuZXhwb3J0IHRva2VuV2l0aCA6PSAodGs6IFRQTExUb2tlbiwgczogc3RyaW5nKSA9PlxyXG5cdHJldHVybiB7Li4udGssIHN0cjogc31cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgdHlwZSBUVG9rZW5HZW5lcmF0b3IgPSAoXHJcblx0XHRsaW5lOiBzdHJpbmdcclxuXHRcdCkgPT4gR2VuZXJhdG9yPFRQTExUb2tlbiwgdm9pZCwgdm9pZD5cclxuXHJcbmlkZW50VG9rZW5HZW46IFRUb2tlbkdlbmVyYXRvciA6PSAobGluZTogc3RyaW5nKSAtPlxyXG5cdHlpZWxkIHtraW5kOiAnbGluZScsIHN0cjogbGluZX1cclxuXHRyZXR1cm5cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgYWxsVG9rZW5zSW4gOj0gKFxyXG5cdFx0aXRlcmFibGU6IEl0ZXJhYmxlPHN0cmluZz4sXHJcblx0XHRnZW46IFRUb2tlbkdlbmVyYXRvciA9IGlkZW50VG9rZW5HZW5cclxuXHRcdGhPcHRpb25zOiBoYXNoPXt9XHJcblx0XHQpOiBHZW5lcmF0b3I8VFBMTFRva2VuLCB2b2lkLCB2b2lkPiAtPlxyXG5cclxuXHR0eXBlIG9wdCA9IHtcclxuXHRcdGxUeXBlczogc3RyaW5nW11cclxuXHRcdH1cclxuXHR7bFR5cGVzfSA6PSBnZXRPcHRpb25zPG9wdD4gaE9wdGlvbnMsIHtcclxuXHRcdGxUeXBlczogWydpbmRlbnQnLCd1bmRlbnQnLCdlbXB0eSddXHJcblx0XHR9XHJcblx0bGV0IGxldmVsID0gMFxyXG5cdGZvciBzdHIgb2YgaXRlcmFibGVcclxuXHRcdERCRyBcIkxJTkU6ICcje2VzY2FwZVN0cihzdHIpfSdcIlxyXG5cdFx0aWYgaXNFbXB0eShzdHIpXHJcblx0XHRcdGlmIGxUeXBlcy5pbmNsdWRlcygnZW1wdHknKVxyXG5cdFx0XHRcdHlpZWxkIHtraW5kOiAnZW1wdHknfVxyXG5cdFx0ZWxzZVxyXG5cdFx0XHQjIC0tLSBOT1RFOiBJZiBpbmRlbnQgPiAwLCBvbmVJbmRlbnQgd2lsbCBiZSBzZXRcclxuXHRcdFx0W2luZGVudCwgbGluZV0gOj0gc3BsaXRMaW5lKHN0cilcclxuXHRcdFx0aWYgbFR5cGVzLmluY2x1ZGVzKCdpbmRlbnQnKSAmJiAoaW5kZW50ID4gbGV2ZWwpXHJcblx0XHRcdFx0bGV2ZWwgKz0gMVxyXG5cdFx0XHRcdHlpZWxkIHRrSW5kZW50XHJcblx0XHRcdFx0d2hpbGUgKGluZGVudCA+IGxldmVsKVxyXG5cdFx0XHRcdFx0bGV2ZWwgKz0gMVxyXG5cdFx0XHRcdFx0eWllbGQgdGtJbmRlbnRcclxuXHRcdFx0aWYgbFR5cGVzLmluY2x1ZGVzKCd1bmRlbnQnKSAmJiAoaW5kZW50IDwgbGV2ZWwpXHJcblx0XHRcdFx0bGV2ZWwgLT0gMVxyXG5cdFx0XHRcdHlpZWxkIHRrVW5kZW50XHJcblx0XHRcdFx0d2hpbGUgKGluZGVudCA8IGxldmVsKVxyXG5cdFx0XHRcdFx0bGV2ZWwgLT0gMVxyXG5cdFx0XHRcdFx0eWllbGQgdGtVbmRlbnRcclxuXHRcdFx0Zm9yIHRvayBvZiBnZW4obGluZSlcclxuXHRcdFx0XHR5aWVsZCB0b2tcclxuXHRpZiBsVHlwZXMuaW5jbHVkZXMoJ3VuZGVudCcpXHJcblx0XHR3aGlsZSAobGV2ZWwgPiAwKVxyXG5cdFx0XHR5aWVsZCB0a1VuZGVudFxyXG5cdFx0XHRsZXZlbCAtPSAxXHJcblx0cmV0dXJuXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuZXhwb3J0IGFsbFRva2Vuc0luQmxvY2sgOj0gKFxyXG5cdFx0YmxvY2s6IHN0cmluZ1xyXG5cdFx0Z2VuOiBUVG9rZW5HZW5lcmF0b3IgPSBpZGVudFRva2VuR2VuXHJcblx0XHQpOiBHZW5lcmF0b3I8VFBMTFRva2VuLCB2b2lkLCB2b2lkPiAtPlxyXG5cclxuXHRmb3IgdG9rIG9mIGFsbFRva2Vuc0luKGFsbExpbmVzSW5CbG9jayhibG9jayksIGdlbilcclxuXHRcdHlpZWxkIHRva1xyXG5cdHJldHVyblxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCBhbGxUb2tlbnNJbkZpbGUgOj0gKFxyXG5cdFx0cGF0aDogc3RyaW5nXHJcblx0XHQpOiBHZW5lcmF0b3I8VFBMTFRva2VuLCB2b2lkLCB2b2lkPiAtPlxyXG5cclxuXHRmb3IgdG9rIG9mIGFsbFRva2Vuc0luQmxvY2soc2x1cnAocGF0aCkpXHJcblx0XHR5aWVsZCB0b2tcclxuXHRyZXR1cm5cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgdG9rZW5UYWJsZSA6PSAoXHJcblx0XHRsVG9rZW5zOiBJdGVyYWJsZTxUUExMVG9rZW4+XHJcblx0XHR0aXRsZT0nVG9rZW5zJ1xyXG5cdFx0KTogc3RyaW5nID0+XHJcblxyXG5cdHRhYmxlIDo9IG5ldyBUZXh0VGFibGUgJ2wgbCdcclxuXHR0YWJsZS5mdWxsc2VwICc9J1xyXG5cdHRhYmxlLnRpdGxlIHRpdGxlXHJcblx0dGFibGUuZnVsbHNlcCAnPSdcclxuXHR0YWJsZS5sYWJlbHMgWydraW5kJywgJ3N0ciddXHJcblx0dGFibGUuc2VwKClcclxuXHRmb3IgdG9rIG9mIGxUb2tlbnNcclxuXHRcdHRhYmxlLmRhdGEgW3Rvay5raW5kLCB0b2suc3RyXVxyXG5cdHRhYmxlLmZ1bGxzZXAgJz0nXHJcblx0cmV0dXJuIHRhYmxlLmFzU3RyaW5nKClcclxuIl19