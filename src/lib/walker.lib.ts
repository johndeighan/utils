"use strict";
// walker.lib.civet

import {
	undef, defined, notdefined, integer,
	isArray, isObject, isPrimitive,
	} from 'datatypes'
import {OL} from 'llutils'
import {DBG} from 'logger'

// ---------------------------------------------------------------------------

type TIndex = string | number

export type TNodeInfo<T> = {
	node: T
	level: integer
	parent: (T | undefined)
	index?: TIndex
	}

// ---------------------------------------------------------------------------

export class Walker<T extends object = object> {

	// --- Keep track of nodes visited to avoid infinite loops
	setVisited: WeakSet<T> = new WeakSet<T>()

	// --- If className is provided, only objects with that
	//     constuctor name will be returned

	className: (string | undefined)

	// ..........................................................

	constructor(className1: (string | undefined) = undef){this.className = className1;}

	// ..........................................................

	isNode(x: object): x is T {

		return (
			isObject(x)  // not undef, null, regex, array
				&& (
						!this.className
					|| (x?.constructor?.name === this.className)
					)
			)
	}

	// ..........................................................

	useNode(x: object): boolean {

		return this.isNode(x)
	}

	// ..........................................................

	filter(h: TNodeInfo<T>): boolean {

		// --- filter() is only called if isNode(h.node) is true
		return true
	}

	// ..........................................................

	*walk(
			item: unknown,
			parent: (T | undefined) = undef,
			level: number = 0,
			index: ((string | number) | undefined) = undef
			): Generator<TNodeInfo<T>, void, void> {

		if (isObject(item) && this.useNode(item)) {
			DBG(`NODE: ${OL(item)}`)
			yield {
				node: item as T,
				parent,
				level,
				index
				}
		}

		if (isArray(item)) {
			DBG("ARRAY")
			let i1 = 0;for (const x of item) {const i = i1++;
				yield* this.walk(x, parent, level+1, i)
			}
		}
		else if (isObject(item)) {
			DBG("OBJECT")
			for (const [key, x] of Object.entries(item)) {
				yield* this.walk(x, (this.isNode(item) ? item : parent), level+1, key)
			}
		}
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDckMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDaEMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQzFCLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUMxQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU07QUFDN0IsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1QixBQUFBLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNSLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPO0FBQ2YsQUFBQSxDQUFDLE1BQU0sQyxDLENBQUMsQUFBQyxDLFksQ0FBRTtBQUNYLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU07QUFDZixDQUFDLENBQUM7QUFDRixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFN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LENBQUMsSSxDQUFDLElBQUksQ0FBQSxBQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEM7R0FBQSxDO0VBQUEsQztDQUFBLEM7QUFBQSxDQUFBO0FBQ2pFIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIHdhbGtlci5saWIuY2l2ZXRcclxuXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGludGVnZXIsXHJcblx0aXNBcnJheSwgaXNPYmplY3QsIGlzUHJpbWl0aXZlLFxyXG5cdH0gZnJvbSAnZGF0YXR5cGVzJ1xyXG5pbXBvcnQge09MfSBmcm9tICdsbHV0aWxzJ1xyXG5pbXBvcnQge0RCR30gZnJvbSAnbG9nZ2VyJ1xyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbnR5cGUgVEluZGV4ID0gc3RyaW5nIHwgbnVtYmVyXHJcblxyXG5leHBvcnQgdHlwZSBUTm9kZUluZm88VD4gPSB7XHJcblx0bm9kZTogVFxyXG5cdGxldmVsOiBpbnRlZ2VyXHJcblx0cGFyZW50OiBUP1xyXG5cdGluZGV4PzogVEluZGV4XHJcblx0fVxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCBjbGFzcyBXYWxrZXI8VCBleHRlbmRzIG9iamVjdCA9IG9iamVjdD5cclxuXHJcblx0IyAtLS0gS2VlcCB0cmFjayBvZiBub2RlcyB2aXNpdGVkIHRvIGF2b2lkIGluZmluaXRlIGxvb3BzXHJcblx0c2V0VmlzaXRlZDogV2Vha1NldDxUPiA9IG5ldyBXZWFrU2V0PFQ+KClcclxuXHJcblx0IyAtLS0gSWYgY2xhc3NOYW1lIGlzIHByb3ZpZGVkLCBvbmx5IG9iamVjdHMgd2l0aCB0aGF0XHJcblx0IyAgICAgY29uc3R1Y3RvciBuYW1lIHdpbGwgYmUgcmV0dXJuZWRcclxuXHJcblx0Y2xhc3NOYW1lOiBzdHJpbmc/XHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cclxuXHRjb25zdHJ1Y3RvcihAY2xhc3NOYW1lOiBzdHJpbmc/ID0gdW5kZWYpXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cclxuXHRpc05vZGUoeDogb2JqZWN0KTogeCBpcyBUXHJcblxyXG5cdFx0cmV0dXJuIChcclxuXHRcdFx0aXNPYmplY3QoeCkgICMgbm90IHVuZGVmLCBudWxsLCByZWdleCwgYXJyYXlcclxuXHRcdFx0XHQmJiAoXHJcblx0XHRcdFx0XHRcdG5vdCBAY2xhc3NOYW1lXHJcblx0XHRcdFx0XHR8fCAoeD8uY29uc3RydWN0b3I/Lm5hbWUgPT0gQGNsYXNzTmFtZSlcclxuXHRcdFx0XHRcdClcclxuXHRcdFx0KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0dXNlTm9kZSh4OiBvYmplY3QpOiBib29sZWFuXHJcblxyXG5cdFx0cmV0dXJuIEBpc05vZGUoeClcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblxyXG5cdGZpbHRlcihoOiBUTm9kZUluZm88VD4pOiBib29sZWFuXHJcblxyXG5cdFx0IyAtLS0gZmlsdGVyKCkgaXMgb25seSBjYWxsZWQgaWYgaXNOb2RlKGgubm9kZSkgaXMgdHJ1ZVxyXG5cdFx0cmV0dXJuIHRydWVcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblxyXG5cdHdhbGsoXHJcblx0XHRcdGl0ZW06IHVua25vd25cclxuXHRcdFx0cGFyZW50OiBUPyA9IHVuZGVmXHJcblx0XHRcdGxldmVsOiBudW1iZXIgPSAwXHJcblx0XHRcdGluZGV4OiAoc3RyaW5nIHwgbnVtYmVyKT8gPSB1bmRlZlxyXG5cdFx0XHQpOiBHZW5lcmF0b3I8VE5vZGVJbmZvPFQ+LCB2b2lkLCB2b2lkPlxyXG5cclxuXHRcdGlmIGlzT2JqZWN0KGl0ZW0pICYmIEB1c2VOb2RlIGl0ZW1cclxuXHRcdFx0REJHIFwiTk9ERTogI3tPTChpdGVtKX1cIlxyXG5cdFx0XHR5aWVsZCB7XHJcblx0XHRcdFx0bm9kZTogaXRlbSBhcyBUXHJcblx0XHRcdFx0cGFyZW50XHJcblx0XHRcdFx0bGV2ZWxcclxuXHRcdFx0XHRpbmRleFxyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRpZiBpc0FycmF5IGl0ZW1cclxuXHRcdFx0REJHIFwiQVJSQVlcIlxyXG5cdFx0XHRmb3IgeCxpIG9mIGl0ZW1cclxuXHRcdFx0XHR5aWVsZCogQHdhbGsgeCwgcGFyZW50LCBsZXZlbCsxLCBpXHJcblx0XHRlbHNlIGlmIGlzT2JqZWN0IGl0ZW1cclxuXHRcdFx0REJHIFwiT0JKRUNUXCJcclxuXHRcdFx0Zm9yIFtrZXksIHhdIG9mIE9iamVjdC5lbnRyaWVzKGl0ZW0pXHJcblx0XHRcdFx0eWllbGQqIEB3YWxrIHgsIChAaXNOb2RlKGl0ZW0pID8gaXRlbSA6IHBhcmVudCksIGxldmVsKzEsIGtleVxyXG4iXX0=