"use strict";
// walker.lib.civet

import {
	undef, defined, notdefined, integer, hash, array,
	isArray, isHash, isPrimitive, assert, croak, isEmpty,
	assertIsString, assertIsArray,
	} from 'datatypes'
import {extract} from 'extract'
import {OL} from 'to-nice'
import {DBG} from 'logger'

// ---------------------------------------------------------------------------

const hasChildren = (x: unknown) => {
	return isHash(x) || isArray(x)
}

export class Walker<T extends object = hash> {

	// --- Keep track of nodes visited to avoid infinite loops
	setVisited: WeakSet<hash | array> = new WeakSet<hash | array>()

	lNodeStack: T[] = []

	// ..........................................................

	get level(): integer {

		return this.lNodeStack.length
	}

	// ..........................................................

	parent(n: integer = 1): T {

		const len = this.lNodeStack.length
		assert((n >= 0) && (n < len), `Bad index: ${n} of ${len}`)
		return this.lNodeStack[len-n-1]
	}

	// ..........................................................

	isNode(x: unknown): x is T {

		return true
	}

	// ..........................................................

	filter(node: T): boolean {

		return true
	}

	// ..........................................................

	extract(dspath: string): (unknown | undefined) {

		DBG(`dspath = '${dspath}'`)
		const lMatches = dspath.match(/^(\^*)(.*)$/)
		if (defined(lMatches)) {
			const [_, goUpStr, mainStr] = lMatches
			return extract(this.parent(goUpStr.length), mainStr)
		}
		else {
			croak(`Bad dspath: ${dspath}`)
		}
	}

	// ..........................................................

	getString(dspath: string): string {

		const str = this.extract(dspath)
		assertIsString(str)
		return str
	}

	// ..........................................................

	getArray(dspath: string): unknown[] {

		const lItems = this.extract(dspath)
		assertIsArray(lItems)
		return lItems
	}

	// ..........................................................
	// GENERATOR

	*walk(x: unknown): Generator<T, void, void> {

		if (hasChildren(x)) {
			this.setVisited = new WeakSet<hash | array>()
			yield* this.walkItem(x)
		}
		return
	}

	// ..........................................................
	// GENERATOR

	*walkItem(item: hash | array): Generator<T, void, void> {

		if (this.setVisited.has(item)) {
			return
		}

		if (this.isNode(item)) {
			// --- type narrowing ensures that item is a T
			if (this.filter(item)) {
				DBG(`YIELD NODE: ${OL(item)}`)
				yield item
				this.setVisited.add(item)
			}

			this.lNodeStack.push(item)
		}    // --- item is parent of yielded items

		if (isArray(item)) {
			let i1 = 0;for (const x of item) {const i = i1++;
				if (isHash(x) || isArray(x)) {
					yield* this.walkItem(x)
				}
			}
		}
		else {
			for (const [key,x] of Object.entries(item)) {
				if (isHash(x) || isArray(x)) {
					yield* this.walkItem(x)
				}
			}
		}
		if (this.isNode(item)) {
			this.lNodeStack.pop()
		}
		return
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDdEQsQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQy9CLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUMxQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVE7QUFDMUIsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQVcsTUFBWCxXQUFXLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDOUIsQUFBQSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEM7QUFBQyxDQUFBO0FBQy9CLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEMsQ0FBRSxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUE7QUFDNUMsQUFBQTtBQUNBLEFBQUEsQ0FBQywwREFBeUQ7QUFDMUQsQUFBQSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNoRSxBQUFBO0FBQ0EsQUFBQSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyQixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDQUFDLEdBQUcsQyxLQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFBLENBQUE7QUFDckIsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUMsSSxDQUFDLFVBQVUsQ0FBQyxNO0NBQU0sQ0FBQTtBQUMzQixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDLE1BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUE7QUFDMUIsQUFBQTtBQUNBLEFBQUEsRUFBSyxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsSSxDQUFDLFVBQVUsQ0FBQyxNQUFNO0FBQzNCLEFBQUEsRUFBRSxNQUFNLENBQUEsQUFBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FB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QUcsQ0FBQSxJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUNsQixBQUFBLEdBQUcsSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQztFQUFDLENBQUE7QUFDcEIsQUFBQSxFQUFFLE07Q0FBTSxDO0FBQUEsQ0FBQTtBQUNSIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIHdhbGtlci5saWIuY2l2ZXRcclxuXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGludGVnZXIsIGhhc2gsIGFycmF5LFxyXG5cdGlzQXJyYXksIGlzSGFzaCwgaXNQcmltaXRpdmUsIGFzc2VydCwgY3JvYWssIGlzRW1wdHksXHJcblx0YXNzZXJ0SXNTdHJpbmcsIGFzc2VydElzQXJyYXksXHJcblx0fSBmcm9tICdkYXRhdHlwZXMnXHJcbmltcG9ydCB7ZXh0cmFjdH0gZnJvbSAnZXh0cmFjdCdcclxuaW1wb3J0IHtPTH0gZnJvbSAndG8tbmljZSdcclxuaW1wb3J0IHtEQkd9IGZyb20gJ2xvZ2dlcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5oYXNDaGlsZHJlbiA6PSAoeDogdW5rbm93bikgPT5cclxuXHRyZXR1cm4gaXNIYXNoKHgpIHx8IGlzQXJyYXkoeClcclxuXHJcbmV4cG9ydCBjbGFzcyBXYWxrZXI8VCBleHRlbmRzIG9iamVjdCA9IGhhc2g+XHJcblxyXG5cdCMgLS0tIEtlZXAgdHJhY2sgb2Ygbm9kZXMgdmlzaXRlZCB0byBhdm9pZCBpbmZpbml0ZSBsb29wc1xyXG5cdHNldFZpc2l0ZWQ6IFdlYWtTZXQ8aGFzaCB8IGFycmF5PiA9IG5ldyBXZWFrU2V0PGhhc2ggfCBhcnJheT4oKVxyXG5cclxuXHRsTm9kZVN0YWNrOiBUW10gPSBbXVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0Z2V0IGxldmVsKCk6IGludGVnZXJcclxuXHJcblx0XHRyZXR1cm4gQGxOb2RlU3RhY2subGVuZ3RoXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cclxuXHRwYXJlbnQobjogaW50ZWdlciA9IDEpOiBUXHJcblxyXG5cdFx0bGVuIDo9IEBsTm9kZVN0YWNrLmxlbmd0aFxyXG5cdFx0YXNzZXJ0IChuID49IDApICYmIChuIDwgbGVuKSwgXCJCYWQgaW5kZXg6ICN7bn0gb2YgI3tsZW59XCJcclxuXHRcdHJldHVybiBAbE5vZGVTdGFja1tsZW4tbi0xXVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0aXNOb2RlKHg6IHVua25vd24pOiB4IGlzIFRcclxuXHJcblx0XHRyZXR1cm4gdHJ1ZVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0ZmlsdGVyKG5vZGU6IFQpOiBib29sZWFuXHJcblxyXG5cdFx0cmV0dXJuIHRydWVcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblxyXG5cdGV4dHJhY3QoZHNwYXRoOiBzdHJpbmcpOiB1bmtub3duP1xyXG5cclxuXHRcdERCRyBcImRzcGF0aCA9ICcje2RzcGF0aH0nXCJcclxuXHRcdGxNYXRjaGVzIDo9IGRzcGF0aC5tYXRjaCAvLy9eXHJcblx0XHRcdFx0KFxcXiopXHJcblx0XHRcdFx0KC4qKVxyXG5cdFx0XHRcdCQvLy9cclxuXHRcdGlmIGRlZmluZWQobE1hdGNoZXMpXHJcblx0XHRcdFtfLCBnb1VwU3RyLCBtYWluU3RyXSA6PSBsTWF0Y2hlc1xyXG5cdFx0XHRyZXR1cm4gZXh0cmFjdCBAcGFyZW50KGdvVXBTdHIubGVuZ3RoKSwgbWFpblN0clxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRjcm9hayBcIkJhZCBkc3BhdGg6ICN7ZHNwYXRofVwiXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cclxuXHRnZXRTdHJpbmcoZHNwYXRoOiBzdHJpbmcpOiBzdHJpbmdcclxuXHJcblx0XHRzdHIgOj0gQGV4dHJhY3QgZHNwYXRoXHJcblx0XHRhc3NlcnRJc1N0cmluZyBzdHJcclxuXHRcdHJldHVybiBzdHJcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblxyXG5cdGdldEFycmF5KGRzcGF0aDogc3RyaW5nKTogdW5rbm93bltdXHJcblxyXG5cdFx0bEl0ZW1zIDo9IEBleHRyYWN0IGRzcGF0aFxyXG5cdFx0YXNzZXJ0SXNBcnJheSBsSXRlbXNcclxuXHRcdHJldHVybiBsSXRlbXNcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBHRU5FUkFUT1JcclxuXHJcblx0d2Fsayh4OiB1bmtub3duKTogR2VuZXJhdG9yPFQsIHZvaWQsIHZvaWQ+XHJcblxyXG5cdFx0aWYgaGFzQ2hpbGRyZW4oeClcclxuXHRcdFx0QHNldFZpc2l0ZWQgPSBuZXcgV2Vha1NldDxoYXNoIHwgYXJyYXk+KClcclxuXHRcdFx0eWllbGQqIEB3YWxrSXRlbSB4XHJcblx0XHRyZXR1cm5cclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBHRU5FUkFUT1JcclxuXHJcblx0d2Fsa0l0ZW0oaXRlbTogaGFzaCB8IGFycmF5KTogR2VuZXJhdG9yPFQsIHZvaWQsIHZvaWQ+XHJcblxyXG5cdFx0aWYgQHNldFZpc2l0ZWQuaGFzIGl0ZW1cclxuXHRcdFx0cmV0dXJuXHJcblxyXG5cdFx0aWYgQGlzTm9kZShpdGVtKVxyXG5cdFx0XHQjIC0tLSB0eXBlIG5hcnJvd2luZyBlbnN1cmVzIHRoYXQgaXRlbSBpcyBhIFRcclxuXHRcdFx0aWYgQGZpbHRlcihpdGVtKVxyXG5cdFx0XHRcdERCRyBcIllJRUxEIE5PREU6ICN7T0woaXRlbSl9XCJcclxuXHRcdFx0XHR5aWVsZCBpdGVtXHJcblx0XHRcdFx0QHNldFZpc2l0ZWQuYWRkIGl0ZW1cclxuXHJcblx0XHRcdEBsTm9kZVN0YWNrLnB1c2ggaXRlbSAgICAjIC0tLSBpdGVtIGlzIHBhcmVudCBvZiB5aWVsZGVkIGl0ZW1zXHJcblxyXG5cdFx0aWYgaXNBcnJheSBpdGVtXHJcblx0XHRcdGZvciB4LGkgb2YgaXRlbVxyXG5cdFx0XHRcdGlmIGlzSGFzaCh4KSB8fCBpc0FycmF5KHgpXHJcblx0XHRcdFx0XHR5aWVsZCogQHdhbGtJdGVtIHhcclxuXHRcdGVsc2VcclxuXHRcdFx0Zm9yIFtrZXkseF0gb2YgT2JqZWN0LmVudHJpZXMoaXRlbSlcclxuXHRcdFx0XHRpZiBpc0hhc2goeCkgfHwgaXNBcnJheSh4KVxyXG5cdFx0XHRcdFx0eWllbGQqIEB3YWxrSXRlbSB4XHJcblx0XHRpZiBAaXNOb2RlKGl0ZW0pXHJcblx0XHRcdEBsTm9kZVN0YWNrLnBvcCgpXHJcblx0XHRyZXR1cm5cclxuIl19