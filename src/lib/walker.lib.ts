"use strict";
// walker.lib.civet

import {
	undef, defined, notdefined, integer, TConstructor,
	isArray, isObject, isPrimitive,
	} from 'datatypes'
import {OL} from 'llutils'
import {DBG} from 'logger'

// ---------------------------------------------------------------------------

type TIndex = string | number

export type TNodeInfo<T> = {
	node: T
	level: integer
	parent: (T | undefined)
	index?: TIndex
	}

// ---------------------------------------------------------------------------

export class Walker<T extends object = object> {

	// --- Keep track of nodes visited to avoid infinite loops
	setVisited: WeakSet<T> = new WeakSet<T>()

	// --- If constructor is provided, only objects with that
	//     constuctor will be returned

	nodeConstructor: (TConstructor<T> | undefined)

	// ..........................................................

	constructor(nodeConstructor1: (TConstructor<T> | undefined) = undef){this.nodeConstructor = nodeConstructor1;}

	// ..........................................................

	isNode(x: object): x is T {

		return (
			isObject(x)  // not undef, null, regex, array
				&& (
						!this.nodeConstructor
					|| (x instanceof this.nodeConstructor)
					)
			)
	}

	// ..........................................................

	useNode(x: object): boolean {

		return this.isNode(x)
	}

	// ..........................................................

	filter(h: TNodeInfo<T>): boolean {

		// --- filter() is only called if isNode(h.node) is true
		return true
	}

	// ..........................................................
	// GENERATOR

	*walk(
			item: unknown,
			parent: (T | undefined) = undef,
			level: number = 0,
			index: ((string | number) | undefined) = undef
			): Generator<TNodeInfo<T>, void, void> {

		if (isObject(item) && this.useNode(item)) {
			DBG(`NODE: ${OL(item)}`)
			yield {
				node: item as T,
				parent,
				level,
				index
				}
		}

		if (isArray(item)) {
			DBG("ARRAY")
			let i1 = 0;for (const x of item) {const i = i1++;
				yield* this.walk(x, parent, level+1, i)
			}
		}
		else if (isObject(item)) {
			DBG("OBJECT")
			for (const [key, x] of Object.entries(item)) {
				yield* this.walk(x, (this.isNode(item) ? item : parent), level+1, key)
			}
		}
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxZQUFZLENBQUM7QUFDbkQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDaEMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQzFCLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUMxQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU07QUFDN0IsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1QixBQUFBLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNSLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPO0FBQ2YsQUFBQSxDQUFDLE1BQU0sQyxDLENBQUMsQUFBQyxDLFksQ0FBRTtBQUNYLEFBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU07QUFDZixDQUFDLENBQUM7QUFDRixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNB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RUFBRSxDQUFDLEksQ0FBQyxPQUFPLENBQUEsQUFBQyxJQUFJLENBQUEsQ0FBQSxDQUFBLENBQUE7QUFDcEMsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDMUIsQUFBQSxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ1YsQUFBQSxJQUFJLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO0FBQ25CLEFBQUEsSUFBSSxNQUFNLENBQUE7QUFDVixBQUFBLElBQUksS0FBSyxDQUFBO0FBQ1QsQUFBQSxJQUFJLEtBQUs7QUFDVCxJQUFJLEM7RUFBQyxDQUFBO0FBQ0wsQUFBQTtBQUNBLEFBQUEsRUFBRSxHQUFHLENBQUEsT0FBTyxDQUFBLEFBQUMsSUFBSSxDQUFBLENBQUEsQ0FBQSxDQUFBO0FBQ2pCLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxPQUFPLENBQUE7QUFDZCxBQUFBLEcsSSxFLEksQ0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLENBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFBLENBQUEsQ0FBVCxNQUFBLEMsRyxFLEUsQ0FBUztBQUNsQixBQUFBLElBQUksS0FBSyxDQUFDLENBQUMsSSxDQUFDLElBQUksQ0FBQSxBQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEM7R0FBQSxDO0VBQUEsQ0FBQTtBQUN0QyxBQUFBLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQSxRQUFRLENBQUEsQUFBQyxJQUFJLENBQUEsQ0FBQSxDQUFBLENBQUE7QUFDdkIsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLFFBQVEsQ0FBQTtBQUNmLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQ3ZDLEFBQUEsSUFBSSxLQUFLLENBQUMsQ0FBQyxJLENBQUMsSUFBSSxDQUFBLEFBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQztHQUFBLEM7RUFBQSxDO0NBQUEsQztBQUFBLENBQUE7QUFDakUiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgd2Fsa2VyLmxpYi5jaXZldFxyXG5cclxuaW1wb3J0IHtcclxuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCwgaW50ZWdlciwgVENvbnN0cnVjdG9yLFxyXG5cdGlzQXJyYXksIGlzT2JqZWN0LCBpc1ByaW1pdGl2ZSxcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtPTH0gZnJvbSAnbGx1dGlscydcclxuaW1wb3J0IHtEQkd9IGZyb20gJ2xvZ2dlcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG50eXBlIFRJbmRleCA9IHN0cmluZyB8IG51bWJlclxyXG5cclxuZXhwb3J0IHR5cGUgVE5vZGVJbmZvPFQ+ID0ge1xyXG5cdG5vZGU6IFRcclxuXHRsZXZlbDogaW50ZWdlclxyXG5cdHBhcmVudDogVD9cclxuXHRpbmRleD86IFRJbmRleFxyXG5cdH1cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgY2xhc3MgV2Fsa2VyPFQgZXh0ZW5kcyBvYmplY3QgPSBvYmplY3Q+XHJcblxyXG5cdCMgLS0tIEtlZXAgdHJhY2sgb2Ygbm9kZXMgdmlzaXRlZCB0byBhdm9pZCBpbmZpbml0ZSBsb29wc1xyXG5cdHNldFZpc2l0ZWQ6IFdlYWtTZXQ8VD4gPSBuZXcgV2Vha1NldDxUPigpXHJcblxyXG5cdCMgLS0tIElmIGNvbnN0cnVjdG9yIGlzIHByb3ZpZGVkLCBvbmx5IG9iamVjdHMgd2l0aCB0aGF0XHJcblx0IyAgICAgY29uc3R1Y3RvciB3aWxsIGJlIHJldHVybmVkXHJcblxyXG5cdG5vZGVDb25zdHJ1Y3RvcjogVENvbnN0cnVjdG9yPFQ+P1xyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0Y29uc3RydWN0b3IoQG5vZGVDb25zdHJ1Y3RvcjogVENvbnN0cnVjdG9yPFQ+PyA9IHVuZGVmKVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0aXNOb2RlKHg6IG9iamVjdCk6IHggaXMgVFxyXG5cclxuXHRcdHJldHVybiAoXHJcblx0XHRcdGlzT2JqZWN0KHgpICAjIG5vdCB1bmRlZiwgbnVsbCwgcmVnZXgsIGFycmF5XHJcblx0XHRcdFx0JiYgKFxyXG5cdFx0XHRcdFx0XHRub3QgQG5vZGVDb25zdHJ1Y3RvclxyXG5cdFx0XHRcdFx0fHwgKHggaW5zdGFuY2VvZiBAbm9kZUNvbnN0cnVjdG9yKVxyXG5cdFx0XHRcdFx0KVxyXG5cdFx0XHQpXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cclxuXHR1c2VOb2RlKHg6IG9iamVjdCk6IGJvb2xlYW5cclxuXHJcblx0XHRyZXR1cm4gQGlzTm9kZSh4KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0ZmlsdGVyKGg6IFROb2RlSW5mbzxUPik6IGJvb2xlYW5cclxuXHJcblx0XHQjIC0tLSBmaWx0ZXIoKSBpcyBvbmx5IGNhbGxlZCBpZiBpc05vZGUoaC5ub2RlKSBpcyB0cnVlXHJcblx0XHRyZXR1cm4gdHJ1ZVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIEdFTkVSQVRPUlxyXG5cclxuXHR3YWxrKFxyXG5cdFx0XHRpdGVtOiB1bmtub3duXHJcblx0XHRcdHBhcmVudDogVD8gPSB1bmRlZlxyXG5cdFx0XHRsZXZlbDogbnVtYmVyID0gMFxyXG5cdFx0XHRpbmRleDogKHN0cmluZyB8IG51bWJlcik/ID0gdW5kZWZcclxuXHRcdFx0KTogR2VuZXJhdG9yPFROb2RlSW5mbzxUPiwgdm9pZCwgdm9pZD5cclxuXHJcblx0XHRpZiBpc09iamVjdChpdGVtKSAmJiBAdXNlTm9kZSBpdGVtXHJcblx0XHRcdERCRyBcIk5PREU6ICN7T0woaXRlbSl9XCJcclxuXHRcdFx0eWllbGQge1xyXG5cdFx0XHRcdG5vZGU6IGl0ZW0gYXMgVFxyXG5cdFx0XHRcdHBhcmVudFxyXG5cdFx0XHRcdGxldmVsXHJcblx0XHRcdFx0aW5kZXhcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0aWYgaXNBcnJheSBpdGVtXHJcblx0XHRcdERCRyBcIkFSUkFZXCJcclxuXHRcdFx0Zm9yIHgsaSBvZiBpdGVtXHJcblx0XHRcdFx0eWllbGQqIEB3YWxrIHgsIHBhcmVudCwgbGV2ZWwrMSwgaVxyXG5cdFx0ZWxzZSBpZiBpc09iamVjdCBpdGVtXHJcblx0XHRcdERCRyBcIk9CSkVDVFwiXHJcblx0XHRcdGZvciBba2V5LCB4XSBvZiBPYmplY3QuZW50cmllcyhpdGVtKVxyXG5cdFx0XHRcdHlpZWxkKiBAd2FsayB4LCAoQGlzTm9kZShpdGVtKSA/IGl0ZW0gOiBwYXJlbnQpLCBsZXZlbCsxLCBrZXlcclxuIl19