"use strict";
// walker.lib.civet

import {
	undef, defined, notdefined, integer, hash, array,
	isArray, isHash, isPrimitive, assert, croak, isEmpty,
	assertIsString, assertIsArray,
	} from 'datatypes'
import {OL} from 'to-nice'
import {DBG} from 'logger'

// ---------------------------------------------------------------------------

const hasChildren = (x: unknown) => {
	return isHash(x) || isArray(x)
}

export type TVisitKind = 'enter' | 'exit' | 'ref'

export class Walker<T extends object = hash> {

	// --- Keep track of nodes visited to avoid infinite loops
	setVisited: WeakSet<hash | array> = new WeakSet<hash | array>()

	lNodeStack: T[] = []

	// ..........................................................

	pushNode(item: T): void {

		this.lNodeStack.push(item)
		return
	}

	// ..........................................................

	popNode(): (T | undefined) {

		return this.lNodeStack.pop()
		return
	}

	// ..........................................................

	get level(): integer {

		return this.lNodeStack.length
	}

	// ..........................................................

	parent(n: integer = 1): T {

		const len = this.lNodeStack.length
		assert((n >= 0) && (n < len), `Bad index: ${n} of ${len}`)
		return this.lNodeStack[len-n]
	}

	// ..........................................................

	isNode(x: unknown): x is T {

		return true
	}

	// ..........................................................

	filter(node: T): boolean {

		return true
	}

	// ..........................................................
	// GENERATOR

	*walk(x: unknown): Generator<T, void, void> {

		if (hasChildren(x)) {
			this.setVisited = new WeakSet<hash | array>()
			yield* this.walkItem(x)
		}
		return
	}

	// ..........................................................
	// GENERATOR

	*walkItem(item: hash | array): Generator<T, void, void> {

		if (this.setVisited.has(item)) {
			return
		}

		if (this.isNode(item)) {
			// --- type narrowing ensures that item is a T
			if (this.filter(item)) {
				DBG(`YIELD NODE: ${OL(item)}`)
				yield item
			}

			// --- item is parent of yielded items
			this.pushNode(item)
		}

		this.setVisited.add(item)

		if (isArray(item)) {
			let i1 = 0;for (const x of item) {const i = i1++;
				if (isHash(x) || isArray(x)) {
					yield* this.walkItem(x)
				}
			}
		}
		else {
			for (const [key,x] of Object.entries(item)) {
				if (isHash(x) || isArray(x)) {
					yield* this.walkItem(x)
				}
			}
		}

		if (this.isNode(item)) {
			this.popNode()
		}

		return
	}

	// ..........................................................
	// GENERATOR

	*walkEx(x: unknown): Generator<[TVisitKind, T], void, void> {

		if (hasChildren(x)) {
			this.setVisited = new WeakSet<hash | array>()
			yield* this.walkItemEx(x)
		}
		return
	}

	// ..........................................................
	// GENERATOR

	*walkItemEx(item: hash | array): Generator<[TVisitKind, T], void, void> {

		if (this.setVisited.has(item)) {
			if (this.isNode(item)) {
				yield ['ref', item]
			}
			return
		}

		if (this.isNode(item)) {
			// --- type narrowing ensures that item is a T
			if (this.filter(item)) {
				DBG(`YIELD NODE: ${OL(item)}`)
				yield ['enter', item]
			}

			// --- item is parent of yielded items
			this.pushNode(item)
		}

		this.setVisited.add(item)

		if (isArray(item)) {
			let i2 = 0;for (const x of item) {const i = i2++;
				if (isHash(x) || isArray(x)) {
					yield* this.walkItemEx(x)
				}
			}
		}
		else {
			for (const [key,x] of Object.entries(item)) {
				if (isHash(x) || isArray(x)) {
					yield* this.walkItemEx(x)
				}
			}
		}

		if (this.isNode(item)) {
			yield ['exit', item]
			this.popNode()
		}

		return
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx3YWxrZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDdEQsQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQzFCLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUMxQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBVyxNQUFYLFdBQVcsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUM5QixBQUFBLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQztBQUFDLENBQUE7QUFDL0IsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUs7QUFDakQsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQyxDQUFFLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQTtBQUM1QyxBQUFBO0FBQ0EsQUFBQSxDQUFDLDBEQUF5RDtBQUMxRCxBQUFBLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLEFBQUE7QUFDQSxBQUFBLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JCLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUE7QUFDQSxBQUFBLEMsUUFBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBLENBQUE7QUFDeEIsQUFBQTtBQUNBLEFBQUEsRUFBRSxJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQSxBQUFDLElBQUksQ0FBQTtBQUN2QixBQUFBLEVBQUUsTTtDQUFNLENBQUE7QUFDUixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDLE9BQVEsQ0FBQyxDQUFDLEMsQyxDQUFDLEFBQUMsQyxZLENBQUUsQ0FBQSxDQUFBO0FBQ2QsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUMsSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQixBQUFBLEVBQUUsTTtDQUFNLENBQUE7QUFDUixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDQUFDLEdBQUcsQyxLQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFBLENBQUE7QUFDckIsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUMsSSxDQUFDLFVBQVUsQ0FBQyxNO0NBQU0sQ0FBQTtBQUMzQixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDLE1BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUE7QUFDMUIsQUFBQTtBQUNBLEFBQUEsRUFBSyxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsSSxDQUFDLFVBQVUsQ0FBQyxNQUFNO0FBQzNCLEFBQUEsRUFBRSxNQUFNLENBQUEsQUFBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUMzRCxBQUFBLEVBQUUsTUFBTSxDQUFDLEksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQztDQUFDLENBQUE7QUFDM0IsQUFBQTtBQUNBLEFBQUEsQ0FBQyw2REFBNEQ7QUFDN0QsQUFBQTtBQUNBLEFBQUEsQyxNQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQzNCLEFBQUE7QUFDQSxBQUFBLEVBQUUsTUFBTSxDQUFDLEk7Q0FBSSxDQUFBO0FBQ2IsQUFBQTtBQUNBLEFBQUEsQ0FBQyw2REFBNEQ7QUFDN0QsQUFBQTtBQUNBLEFBQUEsQyxNQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUEsQ0FBQTtBQUN6QixBQUFBO0FBQ0EsQUFBQSxFQUFFLE1BQU0sQ0FBQyxJO0NBQUksQ0FBQTtBQUNiLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyxZQUFXO0FBQ1osQUFBQTtBQUNBLEFBQUEsQyxDLElBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFBO0FBQzNDLEFBQUE7QUFDQSxBQUFBLEVBQUUsR0FBRyxDQUFBLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDbkIsQUFBQSxHQUFHLEksQ0FBQyxVQUFVLEMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQzVDLEFBQUEsR0FBRyxLQUFLLENBQUMsQ0FBQyxJLENBQUMsUUFBUSxDQUFBLEFBQUMsQ0FBQyxDO0VBQUEsQ0FBQTtBQUNyQixBQUFBLEVBQUUsTTtDQUFNLENBQUE7QUFDUixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBLENBQUMsWUFBVztBQUNaLEFBQUE7QUFDQSxBQUFBLEMsQyxRQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFBO0FBQ3ZELEFBQUE7QUFDQSxBQUFBLEVBQUUsR0FBRyxDQUFBLEksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFBLEFBQUMsSUFBSSxDQUFBLENBQUEsQ0FBQSxDQUFBO0FBQ3pCLEFBQUEsR0FBRyxNO0VBQU0sQ0FBQTtBQUNULEFBQUE7QUFDQSxBQUFBLEVBQUUsR0FBRyxDQUFBLEksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQ2xCLEFBQUEsR0FBRyw4Q0FBNkM7QUFDaEQsQUFBQSxHQUFHLEdBQUcsQ0FBQSxJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUNuQixBQUFBLElBQUksR0FBRyxDQUFBLEFBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUNqQyxBQUFBLElBQUksS0FBSyxDQUFDLEk7R0FBSSxDQUFBO0FBQ2QsQUFBQTtBQUNBLEFBQUEsR0FBRyxzQ0FBcUM7QUFDeEMsQUFBQSxHQUFHLEksQ0FBQyxRQUFRLENBQUEsQUFBQyxJQUFJLEM7RUFBQSxDQUFBO0FBQ2pCLEFBQUE7QUFDQSxBQUFBLEVBQUUsSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUEsQUFBQyxJQUFJLENBQUE7QUFDdEIsQUFBQTtBQUNBLEFBQUEsRUFBRSxHQUFHLENBQUEsT0FBTyxDQUFBLEFBQUMsSUFBSSxDQUFBLENBQUEsQ0FBQSxDQUFBO0FBQ2pCLEFBQUEsRyxJLEUsSSxDQUFHLEdBQUcsQ0FBQyxDQUFBLE1BQUEsQ0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUEsQ0FBQSxDQUFULE1BQUEsQyxHLEUsRSxDQUFTO0FBQ2xCLEFBQUEsSUFBSSxHQUFHLENBQUEsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQSxDQUFBO0FBQzlCLEFBQUEsS0FBSyxLQUFLLENBQUMsQ0FBQyxJLENBQUMsUUFBUSxDQUFBLEFBQUMsQ0FBQyxDO0lBQUEsQztHQUFBLEM7RUFBQSxDQUFBO0FBQ3ZCLEFBQUEsRUFBRSxJQUFJLENBQUEsQ0FBQTtBQUNOLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUN0QyxBQUFBLElBQUksR0FBRyxDQUFBLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUEsQ0FBQTtB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LENBQUMsSUFBSSxDQUFBLENBQUEsQ0FBVCxNQUFBLEMsRyxFLEUsQ0FBUztBQUNsQixBQUFBLElBQUksR0FBRyxDQUFBLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUM5QixBQUFBLEtBQUssS0FBSyxDQUFDLENBQUMsSSxDQUFDLFVBQVUsQ0FBQSxBQUFDLENBQUMsQztJQUFBLEM7R0FBQSxDO0VBQUEsQ0FBQTtBQUN6QixBQUFBLEVBQUUsSUFBSSxDQUFBLENBQUE7QUFDTixBQUFBLEdBQUcsR0FBRyxDQUFDLENBQUEsTUFBQSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDdEMsQUFBQSxJQUFJLEdBQUcsQ0FBQSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDOUIsQUFBQSxLQUFLLEtBQUssQ0FBQyxDQUFDLEksQ0FBQyxVQUFVLENBQUEsQUFBQyxDQUFDLEM7SUFBQSxDO0dBQUEsQztFQUFBLENBQUE7QUFDekIsQUFBQTtBQUNBLEFBQUEsRUFBRSxHQUFHLENBQUEsSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDbEIsQUFBQSxHQUFHLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQztBQUN2QixBQUFBLEdBQUcsSSxDQUFDLE9BQU8sQ0FBQyxDO0VBQUMsQ0FBQTtBQUNiLEFBQUE7QUFDQSxBQUFBLEVBQUUsTTtDQUFNLEM7QUFBQSxDQUFBO0FBQ1IiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgd2Fsa2VyLmxpYi5jaXZldFxyXG5cclxuaW1wb3J0IHtcclxuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCwgaW50ZWdlciwgaGFzaCwgYXJyYXksXHJcblx0aXNBcnJheSwgaXNIYXNoLCBpc1ByaW1pdGl2ZSwgYXNzZXJ0LCBjcm9haywgaXNFbXB0eSxcclxuXHRhc3NlcnRJc1N0cmluZywgYXNzZXJ0SXNBcnJheSxcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtPTH0gZnJvbSAndG8tbmljZSdcclxuaW1wb3J0IHtEQkd9IGZyb20gJ2xvZ2dlcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5oYXNDaGlsZHJlbiA6PSAoeDogdW5rbm93bikgPT5cclxuXHRyZXR1cm4gaXNIYXNoKHgpIHx8IGlzQXJyYXkoeClcclxuXHJcbmV4cG9ydCB0eXBlIFRWaXNpdEtpbmQgPSAnZW50ZXInIHwgJ2V4aXQnIHwgJ3JlZidcclxuXHJcbmV4cG9ydCBjbGFzcyBXYWxrZXI8VCBleHRlbmRzIG9iamVjdCA9IGhhc2g+XHJcblxyXG5cdCMgLS0tIEtlZXAgdHJhY2sgb2Ygbm9kZXMgdmlzaXRlZCB0byBhdm9pZCBpbmZpbml0ZSBsb29wc1xyXG5cdHNldFZpc2l0ZWQ6IFdlYWtTZXQ8aGFzaCB8IGFycmF5PiA9IG5ldyBXZWFrU2V0PGhhc2ggfCBhcnJheT4oKVxyXG5cclxuXHRsTm9kZVN0YWNrOiBUW10gPSBbXVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0cHVzaE5vZGUoaXRlbTogVCk6IHZvaWRcclxuXHJcblx0XHRAbE5vZGVTdGFjay5wdXNoIGl0ZW1cclxuXHRcdHJldHVyblxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0cG9wTm9kZSgpOiBUP1xyXG5cclxuXHRcdHJldHVybiBAbE5vZGVTdGFjay5wb3AoKVxyXG5cdFx0cmV0dXJuXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cclxuXHRnZXQgbGV2ZWwoKTogaW50ZWdlclxyXG5cclxuXHRcdHJldHVybiBAbE5vZGVTdGFjay5sZW5ndGhcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblxyXG5cdHBhcmVudChuOiBpbnRlZ2VyID0gMSk6IFRcclxuXHJcblx0XHRsZW4gOj0gQGxOb2RlU3RhY2subGVuZ3RoXHJcblx0XHRhc3NlcnQgKG4gPj0gMCkgJiYgKG4gPCBsZW4pLCBcIkJhZCBpbmRleDogI3tufSBvZiAje2xlbn1cIlxyXG5cdFx0cmV0dXJuIEBsTm9kZVN0YWNrW2xlbi1uXVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0aXNOb2RlKHg6IHVua25vd24pOiB4IGlzIFRcclxuXHJcblx0XHRyZXR1cm4gdHJ1ZVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHJcblx0ZmlsdGVyKG5vZGU6IFQpOiBib29sZWFuXHJcblxyXG5cdFx0cmV0dXJuIHRydWVcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBHRU5FUkFUT1JcclxuXHJcblx0d2Fsayh4OiB1bmtub3duKTogR2VuZXJhdG9yPFQsIHZvaWQsIHZvaWQ+XHJcblxyXG5cdFx0aWYgaGFzQ2hpbGRyZW4oeClcclxuXHRcdFx0QHNldFZpc2l0ZWQgPSBuZXcgV2Vha1NldDxoYXNoIHwgYXJyYXk+KClcclxuXHRcdFx0eWllbGQqIEB3YWxrSXRlbSB4XHJcblx0XHRyZXR1cm5cclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBHRU5FUkFUT1JcclxuXHJcblx0d2Fsa0l0ZW0oaXRlbTogaGFzaCB8IGFycmF5KTogR2VuZXJhdG9yPFQsIHZvaWQsIHZvaWQ+XHJcblxyXG5cdFx0aWYgQHNldFZpc2l0ZWQuaGFzIGl0ZW1cclxuXHRcdFx0cmV0dXJuXHJcblxyXG5cdFx0aWYgQGlzTm9kZShpdGVtKVxyXG5cdFx0XHQjIC0tLSB0eXBlIG5hcnJvd2luZyBlbnN1cmVzIHRoYXQgaXRlbSBpcyBhIFRcclxuXHRcdFx0aWYgQGZpbHRlcihpdGVtKVxyXG5cdFx0XHRcdERCRyBcIllJRUxEIE5PREU6ICN7T0woaXRlbSl9XCJcclxuXHRcdFx0XHR5aWVsZCBpdGVtXHJcblxyXG5cdFx0XHQjIC0tLSBpdGVtIGlzIHBhcmVudCBvZiB5aWVsZGVkIGl0ZW1zXHJcblx0XHRcdEBwdXNoTm9kZSBpdGVtXHJcblxyXG5cdFx0QHNldFZpc2l0ZWQuYWRkIGl0ZW1cclxuXHJcblx0XHRpZiBpc0FycmF5IGl0ZW1cclxuXHRcdFx0Zm9yIHgsaSBvZiBpdGVtXHJcblx0XHRcdFx0aWYgaXNIYXNoKHgpIHx8IGlzQXJyYXkoeClcclxuXHRcdFx0XHRcdHlpZWxkKiBAd2Fsa0l0ZW0geFxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRmb3IgW2tleSx4XSBvZiBPYmplY3QuZW50cmllcyhpdGVtKVxyXG5cdFx0XHRcdGlmIGlzSGFzaCh4KSB8fCBpc0FycmF5KHgpXHJcblx0XHRcdFx0XHR5aWVsZCogQHdhbGtJdGVtIHhcclxuXHJcblx0XHRpZiBAaXNOb2RlKGl0ZW0pXHJcblx0XHRcdEBwb3BOb2RlKClcclxuXHJcblx0XHRyZXR1cm5cclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBHRU5FUkFUT1JcclxuXHJcblx0d2Fsa0V4KHg6IHVua25vd24pOiBHZW5lcmF0b3I8W1RWaXNpdEtpbmQsIFRdLCB2b2lkLCB2b2lkPlxyXG5cclxuXHRcdGlmIGhhc0NoaWxkcmVuKHgpXHJcblx0XHRcdEBzZXRWaXNpdGVkID0gbmV3IFdlYWtTZXQ8aGFzaCB8IGFycmF5PigpXHJcblx0XHRcdHlpZWxkKiBAd2Fsa0l0ZW1FeCB4XHJcblx0XHRyZXR1cm5cclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBHRU5FUkFUT1JcclxuXHJcblx0d2Fsa0l0ZW1FeChpdGVtOiBoYXNoIHwgYXJyYXkpOiBHZW5lcmF0b3I8W1RWaXNpdEtpbmQsIFRdLCB2b2lkLCB2b2lkPlxyXG5cclxuXHRcdGlmIEBzZXRWaXNpdGVkLmhhcyBpdGVtXHJcblx0XHRcdGlmIEBpc05vZGUoaXRlbSlcclxuXHRcdFx0XHR5aWVsZCBbJ3JlZicsIGl0ZW1dXHJcblx0XHRcdHJldHVyblxyXG5cclxuXHRcdGlmIEBpc05vZGUoaXRlbSlcclxuXHRcdFx0IyAtLS0gdHlwZSBuYXJyb3dpbmcgZW5zdXJlcyB0aGF0IGl0ZW0gaXMgYSBUXHJcblx0XHRcdGlmIEBmaWx0ZXIoaXRlbSlcclxuXHRcdFx0XHREQkcgXCJZSUVMRCBOT0RFOiAje09MKGl0ZW0pfVwiXHJcblx0XHRcdFx0eWllbGQgWydlbnRlcicsIGl0ZW1dXHJcblxyXG5cdFx0XHQjIC0tLSBpdGVtIGlzIHBhcmVudCBvZiB5aWVsZGVkIGl0ZW1zXHJcblx0XHRcdEBwdXNoTm9kZSBpdGVtXHJcblxyXG5cdFx0QHNldFZpc2l0ZWQuYWRkIGl0ZW1cclxuXHJcblx0XHRpZiBpc0FycmF5IGl0ZW1cclxuXHRcdFx0Zm9yIHgsaSBvZiBpdGVtXHJcblx0XHRcdFx0aWYgaXNIYXNoKHgpIHx8IGlzQXJyYXkoeClcclxuXHRcdFx0XHRcdHlpZWxkKiBAd2Fsa0l0ZW1FeCB4XHJcblx0XHRlbHNlXHJcblx0XHRcdGZvciBba2V5LHhdIG9mIE9iamVjdC5lbnRyaWVzKGl0ZW0pXHJcblx0XHRcdFx0aWYgaXNIYXNoKHgpIHx8IGlzQXJyYXkoeClcclxuXHRcdFx0XHRcdHlpZWxkKiBAd2Fsa0l0ZW1FeCB4XHJcblxyXG5cdFx0aWYgQGlzTm9kZShpdGVtKVxyXG5cdFx0XHR5aWVsZCBbJ2V4aXQnLCBpdGVtXVxyXG5cdFx0XHRAcG9wTm9kZSgpXHJcblxyXG5cdFx0cmV0dXJuXHJcbiJdfQ==