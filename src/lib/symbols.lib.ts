"use strict";
// symbols.lib.civet

import {
	undef, defined, notdefined, assert, croak,
	hash, hashof, isEmpty, nonEmpty,
	} from 'datatypes'
import {
	pass, o, getOptions, keys,
	} from 'llutils'
import {OL, ML} from 'to-nice'
import {resetOneIndent} from 'indent'
import {LOG, DBG, DBGVALUE, ERR} from 'logger'
import {
	TPLLToken, TTokenGenerator, allTokensInBlock,
	} from 'pll'
import {isFile, slurp} from 'fsys'

/**
 * @module symbols - locate common symbols
 *    parses a file (default: src/.symbols) that looks like:
 *       src/lib/indent.lib.ts
 *          oneIndent resetOneIndent indentLevel
 *          lineDesc splitLine indented
 *       src/lib/fs.lib.ts
 *          isFile isDir
 *          fileExt withExt
 *
 *    and implements function:
 *       sourceLib := (symbol: string): string?
 */

// --- not exported!

// --- {<sym>: <lib>, ...}
const symbolsPath = 'src/.symbols'

// --- holds symbols in symbolsPath,
//     but only loaded when needed
//     and only if file exists
const symbolMap = new Map<string,string>()

// ---------------------------------------------------------------------------

export const loadSymbols = (
		block: string,
		aMap = new Map<string,string>(),
		hOptions: hash={}
		): Map<string,string> => {

	DBG("in loadSymbols()")

	// --- Check if libraries actually exist
	type opt = {
		checkFiles: boolean
		}
	const {checkFiles} = getOptions<opt>(hOptions, {
		checkFiles: false
		})

	let level = 0   // --- symGen must know the current level

	const symGen: TTokenGenerator = function*(line: string) {

		if (level === 0) {
			yield {kind: 'lib', str: line}
		}
		else if (level === 1) {
			for (const str of line.split(/\s+/)) {
				yield {kind: 'symbol', str}
			}
		}
		else {
			ERR(`level = ${level}`)
			croak(`level = ${level}`)
		}
		return
	}

	let curLib: (string | undefined) = undef
	for (const {kind, str} of allTokensInBlock(block, symGen)) {
		DBG(`TOKEN: ${kind}`)
		switch(kind) {
			case 'indent': {
				level += 1;break;
			}
			case 'undent': {
				level -= 1;break;
			}
			case 'lib': {
				DBG(`Set curLib to ${OL(str)}`)
				curLib = str;break;
			}
			case 'symbol':case 'guard': {
				if (defined(str)) {
					if (level === 0) {
						if (checkFiles) {
							assert(isFile(str), `No such file: ${str}`)
						}
						curLib = str
					}
					else if (defined(curLib)) {
						DBG(`ADD ${str} from ${curLib}`)
						aMap.set(str, curLib)
					}
					else {
						croak("curLib empty at level > 0")
					}
				}
				else {
					croak("undefined str!")
				};break;
			}
			default: {
				croak(`Unknown kind: ${kind}`)
			}
		}
	}
	resetOneIndent()
	return aMap
}

// ---------------------------------------------------------------------------

export const sourceLib = (
		symbol: string,
		m: Map<string,string> = symbolMap  // use global symbolMap by default
		): (string | undefined) => {

	if ((m === symbolMap) && (symbolMap.size === 0)) {
		const contents = slurp(symbolsPath)
		loadSymbols(contents, symbolMap, o`checkFiles`)
	}
	return m.get(symbol)
}

// ---------------------------------------------------------------------------

export const libsAndSymbols = (
		lSymbols: string[]
		): hashof<string[]> => {

	if ((symbolMap.size === 0) && isFile(symbolsPath)) {
		const contents = slurp(symbolsPath)
		loadSymbols(contents, symbolMap, o`checkFiles`)
	}

	const hLibs: hashof<string[]> = {}
	for (const sym of lSymbols) {
		const srcLib = sourceLib(sym)
		if (defined(srcLib)) {
			if (srcLib in hLibs) {
				hLibs[srcLib].push(sym)
			}
			else {
				hLibs[srcLib] = [sym]
			}
		}
	}
	return hLibs
}

// ---------------------------------------------------------------------------

export const getNeededImportStmts = (
		lSymbols: string[]
		): string[] => {

	DBG(`CALL getNeededImportStmts(${OL(lSymbols)})`)
	const hLibs = libsAndSymbols(lSymbols)
	DBGVALUE('hLibs', hLibs)
	const results=[];for (const lib of keys(hLibs)) {
		const lSyms = hLibs[lib]
		const strSyms = lSyms.join(', ')
		results.push(`import {${strSyms}} from '${lib}';`)
	};const lStmts =results
	return lStmts
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxzeW1ib2xzLmxpYi5jaXZldC50c3giLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcam9obmRcXHV0aWxzXFxzcmNcXGxpYlxcc3ltYm9scy5saWIuY2l2ZXQiXSwibWFwcGluZ3MiOiI7QUFBQSxvQkFBbUI7QUFDbkIsQUFBQTtBQUNBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUMzQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQztBQUNqQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVztBQUNuQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUMzQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDOUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRO0FBQ3JDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUM5QyxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLFNBQVMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO0FBQzlDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLO0FBQ2IsQUFBQSxBQUFBLE1B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aEMsQUFBQSxFQUFFLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BCLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUNoQixBQUFBO0FBQ0EsQUFBQSxDQUFDLEdBQUcsQ0FBQSxBQUFDLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQ2pELEFBQUEsQ0FBTSxNQUFMLEtBQUssQ0FBQyxDQUFFLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQztBQUNsQyxBQUFBLENBQUMsUUFBUSxDQUFBLEFBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFBO0FBQ3hCLEFBQUEsQyxLLEMsTyxHLENBQVcsR0FBRyxDQUFDLENBQUEsTUFBQSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDakMsQUFBQSxFQUFPLE1BQUwsS0FBSyxDQUFDLENBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0FBQ3JCLEFBQUEsRUFBUyxNQUFQLE9BQU8sQ0FBQyxDQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDN0IsQUFBQSxFLE8sTUFBRSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxFQUFFLEMsQztDQUFDLEMsQ0FIL0IsTUFBTixNQUFNLENBQUMsQyxPQUc4QjtBQUN0QyxBQUFBLENBQUMsTUFBTSxDQUFDLE07QUFBTSxDQUFBO0FBQ2QiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgc3ltYm9scy5saWIuY2l2ZXRcclxuXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGFzc2VydCwgY3JvYWssXHJcblx0aGFzaCwgaGFzaG9mLCBpc0VtcHR5LCBub25FbXB0eSxcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtcclxuXHRwYXNzLCBvLCBnZXRPcHRpb25zLCBrZXlzLFxyXG5cdH0gZnJvbSAnbGx1dGlscydcclxuaW1wb3J0IHtPTCwgTUx9IGZyb20gJ3RvLW5pY2UnXHJcbmltcG9ydCB7cmVzZXRPbmVJbmRlbnR9IGZyb20gJ2luZGVudCdcclxuaW1wb3J0IHtMT0csIERCRywgREJHVkFMVUUsIEVSUn0gZnJvbSAnbG9nZ2VyJ1xyXG5pbXBvcnQge1xyXG5cdFRQTExUb2tlbiwgVFRva2VuR2VuZXJhdG9yLCBhbGxUb2tlbnNJbkJsb2NrLFxyXG5cdH0gZnJvbSAncGxsJ1xyXG5pbXBvcnQge2lzRmlsZSwgc2x1cnB9IGZyb20gJ2ZzeXMnXHJcblxyXG4vKipcclxuICogQG1vZHVsZSBzeW1ib2xzIC0gbG9jYXRlIGNvbW1vbiBzeW1ib2xzXHJcbiAqICAgIHBhcnNlcyBhIGZpbGUgKGRlZmF1bHQ6IHNyYy8uc3ltYm9scykgdGhhdCBsb29rcyBsaWtlOlxyXG4gKiAgICAgICBzcmMvbGliL2luZGVudC5saWIudHNcclxuICogICAgICAgICAgb25lSW5kZW50IHJlc2V0T25lSW5kZW50IGluZGVudExldmVsXHJcbiAqICAgICAgICAgIGxpbmVEZXNjIHNwbGl0TGluZSBpbmRlbnRlZFxyXG4gKiAgICAgICBzcmMvbGliL2ZzLmxpYi50c1xyXG4gKiAgICAgICAgICBpc0ZpbGUgaXNEaXJcclxuICogICAgICAgICAgZmlsZUV4dCB3aXRoRXh0XHJcbiAqXHJcbiAqICAgIGFuZCBpbXBsZW1lbnRzIGZ1bmN0aW9uOlxyXG4gKiAgICAgICBzb3VyY2VMaWIgOj0gKHN5bWJvbDogc3RyaW5nKTogc3RyaW5nP1xyXG4gKi9cclxuXHJcbiMgLS0tIG5vdCBleHBvcnRlZCFcclxuXHJcbiMgLS0tIHs8c3ltPjogPGxpYj4sIC4uLn1cclxuc3ltYm9sc1BhdGggOj0gJ3NyYy8uc3ltYm9scydcclxuXHJcbiMgLS0tIGhvbGRzIHN5bWJvbHMgaW4gc3ltYm9sc1BhdGgsXHJcbiMgICAgIGJ1dCBvbmx5IGxvYWRlZCB3aGVuIG5lZWRlZFxyXG4jICAgICBhbmQgb25seSBpZiBmaWxlIGV4aXN0c1xyXG5zeW1ib2xNYXAgOj0gbmV3IE1hcDxzdHJpbmcsc3RyaW5nPigpXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuZXhwb3J0IGxvYWRTeW1ib2xzIDo9IChcclxuXHRcdGJsb2NrOiBzdHJpbmdcclxuXHRcdGFNYXAgPSBuZXcgTWFwPHN0cmluZyxzdHJpbmc+KClcclxuXHRcdGhPcHRpb25zOiBoYXNoPXt9XHJcblx0XHQpOiBNYXA8c3RyaW5nLHN0cmluZz4gPT5cclxuXHJcblx0REJHIFwiaW4gbG9hZFN5bWJvbHMoKVwiXHJcblxyXG5cdCMgLS0tIENoZWNrIGlmIGxpYnJhcmllcyBhY3R1YWxseSBleGlzdFxyXG5cdHR5cGUgb3B0ID0ge1xyXG5cdFx0Y2hlY2tGaWxlczogYm9vbGVhblxyXG5cdFx0fVxyXG5cdHtjaGVja0ZpbGVzfSA6PSBnZXRPcHRpb25zPG9wdD4gaE9wdGlvbnMsIHtcclxuXHRcdGNoZWNrRmlsZXM6IGZhbHNlXHJcblx0XHR9XHJcblxyXG5cdGxldCBsZXZlbCA9IDAgICAjIC0tLSBzeW1HZW4gbXVzdCBrbm93IHRoZSBjdXJyZW50IGxldmVsXHJcblxyXG5cdHN5bUdlbjogVFRva2VuR2VuZXJhdG9yIDo9IChsaW5lOiBzdHJpbmcpIC0+XHJcblxyXG5cdFx0aWYgKGxldmVsID09IDApXHJcblx0XHRcdHlpZWxkIHtraW5kOiAnbGliJywgc3RyOiBsaW5lfVxyXG5cdFx0ZWxzZSBpZiAobGV2ZWwgPT0gMSlcclxuXHRcdFx0Zm9yIHN0ciBvZiBsaW5lLnNwbGl0KC9cXHMrLylcclxuXHRcdFx0XHR5aWVsZCB7a2luZDogJ3N5bWJvbCcsIHN0cn1cclxuXHRcdGVsc2VcclxuXHRcdFx0RVJSIFwibGV2ZWwgPSAje2xldmVsfVwiXHJcblx0XHRcdGNyb2FrIFwibGV2ZWwgPSAje2xldmVsfVwiXHJcblx0XHRyZXR1cm5cclxuXHJcblx0bGV0IGN1ckxpYjogc3RyaW5nPyA9IHVuZGVmXHJcblx0Zm9yIHtraW5kLCBzdHJ9IG9mIGFsbFRva2Vuc0luQmxvY2soYmxvY2ssIHN5bUdlbilcclxuXHRcdERCRyBcIlRPS0VOOiAje2tpbmR9XCJcclxuXHRcdHN3aXRjaCBraW5kXHJcblx0XHRcdHdoZW4gJ2luZGVudCdcclxuXHRcdFx0XHRsZXZlbCArPSAxXHJcblx0XHRcdHdoZW4gJ3VuZGVudCdcclxuXHRcdFx0XHRsZXZlbCAtPSAxXHJcblx0XHRcdHdoZW4gJ2xpYidcclxuXHRcdFx0XHREQkcgXCJTZXQgY3VyTGliIHRvICN7T0woc3RyKX1cIlxyXG5cdFx0XHRcdGN1ckxpYiA9IHN0clxyXG5cdFx0XHR3aGVuICdzeW1ib2wnLCAnZ3VhcmQnXHJcblx0XHRcdFx0aWYgZGVmaW5lZChzdHIpXHJcblx0XHRcdFx0XHRpZiAobGV2ZWwgPT0gMClcclxuXHRcdFx0XHRcdFx0aWYgY2hlY2tGaWxlc1xyXG5cdFx0XHRcdFx0XHRcdGFzc2VydCBpc0ZpbGUoc3RyKSwgXCJObyBzdWNoIGZpbGU6ICN7c3RyfVwiXHJcblx0XHRcdFx0XHRcdGN1ckxpYiA9IHN0clxyXG5cdFx0XHRcdFx0ZWxzZSBpZiBkZWZpbmVkKGN1ckxpYilcclxuXHRcdFx0XHRcdFx0REJHIFwiQUREICN7c3RyfSBmcm9tICN7Y3VyTGlifVwiXHJcblx0XHRcdFx0XHRcdGFNYXAuc2V0IHN0ciwgY3VyTGliXHJcblx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdGNyb2FrIFwiY3VyTGliIGVtcHR5IGF0IGxldmVsID4gMFwiXHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0Y3JvYWsgXCJ1bmRlZmluZWQgc3RyIVwiXHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHRjcm9hayBcIlVua25vd24ga2luZDogI3traW5kfVwiXHJcblx0cmVzZXRPbmVJbmRlbnQoKVxyXG5cdHJldHVybiBhTWFwXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuZXhwb3J0IHNvdXJjZUxpYiA6PSAoXHJcblx0XHRzeW1ib2w6IHN0cmluZ1xyXG5cdFx0bTogTWFwPHN0cmluZyxzdHJpbmc+ID0gc3ltYm9sTWFwICAjIHVzZSBnbG9iYWwgc3ltYm9sTWFwIGJ5IGRlZmF1bHRcclxuXHRcdCk6IHN0cmluZz8gPT5cclxuXHJcblx0aWYgKG0gPT0gc3ltYm9sTWFwKSAmJiAoc3ltYm9sTWFwLnNpemUgPT0gMClcclxuXHRcdGNvbnRlbnRzIDo9IHNsdXJwKHN5bWJvbHNQYXRoKVxyXG5cdFx0bG9hZFN5bWJvbHMoY29udGVudHMsIHN5bWJvbE1hcCwgb1wiY2hlY2tGaWxlc1wiKVxyXG5cdHJldHVybiBtLmdldChzeW1ib2wpXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuZXhwb3J0IGxpYnNBbmRTeW1ib2xzIDo9IChcclxuXHRcdGxTeW1ib2xzOiBzdHJpbmdbXVxyXG5cdFx0KTogaGFzaG9mPHN0cmluZ1tdPiA9PlxyXG5cclxuXHRpZiAoc3ltYm9sTWFwLnNpemUgPT0gMCkgJiYgaXNGaWxlKHN5bWJvbHNQYXRoKVxyXG5cdFx0Y29udGVudHMgOj0gc2x1cnAoc3ltYm9sc1BhdGgpXHJcblx0XHRsb2FkU3ltYm9scyhjb250ZW50cywgc3ltYm9sTWFwLCBvJ2NoZWNrRmlsZXMnKVxyXG5cclxuXHRoTGliczogaGFzaG9mPHN0cmluZ1tdPiA6PSB7fVxyXG5cdGZvciBzeW0gb2YgbFN5bWJvbHNcclxuXHRcdHNyY0xpYiA6PSBzb3VyY2VMaWIoc3ltKVxyXG5cdFx0aWYgZGVmaW5lZChzcmNMaWIpXHJcblx0XHRcdGlmIChzcmNMaWIgaW4gaExpYnMpXHJcblx0XHRcdFx0aExpYnNbc3JjTGliXS5wdXNoIHN5bVxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0aExpYnNbc3JjTGliXSA9IFtzeW1dXHJcblx0cmV0dXJuIGhMaWJzXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuZXhwb3J0IGdldE5lZWRlZEltcG9ydFN0bXRzIDo9IChcclxuXHRcdGxTeW1ib2xzOiBzdHJpbmdbXVxyXG5cdFx0KTogc3RyaW5nW10gPT5cclxuXHJcblx0REJHIFwiQ0FMTCBnZXROZWVkZWRJbXBvcnRTdG10cygje09MKGxTeW1ib2xzKX0pXCJcclxuXHRoTGlicyA6PSBsaWJzQW5kU3ltYm9scyhsU3ltYm9scylcclxuXHREQkdWQUxVRSAnaExpYnMnLCBoTGlic1xyXG5cdGxTdG10cyA6PSBmb3IgbGliIG9mIGtleXMoaExpYnMpXHJcblx0XHRsU3ltcyA6PSBoTGlic1tsaWJdXHJcblx0XHRzdHJTeW1zIDo9IGxTeW1zLmpvaW4oJywgJylcclxuXHRcdFwiaW1wb3J0IHsje3N0clN5bXN9fSBmcm9tICcje2xpYn0nO1wiXHJcblx0cmV0dXJuIGxTdG10c1xyXG4iXX0=