"use strict";
// symbols.lib.civet

import {
	undef, defined, notdefined, assert,
	hash, hashof, nonEmpty,
	} from './datatypes.lib.ts'
import {
	pass, OL, ML, croak, o, getOptions, hasKey, keys,
	} from './llutils.lib.ts'
import {LOG, DBG, DBGVALUE} from './logger.lib.ts'
import {resetOneIndent} from './indent.lib.ts'
import {
	TPLLToken, TTokenGenerator, allTokensInBlock,
	} from './pll.lib.ts'
import {isFile, slurp} from './fs.lib.ts'

/**
 * @module symbols - locate common symbols
 *    parses a file (default: src/.symbols) that looks like:
 *       src/lib/indent.lib.ts
 *          oneIndent resetOneIndent indentLevel
 *          lineDesc splitLine indented
 *       src/lib/fs.lib.ts
 *          isFile isDir
 *          fileExt withExt
 *
 *    and implements function:
 *       sourceLib := (symbol: string): string?
 */

// --- not exported!
let hSymbols: hashof<string> = {}     // --- {<sym>: <lib>, ...}

// ---------------------------------------------------------------------------

export const loadSymbols = (
		strSymbols: string,
		hOptions: hash={}
		): hashof<string> => {

	// --- Check if libraries actually exist
	const {checkFiles} = getOptions(hOptions, {
		checkFiles: false
		})

	let level = 0   // --- symGen must know the current level

	const symGen: TTokenGenerator = function*(line: string) {

		if (level === 0) {
			yield {kind: 'lib', str: line}
		}
		else if (level === 1) {
			for (const str of line.split(/\s+/)) {
				yield {kind: 'symbol', str}
			}
		}
		else {
			croak(`level = ${level}`)
		}
		return
	}

	const hSymbols: hashof<string> = {}  // --- {<symbol>: <lib>, ...}
	let curLib: (string | undefined) = undef
	for (const {kind, str} of allTokensInBlock(strSymbols, symGen)) {
		switch(kind) {
			case 'indent': {
				level += 1;break;
			}
			case 'undent': {
				level -= 1;break;
			}
			case 'lib': {
				curLib = str;break;
			}
			case 'symbol':case 'guard': {
				assert(defined(str), "undefined str!")
				if (level === 0) {
					if (checkFiles) {
						assert(isFile(str), `No such file: ${str}`)
					}
					curLib = str
				}
				else if (defined(curLib)) {
					DBG(`ADD ${str} from ${curLib}`)
					hSymbols[str] = curLib
				}
				else {
					croak("curLib empty at level > 0")
				};break;
			}
			default: {
				croak(`Unknown kind: ${kind}`)
			}
		}
	}
	resetOneIndent()
	return hSymbols
}

// ---------------------------------------------------------------------------

export const sourceLib = (
		symbol: string,
		h: hashof<string>=hSymbols
		): string => {

	return h[symbol]
}

// ---------------------------------------------------------------------------

export const libsAndSymbols = (
		lSymbols: string[]
		): hashof<string[]> => {

	const hLibs: hashof<string[]> = {}
	for (const sym of lSymbols) {
		const srcLib = sourceLib(sym)
		if (defined(srcLib)) {
			if (hasKey(hLibs, srcLib)) {
				hLibs[srcLib].push(sym)
			}
			else {
				hLibs[srcLib] = [sym]
			}
		}
	}
	return hLibs
}

// ---------------------------------------------------------------------------

export const getNeededImportStmts = (
		lSymbols: string[]
		): string[] => {

	DBG(`CALL getNeededImportStmts(${OL(lSymbols)})`)
	const hLibs = libsAndSymbols(lSymbols)
	DBGVALUE('hLibs', hLibs)
	const results=[];for (const lib of keys(hLibs)) {
		const lSyms = hLibs[lib]
		const strSyms = lSyms.join(', ')
		if (lib.match(/^[A-Za-z][A-Za-z0-9_]*$/)) {
			results.push(`import {${strSyms}} from '${lib}';`)
		}
		else if (lib.match(/^[\@\.\/]/)) {
			results.push(`import {${strSyms}} from '${lib}';`)
		}
		else {
			results.push(`import {${strSyms}} from './${lib}';`)
		}
	};const lStmts =results
	return lStmts
}

// ---------------------------------------------------------------------------

if (isFile('src/.symbols')) {
	const contents = slurp('src/.symbols')
	hSymbols = loadSymbols(contents, o`checkFiles`)
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9zeW1ib2xzLmxpYi5jaXZldC50c3giLCJzb3VyY2VzIjpbInNyYy9saWIvc3ltYm9scy5saWIuY2l2ZXQiXSwibWFwcGluZ3MiOiI7QUFBQSxvQkFBbUI7QUFDbkIsQUFBQTtBQUNBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNwQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQztBQUN4QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CO0FBQzVCLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2xELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0I7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDbEQsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDOUMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYztBQUN0QixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWE7QUFDekMsQUFBQTtBQUNBLEFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FB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Q0FBQTtBQUNoRCIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBzeW1ib2xzLmxpYi5jaXZldFxyXG5cclxuaW1wb3J0IHtcclxuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCwgYXNzZXJ0LFxyXG5cdGhhc2gsIGhhc2hvZiwgbm9uRW1wdHksXHJcblx0fSBmcm9tICcuL2RhdGF0eXBlcy5saWIudHMnXHJcbmltcG9ydCB7XHJcblx0cGFzcywgT0wsIE1MLCBjcm9haywgbywgZ2V0T3B0aW9ucywgaGFzS2V5LCBrZXlzLFxyXG5cdH0gZnJvbSAnLi9sbHV0aWxzLmxpYi50cydcclxuaW1wb3J0IHtMT0csIERCRywgREJHVkFMVUV9IGZyb20gJy4vbG9nZ2VyLmxpYi50cydcclxuaW1wb3J0IHtyZXNldE9uZUluZGVudH0gZnJvbSAnLi9pbmRlbnQubGliLnRzJ1xyXG5pbXBvcnQge1xyXG5cdFRQTExUb2tlbiwgVFRva2VuR2VuZXJhdG9yLCBhbGxUb2tlbnNJbkJsb2NrLFxyXG5cdH0gZnJvbSAnLi9wbGwubGliLnRzJ1xyXG5pbXBvcnQge2lzRmlsZSwgc2x1cnB9IGZyb20gJy4vZnMubGliLnRzJ1xyXG5cclxuLyoqXHJcbiAqIEBtb2R1bGUgc3ltYm9scyAtIGxvY2F0ZSBjb21tb24gc3ltYm9sc1xyXG4gKiAgICBwYXJzZXMgYSBmaWxlIChkZWZhdWx0OiBzcmMvLnN5bWJvbHMpIHRoYXQgbG9va3MgbGlrZTpcclxuICogICAgICAgc3JjL2xpYi9pbmRlbnQubGliLnRzXHJcbiAqICAgICAgICAgIG9uZUluZGVudCByZXNldE9uZUluZGVudCBpbmRlbnRMZXZlbFxyXG4gKiAgICAgICAgICBsaW5lRGVzYyBzcGxpdExpbmUgaW5kZW50ZWRcclxuICogICAgICAgc3JjL2xpYi9mcy5saWIudHNcclxuICogICAgICAgICAgaXNGaWxlIGlzRGlyXHJcbiAqICAgICAgICAgIGZpbGVFeHQgd2l0aEV4dFxyXG4gKlxyXG4gKiAgICBhbmQgaW1wbGVtZW50cyBmdW5jdGlvbjpcclxuICogICAgICAgc291cmNlTGliIDo9IChzeW1ib2w6IHN0cmluZyk6IHN0cmluZz9cclxuICovXHJcblxyXG4jIC0tLSBub3QgZXhwb3J0ZWQhXHJcbmxldCBoU3ltYm9sczogaGFzaG9mPHN0cmluZz4gPSB7fSAgICAgIyAtLS0gezxzeW0+OiA8bGliPiwgLi4ufVxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCBsb2FkU3ltYm9scyA6PSAoXHJcblx0XHRzdHJTeW1ib2xzOiBzdHJpbmdcclxuXHRcdGhPcHRpb25zOiBoYXNoPXt9XHJcblx0XHQpOiBoYXNob2Y8c3RyaW5nPiA9PlxyXG5cclxuXHQjIC0tLSBDaGVjayBpZiBsaWJyYXJpZXMgYWN0dWFsbHkgZXhpc3RcclxuXHR7Y2hlY2tGaWxlc30gOj0gZ2V0T3B0aW9ucyBoT3B0aW9ucywge1xyXG5cdFx0Y2hlY2tGaWxlczogZmFsc2VcclxuXHRcdH1cclxuXHJcblx0bGV0IGxldmVsID0gMCAgICMgLS0tIHN5bUdlbiBtdXN0IGtub3cgdGhlIGN1cnJlbnQgbGV2ZWxcclxuXHJcblx0c3ltR2VuOiBUVG9rZW5HZW5lcmF0b3IgOj0gKGxpbmU6IHN0cmluZykgLT5cclxuXHJcblx0XHRpZiAobGV2ZWwgPT0gMClcclxuXHRcdFx0eWllbGQge2tpbmQ6ICdsaWInLCBzdHI6IGxpbmV9XHJcblx0XHRlbHNlIGlmIChsZXZlbCA9PSAxKVxyXG5cdFx0XHRmb3Igc3RyIG9mIGxpbmUuc3BsaXQoL1xccysvKVxyXG5cdFx0XHRcdHlpZWxkIHtraW5kOiAnc3ltYm9sJywgc3RyfVxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRjcm9hayBcImxldmVsID0gI3tsZXZlbH1cIlxyXG5cdFx0cmV0dXJuXHJcblxyXG5cdGhTeW1ib2xzOiBoYXNob2Y8c3RyaW5nPiA6PSB7fSAgIyAtLS0gezxzeW1ib2w+OiA8bGliPiwgLi4ufVxyXG5cdGxldCBjdXJMaWI6IHN0cmluZz8gPSB1bmRlZlxyXG5cdGZvciB7a2luZCwgc3RyfSBvZiBhbGxUb2tlbnNJbkJsb2NrKHN0clN5bWJvbHMsIHN5bUdlbilcclxuXHRcdHN3aXRjaCBraW5kXHJcblx0XHRcdHdoZW4gJ2luZGVudCdcclxuXHRcdFx0XHRsZXZlbCArPSAxXHJcblx0XHRcdHdoZW4gJ3VuZGVudCdcclxuXHRcdFx0XHRsZXZlbCAtPSAxXHJcblx0XHRcdHdoZW4gJ2xpYidcclxuXHRcdFx0XHRjdXJMaWIgPSBzdHJcclxuXHRcdFx0d2hlbiAnc3ltYm9sJywgJ2d1YXJkJ1xyXG5cdFx0XHRcdGFzc2VydCBkZWZpbmVkKHN0ciksIFwidW5kZWZpbmVkIHN0ciFcIlxyXG5cdFx0XHRcdGlmIChsZXZlbCA9PSAwKVxyXG5cdFx0XHRcdFx0aWYgY2hlY2tGaWxlc1xyXG5cdFx0XHRcdFx0XHRhc3NlcnQgaXNGaWxlKHN0ciksIFwiTm8gc3VjaCBmaWxlOiAje3N0cn1cIlxyXG5cdFx0XHRcdFx0Y3VyTGliID0gc3RyXHJcblx0XHRcdFx0ZWxzZSBpZiBkZWZpbmVkKGN1ckxpYilcclxuXHRcdFx0XHRcdERCRyBcIkFERCAje3N0cn0gZnJvbSAje2N1ckxpYn1cIlxyXG5cdFx0XHRcdFx0aFN5bWJvbHNbc3RyXSA9IGN1ckxpYlxyXG5cdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdGNyb2FrIFwiY3VyTGliIGVtcHR5IGF0IGxldmVsID4gMFwiXHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHRjcm9hayBcIlVua25vd24ga2luZDogI3traW5kfVwiXHJcblx0cmVzZXRPbmVJbmRlbnQoKVxyXG5cdHJldHVybiBoU3ltYm9sc1xyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCBzb3VyY2VMaWIgOj0gKFxyXG5cdFx0c3ltYm9sOiBzdHJpbmdcclxuXHRcdGg6IGhhc2hvZjxzdHJpbmc+PWhTeW1ib2xzXHJcblx0XHQpOiBzdHJpbmcgPT5cclxuXHJcblx0cmV0dXJuIGhbc3ltYm9sXVxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCBsaWJzQW5kU3ltYm9scyA6PSAoXHJcblx0XHRsU3ltYm9sczogc3RyaW5nW11cclxuXHRcdCk6IGhhc2hvZjxzdHJpbmdbXT4gPT5cclxuXHJcblx0aExpYnM6IGhhc2hvZjxzdHJpbmdbXT4gOj0ge31cclxuXHRmb3Igc3ltIG9mIGxTeW1ib2xzXHJcblx0XHRzcmNMaWIgOj0gc291cmNlTGliKHN5bSlcclxuXHRcdGlmIGRlZmluZWQoc3JjTGliKVxyXG5cdFx0XHRpZiBoYXNLZXkoaExpYnMsIHNyY0xpYilcclxuXHRcdFx0XHRoTGlic1tzcmNMaWJdLnB1c2ggc3ltXHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHRoTGlic1tzcmNMaWJdID0gW3N5bV1cclxuXHRyZXR1cm4gaExpYnNcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgZ2V0TmVlZGVkSW1wb3J0U3RtdHMgOj0gKFxyXG5cdFx0bFN5bWJvbHM6IHN0cmluZ1tdXHJcblx0XHQpOiBzdHJpbmdbXSA9PlxyXG5cclxuXHREQkcgXCJDQUxMIGdldE5lZWRlZEltcG9ydFN0bXRzKCN7T0wobFN5bWJvbHMpfSlcIlxyXG5cdGhMaWJzIDo9IGxpYnNBbmRTeW1ib2xzKGxTeW1ib2xzKVxyXG5cdERCR1ZBTFVFICdoTGlicycsIGhMaWJzXHJcblx0bFN0bXRzIDo9IGZvciBsaWIgb2Yga2V5cyhoTGlicylcclxuXHRcdGxTeW1zIDo9IGhMaWJzW2xpYl1cclxuXHRcdHN0clN5bXMgOj0gbFN5bXMuam9pbignLCAnKVxyXG5cdFx0aWYgbGliLm1hdGNoKC9eW0EtWmEtel1bQS1aYS16MC05X10qJC8pXHJcblx0XHRcdFwiaW1wb3J0IHsje3N0clN5bXN9fSBmcm9tICcje2xpYn0nO1wiXHJcblx0XHRlbHNlIGlmIGxpYi5tYXRjaCgvXltcXEBcXC5cXC9dLylcclxuXHRcdFx0XCJpbXBvcnQgeyN7c3RyU3ltc319IGZyb20gJyN7bGlifSc7XCJcclxuXHRcdGVsc2VcclxuXHRcdFx0XCJpbXBvcnQgeyN7c3RyU3ltc319IGZyb20gJy4vI3tsaWJ9JztcIlxyXG5cdHJldHVybiBsU3RtdHNcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5pZiBpc0ZpbGUoJ3NyYy8uc3ltYm9scycpXHJcblx0Y29udGVudHMgOj0gc2x1cnAoJ3NyYy8uc3ltYm9scycpXHJcblx0aFN5bWJvbHMgPSBsb2FkU3ltYm9scyhjb250ZW50cywgb1wiY2hlY2tGaWxlc1wiKVxyXG4iXX0=