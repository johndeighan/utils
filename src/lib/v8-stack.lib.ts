"use strict";
// v8-stack.lib.civet

import {sprintf} from '@std/fmt/printf'

import {sep} from 'base-utils'
import {
	undef, defined, notdefined, assert, croak,
	isEmpty, nonEmpty, hash,
	isString, isNonEmptyString, isInteger,
	} from 'datatypes'
import {rpad} from 'llutils'
import {OL, ML} from 'to-nice'
import {DBG, LOG, WARN, ERR, INDENT, UNDENT} from 'logger'
import {
	isFile, mkpath, fileExt, withExt,
	normalizePath, relpath,
	} from 'fsys'
import {
	mapSourcePos,
	} from 'source-map'

const width = 40

// ---------------------------------------------------------------------------

export type TFrameType = 'eval'|'native'|'constructor'|'method'|'function'|'script'|'unknown'

export type TStackFrame = {
	type: TFrameType
	fileName: string      // source file name
	line: number
	column: number
	name: string        // name of function or method
	isConstructor: boolean
	isAsync: boolean
	objType?: string    // --- if type == 'method'
	}

// ---------------------------------------------------------------------------

/**
 * Get the runtime stack from the v8 engine
 * ignores any stack frames from this module
 * files will be mapped to original source files
 * 	if a source map is available
 */

export const getV8Stack = (): TStackFrame[] => {
	// --- ignores any stack frames from this module
	//     files will be mapped to original source files
	//        if a source map is available

	try {
		// @ts-ignore
		const oldLimit = Error.stackTraceLimit

		// @ts-ignore
		const oldPreparer = Error.prepareStackTrace

		// @ts-ignore
		Error.stackTraceLimit = Infinity

		// @ts-ignore
		Error.prepareStackTrace = (error, lFrames) => {
			const lResultFrames: TStackFrame[] = []
			DBG(`getV8Stack(): ${lFrames.length} stack frames`)
			let i1 = 0;for (const frame of lFrames) {const i = i1++;

				DBG(`FRAME ${i}`, INDENT)

				// --- Call functions on the frame
				const fileName: string = frame.getFileName() || 'unknown'
				const functionName     = frame.getFunctionName()
				const functionObj      = frame.getFunction()
				const methodName       = frame.getMethodName()
				const line             = frame.getLineNumber()
				const column           = frame.getColumnNumber()
				const isTopLevel       = frame.isToplevel()
				const isAsync          = frame.isAsync()
				const isEval           = frame.isEval()
				const isNative         = frame.isNative()
				const isConstructor    = frame.isConstructor()
				const typeName         = frame.getTypeName()

				DBG(sep('from V8', '-', width))
				DBG(`fileName = ${OL(fileName)}`)
				DBG(`functionName = ${OL(functionName)}`)
				DBG(`defined(functionObj) = ${OL(defined(functionObj))}`)
				DBG(`methodName = ${OL(methodName)}`)
				DBG(`line = ${OL(line)}`)
				DBG(`column = ${OL(column)}`)
				DBG(`isTopLevel = ${OL(isTopLevel)}`)
				DBG(`isAsync = ${OL(isAsync)}`)
				DBG(`isEval = ${OL(isEval)}`)
				DBG(`isNative = ${OL(isNative)}`)
				DBG(`isConstructor = ${OL(isConstructor)}`)
				DBG(`typeName = ${OL(typeName)}`)
				DBG('-'.repeat(width))

				if (fileName.match(/v8-stack\.lib\.[A-Za-z0-9_]+$/)) {
					DBG(`SKIP: fileName = '${fileName}'`, UNDENT)
					continue
				}

				const h: TStackFrame = {
					type: (
						  isEval                ? 'eval'
						: isNative              ? 'native'
						: isConstructor         ? 'constructor'
						: defined(methodName)   ? 'method'
						: defined(functionName) ? 'function'
						: isTopLevel            ? 'script'
						:                         'unknown'
						),
					fileName,
					line,
					column,
					name: (
						  isString(functionName) ? functionName
						: defined(functionObj)   ? '<anon>'
						: isString(methodName)   ? methodName
						:                         ''
						),
					isConstructor,
					isAsync,
					...(defined(methodName) && {objType: typeName})
					}

				// --- fix a bug in the V8 engine where calls inside a
				//     top level anonymous function is reported as
				//     being from the top level, i.e. type 'script'

				const tos = lResultFrames.at(-1)    // --- i.e. previous frame
				if (tos !== undef) {
					if ((h.type === 'script') && (tos.type === 'script')) {
						DBG(`Patch current TOS (currently ${lResultFrames.length} frames)`)
						tos.type = 'function'
						tos.name = '<anon>'
					}
				}

				DBG(sep('return frame', '-', width))
				DBG(ML(h))
				DBG('-'.repeat(width))

				// --- Ignore this entry and any before it
				if (h.objType === 'ModuleJob') {
					DBG("objType is 'ModuleJob' - stop processing")
					break
				}

				lResultFrames.push(h)
				DBG(UNDENT)
			}

			DBG('-'.repeat(width))
			return lResultFrames
		}

		const errObj = new Error()

		// @ts-ignore - because errObj.stack will be an array
		const lStack: TStackFrame[] = errObj.stack || []

		// --- reset to previous values

		// @ts-ignore
		Error.stackTraceLimit = oldLimit

		// @ts-ignore
		Error.prepareStackTrace = oldPreparer

		for (const h of lStack) {
			DBG(`before mapping, h = ${ML(h)}`)
			const {fileName, line, column, name, type} = h
			const hNew = mapSourcePos({
				path: fileName,
				line,
				column
				})
			const newExt = fileExt(hNew.path)
			if (newExt === fileExt(h.fileName)) {
				DBG("Not mapped - returning original position")
				h.fileName = relpath(h.fileName)
			}
			else {
				DBG(`Mapped, hNew = ${ML(hNew)}`)
				h.fileName = relpath(withExt(h.fileName, newExt))
				h.line = hNew.line
				h.column = hNew.column
				DBG(`after mapping, h = ${ML(h)}`)
			}
		}

		return lStack
	}
	catch (e) {
		// @ts-ignore
		ERR(e.message)
		return []
	}
}

// ---------------------------------------------------------------------------

export const getV8StackStr = (): string => {

	const lLines = getV8Stack().map((h) => {
		const {type, name, fileName, line, column} = h
		let ref;
			if (name) {
				ref = sprintf("%-18s", `${type} ${name}`)
			}
			else {
				ref = sprintf("%-18s", `${type}`)
			};const nameStr =ref
		return `[${nameStr}] ${fileName}:${line}:${column}`
	}
		)
	return lLines.join('\n')
}

// ---------------------------------------------------------------------------

/**
 * Get the current function's caller
 */

export const getMyCaller = (): (TStackFrame | undefined) => {

	try {
		const lStack = getV8Stack()
		if (defined(lStack) && (lStack.length > 0)) {
			return lStack[1]
		}
		else {
			return undef
		}
	}
	catch (err) {
		if (err instanceof Error) {
			LOG(`ERROR in getV8Stack(): ${err.message}`)
		}
		return undef
	}
}

// ---------------------------------------------------------------------------

/**
 * Get the current function's caller, ignoring any calls
 * from the same module
 */

export const getMyOutsideCaller = (): (TStackFrame | undefined) => {

	try {
		const lStack = getV8Stack()
		DBG(`Call stack has ${lStack.length} items`)
		if (lStack.length === 0) {
			return undef
		}
		const {fileName} = lStack[0]
		DBG(`fileName = ${fileName}`)
		let i2 = 0;for (const frame of lStack) {const i = i2++;
			DBG(`frame[${i}].fileName = ${frame.fileName}`)
			if (frame.fileName !== fileName) {
				return frame
			}
		}
		return undef
	}
	catch (err) {
		if (err instanceof Error) {
			LOG(`ERROR in getV8Stack(): ${err.message}`)
		}
		return undef
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFx2OC1zdGFjay5saWIuY2l2ZXQudHN4Iiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGpvaG5kXFx1dGlsc1xcc3JjXFxsaWJcXHY4LXN0YWNrLmxpYi5jaXZldCJdLCJtYXBwaW5ncyI6IjtBQUFBLHFCQUFvQjtBQUNwQixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCO0FBQ3ZDLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVk7QUFDOUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDM0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDekIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUN2QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVztBQUNuQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDNUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQzlCLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUMxRCxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FB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USxNQUFOLE1BQU0sQ0FBQyxDQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDeEIsQUFBQSxFQUFFLEdBQUcsQ0FBQSxBQUFDLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUE7QUFDN0MsQUFBQSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQ3pCLEFBQUEsR0FBRyxNQUFNLENBQUMsSztFQUFLLENBQUE7QUFDZixBQUFBLEVBQVksTUFBVixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLEFBQUEsRUFBRSxHQUFHLENBQUEsQUFBQyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFBO0FBQzlCLEFBQUEsRSxJLEUsSSxDQUFFLEdBQUcsQ0FBQyxDQUFBLE1BQUEsS0FBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUEsQ0FBQSxDQUFYLE1BQUEsQyxHLEUsRSxDQUFXO0FBQ3ZCLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0FBQ2pELEFBQUEsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFFLENBQUMsUUFBUSxDQUFDLENBQUEsQ0FBQTtBQUNsQyxBQUFBLElBQUksTUFBTSxDQUFDLEs7R0FBSyxDO0VBQUEsQ0FBQTtBQUNoQixBQUFBLEVBQUUsTUFBTSxDQUFDLEs7Q0FBSyxDQUFBO0FBQ2QsQUFBQSxDQUFDLEtBQUssQ0FBQyxDQUFBLEdBQUcsQ0FBQSxDQUFBLENBQUE7QUFDVixBQUFBLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUEsQ0FBQTtBQUMzQixBQUFBLEdBQUcsR0FBRyxDQUFBLEFBQUMsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQztFQUFBLENBQUE7QUFDOUMsQUFBQSxFQUFFLE1BQU0sQ0FBQyxLO0NBQUssQztBQUFBLENBQUE7QUFDZCIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyB2OC1zdGFjay5saWIuY2l2ZXRcclxuXHJcbmltcG9ydCB7c3ByaW50Zn0gZnJvbSAnQHN0ZC9mbXQvcHJpbnRmJ1xyXG5cclxuaW1wb3J0IHtzZXB9IGZyb20gJ2Jhc2UtdXRpbHMnXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGFzc2VydCwgY3JvYWssXHJcblx0aXNFbXB0eSwgbm9uRW1wdHksIGhhc2gsXHJcblx0aXNTdHJpbmcsIGlzTm9uRW1wdHlTdHJpbmcsIGlzSW50ZWdlcixcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtycGFkfSBmcm9tICdsbHV0aWxzJ1xyXG5pbXBvcnQge09MLCBNTH0gZnJvbSAndG8tbmljZSdcclxuaW1wb3J0IHtEQkcsIExPRywgV0FSTiwgRVJSLCBJTkRFTlQsIFVOREVOVH0gZnJvbSAnbG9nZ2VyJ1xyXG5pbXBvcnQge1xyXG5cdGlzRmlsZSwgbWtwYXRoLCBmaWxlRXh0LCB3aXRoRXh0LFxyXG5cdG5vcm1hbGl6ZVBhdGgsIHJlbHBhdGgsXHJcblx0fSBmcm9tICdmc3lzJ1xyXG5pbXBvcnQge1xyXG5cdG1hcFNvdXJjZVBvcyxcclxuXHR9IGZyb20gJ3NvdXJjZS1tYXAnXHJcblxyXG53aWR0aCA6PSA0MFxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCB0eXBlIFRGcmFtZVR5cGUgPSAnZXZhbCd8J25hdGl2ZSd8J2NvbnN0cnVjdG9yJ3wnbWV0aG9kJ3wnZnVuY3Rpb24nfCdzY3JpcHQnfCd1bmtub3duJ1xyXG5cclxuZXhwb3J0IHR5cGUgVFN0YWNrRnJhbWUgPSB7XHJcblx0dHlwZTogVEZyYW1lVHlwZVxyXG5cdGZpbGVOYW1lOiBzdHJpbmcgICAgICAjIHNvdXJjZSBmaWxlIG5hbWVcclxuXHRsaW5lOiBudW1iZXJcclxuXHRjb2x1bW46IG51bWJlclxyXG5cdG5hbWU6IHN0cmluZyAgICAgICAgIyBuYW1lIG9mIGZ1bmN0aW9uIG9yIG1ldGhvZFxyXG5cdGlzQ29uc3RydWN0b3I6IGJvb2xlYW5cclxuXHRpc0FzeW5jOiBib29sZWFuXHJcblx0b2JqVHlwZT86IHN0cmluZyAgICAjIC0tLSBpZiB0eXBlID09ICdtZXRob2QnXHJcblx0fVxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbi8qKlxyXG4gKiBHZXQgdGhlIHJ1bnRpbWUgc3RhY2sgZnJvbSB0aGUgdjggZW5naW5lXHJcbiAqIGlnbm9yZXMgYW55IHN0YWNrIGZyYW1lcyBmcm9tIHRoaXMgbW9kdWxlXHJcbiAqIGZpbGVzIHdpbGwgYmUgbWFwcGVkIHRvIG9yaWdpbmFsIHNvdXJjZSBmaWxlc1xyXG4gKiBcdGlmIGEgc291cmNlIG1hcCBpcyBhdmFpbGFibGVcclxuICovXHJcblxyXG5leHBvcnQgZ2V0VjhTdGFjayA6PSAoKTogVFN0YWNrRnJhbWVbXSA9PlxyXG5cdCMgLS0tIGlnbm9yZXMgYW55IHN0YWNrIGZyYW1lcyBmcm9tIHRoaXMgbW9kdWxlXHJcblx0IyAgICAgZmlsZXMgd2lsbCBiZSBtYXBwZWQgdG8gb3JpZ2luYWwgc291cmNlIGZpbGVzXHJcblx0IyAgICAgICAgaWYgYSBzb3VyY2UgbWFwIGlzIGF2YWlsYWJsZVxyXG5cclxuXHR0cnlcclxuXHRcdCMgQHRzLWlnbm9yZVxyXG5cdFx0b2xkTGltaXQgOj0gRXJyb3Iuc3RhY2tUcmFjZUxpbWl0XHJcblxyXG5cdFx0IyBAdHMtaWdub3JlXHJcblx0XHRvbGRQcmVwYXJlciA6PSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZVxyXG5cclxuXHRcdCMgQHRzLWlnbm9yZVxyXG5cdFx0RXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID0gSW5maW5pdHlcclxuXHJcblx0XHQjIEB0cy1pZ25vcmVcclxuXHRcdEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gKGVycm9yLCBsRnJhbWVzKSA9PlxyXG5cdFx0XHRsUmVzdWx0RnJhbWVzOiBUU3RhY2tGcmFtZVtdIDo9IFtdXHJcblx0XHRcdERCRyBcImdldFY4U3RhY2soKTogI3tsRnJhbWVzLmxlbmd0aH0gc3RhY2sgZnJhbWVzXCJcclxuXHRcdFx0Zm9yIGZyYW1lLGkgb2YgbEZyYW1lc1xyXG5cclxuXHRcdFx0XHREQkcgXCJGUkFNRSAje2l9XCIsIElOREVOVFxyXG5cclxuXHRcdFx0XHQjIC0tLSBDYWxsIGZ1bmN0aW9ucyBvbiB0aGUgZnJhbWVcclxuXHRcdFx0XHRmaWxlTmFtZTogc3RyaW5nIDo9IGZyYW1lLmdldEZpbGVOYW1lKCkgfHwgJ3Vua25vd24nXHJcblx0XHRcdFx0ZnVuY3Rpb25OYW1lICAgICA6PSBmcmFtZS5nZXRGdW5jdGlvbk5hbWUoKVxyXG5cdFx0XHRcdGZ1bmN0aW9uT2JqICAgICAgOj0gZnJhbWUuZ2V0RnVuY3Rpb24oKVxyXG5cdFx0XHRcdG1ldGhvZE5hbWUgICAgICAgOj0gZnJhbWUuZ2V0TWV0aG9kTmFtZSgpXHJcblx0XHRcdFx0bGluZSAgICAgICAgICAgICA6PSBmcmFtZS5nZXRMaW5lTnVtYmVyKClcclxuXHRcdFx0XHRjb2x1bW4gICAgICAgICAgIDo9IGZyYW1lLmdldENvbHVtbk51bWJlcigpXHJcblx0XHRcdFx0aXNUb3BMZXZlbCAgICAgICA6PSBmcmFtZS5pc1RvcGxldmVsKClcclxuXHRcdFx0XHRpc0FzeW5jICAgICAgICAgIDo9IGZyYW1lLmlzQXN5bmMoKVxyXG5cdFx0XHRcdGlzRXZhbCAgICAgICAgICAgOj0gZnJhbWUuaXNFdmFsKClcclxuXHRcdFx0XHRpc05hdGl2ZSAgICAgICAgIDo9IGZyYW1lLmlzTmF0aXZlKClcclxuXHRcdFx0XHRpc0NvbnN0cnVjdG9yICAgIDo9IGZyYW1lLmlzQ29uc3RydWN0b3IoKVxyXG5cdFx0XHRcdHR5cGVOYW1lICAgICAgICAgOj0gZnJhbWUuZ2V0VHlwZU5hbWUoKVxyXG5cclxuXHRcdFx0XHREQkcgc2VwKCdmcm9tIFY4JywgJy0nLCB3aWR0aClcclxuXHRcdFx0XHREQkcgXCJmaWxlTmFtZSA9ICN7T0woZmlsZU5hbWUpfVwiXHJcblx0XHRcdFx0REJHIFwiZnVuY3Rpb25OYW1lID0gI3tPTChmdW5jdGlvbk5hbWUpfVwiXHJcblx0XHRcdFx0REJHIFwiZGVmaW5lZChmdW5jdGlvbk9iaikgPSAje09MKGRlZmluZWQoZnVuY3Rpb25PYmopKX1cIlxyXG5cdFx0XHRcdERCRyBcIm1ldGhvZE5hbWUgPSAje09MKG1ldGhvZE5hbWUpfVwiXHJcblx0XHRcdFx0REJHIFwibGluZSA9ICN7T0wobGluZSl9XCJcclxuXHRcdFx0XHREQkcgXCJjb2x1bW4gPSAje09MKGNvbHVtbil9XCJcclxuXHRcdFx0XHREQkcgXCJpc1RvcExldmVsID0gI3tPTChpc1RvcExldmVsKX1cIlxyXG5cdFx0XHRcdERCRyBcImlzQXN5bmMgPSAje09MKGlzQXN5bmMpfVwiXHJcblx0XHRcdFx0REJHIFwiaXNFdmFsID0gI3tPTChpc0V2YWwpfVwiXHJcblx0XHRcdFx0REJHIFwiaXNOYXRpdmUgPSAje09MKGlzTmF0aXZlKX1cIlxyXG5cdFx0XHRcdERCRyBcImlzQ29uc3RydWN0b3IgPSAje09MKGlzQ29uc3RydWN0b3IpfVwiXHJcblx0XHRcdFx0REJHIFwidHlwZU5hbWUgPSAje09MKHR5cGVOYW1lKX1cIlxyXG5cdFx0XHRcdERCRyAnLScucmVwZWF0KHdpZHRoKVxyXG5cclxuXHRcdFx0XHRpZiBmaWxlTmFtZS5tYXRjaCgvdjgtc3RhY2tcXC5saWJcXC5bQS1aYS16MC05X10rJC8pXHJcblx0XHRcdFx0XHREQkcgXCJTS0lQOiBmaWxlTmFtZSA9ICcje2ZpbGVOYW1lfSdcIiwgVU5ERU5UXHJcblx0XHRcdFx0XHRjb250aW51ZVxyXG5cclxuXHRcdFx0XHRoOiBUU3RhY2tGcmFtZSA6PSB7XHJcblx0XHRcdFx0XHR0eXBlOiAoXHJcblx0XHRcdFx0XHRcdCAgaXNFdmFsICAgICAgICAgICAgICAgID8gJ2V2YWwnXHJcblx0XHRcdFx0XHRcdDogaXNOYXRpdmUgICAgICAgICAgICAgID8gJ25hdGl2ZSdcclxuXHRcdFx0XHRcdFx0OiBpc0NvbnN0cnVjdG9yICAgICAgICAgPyAnY29uc3RydWN0b3InXHJcblx0XHRcdFx0XHRcdDogZGVmaW5lZChtZXRob2ROYW1lKSAgID8gJ21ldGhvZCdcclxuXHRcdFx0XHRcdFx0OiBkZWZpbmVkKGZ1bmN0aW9uTmFtZSkgPyAnZnVuY3Rpb24nXHJcblx0XHRcdFx0XHRcdDogaXNUb3BMZXZlbCAgICAgICAgICAgID8gJ3NjcmlwdCdcclxuXHRcdFx0XHRcdFx0OiAgICAgICAgICAgICAgICAgICAgICAgICAndW5rbm93bidcclxuXHRcdFx0XHRcdFx0KVxyXG5cdFx0XHRcdFx0ZmlsZU5hbWVcclxuXHRcdFx0XHRcdGxpbmVcclxuXHRcdFx0XHRcdGNvbHVtblxyXG5cdFx0XHRcdFx0bmFtZTogKFxyXG5cdFx0XHRcdFx0XHQgIGlzU3RyaW5nKGZ1bmN0aW9uTmFtZSkgPyBmdW5jdGlvbk5hbWVcclxuXHRcdFx0XHRcdFx0OiBkZWZpbmVkKGZ1bmN0aW9uT2JqKSAgID8gJzxhbm9uPidcclxuXHRcdFx0XHRcdFx0OiBpc1N0cmluZyhtZXRob2ROYW1lKSAgID8gbWV0aG9kTmFtZVxyXG5cdFx0XHRcdFx0XHQ6ICAgICAgICAgICAgICAgICAgICAgICAgICcnXHJcblx0XHRcdFx0XHRcdClcclxuXHRcdFx0XHRcdGlzQ29uc3RydWN0b3JcclxuXHRcdFx0XHRcdGlzQXN5bmNcclxuXHRcdFx0XHRcdC4uLihkZWZpbmVkKG1ldGhvZE5hbWUpICYmIHtvYmpUeXBlOiB0eXBlTmFtZX0pXHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdCMgLS0tIGZpeCBhIGJ1ZyBpbiB0aGUgVjggZW5naW5lIHdoZXJlIGNhbGxzIGluc2lkZSBhXHJcblx0XHRcdFx0IyAgICAgdG9wIGxldmVsIGFub255bW91cyBmdW5jdGlvbiBpcyByZXBvcnRlZCBhc1xyXG5cdFx0XHRcdCMgICAgIGJlaW5nIGZyb20gdGhlIHRvcCBsZXZlbCwgaS5lLiB0eXBlICdzY3JpcHQnXHJcblxyXG5cdFx0XHRcdHRvcyA6PSBsUmVzdWx0RnJhbWVzLmF0KC0xKSAgICAjIC0tLSBpLmUuIHByZXZpb3VzIGZyYW1lXHJcblx0XHRcdFx0aWYgKHRvcyAhPSB1bmRlZilcclxuXHRcdFx0XHRcdGlmIChoLnR5cGUgPT0gJ3NjcmlwdCcpICYmICh0b3MudHlwZSA9PSAnc2NyaXB0JylcclxuXHRcdFx0XHRcdFx0REJHIFwiUGF0Y2ggY3VycmVudCBUT1MgKGN1cnJlbnRseSAje2xSZXN1bHRGcmFtZXMubGVuZ3RofSBmcmFtZXMpXCJcclxuXHRcdFx0XHRcdFx0dG9zLnR5cGUgPSAnZnVuY3Rpb24nXHJcblx0XHRcdFx0XHRcdHRvcy5uYW1lID0gJzxhbm9uPidcclxuXHJcblx0XHRcdFx0REJHIHNlcCgncmV0dXJuIGZyYW1lJywgJy0nLCB3aWR0aClcclxuXHRcdFx0XHREQkcgTUwoaClcclxuXHRcdFx0XHREQkcgJy0nLnJlcGVhdCh3aWR0aClcclxuXHJcblx0XHRcdFx0IyAtLS0gSWdub3JlIHRoaXMgZW50cnkgYW5kIGFueSBiZWZvcmUgaXRcclxuXHRcdFx0XHRpZiAoaC5vYmpUeXBlID09ICdNb2R1bGVKb2InKVxyXG5cdFx0XHRcdFx0REJHIFwib2JqVHlwZSBpcyAnTW9kdWxlSm9iJyAtIHN0b3AgcHJvY2Vzc2luZ1wiXHJcblx0XHRcdFx0XHRicmVha1xyXG5cclxuXHRcdFx0XHRsUmVzdWx0RnJhbWVzLnB1c2ggaFxyXG5cdFx0XHRcdERCRyBVTkRFTlRcclxuXHJcblx0XHRcdERCRyAnLScucmVwZWF0KHdpZHRoKVxyXG5cdFx0XHRyZXR1cm4gbFJlc3VsdEZyYW1lc1xyXG5cclxuXHRcdGVyck9iaiA6PSBuZXcgRXJyb3IoKVxyXG5cclxuXHRcdCMgQHRzLWlnbm9yZSAtIGJlY2F1c2UgZXJyT2JqLnN0YWNrIHdpbGwgYmUgYW4gYXJyYXlcclxuXHRcdGxTdGFjazogVFN0YWNrRnJhbWVbXSA6PSBlcnJPYmouc3RhY2sgfHwgW11cclxuXHJcblx0XHQjIC0tLSByZXNldCB0byBwcmV2aW91cyB2YWx1ZXNcclxuXHJcblx0XHQjIEB0cy1pZ25vcmVcclxuXHRcdEVycm9yLnN0YWNrVHJhY2VMaW1pdCA9IG9sZExpbWl0XHJcblxyXG5cdFx0IyBAdHMtaWdub3JlXHJcblx0XHRFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IG9sZFByZXBhcmVyXHJcblxyXG5cdFx0Zm9yIGggb2YgbFN0YWNrXHJcblx0XHRcdERCRyBcImJlZm9yZSBtYXBwaW5nLCBoID0gI3tNTChoKX1cIlxyXG5cdFx0XHR7ZmlsZU5hbWUsIGxpbmUsIGNvbHVtbiwgbmFtZSwgdHlwZX0gOj0gaFxyXG5cdFx0XHRoTmV3IDo9IG1hcFNvdXJjZVBvcyB7XHJcblx0XHRcdFx0cGF0aDogZmlsZU5hbWVcclxuXHRcdFx0XHRsaW5lXHJcblx0XHRcdFx0Y29sdW1uXHJcblx0XHRcdFx0fVxyXG5cdFx0XHRuZXdFeHQgOj0gZmlsZUV4dChoTmV3LnBhdGgpXHJcblx0XHRcdGlmIChuZXdFeHQgPT0gZmlsZUV4dChoLmZpbGVOYW1lKSlcclxuXHRcdFx0XHREQkcgXCJOb3QgbWFwcGVkIC0gcmV0dXJuaW5nIG9yaWdpbmFsIHBvc2l0aW9uXCJcclxuXHRcdFx0XHRoLmZpbGVOYW1lID0gcmVscGF0aChoLmZpbGVOYW1lKVxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0REJHIFwiTWFwcGVkLCBoTmV3ID0gI3tNTChoTmV3KX1cIlxyXG5cdFx0XHRcdGguZmlsZU5hbWUgPSByZWxwYXRoKHdpdGhFeHQoaC5maWxlTmFtZSwgbmV3RXh0KSlcclxuXHRcdFx0XHRoLmxpbmUgPSBoTmV3LmxpbmVcclxuXHRcdFx0XHRoLmNvbHVtbiA9IGhOZXcuY29sdW1uXHJcblx0XHRcdFx0REJHIFwiYWZ0ZXIgbWFwcGluZywgaCA9ICN7TUwoaCl9XCJcclxuXHJcblx0XHRyZXR1cm4gbFN0YWNrXHJcblx0Y2F0Y2ggZVxyXG5cdFx0IyBAdHMtaWdub3JlXHJcblx0XHRFUlIgZS5tZXNzYWdlXHJcblx0XHRyZXR1cm4gW11cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgZ2V0VjhTdGFja1N0ciA6PSAoKTogc3RyaW5nID0+XHJcblxyXG5cdGxMaW5lcyA6PSBnZXRWOFN0YWNrKCkubWFwKChoKSA9PlxyXG5cdFx0e3R5cGUsIG5hbWUsIGZpbGVOYW1lLCBsaW5lLCBjb2x1bW59IDo9IGhcclxuXHRcdG5hbWVTdHIgOj1cclxuXHRcdFx0aWYgbmFtZVxyXG5cdFx0XHRcdHNwcmludGYoXCIlLTE4c1wiLCBcIiN7dHlwZX0gI3tuYW1lfVwiKVxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0c3ByaW50ZihcIiUtMThzXCIsIFwiI3t0eXBlfVwiKVxyXG5cdFx0cmV0dXJuIFwiWyN7bmFtZVN0cn1dICN7ZmlsZU5hbWV9OiN7bGluZX06I3tjb2x1bW59XCJcclxuXHRcdClcclxuXHRyZXR1cm4gbExpbmVzLmpvaW4oJ1xcbicpXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuLyoqXHJcbiAqIEdldCB0aGUgY3VycmVudCBmdW5jdGlvbidzIGNhbGxlclxyXG4gKi9cclxuXHJcbmV4cG9ydCBnZXRNeUNhbGxlciA6PSAoKTogVFN0YWNrRnJhbWU/ID0+XHJcblxyXG5cdHRyeVxyXG5cdFx0bFN0YWNrIDo9IGdldFY4U3RhY2soKVxyXG5cdFx0aWYgZGVmaW5lZChsU3RhY2spICYmIChsU3RhY2subGVuZ3RoID4gMClcclxuXHRcdFx0cmV0dXJuIGxTdGFja1sxXVxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRyZXR1cm4gdW5kZWZcclxuXHRjYXRjaCBlcnJcclxuXHRcdGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcilcclxuXHRcdFx0TE9HIFwiRVJST1IgaW4gZ2V0VjhTdGFjaygpOiAje2Vyci5tZXNzYWdlfVwiXHJcblx0XHRyZXR1cm4gdW5kZWZcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4vKipcclxuICogR2V0IHRoZSBjdXJyZW50IGZ1bmN0aW9uJ3MgY2FsbGVyLCBpZ25vcmluZyBhbnkgY2FsbHNcclxuICogZnJvbSB0aGUgc2FtZSBtb2R1bGVcclxuICovXHJcblxyXG5leHBvcnQgZ2V0TXlPdXRzaWRlQ2FsbGVyIDo9ICgpOiBUU3RhY2tGcmFtZT8gPT5cclxuXHJcblx0dHJ5XHJcblx0XHRsU3RhY2sgOj0gZ2V0VjhTdGFjaygpXHJcblx0XHREQkcgXCJDYWxsIHN0YWNrIGhhcyAje2xTdGFjay5sZW5ndGh9IGl0ZW1zXCJcclxuXHRcdGlmIChsU3RhY2subGVuZ3RoID09IDApXHJcblx0XHRcdHJldHVybiB1bmRlZlxyXG5cdFx0e2ZpbGVOYW1lfSA6PSBsU3RhY2tbMF1cclxuXHRcdERCRyBcImZpbGVOYW1lID0gI3tmaWxlTmFtZX1cIlxyXG5cdFx0Zm9yIGZyYW1lLGkgb2YgbFN0YWNrXHJcblx0XHRcdERCRyBcImZyYW1lWyN7aX1dLmZpbGVOYW1lID0gI3tmcmFtZS5maWxlTmFtZX1cIlxyXG5cdFx0XHRpZiAoZnJhbWUuZmlsZU5hbWUgIT0gZmlsZU5hbWUpXHJcblx0XHRcdFx0cmV0dXJuIGZyYW1lXHJcblx0XHRyZXR1cm4gdW5kZWZcclxuXHRjYXRjaCBlcnJcclxuXHRcdGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcilcclxuXHRcdFx0TE9HIFwiRVJST1IgaW4gZ2V0VjhTdGFjaygpOiAje2Vyci5tZXNzYWdlfVwiXHJcblx0XHRyZXR1cm4gdW5kZWZcclxuIl19