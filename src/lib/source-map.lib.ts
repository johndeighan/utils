"use strict";
// source-map.lib.civet

import {existsSync} from 'jsr:@std/fs'
import {RawSourceMap, SourceMapConsumer} from "npm:source-map-sync"

import {
	undef, defined, notdefined, assert, croak,
	} from 'datatypes'

const hSourceMapCache = new Map<string, RawSourceMap>()

// ---------------------------------------------------------------------------

export const stripSrcMap = (
		contents: string
		): [string, string?] => {

	const lMatches = contents.match(/^(.*)\/\/\#\s+sourceMappingURL=data:application\/json;(?:charset=utf-8;)?base64,(.*)$/s)
	if (defined(lMatches) && (lMatches.length === 3)) {
		const [_, src, srcMapStr] = lMatches
		return [src.trim(), srcMapStr.trim()]
	}
	else {
		const pos = contents.indexOf('//# sourceMappingURL')
		if (pos >= 0) {
			croak(`Bad source map: ${contents.substring(pos)}`)
		}
		return [contents.trim(), undef]
	}
}

// ---------------------------------------------------------------------------

export const extractSourceMap = (
		path: string
		): [string, RawSourceMap?] => {

	if (!existsSync(path)) {
		croak(`No such file: ${path}`)
	}

	const [src, srcMapStr] = stripSrcMap(Deno.readTextFileSync(path))

	if (defined(srcMapStr)) {
		const sourceMap = JSON.parse(atob(srcMapStr)) as RawSourceMap
		hSourceMapCache.set(path, sourceMap)
		return [src, sourceMap]
	}
	else {
		return [src, undef]
	}
}

// ---------------------------------------------------------------------------

export type TFilePos = {
	path: string
	line: number
	column: number
	}

// ---------------------------------------------------------------------------

export const mapSourcePos = (h: TFilePos): TFilePos => {

	const {path, line, column} = h
	const [source, hSrcMap] = extractSourceMap(path)
	if (defined(hSrcMap)) {
		const consumer = new SourceMapConsumer(hSrcMap)
		const hNew = consumer.originalPositionFor({line, column})
		if (
				   defined(hNew)
				&& defined(hNew.source)
				&& defined(hNew.line)
				&& defined(hNew.column)
				) {
			return {
				path:   hNew.source,
				line:   hNew.line,
				column: hNew.column
				}
		}
		else {
			return h
		}
	}
	else {
		return h
	}
}

// ---------------------------------------------------------------------------

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxzb3VyY2UtbWFwLmxpYi5jaXZldC50c3giLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcam9obmRcXHV0aWxzXFxzcmNcXGxpYlxcc291cmNlLW1hcC5saWIuY2l2ZXQiXSwibWFwcGluZ3MiOiI7QUFBQSx1QkFBc0I7QUFDdEIsQUFBQTtBQUNBLEFBQUEsTUFBTSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWE7QUFDdEMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLHFCQUFxQjtBQUNuRSxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDM0MsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQTtBQUNBLEFBQUEsQUFBZSxNQUFmLGVBQWUsQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBQ2xELEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBWSxNQUFYLFdBQVcsQ0FBQyxDQUFFLENBQUMsQ0FBQztBQUN2QixBQUFBLEVBQUUsUUFBUSxDQUFDLENBQUMsTUFBTTtBQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUN6QixBQUFBO0FBQ0EsQUFBQSxDQUFTLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFBLEFBQUMsQ0FBRyxDQUFDLEFBQzlCLElBQUksQUFBYSxB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QUFBLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0FBQzNCLElBQUksQ0FBQyxDQUFBLENBQUE7QUFDTCxBQUFBLEdBQUcsTUFBTSxDQUFDLENBQUM7QUFDWCxBQUFBLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQTtBQUN2QixBQUFBLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtBQUNyQixBQUFBLElBQUksTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU07QUFDdkIsSUFBSSxDO0VBQUMsQ0FBQTtBQUNMLEFBQUEsRUFBRSxJQUFJLENBQUEsQ0FBQTtBQUNOLEFBQUEsR0FBRyxNQUFNLENBQUMsQztFQUFDLEM7Q0FBQSxDQUFBO0FBQ1gsQUFBQSxDQUFDLElBQUksQ0FBQSxDQUFBO0FBQ0wsQUFBQSxFQUFFLE1BQU0sQ0FBQyxDO0NBQUMsQztBQUFBLENBQUE7QUFDVjtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIHNvdXJjZS1tYXAubGliLmNpdmV0XG5cbmltcG9ydCB7ZXhpc3RzU3luY30gZnJvbSAnanNyOkBzdGQvZnMnXG5pbXBvcnQge1Jhd1NvdXJjZU1hcCwgU291cmNlTWFwQ29uc3VtZXJ9IGZyb20gXCJucG06c291cmNlLW1hcC1zeW5jXCJcblxuaW1wb3J0IHtcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGFzc2VydCwgY3JvYWssXG5cdH0gZnJvbSAnZGF0YXR5cGVzJ1xuXG5oU291cmNlTWFwQ2FjaGUgOj0gbmV3IE1hcDxzdHJpbmcsIFJhd1NvdXJjZU1hcD4oKVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgc3RyaXBTcmNNYXAgOj0gKFxuXHRcdGNvbnRlbnRzOiBzdHJpbmdcblx0XHQpOiBbc3RyaW5nLCBzdHJpbmc/XSA9PlxuXG5cdGxNYXRjaGVzIDo9IGNvbnRlbnRzLm1hdGNoIC8vL15cblx0XHQoLiopICAgICAgICAgICAgICMgLS0tIHNvdXJjZSBjb2RlXG5cdFx0XFwvIFxcLyBcXCMgXFxzK1xuXHRcdHNvdXJjZU1hcHBpbmdVUkw9ZGF0YTphcHBsaWNhdGlvblxcL2pzb247XG5cdFx0KD86IGNoYXJzZXQ9dXRmLTg7ICk/XG5cdFx0YmFzZTY0LFxuXHRcdCguKikgICAgICAgICAgICAgIyAtLS0gZW5jb2RlZCBzb3VyY2UgbWFwXG5cdFx0JC8vL3Ncblx0aWYgZGVmaW5lZChsTWF0Y2hlcykgJiYgKGxNYXRjaGVzLmxlbmd0aCA9PSAzKVxuXHRcdFtfLCBzcmMsIHNyY01hcFN0cl0gOj0gbE1hdGNoZXNcblx0XHRyZXR1cm4gW3NyYy50cmltKCksIHNyY01hcFN0ci50cmltKCldXG5cdGVsc2Vcblx0XHRwb3MgOj0gY29udGVudHMuaW5kZXhPZignLy8jIHNvdXJjZU1hcHBpbmdVUkwnKVxuXHRcdGlmIChwb3MgPj0gMClcblx0XHRcdGNyb2FrIFwiQmFkIHNvdXJjZSBtYXA6ICN7Y29udGVudHMuc3Vic3RyaW5nKHBvcyl9XCJcblx0XHRyZXR1cm4gW2NvbnRlbnRzLnRyaW0oKSwgdW5kZWZdXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBleHRyYWN0U291cmNlTWFwIDo9IChcblx0XHRwYXRoOiBzdHJpbmdcblx0XHQpOiBbc3RyaW5nLCBSYXdTb3VyY2VNYXA/XSA9PlxuXG5cdGlmIG5vdCBleGlzdHNTeW5jKHBhdGgpXG5cdFx0Y3JvYWsgXCJObyBzdWNoIGZpbGU6ICN7cGF0aH1cIlxuXG5cdFtzcmMsIHNyY01hcFN0cl0gOj0gc3RyaXBTcmNNYXAgRGVuby5yZWFkVGV4dEZpbGVTeW5jKHBhdGgpXG5cblx0aWYgZGVmaW5lZChzcmNNYXBTdHIpXG5cdFx0c291cmNlTWFwIDo9IEpTT04ucGFyc2UoYXRvYihzcmNNYXBTdHIpKSBhcyBSYXdTb3VyY2VNYXBcblx0XHRoU291cmNlTWFwQ2FjaGUuc2V0IHBhdGgsIHNvdXJjZU1hcFxuXHRcdHJldHVybiBbc3JjLCBzb3VyY2VNYXBdXG5cdGVsc2Vcblx0XHRyZXR1cm4gW3NyYywgdW5kZWZdXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCB0eXBlIFRGaWxlUG9zID0ge1xuXHRwYXRoOiBzdHJpbmdcblx0bGluZTogbnVtYmVyXG5cdGNvbHVtbjogbnVtYmVyXG5cdH1cblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IG1hcFNvdXJjZVBvcyA6PSAoaDogVEZpbGVQb3MpOiBURmlsZVBvcyA9PlxuXG5cdHtwYXRoLCBsaW5lLCBjb2x1bW59IDo9IGhcblx0W3NvdXJjZSwgaFNyY01hcF0gOj0gZXh0cmFjdFNvdXJjZU1hcChwYXRoKVxuXHRpZiBkZWZpbmVkKGhTcmNNYXApXG5cdFx0Y29uc3VtZXIgOj0gbmV3IFNvdXJjZU1hcENvbnN1bWVyKGhTcmNNYXApXG5cdFx0aE5ldyA6PSBjb25zdW1lci5vcmlnaW5hbFBvc2l0aW9uRm9yKHtsaW5lLCBjb2x1bW59KVxuXHRcdGlmIChcblx0XHRcdFx0ICAgZGVmaW5lZChoTmV3KVxuXHRcdFx0XHQmJiBkZWZpbmVkKGhOZXcuc291cmNlKVxuXHRcdFx0XHQmJiBkZWZpbmVkKGhOZXcubGluZSlcblx0XHRcdFx0JiYgZGVmaW5lZChoTmV3LmNvbHVtbilcblx0XHRcdFx0KVxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0cGF0aDogICBoTmV3LnNvdXJjZVxuXHRcdFx0XHRsaW5lOiAgIGhOZXcubGluZVxuXHRcdFx0XHRjb2x1bW46IGhOZXcuY29sdW1uXG5cdFx0XHRcdH1cblx0XHRlbHNlXG5cdFx0XHRyZXR1cm4gaFxuXHRlbHNlXG5cdFx0cmV0dXJuIGhcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiJdfQ==