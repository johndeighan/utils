"use strict";
// parser.lib.civet

import {
	undef, defined, notdefined, assert, hash, hashof,
	isArray, isFunction, isString, isRegExp, isHash,
	} from 'datatypes'
import {
	getOptions, escapeStr, spaces, randomLabel, OL,
	getLineAndColumn,
	} from 'llutils'
import {
	DBG, INDENT, UNDENT,
	} from 'logger'

// ---------------------------------------------------------------------------

export type TRuleFunc = (str: string, pos: number) => number

export const isRuleFunc = (x: unknown): x is TRuleFunc => {
	return (typeof x === 'function')
}

export class Rule {
	type: string
	func: TRuleFunc
	label: string = randomLabel()
	lChildren: Rule[] = []

	constructor(
			type: string,
			func: TRuleFunc,
			lChildren: Rule[] = []
			) {
		this.type = type
		this.func = func
		this.lChildren = []
	}

	next(str: string, pos: number): number {
		return this.func(str, pos)
	}
}

// --- Anything that can be converted to a Rule
export type TLaxRule = RegExp | string | TRuleFunc | TLaxRule[] | hashof<TLaxRule>

export type TCallback = (rule: Rule, lMatches: string[]) => void

// ---------------------------------------------------------------------------
// --- Custom errors

export class ParseError extends Error {

	constructor(msg: string) {
		super(msg)
		this.name = 'ParseError'
	}
}

// ---------------------------------------------------------------------------
// --- Returns a function that:
//        1. accepts a string
//        2. throws error on failure

export type TParser = (str: string) => void

export function getParser(
		laxRule: TLaxRule,
		lCallbacks: TCallback[] = [],
		hOptions: hash = {}
		): TParser {

	type opt = {
		reSkip: RegExp
		partial: boolean
		}
	const {reSkip, partial} = getOptions<opt>(hOptions, {
		reSkip: /^\s+/,
		partial: false
		})

	// ..........................................................
	// function that skips reSkip, if defined

	const skipIgnored: TRuleFunc = (str, pos) => {

		const lMatches = str.substring(pos).match(reSkip)
		if (defined(lMatches)) {
			const len = lMatches[0].length
			if (len > 0) {
				DBG(`${len} chars skipped`)
			}
			return pos + len
		}
		else {
			return pos
		}
	}

	// ..........................................................
	// --- function that maps RegExp => Rule

	const RegexMatcher = (re: RegExp): Rule => {

		return new Rule('r', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			const lMatches = re.exec(str.substring(skipPos))
			if (lMatches === null) {
				throw new ParseError("RegExp Rule not matched")
			}

			const len = lMatches[0].length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, lMatches)
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps string => Rule

	const StringMatcher = (substr: string): Rule => {

		return new Rule('s', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			if (!str.startsWith(substr, skipPos)) {
				throw new ParseError("String Rule not matched")
			}

			const len = substr.length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, [substr])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TRuleFunc => Rule

	const FuncMatcher = (func: TRuleFunc): Rule => {

		return new Rule('f', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)
			const newPos = func(str, skipPos)
			assert((newPos > pos), "Zero length in rule match")
			for (const cb of lCallbacks) {
				cb(rule, [str.substring(pos, newPos)])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule => Rule

	const getRule = (laxRule: TLaxRule): Rule => {

		if (isRegExp(laxRule)) {
			return RegexMatcher(laxRule)
		}

		else if (isString(laxRule)) {
			return StringMatcher(laxRule)
		}

		else if (isRuleFunc(laxRule)) {
			return FuncMatcher(laxRule)
		}

		else if (isArray(laxRule)) {
			return All(laxRule)
		}

		else {
			return Any(laxRule)
		}
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const Any = (hItems: hashof<TLaxRule>): Rule => {

		const results=[];for (const key in hItems) {const val = hItems[key];
			const rule = getRule(val as TLaxRule)
			rule.label = key
			results.push(rule)
		};const lRules =results

		return new Rule('|', (str, pos): number => {
			// --- Try each rule
			//     if any succeed, succeed & return new pos
			//     else throw error
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					for (const cb of lCallbacks) {
						cb(rule, [str.substring(pos, newPos)])
					}
					return newPos
				} catch(e) {}
			}

			throw new ParseError("Any Rule not matched")
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const All = (lLaxRules: TLaxRule[]): Rule => {

		const results1=[];for (const laxRule of lLaxRules) {
			results1.push(getRule(laxRule))
		};const lRules =results1

		return new Rule('&', (str, pos): number => {
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					pos = newPos
				}
				catch (err) {
					throw new ParseError("All Rule not matched")
				}
			}

			for (const cb of lCallbacks) {
				cb(rule, [])
			}
			return pos
		}
			)
	}

	// --- Return a function that throws an error
	//     if string doesn't parse

	const rule = getRule(laxRule)
	return (str) => {
		DBG(`Parse ${escapeStr(str)}`, INDENT)
		try {
			const endPos = rule.next(str, 0)
			DBG(`endPos = ${endPos}`)
			if ((endPos === str.length) || partial) {
				DBG(UNDENT)
				return true
			}
			const finalPos = skipIgnored(str, endPos)
			DBG(`finalPos = ${finalPos}`, UNDENT)
			if (finalPos !== str.length) {
				throw new ParseError("Not all input exhausted")
			}
			return
		}
		catch (err) {
			DBG(UNDENT)
			throw err
		}
	}
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDakQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDaEQsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNyQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNoQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTTtBQUM1RCxBQUFBO0FBQ0EsQUFBQSxB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QUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyw0Q0FBMkM7QUFDNUMsQUFBQTtBQUNBLEFBQUEsQ0FBSSxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDeEMsQUFBQTtBQUNBLEFBQUEsRSxLLEMsUSxHLENBQVksR0FBRyxDQUFDLENBQUEsTUFBQSxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQSxDQUFBLENBQUE7QUFDcEMsQUFBQSxHLFEsTUFBRyxPQUFPLENBQUEsQUFBQyxPQUFPLEMsQztFQUFBLEMsQ0FEVixNQUFOLE1BQU0sQ0FBQyxDLFFBQ1M7QUFDbEIsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQzVDLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFBLENBQUEsQ0FBQTtBQUNyQixBQUFBLElBQUksR0FBRyxDQUFBLENBQUE7QUFDUCxBQUFBLEtBQVcsTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ2xDLEFBQUEsS0FBSyxHQUFHLEMsQ0FBRSxDQUFDLE07SUFBTSxDQUFBO0FBQ2pCLEFBQUEsSUFBSSxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ2IsQUFBQSxLQUFLLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFBLEFBQUMsc0JBQXNCLEM7SUFBQSxDO0dBQUEsQ0FBQTtBQUNoRCxBQUFBO0FBQ0EsQUFBQSxHQUFHLEdBQUcsQ0FBQyxDQUFBLE1BQUEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUEsQ0FBQSxDQUFBO0FBQ3ZCLEFBQUEsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEM7R0FBQyxDQUFBO0FBQ2hCLEFBQUEsR0FBRyxNQUFNLENBQUMsRztFQUFHLENBQUE7QUFDYixHQUFHLEM7Q0FBQyxDQUFBO0FBQ0osQUFBQTtBQUNBLEFBQUEsQ0FBQyw2Q0FBNEM7QUFDN0MsQUFBQSxDQUFDLDhCQUE2QjtBQUM5QixBQUFBO0FBQ0EsQUFBQSxDQUFLLE1BQUosSUFBSSxDQUFDLENBQUUsQ0FBQyxPQUFPLENBQUEsQUFBQyxPQUFPLENBQUE7QUFDeEIsQUFBQSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ2hCLEFBQUEsRUFBRSxHQUFHLENBQUEsQUFBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQ3ZDLEFBQUEsRUFBRSxHQUFHLENBQUEsQ0FBQTtBQUNMLEFBQUEsR0FBUyxNQUFOLE1BQU0sQ0FBQyxDQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7QUFDM0IsQUFBQSxHQUFHLEdBQUcsQ0FBQSxDQUFDLE1BQU0sQ0FBQyxHQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUEsQ0FBQSxDQUFBO0FBQ3ZDLEFBQUEsSUFBSSxHQUFHLENBQUEsQUFBQyxNQUFNLENBQUE7QUFDZCxBQUFBLElBQUksTUFBTSxDQUFDLEk7R0FBSSxDQUFBO0FBQ2YsQUFBQSxHQUFXLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ3ZDLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQ3ZDLEFBQUEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUEsQ0FBQTtBQUM5QixBQUFBLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMseUJBQXlCLEM7R0FBQyxDQUFBO0FBQ25ELEFBQUEsR0FBRyxNO0VBQU0sQ0FBQTtBQUNULEFBQUEsRUFBRSxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ1gsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLE1BQU0sQ0FBQTtBQUNiLEFBQUEsR0FBRyxLQUFLLENBQUMsRztFQUFHLEM7Q0FBQSxDO0FBQUEsQ0FBQTtBQUNaIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIHBhcnNlci5saWIuY2l2ZXRcclxuXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGFzc2VydCwgaGFzaCwgaGFzaG9mLFxyXG5cdGlzQXJyYXksIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc1JlZ0V4cCwgaXNIYXNoLFxyXG5cdH0gZnJvbSAnZGF0YXR5cGVzJ1xyXG5pbXBvcnQge1xyXG5cdGdldE9wdGlvbnMsIGVzY2FwZVN0ciwgc3BhY2VzLCByYW5kb21MYWJlbCwgT0wsXHJcblx0Z2V0TGluZUFuZENvbHVtbixcclxuXHR9IGZyb20gJ2xsdXRpbHMnXHJcbmltcG9ydCB7XHJcblx0REJHLCBJTkRFTlQsIFVOREVOVCxcclxuXHR9IGZyb20gJ2xvZ2dlcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgdHlwZSBUUnVsZUZ1bmMgPSAoc3RyOiBzdHJpbmcsIHBvczogbnVtYmVyKSA9PiBudW1iZXJcclxuXHJcbmV4cG9ydCBpc1J1bGVGdW5jIDo9ICh4OiB1bmtub3duKTogeCBpcyBUUnVsZUZ1bmMgPT5cclxuXHRyZXR1cm4gKHR5cGVvZiB4ID09ICdmdW5jdGlvbicpXHJcblxyXG5leHBvcnQgY2xhc3MgUnVsZVxyXG5cdHR5cGU6IHN0cmluZ1xyXG5cdGZ1bmM6IFRSdWxlRnVuY1xyXG5cdGxhYmVsOiBzdHJpbmcgPSByYW5kb21MYWJlbCgpXHJcblx0bENoaWxkcmVuOiBSdWxlW10gPSBbXVxyXG5cclxuXHRjb25zdHJ1Y3RvcihcclxuXHRcdFx0dHlwZTogc3RyaW5nLFxyXG5cdFx0XHRmdW5jOiBUUnVsZUZ1bmMsXHJcblx0XHRcdGxDaGlsZHJlbjogUnVsZVtdID0gW11cclxuXHRcdFx0KVxyXG5cdFx0QHR5cGUgPSB0eXBlXHJcblx0XHRAZnVuYyA9IGZ1bmNcclxuXHRcdEBsQ2hpbGRyZW4gPSBbXVxyXG5cclxuXHRuZXh0KHN0cjogc3RyaW5nLCBwb3M6IG51bWJlcik6IG51bWJlclxyXG5cdFx0cmV0dXJuIEBmdW5jKHN0ciwgcG9zKVxyXG5cclxuIyAtLS0gQW55dGhpbmcgdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGEgUnVsZVxyXG5leHBvcnQgdHlwZSBUTGF4UnVsZSA9IFJlZ0V4cCB8IHN0cmluZyB8IFRSdWxlRnVuYyB8IFRMYXhSdWxlW10gfCBoYXNob2Y8VExheFJ1bGU+XHJcblxyXG5leHBvcnQgdHlwZSBUQ2FsbGJhY2sgPSAocnVsZTogUnVsZSwgbE1hdGNoZXM6IHN0cmluZ1tdKSA9PiB2b2lkXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4jIC0tLSBDdXN0b20gZXJyb3JzXHJcblxyXG5leHBvcnQgY2xhc3MgUGFyc2VFcnJvciBleHRlbmRzIEVycm9yXHJcblxyXG5cdGNvbnN0cnVjdG9yKG1zZzogc3RyaW5nKVxyXG5cdFx0c3VwZXIgbXNnXHJcblx0XHR0aGlzLm5hbWUgPSAnUGFyc2VFcnJvcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiMgLS0tIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0OlxyXG4jICAgICAgICAxLiBhY2NlcHRzIGEgc3RyaW5nXHJcbiMgICAgICAgIDIuIHRocm93cyBlcnJvciBvbiBmYWlsdXJlXHJcblxyXG5leHBvcnQgdHlwZSBUUGFyc2VyID0gKHN0cjogc3RyaW5nKSA9PiB2b2lkXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFyc2VyKFxyXG5cdFx0bGF4UnVsZTogVExheFJ1bGVcclxuXHRcdGxDYWxsYmFja3M6IFRDYWxsYmFja1tdID0gW11cclxuXHRcdGhPcHRpb25zOiBoYXNoID0ge31cclxuXHRcdCk6IFRQYXJzZXJcclxuXHJcblx0dHlwZSBvcHQgPSB7XHJcblx0XHRyZVNraXA6IFJlZ0V4cFxyXG5cdFx0cGFydGlhbDogYm9vbGVhblxyXG5cdFx0fVxyXG5cdHtyZVNraXAsIHBhcnRpYWx9IDo9IGdldE9wdGlvbnM8b3B0PiBoT3B0aW9ucywge1xyXG5cdFx0cmVTa2lwOiAvXlxccysvXHJcblx0XHRwYXJ0aWFsOiBmYWxzZVxyXG5cdFx0fVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIGZ1bmN0aW9uIHRoYXQgc2tpcHMgcmVTa2lwLCBpZiBkZWZpbmVkXHJcblxyXG5cdHNraXBJZ25vcmVkOiBUUnVsZUZ1bmMgOj0gKHN0ciwgcG9zKSA9PlxyXG5cclxuXHRcdGxNYXRjaGVzIDo9IHN0ci5zdWJzdHJpbmcocG9zKS5tYXRjaCByZVNraXBcclxuXHRcdGlmIGRlZmluZWQobE1hdGNoZXMpXHJcblx0XHRcdGxlbiA6PSBsTWF0Y2hlc1swXS5sZW5ndGhcclxuXHRcdFx0aWYgKGxlbiA+IDApXHJcblx0XHRcdFx0REJHIFwiI3tsZW59IGNoYXJzIHNraXBwZWRcIlxyXG5cdFx0XHRyZXR1cm4gcG9zICsgbGVuXHJcblx0XHRlbHNlXHJcblx0XHRcdHJldHVybiBwb3NcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFJlZ0V4cCA9PiBSdWxlXHJcblxyXG5cdFJlZ2V4TWF0Y2hlciA6PSAocmU6IFJlZ0V4cCk6IFJ1bGUgPT5cclxuXHJcblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3InLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cclxuXHJcblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXHJcblxyXG5cdFx0XHRsTWF0Y2hlcyA6PSByZS5leGVjKHN0ci5zdWJzdHJpbmcoc2tpcFBvcykpXHJcblx0XHRcdGlmIChsTWF0Y2hlcyA9PSBudWxsKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiUmVnRXhwIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0bGVuIDo9IGxNYXRjaGVzWzBdLmxlbmd0aFxyXG5cdFx0XHRhc3NlcnQgKGxlbiA+IDApLCBcIlplcm8gbGVuZ3RoIGluIHJlZ2V4IG1hdGNoXCJcclxuXHRcdFx0bmV3UG9zIDo9IHNraXBQb3MgKyBsZW5cclxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3NcclxuXHRcdFx0XHRjYihydWxlLCBsTWF0Y2hlcylcclxuXHRcdFx0cmV0dXJuIG5ld1Bvc1xyXG5cdFx0XHQpXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBzdHJpbmcgPT4gUnVsZVxyXG5cclxuXHRTdHJpbmdNYXRjaGVyIDo9IChzdWJzdHI6IHN0cmluZyk6IFJ1bGUgPT5cclxuXHJcblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3MnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cclxuXHJcblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXHJcblxyXG5cdFx0XHRpZiBub3Qgc3RyLnN0YXJ0c1dpdGgoc3Vic3RyLCBza2lwUG9zKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiU3RyaW5nIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0bGVuIDo9IHN1YnN0ci5sZW5ndGhcclxuXHRcdFx0YXNzZXJ0IChsZW4gPiAwKSwgXCJaZXJvIGxlbmd0aCBpbiByZWdleCBtYXRjaFwiXHJcblx0XHRcdG5ld1BvcyA6PSBza2lwUG9zICsgbGVuXHJcblx0XHRcdGZvciBjYiBvZiBsQ2FsbGJhY2tzXHJcblx0XHRcdFx0Y2IocnVsZSwgW3N1YnN0cl0pXHJcblx0XHRcdHJldHVybiBuZXdQb3NcclxuXHRcdFx0KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIC0tLSBmdW5jdGlvbiB0aGF0IG1hcHMgVFJ1bGVGdW5jID0+IFJ1bGVcclxuXHJcblx0RnVuY01hdGNoZXIgOj0gKGZ1bmM6IFRSdWxlRnVuYyk6IFJ1bGUgPT5cclxuXHJcblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ2YnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cclxuXHJcblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXHJcblx0XHRcdG5ld1BvcyA6PSBmdW5jKHN0ciwgc2tpcFBvcylcclxuXHRcdFx0YXNzZXJ0IChuZXdQb3MgPiBwb3MpLCBcIlplcm8gbGVuZ3RoIGluIHJ1bGUgbWF0Y2hcIlxyXG5cdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xyXG5cdFx0XHRcdGNiKHJ1bGUsIFtzdHIuc3Vic3RyaW5nKHBvcywgbmV3UG9zKV0pXHJcblx0XHRcdHJldHVybiBuZXdQb3NcclxuXHRcdFx0KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIC0tLSBmdW5jdGlvbiB0aGF0IG1hcHMgVExheFJ1bGUgPT4gUnVsZVxyXG5cclxuXHRnZXRSdWxlIDo9IChsYXhSdWxlOiBUTGF4UnVsZSk6IFJ1bGUgPT5cclxuXHJcblx0XHRpZiBpc1JlZ0V4cChsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gUmVnZXhNYXRjaGVyKGxheFJ1bGUpXHJcblxyXG5cdFx0ZWxzZSBpZiBpc1N0cmluZyhsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gU3RyaW5nTWF0Y2hlcihsYXhSdWxlKVxyXG5cclxuXHRcdGVsc2UgaWYgaXNSdWxlRnVuYyhsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gRnVuY01hdGNoZXIobGF4UnVsZSlcclxuXHJcblx0XHRlbHNlIGlmIGlzQXJyYXkobGF4UnVsZSlcclxuXHRcdFx0cmV0dXJuIEFsbCBsYXhSdWxlXHJcblxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRyZXR1cm4gQW55IGxheFJ1bGVcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxyXG5cclxuXHRBbnkgOj0gKGhJdGVtczogaGFzaG9mPFRMYXhSdWxlPik6IFJ1bGUgPT5cclxuXHJcblx0XHRsUnVsZXMgOj0gZm9yIGtleSx2YWwgaW4gaEl0ZW1zXHJcblx0XHRcdHJ1bGUgOj0gZ2V0UnVsZSh2YWwgYXMgVExheFJ1bGUpXHJcblx0XHRcdHJ1bGUubGFiZWwgPSBrZXlcclxuXHRcdFx0cnVsZVxyXG5cclxuXHRcdHJldHVybiBuZXcgUnVsZSgnfCcsIChzdHIsIHBvcyk6IG51bWJlciA9PlxyXG5cdFx0XHQjIC0tLSBUcnkgZWFjaCBydWxlXHJcblx0XHRcdCMgICAgIGlmIGFueSBzdWNjZWVkLCBzdWNjZWVkICYgcmV0dXJuIG5ldyBwb3NcclxuXHRcdFx0IyAgICAgZWxzZSB0aHJvdyBlcnJvclxyXG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcclxuXHRcdFx0XHR0cnlcclxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXHJcblx0XHRcdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xyXG5cdFx0XHRcdFx0XHRjYihydWxlLCBbc3RyLnN1YnN0cmluZyhwb3MsIG5ld1BvcyldKVxyXG5cdFx0XHRcdFx0cmV0dXJuIG5ld1Bvc1xyXG5cclxuXHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IgXCJBbnkgUnVsZSBub3QgbWF0Y2hlZFwiXHJcblx0XHRcdClcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxyXG5cclxuXHRBbGwgOj0gKGxMYXhSdWxlczogVExheFJ1bGVbXSk6IFJ1bGUgPT5cclxuXHJcblx0XHRsUnVsZXMgOj0gZm9yIGxheFJ1bGUgb2YgbExheFJ1bGVzXHJcblx0XHRcdGdldFJ1bGUgbGF4UnVsZVxyXG5cclxuXHRcdHJldHVybiBuZXcgUnVsZSgnJicsIChzdHIsIHBvcyk6IG51bWJlciA9PlxyXG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcclxuXHRcdFx0XHR0cnlcclxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXHJcblx0XHRcdFx0XHRwb3MgPSBuZXdQb3NcclxuXHRcdFx0XHRjYXRjaCBlcnJcclxuXHRcdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiQWxsIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3NcclxuXHRcdFx0XHRjYihydWxlLCBbXSlcclxuXHRcdFx0cmV0dXJuIHBvc1xyXG5cdFx0XHQpXHJcblxyXG5cdCMgLS0tIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgdGhyb3dzIGFuIGVycm9yXHJcblx0IyAgICAgaWYgc3RyaW5nIGRvZXNuJ3QgcGFyc2VcclxuXHJcblx0cnVsZSA6PSBnZXRSdWxlIGxheFJ1bGVcclxuXHRyZXR1cm4gKHN0cikgPT5cclxuXHRcdERCRyBcIlBhcnNlICN7ZXNjYXBlU3RyKHN0cil9XCIsIElOREVOVFxyXG5cdFx0dHJ5XHJcblx0XHRcdGVuZFBvcyA6PSBydWxlLm5leHQoc3RyLCAwKVxyXG5cdFx0XHREQkcgXCJlbmRQb3MgPSAje2VuZFBvc31cIlxyXG5cdFx0XHRpZiAoZW5kUG9zID09IHN0ci5sZW5ndGgpIHx8IHBhcnRpYWxcclxuXHRcdFx0XHREQkcgVU5ERU5UXHJcblx0XHRcdFx0cmV0dXJuIHRydWVcclxuXHRcdFx0ZmluYWxQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBlbmRQb3MpXHJcblx0XHRcdERCRyBcImZpbmFsUG9zID0gI3tmaW5hbFBvc31cIiwgVU5ERU5UXHJcblx0XHRcdGlmIChmaW5hbFBvcyAhPSBzdHIubGVuZ3RoKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yKFwiTm90IGFsbCBpbnB1dCBleGhhdXN0ZWRcIilcclxuXHRcdFx0cmV0dXJuXHJcblx0XHRjYXRjaCBlcnJcclxuXHRcdFx0REJHIFVOREVOVFxyXG5cdFx0XHR0aHJvdyBlcnJcclxuIl19