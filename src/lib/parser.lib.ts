"use strict";
// parser.lib.civet

import {
	undef, defined, notdefined, assert, hash, hashof,
	isArray, isFunction, isString, isRegExp, isHash,
	} from 'datatypes'
import {
	getOptions, escapeStr, spaces, randomLabel, OL,
	getLineAndColumn,
	} from 'llutils'
import {
	DBG, INDENT, UNDENT,
	} from 'logger'

// ---------------------------------------------------------------------------

export type TRuleFunc = (str: string, pos: number) => number

export const isRuleFunc = (x: unknown): x is TRuleFunc => {
	return (typeof x === 'function')
}

export class Rule {
	type: string
	func: TRuleFunc
	label: string = randomLabel()
	lChildren: Rule[] = []

	constructor(
			type: string,
			func: TRuleFunc,
			lChildren: Rule[] = []
			) {
		this.type = type
		this.func = func
		this.lChildren = []
	}

	next(str: string, pos: number): number {
		return this.func(str, pos)
	}
}

// --- Anything that can be converted to a Rule
export type TLaxRule = RegExp | string | TRuleFunc | TLaxRule[] | hashof<TLaxRule>

export type TCallback = (rule: Rule, lMatches: string[]) => void

// ---------------------------------------------------------------------------
// --- Custom errors

export class ParseError extends Error {

	constructor(msg: string) {
		super(msg)
		this.name = 'ParseError'
	}
}

// ---------------------------------------------------------------------------
// --- Returns a function that:
//        1. accepts a string
//        2. throws error on failure

export type TParser = (str: string) => void

export function getParser(
		laxRule: TLaxRule,
		lCallbacks: TCallback[] = [],
		hOptions: hash = {}
		): TParser {

	type opt = {
		reSkip: RegExp
		partial: boolean
		}
	const {reSkip, partial} = getOptions<opt>(hOptions, {
		reSkip: /^\s+/,
		partial: false
		})

	// ..........................................................
	// function that skips reSkip, if defined

	const skipIgnored: TRuleFunc = (str, pos) => {

		const lMatches = str.substring(pos).match(reSkip)
		if (defined(lMatches)) {
			const len = lMatches[0].length
			if (len > 0) {
				DBG(`${len} chars skipped`)
			}
			return pos + len
		}
		else {
			return pos
		}
	}

	// ..........................................................
	// --- function that maps RegExp => Rule

	const RegexMatcher = (re: RegExp): Rule => {

		return new Rule('r', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			const lMatches = re.exec(str.substring(skipPos))
			if (lMatches === null) {
				throw new ParseError("RegExp Rule not matched")
			}

			const len = lMatches[0].length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, lMatches)
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps string => Rule

	const StringMatcher = (substr: string): Rule => {

		return new Rule('s', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			if (!str.startsWith(substr, skipPos)) {
				throw new ParseError("String Rule not matched")
			}

			const len = substr.length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, [substr])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TRuleFunc => Rule

	const FuncMatcher = (func: TRuleFunc): Rule => {

		return new Rule('f', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)
			const newPos = func(str, skipPos)
			assert((newPos > pos), "Zero length in rule match")
			for (const cb of lCallbacks) {
				cb(rule, [str.substring(pos, newPos)])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule => Rule

	const getRule = (laxRule: TLaxRule): Rule => {

		if (isRegExp(laxRule)) {
			return RegexMatcher(laxRule)
		}

		else if (isString(laxRule)) {
			return StringMatcher(laxRule)
		}

		else if (isRuleFunc(laxRule)) {
			return FuncMatcher(laxRule)
		}

		else if (isArray(laxRule)) {
			return All(laxRule)
		}

		else {
			return Any(laxRule)
		}
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const Any = (hItems: hashof<TLaxRule>): Rule => {

		const results=[];for (const key in hItems) {const val = hItems[key];
			const rule = getRule(val as TLaxRule)
			rule.label = key
			results.push(rule)
		};const lRules =results

		return new Rule('|', (str, pos): number => {
			// --- Try each rule
			//     if any succeed, succeed & return new pos
			//     else throw error
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					for (const cb of lCallbacks) {
						cb(rule, [str.substring(pos, newPos)])
					}
					return newPos
				} catch(e) {}
			}

			throw new ParseError("Any Rule not matched")
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const All = (lLaxRules: TLaxRule[]): Rule => {

		const results1=[];for (const laxRule of lLaxRules) {
			results1.push(getRule(laxRule))
		};const lRules =results1

		return new Rule('&', (str, pos): number => {
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					pos = newPos
				}
				catch (err) {
					throw new ParseError("All Rule not matched")
				}
			}

			for (const cb of lCallbacks) {
				cb(rule, [])
			}
			return pos
		}
			)
	}

	// --- Return a function that throws an error
	//     if string doesn't parse

	const rule = getRule(laxRule)
	return (str) => {
		DBG(`Parse ${escapeStr(str)}`, INDENT)
		try {
			const endPos = rule.next(str, 0)
			DBG(`endPos = ${endPos}`)
			if ((endPos === str.length) || partial) {
				DBG(UNDENT)
				return true
			}
			const finalPos = skipIgnored(str, endPos)
			DBG(`finalPos = ${finalPos}`, UNDENT)
			if (finalPos !== str.length) {
				throw new ParseError("Not all input exhausted")
			}
			return
		}
		catch (err) {
			DBG(UNDENT)
			throw err
		}
	}
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDakQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDaEQsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNyQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNoQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTTtBQUM1RCxBQUFBO0FBQ0EsQUFBQSxB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QUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyw0Q0FBMkM7QUFDNUMsQUFBQTtBQUNBLEFBQUEsQ0FBSSxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDeEMsQUFBQTtBQUNBLEFBQUEsRSxLLEMsUSxHLENBQVksR0FBRyxDQUFDLENBQUEsTUFBQSxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQSxDQUFBLENBQUE7QUFDcEMsQUFBQSxHLFEsTUFBRyxPQUFPLENBQUEsQUFBQyxPQUFPLEMsQztFQUFBLEMsQ0FEVixNQUFOLE1BQU0sQ0FBQyxDLFFBQ1M7QUFDbEIsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQzVDLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFBLENBQUEsQ0FBQTtBQUNyQixBQUFBLElBQUksR0FBRyxDQUFBLENBQUE7QUFDUCxBQUFBLEtBQVcsTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ2xDLEFBQUEsS0FBSyxHQUFHLEMsQ0FBRSxDQUFDLE07SUFBTSxDQUFBO0FBQ2pCLEFBQUEsSUFBSSxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ2IsQUFBQSxLQUFLLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFBLEFBQUMsc0JBQXNCLEM7SUFBQSxDO0dBQUEsQ0FBQTtBQUNoRCxBQUFBO0FBQ0EsQUFBQSxHQUFHLEdBQUcsQ0FBQyxDQUFBLE1BQUEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUEsQ0FBQSxDQUFBO0FBQ3ZCLEFBQUEsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEM7R0FBQyxDQUFBO0FBQ2hCLEFBQUEsR0FBRyxNQUFNLENBQUMsRztFQUFHLENBQUE7QUFDYixHQUFHLEM7Q0FBQyxDQUFBO0FBQ0osQUFBQTtBQUNBLEFBQUEsQ0FBQyw2Q0FBNEM7QUFDN0MsQUFBQSxDQUFDLDhCQUE2QjtBQUM5QixBQUFBO0FBQ0EsQUFBQSxDQUFLLE1BQUosSUFBSSxDQUFDLENBQUUsQ0FBQyxPQUFPLENBQUEsQUFBQyxPQUFPLENBQUE7QUFDeEIsQUFBQSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ2hCLEFBQUEsRUFBRSxHQUFHLENBQUEsQUFBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQ3ZDLEFBQUEsRUFBRSxHQUFHLENBQUEsQ0FBQTtBQUNMLEFBQUEsR0FBUyxNQUFOLE1BQU0sQ0FBQyxDQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7QUFDM0IsQUFBQSxHQUFHLEdBQUcsQ0FBQSxDQUFDLE1BQU0sQ0FBQyxHQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUEsQ0FBQSxDQUFBO0FBQ3ZDLEFBQUEsSUFBSSxHQUFHLENBQUEsQUFBQyxNQUFNLENBQUE7QUFDZCxBQUFBLElBQUksTUFBTSxDQUFDLEk7R0FBSSxDQUFBO0FBQ2YsQUFBQSxHQUFXLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ3ZDLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQ3ZDLEFBQUEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUEsQ0FBQTtBQUM5QixBQUFBLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMseUJBQXlCLEM7R0FBQyxDQUFBO0FBQ25ELEFBQUEsR0FBRyxNO0VBQU0sQ0FBQTtBQUNULEFBQUEsRUFBRSxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ1gsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLE1BQU0sQ0FBQTtBQUNiLEFBQUEsR0FBRyxLQUFLLENBQUMsRztFQUFHLEM7Q0FBQSxDO0FBQUEsQ0FBQTtBQUNaIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIHBhcnNlci5saWIuY2l2ZXRcblxuaW1wb3J0IHtcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGFzc2VydCwgaGFzaCwgaGFzaG9mLFxuXHRpc0FycmF5LCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNSZWdFeHAsIGlzSGFzaCxcblx0fSBmcm9tICdkYXRhdHlwZXMnXG5pbXBvcnQge1xuXHRnZXRPcHRpb25zLCBlc2NhcGVTdHIsIHNwYWNlcywgcmFuZG9tTGFiZWwsIE9MLFxuXHRnZXRMaW5lQW5kQ29sdW1uLFxuXHR9IGZyb20gJ2xsdXRpbHMnXG5pbXBvcnQge1xuXHREQkcsIElOREVOVCwgVU5ERU5ULFxuXHR9IGZyb20gJ2xvZ2dlcidcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IHR5cGUgVFJ1bGVGdW5jID0gKHN0cjogc3RyaW5nLCBwb3M6IG51bWJlcikgPT4gbnVtYmVyXG5cbmV4cG9ydCBpc1J1bGVGdW5jIDo9ICh4OiB1bmtub3duKTogeCBpcyBUUnVsZUZ1bmMgPT5cblx0cmV0dXJuICh0eXBlb2YgeCA9PSAnZnVuY3Rpb24nKVxuXG5leHBvcnQgY2xhc3MgUnVsZVxuXHR0eXBlOiBzdHJpbmdcblx0ZnVuYzogVFJ1bGVGdW5jXG5cdGxhYmVsOiBzdHJpbmcgPSByYW5kb21MYWJlbCgpXG5cdGxDaGlsZHJlbjogUnVsZVtdID0gW11cblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRcdHR5cGU6IHN0cmluZyxcblx0XHRcdGZ1bmM6IFRSdWxlRnVuYyxcblx0XHRcdGxDaGlsZHJlbjogUnVsZVtdID0gW11cblx0XHRcdClcblx0XHRAdHlwZSA9IHR5cGVcblx0XHRAZnVuYyA9IGZ1bmNcblx0XHRAbENoaWxkcmVuID0gW11cblxuXHRuZXh0KHN0cjogc3RyaW5nLCBwb3M6IG51bWJlcik6IG51bWJlclxuXHRcdHJldHVybiBAZnVuYyhzdHIsIHBvcylcblxuIyAtLS0gQW55dGhpbmcgdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGEgUnVsZVxuZXhwb3J0IHR5cGUgVExheFJ1bGUgPSBSZWdFeHAgfCBzdHJpbmcgfCBUUnVsZUZ1bmMgfCBUTGF4UnVsZVtdIHwgaGFzaG9mPFRMYXhSdWxlPlxuXG5leHBvcnQgdHlwZSBUQ2FsbGJhY2sgPSAocnVsZTogUnVsZSwgbE1hdGNoZXM6IHN0cmluZ1tdKSA9PiB2b2lkXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4jIC0tLSBDdXN0b20gZXJyb3JzXG5cbmV4cG9ydCBjbGFzcyBQYXJzZUVycm9yIGV4dGVuZHMgRXJyb3JcblxuXHRjb25zdHJ1Y3Rvcihtc2c6IHN0cmluZylcblx0XHRzdXBlciBtc2dcblx0XHR0aGlzLm5hbWUgPSAnUGFyc2VFcnJvcidcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgLS0tIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0OlxuIyAgICAgICAgMS4gYWNjZXB0cyBhIHN0cmluZ1xuIyAgICAgICAgMi4gdGhyb3dzIGVycm9yIG9uIGZhaWx1cmVcblxuZXhwb3J0IHR5cGUgVFBhcnNlciA9IChzdHI6IHN0cmluZykgPT4gdm9pZFxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFyc2VyKFxuXHRcdGxheFJ1bGU6IFRMYXhSdWxlXG5cdFx0bENhbGxiYWNrczogVENhbGxiYWNrW10gPSBbXVxuXHRcdGhPcHRpb25zOiBoYXNoID0ge31cblx0XHQpOiBUUGFyc2VyXG5cblx0dHlwZSBvcHQgPSB7XG5cdFx0cmVTa2lwOiBSZWdFeHBcblx0XHRwYXJ0aWFsOiBib29sZWFuXG5cdFx0fVxuXHR7cmVTa2lwLCBwYXJ0aWFsfSA6PSBnZXRPcHRpb25zPG9wdD4gaE9wdGlvbnMsIHtcblx0XHRyZVNraXA6IC9eXFxzKy9cblx0XHRwYXJ0aWFsOiBmYWxzZVxuXHRcdH1cblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyBmdW5jdGlvbiB0aGF0IHNraXBzIHJlU2tpcCwgaWYgZGVmaW5lZFxuXG5cdHNraXBJZ25vcmVkOiBUUnVsZUZ1bmMgOj0gKHN0ciwgcG9zKSA9PlxuXG5cdFx0bE1hdGNoZXMgOj0gc3RyLnN1YnN0cmluZyhwb3MpLm1hdGNoIHJlU2tpcFxuXHRcdGlmIGRlZmluZWQobE1hdGNoZXMpXG5cdFx0XHRsZW4gOj0gbE1hdGNoZXNbMF0ubGVuZ3RoXG5cdFx0XHRpZiAobGVuID4gMClcblx0XHRcdFx0REJHIFwiI3tsZW59IGNoYXJzIHNraXBwZWRcIlxuXHRcdFx0cmV0dXJuIHBvcyArIGxlblxuXHRcdGVsc2Vcblx0XHRcdHJldHVybiBwb3NcblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFJlZ0V4cCA9PiBSdWxlXG5cblx0UmVnZXhNYXRjaGVyIDo9IChyZTogUmVnRXhwKTogUnVsZSA9PlxuXG5cdFx0cmV0dXJuIG5ldyBSdWxlKCdyJywgKHN0ciwgcG9zKTogbnVtYmVyID0+XG5cblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXG5cblx0XHRcdGxNYXRjaGVzIDo9IHJlLmV4ZWMoc3RyLnN1YnN0cmluZyhza2lwUG9zKSlcblx0XHRcdGlmIChsTWF0Y2hlcyA9PSBudWxsKVxuXHRcdFx0XHR0aHJvdyBuZXcgUGFyc2VFcnJvciBcIlJlZ0V4cCBSdWxlIG5vdCBtYXRjaGVkXCJcblxuXHRcdFx0bGVuIDo9IGxNYXRjaGVzWzBdLmxlbmd0aFxuXHRcdFx0YXNzZXJ0IChsZW4gPiAwKSwgXCJaZXJvIGxlbmd0aCBpbiByZWdleCBtYXRjaFwiXG5cdFx0XHRuZXdQb3MgOj0gc2tpcFBvcyArIGxlblxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3Ncblx0XHRcdFx0Y2IocnVsZSwgbE1hdGNoZXMpXG5cdFx0XHRyZXR1cm4gbmV3UG9zXG5cdFx0XHQpXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBzdHJpbmcgPT4gUnVsZVxuXG5cdFN0cmluZ01hdGNoZXIgOj0gKHN1YnN0cjogc3RyaW5nKTogUnVsZSA9PlxuXG5cdFx0cmV0dXJuIG5ldyBSdWxlKCdzJywgKHN0ciwgcG9zKTogbnVtYmVyID0+XG5cblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXG5cblx0XHRcdGlmIG5vdCBzdHIuc3RhcnRzV2l0aChzdWJzdHIsIHNraXBQb3MpXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiU3RyaW5nIFJ1bGUgbm90IG1hdGNoZWRcIlxuXG5cdFx0XHRsZW4gOj0gc3Vic3RyLmxlbmd0aFxuXHRcdFx0YXNzZXJ0IChsZW4gPiAwKSwgXCJaZXJvIGxlbmd0aCBpbiByZWdleCBtYXRjaFwiXG5cdFx0XHRuZXdQb3MgOj0gc2tpcFBvcyArIGxlblxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3Ncblx0XHRcdFx0Y2IocnVsZSwgW3N1YnN0cl0pXG5cdFx0XHRyZXR1cm4gbmV3UG9zXG5cdFx0XHQpXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBUUnVsZUZ1bmMgPT4gUnVsZVxuXG5cdEZ1bmNNYXRjaGVyIDo9IChmdW5jOiBUUnVsZUZ1bmMpOiBSdWxlID0+XG5cblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ2YnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cblxuXHRcdFx0c2tpcFBvcyA6PSBza2lwSWdub3JlZChzdHIsIHBvcylcblx0XHRcdG5ld1BvcyA6PSBmdW5jKHN0ciwgc2tpcFBvcylcblx0XHRcdGFzc2VydCAobmV3UG9zID4gcG9zKSwgXCJaZXJvIGxlbmd0aCBpbiBydWxlIG1hdGNoXCJcblx0XHRcdGZvciBjYiBvZiBsQ2FsbGJhY2tzXG5cdFx0XHRcdGNiKHJ1bGUsIFtzdHIuc3Vic3RyaW5nKHBvcywgbmV3UG9zKV0pXG5cdFx0XHRyZXR1cm4gbmV3UG9zXG5cdFx0XHQpXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBUTGF4UnVsZSA9PiBSdWxlXG5cblx0Z2V0UnVsZSA6PSAobGF4UnVsZTogVExheFJ1bGUpOiBSdWxlID0+XG5cblx0XHRpZiBpc1JlZ0V4cChsYXhSdWxlKVxuXHRcdFx0cmV0dXJuIFJlZ2V4TWF0Y2hlcihsYXhSdWxlKVxuXG5cdFx0ZWxzZSBpZiBpc1N0cmluZyhsYXhSdWxlKVxuXHRcdFx0cmV0dXJuIFN0cmluZ01hdGNoZXIobGF4UnVsZSlcblxuXHRcdGVsc2UgaWYgaXNSdWxlRnVuYyhsYXhSdWxlKVxuXHRcdFx0cmV0dXJuIEZ1bmNNYXRjaGVyKGxheFJ1bGUpXG5cblx0XHRlbHNlIGlmIGlzQXJyYXkobGF4UnVsZSlcblx0XHRcdHJldHVybiBBbGwgbGF4UnVsZVxuXG5cdFx0ZWxzZVxuXHRcdFx0cmV0dXJuIEFueSBsYXhSdWxlXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBUTGF4UnVsZVtdID0+IFJ1bGVcblxuXHRBbnkgOj0gKGhJdGVtczogaGFzaG9mPFRMYXhSdWxlPik6IFJ1bGUgPT5cblxuXHRcdGxSdWxlcyA6PSBmb3Iga2V5LHZhbCBpbiBoSXRlbXNcblx0XHRcdHJ1bGUgOj0gZ2V0UnVsZSh2YWwgYXMgVExheFJ1bGUpXG5cdFx0XHRydWxlLmxhYmVsID0ga2V5XG5cdFx0XHRydWxlXG5cblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3wnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cblx0XHRcdCMgLS0tIFRyeSBlYWNoIHJ1bGVcblx0XHRcdCMgICAgIGlmIGFueSBzdWNjZWVkLCBzdWNjZWVkICYgcmV0dXJuIG5ldyBwb3Ncblx0XHRcdCMgICAgIGVsc2UgdGhyb3cgZXJyb3Jcblx0XHRcdGZvciBydWxlIG9mIGxSdWxlc1xuXHRcdFx0XHR0cnlcblx0XHRcdFx0XHRuZXdQb3MgOj0gcnVsZS5uZXh0KHN0ciwgcG9zKVxuXHRcdFx0XHRcdGZvciBjYiBvZiBsQ2FsbGJhY2tzXG5cdFx0XHRcdFx0XHRjYihydWxlLCBbc3RyLnN1YnN0cmluZyhwb3MsIG5ld1BvcyldKVxuXHRcdFx0XHRcdHJldHVybiBuZXdQb3NcblxuXHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IgXCJBbnkgUnVsZSBub3QgbWF0Y2hlZFwiXG5cdFx0XHQpXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBUTGF4UnVsZVtdID0+IFJ1bGVcblxuXHRBbGwgOj0gKGxMYXhSdWxlczogVExheFJ1bGVbXSk6IFJ1bGUgPT5cblxuXHRcdGxSdWxlcyA6PSBmb3IgbGF4UnVsZSBvZiBsTGF4UnVsZXNcblx0XHRcdGdldFJ1bGUgbGF4UnVsZVxuXG5cdFx0cmV0dXJuIG5ldyBSdWxlKCcmJywgKHN0ciwgcG9zKTogbnVtYmVyID0+XG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcblx0XHRcdFx0dHJ5XG5cdFx0XHRcdFx0bmV3UG9zIDo9IHJ1bGUubmV4dChzdHIsIHBvcylcblx0XHRcdFx0XHRwb3MgPSBuZXdQb3Ncblx0XHRcdFx0Y2F0Y2ggZXJyXG5cdFx0XHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IgXCJBbGwgUnVsZSBub3QgbWF0Y2hlZFwiXG5cblx0XHRcdGZvciBjYiBvZiBsQ2FsbGJhY2tzXG5cdFx0XHRcdGNiKHJ1bGUsIFtdKVxuXHRcdFx0cmV0dXJuIHBvc1xuXHRcdFx0KVxuXG5cdCMgLS0tIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgdGhyb3dzIGFuIGVycm9yXG5cdCMgICAgIGlmIHN0cmluZyBkb2Vzbid0IHBhcnNlXG5cblx0cnVsZSA6PSBnZXRSdWxlIGxheFJ1bGVcblx0cmV0dXJuIChzdHIpID0+XG5cdFx0REJHIFwiUGFyc2UgI3tlc2NhcGVTdHIoc3RyKX1cIiwgSU5ERU5UXG5cdFx0dHJ5XG5cdFx0XHRlbmRQb3MgOj0gcnVsZS5uZXh0KHN0ciwgMClcblx0XHRcdERCRyBcImVuZFBvcyA9ICN7ZW5kUG9zfVwiXG5cdFx0XHRpZiAoZW5kUG9zID09IHN0ci5sZW5ndGgpIHx8IHBhcnRpYWxcblx0XHRcdFx0REJHIFVOREVOVFxuXHRcdFx0XHRyZXR1cm4gdHJ1ZVxuXHRcdFx0ZmluYWxQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBlbmRQb3MpXG5cdFx0XHREQkcgXCJmaW5hbFBvcyA9ICN7ZmluYWxQb3N9XCIsIFVOREVOVFxuXHRcdFx0aWYgKGZpbmFsUG9zICE9IHN0ci5sZW5ndGgpXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yKFwiTm90IGFsbCBpbnB1dCBleGhhdXN0ZWRcIilcblx0XHRcdHJldHVyblxuXHRcdGNhdGNoIGVyclxuXHRcdFx0REJHIFVOREVOVFxuXHRcdFx0dGhyb3cgZXJyXG4iXX0=