"use strict";
// parser.lib.civet

import {
	undef, defined, notdefined, assert, hash, hashof,
	isArray, isFunction, isString, isRegExp, isHash,
	} from 'datatypes'
import {
	getOptions, escapeStr, spaces, randomLabel, OL,
	getLineAndColumn,
	} from 'llutils'
import {
	DBG, INDENT, UNDENT,
	} from 'logger'

// ---------------------------------------------------------------------------

export type TRuleFunc = (str: string, pos: number) => number
export const isRuleFunc = (x: any): x is TRuleFunc => {
	return (typeof x === 'function')
}

export class Rule {
	type: string
	func: TRuleFunc
	label: string = randomLabel()
	lChildren: Rule[] = []

	constructor(
			type: string,
			func: TRuleFunc,
			lChildren: Rule[] = []
			) {
		this.type = type
		this.func = func
		this.lChildren = []
	}

	next(str: string, pos: number): number {
		return this.func(str, pos)
	}
}

// --- Anything that can be converted to a Rule
export type TLaxRule = RegExp | string | TRuleFunc | TLaxRule[] | hashof<TLaxRule>

export type TCallback = (rule: Rule, lMatches: string[]) => void

// ---------------------------------------------------------------------------
// --- Custom errors

export class ParseError extends Error {

	constructor(msg: string) {
		super(msg)
		this.name = 'ParseError'
	}
}

// ---------------------------------------------------------------------------
// --- Returns a function that:
//        1. accepts a string
//        2. throws error on failure

export type TParser = (str: string) => void

export function getParser(
		laxRule: TLaxRule,
		lCallbacks: TCallback[] = [],
		hOptions: hash = {}
		): TParser {

	type opt = {
		reSkip: RegExp
		partial: boolean
		}
	const {reSkip, partial} = getOptions<opt>(hOptions, {
		reSkip: /^\s+/,
		partial: false
		})

	// ..........................................................
	// function that skips reSkip, if defined

	const skipIgnored: TRuleFunc = (str, pos) => {

		const lMatches = str.substring(pos).match(reSkip)
		if (defined(lMatches)) {
			const len = lMatches[0].length
			if (len > 0) {
				DBG(`${len} chars skipped`)
			}
			return pos + len
		}
		else {
			return pos
		}
	}

	// ..........................................................
	// --- function that maps RegExp => Rule

	const RegexMatcher = (re: RegExp): Rule => {

		return new Rule('r', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			const lMatches = re.exec(str.substring(skipPos))
			if (lMatches === null) {
				throw new ParseError("RegExp Rule not matched")
			}

			const len = lMatches[0].length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, lMatches)
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps string => Rule

	const StringMatcher = (substr: string): Rule => {

		return new Rule('s', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			if (!str.startsWith(substr, skipPos)) {
				throw new ParseError("String Rule not matched")
			}

			const len = substr.length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, [substr])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TRuleFunc => Rule

	const FuncMatcher = (func: TRuleFunc): Rule => {

		return new Rule('f', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)
			const newPos = func(str, skipPos)
			assert((newPos > pos), "Zero length in rule match")
			for (const cb of lCallbacks) {
				cb(rule, [str.substring(pos, newPos)])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule => Rule

	const getRule = (laxRule: TLaxRule): Rule => {

		if (isRegExp(laxRule)) {
			return RegexMatcher(laxRule)
		}

		else if (isString(laxRule)) {
			return StringMatcher(laxRule)
		}

		else if (isRuleFunc(laxRule)) {
			return FuncMatcher(laxRule)
		}

		else if (isArray(laxRule)) {
			return All(laxRule)
		}

		else {
			return Any(laxRule)
		}
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const Any = (hItems: hashof<TLaxRule>): Rule => {

		const results=[];for (const key in hItems) {const val = hItems[key];
			const rule = getRule(val as TLaxRule)
			rule.label = key
			results.push(rule)
		};const lRules =results

		return new Rule('|', (str, pos): number => {
			// --- Try each rule
			//     if any succeed, succeed & return new pos
			//     else throw error
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					for (const cb of lCallbacks) {
						cb(rule, [str.substring(pos, newPos)])
					}
					return newPos
				} catch(e) {}
			}

			throw new ParseError("Any Rule not matched")
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const All = (lLaxRules: TLaxRule[]): Rule => {

		const results1=[];for (const laxRule of lLaxRules) {
			results1.push(getRule(laxRule))
		};const lRules =results1

		return new Rule('&', (str, pos): number => {
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					pos = newPos
				}
				catch (err) {
					throw new ParseError("All Rule not matched")
				}
			}

			for (const cb of lCallbacks) {
				cb(rule, [])
			}
			return pos
		}
			)
	}

	// --- Return a function that throws an error
	//     if string doesn't parse

	const rule = getRule(laxRule)
	return (str) => {
		DBG(`Parse ${escapeStr(str)}`, INDENT)
		try {
			const endPos = rule.next(str, 0)
			DBG(`endPos = ${endPos}`)
			if ((endPos === str.length) || partial) {
				DBG(UNDENT)
				return true
			}
			const finalPos = skipIgnored(str, endPos)
			DBG(`finalPos = ${finalPos}`, UNDENT)
			if (finalPos !== str.length) {
				throw new ParseError("Not all input exhausted")
			}
			return
		}
		catch (err) {
			DBG(UNDENT)
			throw err
		}
	}
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9wYXJzZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2xpYi9wYXJzZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDakQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDaEQsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNyQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNoQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTTtBQUM1RCxBQUFBLEFBQUEsTUFBTSxDQUFXLE1BQVYsVUFBVSxDQUFDLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDaEQsQUFBQSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRSxDQUFDLFVBQVUsQztBQUFDLENBQUE7QUFDaEMsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQSxDQUFBO0FBQ2pCLEFBQUEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNO0FBQ2IsQUFBQSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVM7QUFDaEIsQUFBQSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDOUIsQUFBQSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QixBQUFBO0FBQ0EsQUFBQSxDLFdBQVksQ0FBQztBQUNiLEFBQUEsR0FBRyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDaEIsQUFBQSxHQUFHLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNuQixBQUFBLEdBQUcsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLEdBQUcsQ0FBQyxDQUFBLENBQUE7QUFDSixBQUFBLEVBQUUsSSxDQUFDLElBQUksQyxDQUFFLENBQUMsSUFBSTtBQUNkLEFBQUEsRUFBRSxJLENBQUMsSUFBSSxDLENBQUUsQ0FBQyxJQUFJO0FBQ2QsQUFBQSxFQUFFLEksQ0FBQyxTQUFTLEMsQ0FBRSxDQUFDLENBQUMsQztDQUFDLENBQUE7QUFDakIsQUFBQTtBQUNBLEFBQUEsQyxJQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUEsQ0FBQTtBQUN2QyxBQUFBLEVBQUUsTUFBTSxDQUFD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LENBQUMsQ0FBQyxDQUFDLENBQUMsQztHQUFDLENBQUE7QUFDaEIsQUFBQSxHQUFHLE1BQU0sQ0FBQyxHO0VBQUcsQ0FBQTtBQUNiLEdBQUcsQztDQUFDLENBQUE7QUFDSixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZDQUE0QztBQUM3QyxBQUFBLENBQUMsOEJBQTZCO0FBQzlCLEFBQUE7QUFDQSxBQUFBLENBQUssTUFBSixJQUFJLENBQUMsQ0FBRSxDQUFDLE9BQU8sQ0FBQSxBQUFDLE9BQU8sQ0FBQTtBQUN4QixBQUFBLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDaEIsQUFBQSxFQUFFLEdBQUcsQ0FBQSxBQUFDLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFDdkMsQUFBQSxFQUFFLEdBQUcsQ0FBQSxDQUFBO0FBQ0wsQUFBQSxHQUFTLE1BQU4sTUFBTSxDQUFDLENBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixBQUFBLEdBQUcsR0FBRyxDQUFBLEFBQUMsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtBQUMzQixBQUFBLEdBQUcsR0FBRyxDQUFBLENBQUMsTUFBTSxDQUFDLEdBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQSxDQUFBLENBQUE7QUFDdkMsQUFBQSxJQUFJLEdBQUcsQ0FBQSxBQUFDLE1BQU0sQ0FBQTtBQUNkLEFBQUEsSUFBSSxNQUFNLENBQUMsSTtHQUFJLENBQUE7QUFDZixBQUFBLEdBQVcsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDdkMsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFDdkMsQUFBQSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFBO0FBQzlCLEFBQUEsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyx5QkFBeUIsQztHQUFDLENBQUE7QUFDbkQsQUFBQSxHQUFHLE07RUFBTSxDQUFBO0FBQ1QsQUFBQSxFQUFFLEtBQUssQ0FBQyxDQUFBLEdBQUcsQ0FBQSxDQUFBLENBQUE7QUFDWCxBQUFBLEdBQUcsR0FBRyxDQUFBLEFBQUMsTUFBTSxDQUFBO0FBQ2IsQUFBQSxHQUFHLEtBQUssQ0FBQyxHO0VBQUcsQztDQUFBLEM7QUFBQSxDQUFBO0FBQ1oiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgcGFyc2VyLmxpYi5jaXZldFxuXG5pbXBvcnQge1xuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCwgYXNzZXJ0LCBoYXNoLCBoYXNob2YsXG5cdGlzQXJyYXksIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc1JlZ0V4cCwgaXNIYXNoLFxuXHR9IGZyb20gJ2RhdGF0eXBlcydcbmltcG9ydCB7XG5cdGdldE9wdGlvbnMsIGVzY2FwZVN0ciwgc3BhY2VzLCByYW5kb21MYWJlbCwgT0wsXG5cdGdldExpbmVBbmRDb2x1bW4sXG5cdH0gZnJvbSAnbGx1dGlscydcbmltcG9ydCB7XG5cdERCRywgSU5ERU5ULCBVTkRFTlQsXG5cdH0gZnJvbSAnbG9nZ2VyJ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgdHlwZSBUUnVsZUZ1bmMgPSAoc3RyOiBzdHJpbmcsIHBvczogbnVtYmVyKSA9PiBudW1iZXJcbmV4cG9ydCBpc1J1bGVGdW5jIDo9ICh4OiBhbnkpOiB4IGlzIFRSdWxlRnVuYyA9PlxuXHRyZXR1cm4gKHR5cGVvZiB4ID09ICdmdW5jdGlvbicpXG5cbmV4cG9ydCBjbGFzcyBSdWxlXG5cdHR5cGU6IHN0cmluZ1xuXHRmdW5jOiBUUnVsZUZ1bmNcblx0bGFiZWw6IHN0cmluZyA9IHJhbmRvbUxhYmVsKClcblx0bENoaWxkcmVuOiBSdWxlW10gPSBbXVxuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdFx0dHlwZTogc3RyaW5nLFxuXHRcdFx0ZnVuYzogVFJ1bGVGdW5jLFxuXHRcdFx0bENoaWxkcmVuOiBSdWxlW10gPSBbXVxuXHRcdFx0KVxuXHRcdEB0eXBlID0gdHlwZVxuXHRcdEBmdW5jID0gZnVuY1xuXHRcdEBsQ2hpbGRyZW4gPSBbXVxuXG5cdG5leHQoc3RyOiBzdHJpbmcsIHBvczogbnVtYmVyKTogbnVtYmVyXG5cdFx0cmV0dXJuIEBmdW5jKHN0ciwgcG9zKVxuXG4jIC0tLSBBbnl0aGluZyB0aGF0IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYSBSdWxlXG5leHBvcnQgdHlwZSBUTGF4UnVsZSA9IFJlZ0V4cCB8IHN0cmluZyB8IFRSdWxlRnVuYyB8IFRMYXhSdWxlW10gfCBoYXNob2Y8VExheFJ1bGU+XG5cbmV4cG9ydCB0eXBlIFRDYWxsYmFjayA9IChydWxlOiBSdWxlLCBsTWF0Y2hlczogc3RyaW5nW10pID0+IHZvaWRcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgLS0tIEN1c3RvbSBlcnJvcnNcblxuZXhwb3J0IGNsYXNzIFBhcnNlRXJyb3IgZXh0ZW5kcyBFcnJvclxuXG5cdGNvbnN0cnVjdG9yKG1zZzogc3RyaW5nKVxuXHRcdHN1cGVyIG1zZ1xuXHRcdHRoaXMubmFtZSA9ICdQYXJzZUVycm9yJ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIyAtLS0gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQ6XG4jICAgICAgICAxLiBhY2NlcHRzIGEgc3RyaW5nXG4jICAgICAgICAyLiB0aHJvd3MgZXJyb3Igb24gZmFpbHVyZVxuXG5leHBvcnQgdHlwZSBUUGFyc2VyID0gKHN0cjogc3RyaW5nKSA9PiB2b2lkXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXJzZXIoXG5cdFx0bGF4UnVsZTogVExheFJ1bGVcblx0XHRsQ2FsbGJhY2tzOiBUQ2FsbGJhY2tbXSA9IFtdXG5cdFx0aE9wdGlvbnM6IGhhc2ggPSB7fVxuXHRcdCk6IFRQYXJzZXJcblxuXHR0eXBlIG9wdCA9IHtcblx0XHRyZVNraXA6IFJlZ0V4cFxuXHRcdHBhcnRpYWw6IGJvb2xlYW5cblx0XHR9XG5cdHtyZVNraXAsIHBhcnRpYWx9IDo9IGdldE9wdGlvbnM8b3B0PiBoT3B0aW9ucywge1xuXHRcdHJlU2tpcDogL15cXHMrL1xuXHRcdHBhcnRpYWw6IGZhbHNlXG5cdFx0fVxuXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuXHQjIGZ1bmN0aW9uIHRoYXQgc2tpcHMgcmVTa2lwLCBpZiBkZWZpbmVkXG5cblx0c2tpcElnbm9yZWQ6IFRSdWxlRnVuYyA6PSAoc3RyLCBwb3MpID0+XG5cblx0XHRsTWF0Y2hlcyA6PSBzdHIuc3Vic3RyaW5nKHBvcykubWF0Y2ggcmVTa2lwXG5cdFx0aWYgZGVmaW5lZChsTWF0Y2hlcylcblx0XHRcdGxlbiA6PSBsTWF0Y2hlc1swXS5sZW5ndGhcblx0XHRcdGlmIChsZW4gPiAwKVxuXHRcdFx0XHREQkcgXCIje2xlbn0gY2hhcnMgc2tpcHBlZFwiXG5cdFx0XHRyZXR1cm4gcG9zICsgbGVuXG5cdFx0ZWxzZVxuXHRcdFx0cmV0dXJuIHBvc1xuXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuXHQjIC0tLSBmdW5jdGlvbiB0aGF0IG1hcHMgUmVnRXhwID0+IFJ1bGVcblxuXHRSZWdleE1hdGNoZXIgOj0gKHJlOiBSZWdFeHApOiBSdWxlID0+XG5cblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3InLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cblxuXHRcdFx0c2tpcFBvcyA6PSBza2lwSWdub3JlZChzdHIsIHBvcylcblxuXHRcdFx0bE1hdGNoZXMgOj0gcmUuZXhlYyhzdHIuc3Vic3RyaW5nKHNraXBQb3MpKVxuXHRcdFx0aWYgKGxNYXRjaGVzID09IG51bGwpXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiUmVnRXhwIFJ1bGUgbm90IG1hdGNoZWRcIlxuXG5cdFx0XHRsZW4gOj0gbE1hdGNoZXNbMF0ubGVuZ3RoXG5cdFx0XHRhc3NlcnQgKGxlbiA+IDApLCBcIlplcm8gbGVuZ3RoIGluIHJlZ2V4IG1hdGNoXCJcblx0XHRcdG5ld1BvcyA6PSBza2lwUG9zICsgbGVuXG5cdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xuXHRcdFx0XHRjYihydWxlLCBsTWF0Y2hlcylcblx0XHRcdHJldHVybiBuZXdQb3Ncblx0XHRcdClcblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIHN0cmluZyA9PiBSdWxlXG5cblx0U3RyaW5nTWF0Y2hlciA6PSAoc3Vic3RyOiBzdHJpbmcpOiBSdWxlID0+XG5cblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3MnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cblxuXHRcdFx0c2tpcFBvcyA6PSBza2lwSWdub3JlZChzdHIsIHBvcylcblxuXHRcdFx0aWYgbm90IHN0ci5zdGFydHNXaXRoKHN1YnN0ciwgc2tpcFBvcylcblx0XHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IgXCJTdHJpbmcgUnVsZSBub3QgbWF0Y2hlZFwiXG5cblx0XHRcdGxlbiA6PSBzdWJzdHIubGVuZ3RoXG5cdFx0XHRhc3NlcnQgKGxlbiA+IDApLCBcIlplcm8gbGVuZ3RoIGluIHJlZ2V4IG1hdGNoXCJcblx0XHRcdG5ld1BvcyA6PSBza2lwUG9zICsgbGVuXG5cdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xuXHRcdFx0XHRjYihydWxlLCBbc3Vic3RyXSlcblx0XHRcdHJldHVybiBuZXdQb3Ncblx0XHRcdClcblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRSdWxlRnVuYyA9PiBSdWxlXG5cblx0RnVuY01hdGNoZXIgOj0gKGZ1bmM6IFRSdWxlRnVuYyk6IFJ1bGUgPT5cblxuXHRcdHJldHVybiBuZXcgUnVsZSgnZicsIChzdHIsIHBvcyk6IG51bWJlciA9PlxuXG5cdFx0XHRza2lwUG9zIDo9IHNraXBJZ25vcmVkKHN0ciwgcG9zKVxuXHRcdFx0bmV3UG9zIDo9IGZ1bmMoc3RyLCBza2lwUG9zKVxuXHRcdFx0YXNzZXJ0IChuZXdQb3MgPiBwb3MpLCBcIlplcm8gbGVuZ3RoIGluIHJ1bGUgbWF0Y2hcIlxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3Ncblx0XHRcdFx0Y2IocnVsZSwgW3N0ci5zdWJzdHJpbmcocG9zLCBuZXdQb3MpXSlcblx0XHRcdHJldHVybiBuZXdQb3Ncblx0XHRcdClcblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlID0+IFJ1bGVcblxuXHRnZXRSdWxlIDo9IChsYXhSdWxlOiBUTGF4UnVsZSk6IFJ1bGUgPT5cblxuXHRcdGlmIGlzUmVnRXhwKGxheFJ1bGUpXG5cdFx0XHRyZXR1cm4gUmVnZXhNYXRjaGVyKGxheFJ1bGUpXG5cblx0XHRlbHNlIGlmIGlzU3RyaW5nKGxheFJ1bGUpXG5cdFx0XHRyZXR1cm4gU3RyaW5nTWF0Y2hlcihsYXhSdWxlKVxuXG5cdFx0ZWxzZSBpZiBpc1J1bGVGdW5jKGxheFJ1bGUpXG5cdFx0XHRyZXR1cm4gRnVuY01hdGNoZXIobGF4UnVsZSlcblxuXHRcdGVsc2UgaWYgaXNBcnJheShsYXhSdWxlKVxuXHRcdFx0cmV0dXJuIEFsbCBsYXhSdWxlXG5cblx0XHRlbHNlXG5cdFx0XHRyZXR1cm4gQW55IGxheFJ1bGVcblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxuXG5cdEFueSA6PSAoaEl0ZW1zOiBoYXNob2Y8VExheFJ1bGU+KTogUnVsZSA9PlxuXG5cdFx0bFJ1bGVzIDo9IGZvciBrZXksdmFsIGluIGhJdGVtc1xuXHRcdFx0cnVsZSA6PSBnZXRSdWxlKHZhbCBhcyBUTGF4UnVsZSlcblx0XHRcdHJ1bGUubGFiZWwgPSBrZXlcblx0XHRcdHJ1bGVcblxuXHRcdHJldHVybiBuZXcgUnVsZSgnfCcsIChzdHIsIHBvcyk6IG51bWJlciA9PlxuXHRcdFx0IyAtLS0gVHJ5IGVhY2ggcnVsZVxuXHRcdFx0IyAgICAgaWYgYW55IHN1Y2NlZWQsIHN1Y2NlZWQgJiByZXR1cm4gbmV3IHBvc1xuXHRcdFx0IyAgICAgZWxzZSB0aHJvdyBlcnJvclxuXHRcdFx0Zm9yIHJ1bGUgb2YgbFJ1bGVzXG5cdFx0XHRcdHRyeVxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXG5cdFx0XHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3Ncblx0XHRcdFx0XHRcdGNiKHJ1bGUsIFtzdHIuc3Vic3RyaW5nKHBvcywgbmV3UG9zKV0pXG5cdFx0XHRcdFx0cmV0dXJuIG5ld1Bvc1xuXG5cdFx0XHR0aHJvdyBuZXcgUGFyc2VFcnJvciBcIkFueSBSdWxlIG5vdCBtYXRjaGVkXCJcblx0XHRcdClcblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxuXG5cdEFsbCA6PSAobExheFJ1bGVzOiBUTGF4UnVsZVtdKTogUnVsZSA9PlxuXG5cdFx0bFJ1bGVzIDo9IGZvciBsYXhSdWxlIG9mIGxMYXhSdWxlc1xuXHRcdFx0Z2V0UnVsZSBsYXhSdWxlXG5cblx0XHRyZXR1cm4gbmV3IFJ1bGUoJyYnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cblx0XHRcdGZvciBydWxlIG9mIGxSdWxlc1xuXHRcdFx0XHR0cnlcblx0XHRcdFx0XHRuZXdQb3MgOj0gcnVsZS5uZXh0KHN0ciwgcG9zKVxuXHRcdFx0XHRcdHBvcyA9IG5ld1Bvc1xuXHRcdFx0XHRjYXRjaCBlcnJcblx0XHRcdFx0XHR0aHJvdyBuZXcgUGFyc2VFcnJvciBcIkFsbCBSdWxlIG5vdCBtYXRjaGVkXCJcblxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3Ncblx0XHRcdFx0Y2IocnVsZSwgW10pXG5cdFx0XHRyZXR1cm4gcG9zXG5cdFx0XHQpXG5cblx0IyAtLS0gUmV0dXJuIGEgZnVuY3Rpb24gdGhhdCB0aHJvd3MgYW4gZXJyb3Jcblx0IyAgICAgaWYgc3RyaW5nIGRvZXNuJ3QgcGFyc2VcblxuXHRydWxlIDo9IGdldFJ1bGUgbGF4UnVsZVxuXHRyZXR1cm4gKHN0cikgPT5cblx0XHREQkcgXCJQYXJzZSAje2VzY2FwZVN0cihzdHIpfVwiLCBJTkRFTlRcblx0XHR0cnlcblx0XHRcdGVuZFBvcyA6PSBydWxlLm5leHQoc3RyLCAwKVxuXHRcdFx0REJHIFwiZW5kUG9zID0gI3tlbmRQb3N9XCJcblx0XHRcdGlmIChlbmRQb3MgPT0gc3RyLmxlbmd0aCkgfHwgcGFydGlhbFxuXHRcdFx0XHREQkcgVU5ERU5UXG5cdFx0XHRcdHJldHVybiB0cnVlXG5cdFx0XHRmaW5hbFBvcyA6PSBza2lwSWdub3JlZChzdHIsIGVuZFBvcylcblx0XHRcdERCRyBcImZpbmFsUG9zID0gI3tmaW5hbFBvc31cIiwgVU5ERU5UXG5cdFx0XHRpZiAoZmluYWxQb3MgIT0gc3RyLmxlbmd0aClcblx0XHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IoXCJOb3QgYWxsIGlucHV0IGV4aGF1c3RlZFwiKVxuXHRcdFx0cmV0dXJuXG5cdFx0Y2F0Y2ggZXJyXG5cdFx0XHREQkcgVU5ERU5UXG5cdFx0XHR0aHJvdyBlcnJcbiJdfQ==