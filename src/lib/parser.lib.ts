"use strict";
// parser.lib.civet

import {
	undef, defined, notdefined, assert, hash, hashof,
	isArray, isFunction, isString, isRegExp, isHash,
	} from 'datatypes'
import {
	getOptions, escapeStr, spaces, randomLabel,
	getLineAndColumn,
	} from 'llutils'
import {OL} from 'to-nice'
import {
	DBG, INDENT, UNDENT,
	} from 'logger'

// ---------------------------------------------------------------------------

export type TRuleFunc = (str: string, pos: number) => number

export const isRuleFunc = (x: unknown): x is TRuleFunc => {
	return (typeof x === 'function')
}

export class Rule {
	type: string
	func: TRuleFunc
	label: string = randomLabel()
	lChildren: Rule[] = []

	constructor(
			type: string,
			func: TRuleFunc,
			lChildren: Rule[] = []
			) {
		this.type = type
		this.func = func
		this.lChildren = []
	}

	next(str: string, pos: number): number {
		return this.func(str, pos)
	}
}

// --- Anything that can be converted to a Rule
export type TLaxRule = RegExp | string | TRuleFunc | TLaxRule[] | {[key: string|symbol]: TLaxRule}

// --- This used to work
//     I want to allow a TLaxRule to possibly be an array or hash of TLaxRules
//     was: export type TLaxRule = RegExp | string | TRuleFunc | TLaxRule[] | hashof<TLaxRule>

export type TCallback = (rule: Rule, lMatches: string[]) => void

// ---------------------------------------------------------------------------
// --- Custom errors

export class ParseError extends Error {

	constructor(msg: string) {
		super(msg)
		this.name = 'ParseError'
	}
}

// ---------------------------------------------------------------------------
// --- Returns a function that:
//        1. accepts a string
//        2. throws error on failure

export type TParser = (str: string) => void

export function getParser(
		laxRule: TLaxRule | TLaxRule[] | hashof<TLaxRule>,
		lCallbacks: TCallback[] = [],
		hOptions: hash = {}
		): TParser {

	type opt = {
		reSkip: RegExp
		partial: boolean
		}
	const {reSkip, partial} = getOptions<opt>(hOptions, {
		reSkip: /^\s+/,
		partial: false
		})

	// ..........................................................
	// function that skips reSkip, if defined

	const skipIgnored: TRuleFunc = (str, pos) => {

		const lMatches = str.substring(pos).match(reSkip)
		if (defined(lMatches)) {
			const len = lMatches[0].length
			if (len > 0) {
				DBG(`${len} chars skipped`)
			}
			return pos + len
		}
		else {
			return pos
		}
	}

	// ..........................................................
	// --- function that maps RegExp => Rule

	const RegexMatcher = (re: RegExp): Rule => {

		return new Rule('r', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			const lMatches = re.exec(str.substring(skipPos))
			if (lMatches === null) {
				throw new ParseError("RegExp Rule not matched")
			}

			const len = lMatches[0].length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, lMatches)
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps string => Rule

	const StringMatcher = (substr: string): Rule => {

		return new Rule('s', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			if (!str.startsWith(substr, skipPos)) {
				throw new ParseError("String Rule not matched")
			}

			const len = substr.length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, [substr])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TRuleFunc => Rule

	const FuncMatcher = (func: TRuleFunc): Rule => {

		return new Rule('f', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)
			const newPos = func(str, skipPos)
			assert((newPos > pos), "Zero length in rule match")
			for (const cb of lCallbacks) {
				cb(rule, [str.substring(pos, newPos)])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule => Rule

	const getRule = (laxRule: TLaxRule | TLaxRule[] | hashof<TLaxRule>): Rule => {

		if (isRegExp(laxRule)) {
			return RegexMatcher(laxRule)
		}

		else if (isString(laxRule)) {
			return StringMatcher(laxRule)
		}

		else if (isRuleFunc(laxRule)) {
			return FuncMatcher(laxRule)
		}

		else if (isArray(laxRule)) {
			return All(laxRule)
		}

		else {
			return Any(laxRule)
		}
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const Any = (hItems: hashof<TLaxRule>): Rule => {

		const results=[];for (const key in hItems) {const val = hItems[key];
			const rule = getRule(val as TLaxRule)
			rule.label = key
			results.push(rule)
		};const lRules =results

		return new Rule('|', (str, pos): number => {
			// --- Try each rule
			//     if any succeed, succeed & return new pos
			//     else throw error
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					for (const cb of lCallbacks) {
						cb(rule, [str.substring(pos, newPos)])
					}
					return newPos
				} catch(e) {}
			}

			throw new ParseError("Any Rule not matched")
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const All = (lLaxRules: TLaxRule[]): Rule => {

		const results1=[];for (const laxRule of lLaxRules) {
			results1.push(getRule(laxRule))
		};const lRules =results1

		return new Rule('&', (str, pos): number => {
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					pos = newPos
				}
				catch (err) {
					throw new ParseError("All Rule not matched")
				}
			}

			for (const cb of lCallbacks) {
				cb(rule, [])
			}
			return pos
		}
			)
	}

	// --- Return a function that throws an error
	//     if string doesn't parse

	const rule = getRule(laxRule)
	return (str) => {
		DBG(`Parse ${escapeStr(str)}`, INDENT)
		try {
			const endPos = rule.next(str, 0)
			DBG(`endPos = ${endPos}`)
			if ((endPos === str.length) || partial) {
				DBG(UNDENT)
				return true
			}
			const finalPos = skipIgnored(str, endPos)
			DBG(`finalPos = ${finalPos}`, UNDENT)
			if (finalPos !== str.length) {
				throw new ParseError("Not all input exhausted")
			}
			return
		}
		catch (err) {
			DBG(UNDENT)
			throw err
		}
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDakQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDNUMsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVE7QUFDaEIsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxD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SztBQUNoQixFQUFFLENBQUMsQ0FBQTtBQUNILEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyx5Q0FBd0M7QUFDekMsQUFBQTtBQUNBLEFBQUEsQ0FBdUIsTUFBdEIsV0FBVyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ3hDLEFBQUE7QUFDQSxBQUFBLEVBQVUsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFBLEFBQUMsTUFBTSxDQUFBO0FBQzdDLEFBQUEsRUFBRSxHQUFHLENBQUEsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUN0QixBQUFBLEdBQU0sTUFBSCxHQUFHLENBQUMsQ0FBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNO0FBQzVCLEFBQUEsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQ2YsQUFBQSxJQUFJLEdBQUcsQ0FBQSxBQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsY0FBYyxDQUFDLEM7R0FBQSxDQUFBO0FBQzlCLEFBQUEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHO0VBQUcsQ0FBQTtBQUNuQixBQUFBLEVBQUUsSUFBSSxDQUFBLENBQUE7QUFDTixBQUFBLEdBQUcsTUFBTSxDQUFDLEc7RUFBRyxDO0NBQUEsQ0FBQTtBQUNiLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyx3Q0FBdUM7QUFDeEMsQUFBQTtBQUNBLEFBQUEsQ0FBYSxNQUFaLFlBQVksQ0FBQyxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUN0QyxBQUFBO0FBQ0EsQUFB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QUFBLENBQUEsQ0FBQTtBQUN6QixBQUFBLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDO0tBQUMsQ0FBQTtBQUM1QyxBQUFBLEtBQUssTUFBTSxDQUFDLE07SUFBTSxDLEMsUyxDLEM7R0FBQSxDQUFBO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUEsQUFBQyxzQkFBc0IsQztFQUFBLENBQUE7QUFDOUMsR0FBRyxDO0NBQUMsQ0FBQTtBQUNKLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyw0Q0FBMkM7QUFDNUMsQUFBQTtBQUNBLEFBQUEsQ0FBSSxNQUFILEdBQUcsQ0FBQyxDQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDeEMsQUFBQTtBQUNBLEFBQUEsRSxLLEMsUSxHLENBQVksR0FBRyxDQUFDLENBQUEsTUFBQSxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQSxDQUFBLENBQUE7QUFDcEMsQUFBQSxHLFEsTUFBRyxPQUFPLENBQUEsQUFBQyxPQUFPLEMsQztFQUFBLEMsQ0FEVixNQUFOLE1BQU0sQ0FBQyxDLFFBQ1M7QUFDbEIsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQzVDLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFBLENBQUEsQ0FBQTtBQUNyQixBQUFBLElBQUksR0FBRyxDQUFBLENBQUE7QUFDUCxBQUFBLEtBQVcsTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ2xDLEFBQUEsS0FBSyxHQUFHLEMsQ0FBRSxDQUFDLE07SUFBTSxDQUFBO0FBQ2pCLEFBQUEsSUFBSSxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ2IsQUFBQSxLQUFLLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFBLEFBQUMsc0JBQXNCLEM7SUFBQSxDO0dBQUEsQ0FBQTtBQUNoRCxBQUFBO0FBQ0EsQUFBQSxHQUFHLEdBQUcsQ0FBQyxDQUFBLE1BQUEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUEsQ0FBQSxDQUFBO0FBQ3ZCLEFBQUEsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEM7R0FBQyxDQUFBO0FBQ2hCLEFBQUEsR0FBRyxNQUFNLENBQUMsRztFQUFHLENBQUE7QUFDYixHQUFHLEM7Q0FBQyxDQUFBO0FBQ0osQUFBQTtBQUNBLEFBQUEsQ0FBQyw2Q0FBNEM7QUFDN0MsQUFBQSxDQUFDLDhCQUE2QjtBQUM5QixBQUFBO0FBQ0EsQUFBQSxDQUFLLE1BQUosSUFBSSxDQUFDLENBQUUsQ0FBQyxPQUFPLENBQUEsQUFBQyxPQUFPLENBQUE7QUFDeEIsQUFBQSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ2hCLEFBQUEsRUFBRSxHQUFHLENBQUEsQUFBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQ3ZDLEFBQUEsRUFBRSxHQUFHLENBQUEsQ0FBQTtBQUNMLEFBQUEsR0FBUyxNQUFOLE1BQU0sQ0FBQyxDQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7QUFDM0IsQUFBQSxHQUFHLEdBQUcsQ0FBQSxDQUFDLE1BQU0sQ0FBQyxHQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUEsQ0FBQSxDQUFBO0FBQ3ZDLEFBQUEsSUFBSSxHQUFHLENBQUEsQUFBQyxNQUFNLENBQUE7QUFDZCxBQUFBLElBQUksTUFBTSxDQUFDLEk7R0FBSSxDQUFBO0FBQ2YsQUFBQSxHQUFXLE1BQVIsUUFBUSxDQUFDLENBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ3ZDLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQ3ZDLEFBQUEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUEsQ0FBQTtBQUM5QixBQUFBLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMseUJBQXlCLEM7R0FBQyxDQUFBO0FBQ25ELEFBQUEsR0FBRyxNO0VBQU0sQ0FBQTtBQUNULEFBQUEsRUFBRSxLQUFLLENBQUMsQ0FBQSxHQUFHLENBQUEsQ0FBQSxDQUFBO0FBQ1gsQUFBQSxHQUFHLEdBQUcsQ0FBQSxBQUFDLE1BQU0sQ0FBQTtBQUNiLEFBQUEsR0FBRyxLQUFLLENBQUMsRztFQUFHLEM7Q0FBQSxDO0FBQUEsQ0FBQTtBQUNaIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIHBhcnNlci5saWIuY2l2ZXRcclxuXHJcbmltcG9ydCB7XHJcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIGFzc2VydCwgaGFzaCwgaGFzaG9mLFxyXG5cdGlzQXJyYXksIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc1JlZ0V4cCwgaXNIYXNoLFxyXG5cdH0gZnJvbSAnZGF0YXR5cGVzJ1xyXG5pbXBvcnQge1xyXG5cdGdldE9wdGlvbnMsIGVzY2FwZVN0ciwgc3BhY2VzLCByYW5kb21MYWJlbCxcclxuXHRnZXRMaW5lQW5kQ29sdW1uLFxyXG5cdH0gZnJvbSAnbGx1dGlscydcclxuaW1wb3J0IHtPTH0gZnJvbSAndG8tbmljZSdcclxuaW1wb3J0IHtcclxuXHREQkcsIElOREVOVCwgVU5ERU5ULFxyXG5cdH0gZnJvbSAnbG9nZ2VyJ1xyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbmV4cG9ydCB0eXBlIFRSdWxlRnVuYyA9IChzdHI6IHN0cmluZywgcG9zOiBudW1iZXIpID0+IG51bWJlclxyXG5cclxuZXhwb3J0IGlzUnVsZUZ1bmMgOj0gKHg6IHVua25vd24pOiB4IGlzIFRSdWxlRnVuYyA9PlxyXG5cdHJldHVybiAodHlwZW9mIHggPT0gJ2Z1bmN0aW9uJylcclxuXHJcbmV4cG9ydCBjbGFzcyBSdWxlXHJcblx0dHlwZTogc3RyaW5nXHJcblx0ZnVuYzogVFJ1bGVGdW5jXHJcblx0bGFiZWw6IHN0cmluZyA9IHJhbmRvbUxhYmVsKClcclxuXHRsQ2hpbGRyZW46IFJ1bGVbXSA9IFtdXHJcblxyXG5cdGNvbnN0cnVjdG9yKFxyXG5cdFx0XHR0eXBlOiBzdHJpbmcsXHJcblx0XHRcdGZ1bmM6IFRSdWxlRnVuYyxcclxuXHRcdFx0bENoaWxkcmVuOiBSdWxlW10gPSBbXVxyXG5cdFx0XHQpXHJcblx0XHRAdHlwZSA9IHR5cGVcclxuXHRcdEBmdW5jID0gZnVuY1xyXG5cdFx0QGxDaGlsZHJlbiA9IFtdXHJcblxyXG5cdG5leHQoc3RyOiBzdHJpbmcsIHBvczogbnVtYmVyKTogbnVtYmVyXHJcblx0XHRyZXR1cm4gQGZ1bmMoc3RyLCBwb3MpXHJcblxyXG4jIC0tLSBBbnl0aGluZyB0aGF0IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYSBSdWxlXHJcbmV4cG9ydCB0eXBlIFRMYXhSdWxlID0gUmVnRXhwIHwgc3RyaW5nIHwgVFJ1bGVGdW5jIHwgVExheFJ1bGVbXSB8IHtba2V5OiBzdHJpbmd8c3ltYm9sXTogVExheFJ1bGV9XHJcblxyXG4jIC0tLSBUaGlzIHVzZWQgdG8gd29ya1xyXG4jICAgICBJIHdhbnQgdG8gYWxsb3cgYSBUTGF4UnVsZSB0byBwb3NzaWJseSBiZSBhbiBhcnJheSBvciBoYXNoIG9mIFRMYXhSdWxlc1xyXG4jICAgICB3YXM6IGV4cG9ydCB0eXBlIFRMYXhSdWxlID0gUmVnRXhwIHwgc3RyaW5nIHwgVFJ1bGVGdW5jIHwgVExheFJ1bGVbXSB8IGhhc2hvZjxUTGF4UnVsZT5cclxuXHJcbmV4cG9ydCB0eXBlIFRDYWxsYmFjayA9IChydWxlOiBSdWxlLCBsTWF0Y2hlczogc3RyaW5nW10pID0+IHZvaWRcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiMgLS0tIEN1c3RvbSBlcnJvcnNcclxuXHJcbmV4cG9ydCBjbGFzcyBQYXJzZUVycm9yIGV4dGVuZHMgRXJyb3JcclxuXHJcblx0Y29uc3RydWN0b3IobXNnOiBzdHJpbmcpXHJcblx0XHRzdXBlciBtc2dcclxuXHRcdHRoaXMubmFtZSA9ICdQYXJzZUVycm9yJ1xyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuIyAtLS0gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQ6XHJcbiMgICAgICAgIDEuIGFjY2VwdHMgYSBzdHJpbmdcclxuIyAgICAgICAgMi4gdGhyb3dzIGVycm9yIG9uIGZhaWx1cmVcclxuXHJcbmV4cG9ydCB0eXBlIFRQYXJzZXIgPSAoc3RyOiBzdHJpbmcpID0+IHZvaWRcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXJzZXIoXHJcblx0XHRsYXhSdWxlOiBUTGF4UnVsZSB8IFRMYXhSdWxlW10gfCBoYXNob2Y8VExheFJ1bGU+XHJcblx0XHRsQ2FsbGJhY2tzOiBUQ2FsbGJhY2tbXSA9IFtdXHJcblx0XHRoT3B0aW9uczogaGFzaCA9IHt9XHJcblx0XHQpOiBUUGFyc2VyXHJcblxyXG5cdHR5cGUgb3B0ID0ge1xyXG5cdFx0cmVTa2lwOiBSZWdFeHBcclxuXHRcdHBhcnRpYWw6IGJvb2xlYW5cclxuXHRcdH1cclxuXHR7cmVTa2lwLCBwYXJ0aWFsfSA6PSBnZXRPcHRpb25zPG9wdD4gaE9wdGlvbnMsIHtcclxuXHRcdHJlU2tpcDogL15cXHMrL1xyXG5cdFx0cGFydGlhbDogZmFsc2VcclxuXHRcdH1cclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyBmdW5jdGlvbiB0aGF0IHNraXBzIHJlU2tpcCwgaWYgZGVmaW5lZFxyXG5cclxuXHRza2lwSWdub3JlZDogVFJ1bGVGdW5jIDo9IChzdHIsIHBvcykgPT5cclxuXHJcblx0XHRsTWF0Y2hlcyA6PSBzdHIuc3Vic3RyaW5nKHBvcykubWF0Y2ggcmVTa2lwXHJcblx0XHRpZiBkZWZpbmVkKGxNYXRjaGVzKVxyXG5cdFx0XHRsZW4gOj0gbE1hdGNoZXNbMF0ubGVuZ3RoXHJcblx0XHRcdGlmIChsZW4gPiAwKVxyXG5cdFx0XHRcdERCRyBcIiN7bGVufSBjaGFycyBza2lwcGVkXCJcclxuXHRcdFx0cmV0dXJuIHBvcyArIGxlblxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRyZXR1cm4gcG9zXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBSZWdFeHAgPT4gUnVsZVxyXG5cclxuXHRSZWdleE1hdGNoZXIgOj0gKHJlOiBSZWdFeHApOiBSdWxlID0+XHJcblxyXG5cdFx0cmV0dXJuIG5ldyBSdWxlKCdyJywgKHN0ciwgcG9zKTogbnVtYmVyID0+XHJcblxyXG5cdFx0XHRza2lwUG9zIDo9IHNraXBJZ25vcmVkKHN0ciwgcG9zKVxyXG5cclxuXHRcdFx0bE1hdGNoZXMgOj0gcmUuZXhlYyhzdHIuc3Vic3RyaW5nKHNraXBQb3MpKVxyXG5cdFx0XHRpZiAobE1hdGNoZXMgPT0gbnVsbClcclxuXHRcdFx0XHR0aHJvdyBuZXcgUGFyc2VFcnJvciBcIlJlZ0V4cCBSdWxlIG5vdCBtYXRjaGVkXCJcclxuXHJcblx0XHRcdGxlbiA6PSBsTWF0Y2hlc1swXS5sZW5ndGhcclxuXHRcdFx0YXNzZXJ0IChsZW4gPiAwKSwgXCJaZXJvIGxlbmd0aCBpbiByZWdleCBtYXRjaFwiXHJcblx0XHRcdG5ld1BvcyA6PSBza2lwUG9zICsgbGVuXHJcblx0XHRcdGZvciBjYiBvZiBsQ2FsbGJhY2tzXHJcblx0XHRcdFx0Y2IocnVsZSwgbE1hdGNoZXMpXHJcblx0XHRcdHJldHVybiBuZXdQb3NcclxuXHRcdFx0KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIC0tLSBmdW5jdGlvbiB0aGF0IG1hcHMgc3RyaW5nID0+IFJ1bGVcclxuXHJcblx0U3RyaW5nTWF0Y2hlciA6PSAoc3Vic3RyOiBzdHJpbmcpOiBSdWxlID0+XHJcblxyXG5cdFx0cmV0dXJuIG5ldyBSdWxlKCdzJywgKHN0ciwgcG9zKTogbnVtYmVyID0+XHJcblxyXG5cdFx0XHRza2lwUG9zIDo9IHNraXBJZ25vcmVkKHN0ciwgcG9zKVxyXG5cclxuXHRcdFx0aWYgbm90IHN0ci5zdGFydHNXaXRoKHN1YnN0ciwgc2tpcFBvcylcclxuXHRcdFx0XHR0aHJvdyBuZXcgUGFyc2VFcnJvciBcIlN0cmluZyBSdWxlIG5vdCBtYXRjaGVkXCJcclxuXHJcblx0XHRcdGxlbiA6PSBzdWJzdHIubGVuZ3RoXHJcblx0XHRcdGFzc2VydCAobGVuID4gMCksIFwiWmVybyBsZW5ndGggaW4gcmVnZXggbWF0Y2hcIlxyXG5cdFx0XHRuZXdQb3MgOj0gc2tpcFBvcyArIGxlblxyXG5cdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xyXG5cdFx0XHRcdGNiKHJ1bGUsIFtzdWJzdHJdKVxyXG5cdFx0XHRyZXR1cm4gbmV3UG9zXHJcblx0XHRcdClcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRSdWxlRnVuYyA9PiBSdWxlXHJcblxyXG5cdEZ1bmNNYXRjaGVyIDo9IChmdW5jOiBUUnVsZUZ1bmMpOiBSdWxlID0+XHJcblxyXG5cdFx0cmV0dXJuIG5ldyBSdWxlKCdmJywgKHN0ciwgcG9zKTogbnVtYmVyID0+XHJcblxyXG5cdFx0XHRza2lwUG9zIDo9IHNraXBJZ25vcmVkKHN0ciwgcG9zKVxyXG5cdFx0XHRuZXdQb3MgOj0gZnVuYyhzdHIsIHNraXBQb3MpXHJcblx0XHRcdGFzc2VydCAobmV3UG9zID4gcG9zKSwgXCJaZXJvIGxlbmd0aCBpbiBydWxlIG1hdGNoXCJcclxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3NcclxuXHRcdFx0XHRjYihydWxlLCBbc3RyLnN1YnN0cmluZyhwb3MsIG5ld1BvcyldKVxyXG5cdFx0XHRyZXR1cm4gbmV3UG9zXHJcblx0XHRcdClcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlID0+IFJ1bGVcclxuXHJcblx0Z2V0UnVsZSA6PSAobGF4UnVsZTogVExheFJ1bGUgfCBUTGF4UnVsZVtdIHwgaGFzaG9mPFRMYXhSdWxlPik6IFJ1bGUgPT5cclxuXHJcblx0XHRpZiBpc1JlZ0V4cChsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gUmVnZXhNYXRjaGVyKGxheFJ1bGUpXHJcblxyXG5cdFx0ZWxzZSBpZiBpc1N0cmluZyhsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gU3RyaW5nTWF0Y2hlcihsYXhSdWxlKVxyXG5cclxuXHRcdGVsc2UgaWYgaXNSdWxlRnVuYyhsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gRnVuY01hdGNoZXIobGF4UnVsZSlcclxuXHJcblx0XHRlbHNlIGlmIGlzQXJyYXkobGF4UnVsZSlcclxuXHRcdFx0cmV0dXJuIEFsbCBsYXhSdWxlXHJcblxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRyZXR1cm4gQW55IGxheFJ1bGVcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxyXG5cclxuXHRBbnkgOj0gKGhJdGVtczogaGFzaG9mPFRMYXhSdWxlPik6IFJ1bGUgPT5cclxuXHJcblx0XHRsUnVsZXMgOj0gZm9yIGtleSx2YWwgaW4gaEl0ZW1zXHJcblx0XHRcdHJ1bGUgOj0gZ2V0UnVsZSh2YWwgYXMgVExheFJ1bGUpXHJcblx0XHRcdHJ1bGUubGFiZWwgPSBrZXlcclxuXHRcdFx0cnVsZVxyXG5cclxuXHRcdHJldHVybiBuZXcgUnVsZSgnfCcsIChzdHIsIHBvcyk6IG51bWJlciA9PlxyXG5cdFx0XHQjIC0tLSBUcnkgZWFjaCBydWxlXHJcblx0XHRcdCMgICAgIGlmIGFueSBzdWNjZWVkLCBzdWNjZWVkICYgcmV0dXJuIG5ldyBwb3NcclxuXHRcdFx0IyAgICAgZWxzZSB0aHJvdyBlcnJvclxyXG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcclxuXHRcdFx0XHR0cnlcclxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXHJcblx0XHRcdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xyXG5cdFx0XHRcdFx0XHRjYihydWxlLCBbc3RyLnN1YnN0cmluZyhwb3MsIG5ld1BvcyldKVxyXG5cdFx0XHRcdFx0cmV0dXJuIG5ld1Bvc1xyXG5cclxuXHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IgXCJBbnkgUnVsZSBub3QgbWF0Y2hlZFwiXHJcblx0XHRcdClcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxyXG5cclxuXHRBbGwgOj0gKGxMYXhSdWxlczogVExheFJ1bGVbXSk6IFJ1bGUgPT5cclxuXHJcblx0XHRsUnVsZXMgOj0gZm9yIGxheFJ1bGUgb2YgbExheFJ1bGVzXHJcblx0XHRcdGdldFJ1bGUgbGF4UnVsZVxyXG5cclxuXHRcdHJldHVybiBuZXcgUnVsZSgnJicsIChzdHIsIHBvcyk6IG51bWJlciA9PlxyXG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcclxuXHRcdFx0XHR0cnlcclxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXHJcblx0XHRcdFx0XHRwb3MgPSBuZXdQb3NcclxuXHRcdFx0XHRjYXRjaCBlcnJcclxuXHRcdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiQWxsIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3NcclxuXHRcdFx0XHRjYihydWxlLCBbXSlcclxuXHRcdFx0cmV0dXJuIHBvc1xyXG5cdFx0XHQpXHJcblxyXG5cdCMgLS0tIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgdGhyb3dzIGFuIGVycm9yXHJcblx0IyAgICAgaWYgc3RyaW5nIGRvZXNuJ3QgcGFyc2VcclxuXHJcblx0cnVsZSA6PSBnZXRSdWxlIGxheFJ1bGVcclxuXHRyZXR1cm4gKHN0cikgPT5cclxuXHRcdERCRyBcIlBhcnNlICN7ZXNjYXBlU3RyKHN0cil9XCIsIElOREVOVFxyXG5cdFx0dHJ5XHJcblx0XHRcdGVuZFBvcyA6PSBydWxlLm5leHQoc3RyLCAwKVxyXG5cdFx0XHREQkcgXCJlbmRQb3MgPSAje2VuZFBvc31cIlxyXG5cdFx0XHRpZiAoZW5kUG9zID09IHN0ci5sZW5ndGgpIHx8IHBhcnRpYWxcclxuXHRcdFx0XHREQkcgVU5ERU5UXHJcblx0XHRcdFx0cmV0dXJuIHRydWVcclxuXHRcdFx0ZmluYWxQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBlbmRQb3MpXHJcblx0XHRcdERCRyBcImZpbmFsUG9zID0gI3tmaW5hbFBvc31cIiwgVU5ERU5UXHJcblx0XHRcdGlmIChmaW5hbFBvcyAhPSBzdHIubGVuZ3RoKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yKFwiTm90IGFsbCBpbnB1dCBleGhhdXN0ZWRcIilcclxuXHRcdFx0cmV0dXJuXHJcblx0XHRjYXRjaCBlcnJcclxuXHRcdFx0REJHIFVOREVOVFxyXG5cdFx0XHR0aHJvdyBlcnJcclxuIl19