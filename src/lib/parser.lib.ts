"use strict";
// parser.lib.civet

import {
	undef, defined, notdefined, assert, hash, hashof,
	isArray, isFunction, isString, isRegExp, isHash,
	} from 'datatypes'
import {
	getOptions, escapeStr, spaces, randomLabel,
	getLineAndColumn,
	} from 'llutils'
import {OL} from 'to-nice'
import {
	DBG, INDENT, UNDENT,
	} from 'logger'

// ---------------------------------------------------------------------------

export type TRuleFunc = (str: string, pos: number) => number

export const isRuleFunc = (x: unknown): x is TRuleFunc => {
	return (typeof x === 'function')
}

export class Rule {
	type: string
	func: TRuleFunc
	label: string = randomLabel()
	lChildren: Rule[] = []

	constructor(
			type: string,
			func: TRuleFunc,
			lChildren: Rule[] = []
			) {
		this.type = type
		this.func = func
		this.lChildren = []
	}

	next(str: string, pos: number): number {
		return this.func(str, pos)
	}
}

// --- Anything that can be converted to a Rule
export type TLaxRule = RegExp | string | TRuleFunc | TLaxRule[] | hashof<TLaxRule>

export type TCallback = (rule: Rule, lMatches: string[]) => void

// ---------------------------------------------------------------------------
// --- Custom errors

export class ParseError extends Error {

	constructor(msg: string) {
		super(msg)
		this.name = 'ParseError'
	}
}

// ---------------------------------------------------------------------------
// --- Returns a function that:
//        1. accepts a string
//        2. throws error on failure

export type TParser = (str: string) => void

export function getParser(
		laxRule: TLaxRule,
		lCallbacks: TCallback[] = [],
		hOptions: hash = {}
		): TParser {

	type opt = {
		reSkip: RegExp
		partial: boolean
		}
	const {reSkip, partial} = getOptions<opt>(hOptions, {
		reSkip: /^\s+/,
		partial: false
		})

	// ..........................................................
	// function that skips reSkip, if defined

	const skipIgnored: TRuleFunc = (str, pos) => {

		const lMatches = str.substring(pos).match(reSkip)
		if (defined(lMatches)) {
			const len = lMatches[0].length
			if (len > 0) {
				DBG(`${len} chars skipped`)
			}
			return pos + len
		}
		else {
			return pos
		}
	}

	// ..........................................................
	// --- function that maps RegExp => Rule

	const RegexMatcher = (re: RegExp): Rule => {

		return new Rule('r', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			const lMatches = re.exec(str.substring(skipPos))
			if (lMatches === null) {
				throw new ParseError("RegExp Rule not matched")
			}

			const len = lMatches[0].length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, lMatches)
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps string => Rule

	const StringMatcher = (substr: string): Rule => {

		return new Rule('s', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)

			if (!str.startsWith(substr, skipPos)) {
				throw new ParseError("String Rule not matched")
			}

			const len = substr.length
			assert((len > 0), "Zero length in regex match")
			const newPos = skipPos + len
			for (const cb of lCallbacks) {
				cb(rule, [substr])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TRuleFunc => Rule

	const FuncMatcher = (func: TRuleFunc): Rule => {

		return new Rule('f', (str, pos): number => {

			const skipPos = skipIgnored(str, pos)
			const newPos = func(str, skipPos)
			assert((newPos > pos), "Zero length in rule match")
			for (const cb of lCallbacks) {
				cb(rule, [str.substring(pos, newPos)])
			}
			return newPos
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule => Rule

	const getRule = (laxRule: TLaxRule): Rule => {

		if (isRegExp(laxRule)) {
			return RegexMatcher(laxRule)
		}

		else if (isString(laxRule)) {
			return StringMatcher(laxRule)
		}

		else if (isRuleFunc(laxRule)) {
			return FuncMatcher(laxRule)
		}

		else if (isArray(laxRule)) {
			return All(laxRule)
		}

		else {
			return Any(laxRule)
		}
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const Any = (hItems: hashof<TLaxRule>): Rule => {

		const results=[];for (const key in hItems) {const val = hItems[key];
			const rule = getRule(val as TLaxRule)
			rule.label = key
			results.push(rule)
		};const lRules =results

		return new Rule('|', (str, pos): number => {
			// --- Try each rule
			//     if any succeed, succeed & return new pos
			//     else throw error
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					for (const cb of lCallbacks) {
						cb(rule, [str.substring(pos, newPos)])
					}
					return newPos
				} catch(e) {}
			}

			throw new ParseError("Any Rule not matched")
		}
			)
	}

	// ..........................................................
	// --- function that maps TLaxRule[] => Rule

	const All = (lLaxRules: TLaxRule[]): Rule => {

		const results1=[];for (const laxRule of lLaxRules) {
			results1.push(getRule(laxRule))
		};const lRules =results1

		return new Rule('&', (str, pos): number => {
			for (const rule of lRules) {
				try {
					const newPos = rule.next(str, pos)
					pos = newPos
				}
				catch (err) {
					throw new ParseError("All Rule not matched")
				}
			}

			for (const cb of lCallbacks) {
				cb(rule, [])
			}
			return pos
		}
			)
	}

	// --- Return a function that throws an error
	//     if string doesn't parse

	const rule = getRule(laxRule)
	return (str) => {
		DBG(`Parse ${escapeStr(str)}`, INDENT)
		try {
			const endPos = rule.next(str, 0)
			DBG(`endPos = ${endPos}`)
			if ((endPos === str.length) || partial) {
				DBG(UNDENT)
				return true
			}
			const finalPos = skipIgnored(str, endPos)
			DBG(`finalPos = ${finalPos}`, UNDENT)
			if (finalPos !== str.length) {
				throw new ParseError("Not all input exhausted")
			}
			return
		}
		catch (err) {
			DBG(UNDENT)
			throw err
		}
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxwYXJzZXIubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDbEQsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDakQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDNUMsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVE7QUFDaEIsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxD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QyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ3hDLEFBQUE7QUFDQSxBQUFBLEVBQVUsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFBLEFBQUMsTUFBTSxDQUFBO0FBQzdDLEFBQUEsRUFBRSxHQUFHLENBQUEsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUN0QixBQUFBLEdBQU0sTUFBSCxHQUFHLENBQUMsQ0FBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNO0FBQzVCLEFBQUEsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBO0FBQ2YsQUFBQSxJQUFJLEdBQUcsQ0FBQSxBQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsY0FBYyxDQUFDLEM7R0FBQSxDQUFBO0FBQzlCLEFBQUEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHO0VBQUcsQ0FBQTtBQUNuQixBQUFBLEVBQUUsSUFBSSxDQUFBLENBQUE7QUFDTixBQUFBLEdBQUcsTUFBTSxDQUFDLEc7RUFBRyxDO0NBQUEsQ0FBQTtBQUNiLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUEsQ0FBQyx3Q0FBdUM7QUFDeEMsQUFBQTtBQUNBLEFBQUEsQ0FBYSxNQUFaLFlBQVksQ0FBQyxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUN0QyxBQUFBO0FBQ0EsQUFBQSxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDNUMsQUFBQTtBQUNBLEFBQUEsR0FBVSxNQUFQLE9BQU8sQ0FBQyxDQUFFLENBQUMsV0FBVyxD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QUFBQTtBQUNBLEFBQUEsR0FBRyxHQUFHLENBQUMsQ0FBQSxNQUFBLEVBQUUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFBLENBQUEsQ0FBQTtBQUN2QixBQUFBLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDO0dBQUMsQ0FBQTtBQUNoQixBQUFBLEdBQUcsTUFBTSxDQUFDLEc7RUFBRyxDQUFBO0FBQ2IsR0FBRyxDO0NBQUMsQ0FBQTtBQUNKLEFBQUE7QUFDQSxBQUFBLENBQUMsNkNBQTRDO0FBQzdDLEFBQUEsQ0FBQyw4QkFBNkI7QUFDOUIsQUFBQTtBQUNBLEFBQUEsQ0FBSyxNQUFKLElBQUksQ0FBQyxDQUFFLENBQUMsT0FBTyxDQUFBLEFBQUMsT0FBTyxDQUFBO0FBQ3hCLEFBQUEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUEsQ0FBQTtBQUNoQixBQUFBLEVBQUUsR0FBRyxDQUFBLEFBQUMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtBQUN2QyxBQUFBLEVBQUUsR0FBRyxDQUFBLENBQUE7QUFDTCxBQUFBLEdBQVMsTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFBO0FBQzNCLEFBQUEsR0FBRyxHQUFHLENBQUEsQ0FBQyxNQUFNLENBQUMsR0FBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFBLENBQUEsQ0FBQTtBQUN2QyxBQUFBLElBQUksR0FBRyxDQUFBLEFBQUMsTUFBTSxDQUFBO0FBQ2QsQUFBQSxJQUFJLE1BQU0sQ0FBQyxJO0dBQUksQ0FBQTtBQUNmLEFBQUEsR0FBVyxNQUFSLFFBQVEsQ0FBQyxDQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUN2QyxBQUFBLEdBQUcsR0FBRyxDQUFBLEFBQUMsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtBQUN2QyxBQUFBLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUE7QUFDOUIsQUFBQSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLHlCQUF5QixDO0dBQUMsQ0FBQTtBQUNuRCxBQUFBLEdBQUcsTTtFQUFNLENBQUE7QUFDVCxBQUFBLEVBQUUsS0FBSyxDQUFDLENBQUEsR0FBRyxDQUFBLENBQUEsQ0FBQTtBQUNYLEFBQUEsR0FBRyxHQUFHLENBQUEsQUFBQyxNQUFNLENBQUE7QUFDYixBQUFBLEdBQUcsS0FBSyxDQUFDLEc7RUFBRyxDO0NBQUEsQztBQUFBLENBQUE7QUFDWiIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBwYXJzZXIubGliLmNpdmV0XHJcblxyXG5pbXBvcnQge1xyXG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLCBhc3NlcnQsIGhhc2gsIGhhc2hvZixcclxuXHRpc0FycmF5LCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNSZWdFeHAsIGlzSGFzaCxcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtcclxuXHRnZXRPcHRpb25zLCBlc2NhcGVTdHIsIHNwYWNlcywgcmFuZG9tTGFiZWwsXHJcblx0Z2V0TGluZUFuZENvbHVtbixcclxuXHR9IGZyb20gJ2xsdXRpbHMnXHJcbmltcG9ydCB7T0x9IGZyb20gJ3RvLW5pY2UnXHJcbmltcG9ydCB7XHJcblx0REJHLCBJTkRFTlQsIFVOREVOVCxcclxuXHR9IGZyb20gJ2xvZ2dlcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5leHBvcnQgdHlwZSBUUnVsZUZ1bmMgPSAoc3RyOiBzdHJpbmcsIHBvczogbnVtYmVyKSA9PiBudW1iZXJcclxuXHJcbmV4cG9ydCBpc1J1bGVGdW5jIDo9ICh4OiB1bmtub3duKTogeCBpcyBUUnVsZUZ1bmMgPT5cclxuXHRyZXR1cm4gKHR5cGVvZiB4ID09ICdmdW5jdGlvbicpXHJcblxyXG5leHBvcnQgY2xhc3MgUnVsZVxyXG5cdHR5cGU6IHN0cmluZ1xyXG5cdGZ1bmM6IFRSdWxlRnVuY1xyXG5cdGxhYmVsOiBzdHJpbmcgPSByYW5kb21MYWJlbCgpXHJcblx0bENoaWxkcmVuOiBSdWxlW10gPSBbXVxyXG5cclxuXHRjb25zdHJ1Y3RvcihcclxuXHRcdFx0dHlwZTogc3RyaW5nLFxyXG5cdFx0XHRmdW5jOiBUUnVsZUZ1bmMsXHJcblx0XHRcdGxDaGlsZHJlbjogUnVsZVtdID0gW11cclxuXHRcdFx0KVxyXG5cdFx0QHR5cGUgPSB0eXBlXHJcblx0XHRAZnVuYyA9IGZ1bmNcclxuXHRcdEBsQ2hpbGRyZW4gPSBbXVxyXG5cclxuXHRuZXh0KHN0cjogc3RyaW5nLCBwb3M6IG51bWJlcik6IG51bWJlclxyXG5cdFx0cmV0dXJuIEBmdW5jKHN0ciwgcG9zKVxyXG5cclxuIyAtLS0gQW55dGhpbmcgdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGEgUnVsZVxyXG5leHBvcnQgdHlwZSBUTGF4UnVsZSA9IFJlZ0V4cCB8IHN0cmluZyB8IFRSdWxlRnVuYyB8IFRMYXhSdWxlW10gfCBoYXNob2Y8VExheFJ1bGU+XHJcblxyXG5leHBvcnQgdHlwZSBUQ2FsbGJhY2sgPSAocnVsZTogUnVsZSwgbE1hdGNoZXM6IHN0cmluZ1tdKSA9PiB2b2lkXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4jIC0tLSBDdXN0b20gZXJyb3JzXHJcblxyXG5leHBvcnQgY2xhc3MgUGFyc2VFcnJvciBleHRlbmRzIEVycm9yXHJcblxyXG5cdGNvbnN0cnVjdG9yKG1zZzogc3RyaW5nKVxyXG5cdFx0c3VwZXIgbXNnXHJcblx0XHR0aGlzLm5hbWUgPSAnUGFyc2VFcnJvcidcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiMgLS0tIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0OlxyXG4jICAgICAgICAxLiBhY2NlcHRzIGEgc3RyaW5nXHJcbiMgICAgICAgIDIuIHRocm93cyBlcnJvciBvbiBmYWlsdXJlXHJcblxyXG5leHBvcnQgdHlwZSBUUGFyc2VyID0gKHN0cjogc3RyaW5nKSA9PiB2b2lkXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFyc2VyKFxyXG5cdFx0bGF4UnVsZTogVExheFJ1bGVcclxuXHRcdGxDYWxsYmFja3M6IFRDYWxsYmFja1tdID0gW11cclxuXHRcdGhPcHRpb25zOiBoYXNoID0ge31cclxuXHRcdCk6IFRQYXJzZXJcclxuXHJcblx0dHlwZSBvcHQgPSB7XHJcblx0XHRyZVNraXA6IFJlZ0V4cFxyXG5cdFx0cGFydGlhbDogYm9vbGVhblxyXG5cdFx0fVxyXG5cdHtyZVNraXAsIHBhcnRpYWx9IDo9IGdldE9wdGlvbnM8b3B0PiBoT3B0aW9ucywge1xyXG5cdFx0cmVTa2lwOiAvXlxccysvXHJcblx0XHRwYXJ0aWFsOiBmYWxzZVxyXG5cdFx0fVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIGZ1bmN0aW9uIHRoYXQgc2tpcHMgcmVTa2lwLCBpZiBkZWZpbmVkXHJcblxyXG5cdHNraXBJZ25vcmVkOiBUUnVsZUZ1bmMgOj0gKHN0ciwgcG9zKSA9PlxyXG5cclxuXHRcdGxNYXRjaGVzIDo9IHN0ci5zdWJzdHJpbmcocG9zKS5tYXRjaCByZVNraXBcclxuXHRcdGlmIGRlZmluZWQobE1hdGNoZXMpXHJcblx0XHRcdGxlbiA6PSBsTWF0Y2hlc1swXS5sZW5ndGhcclxuXHRcdFx0aWYgKGxlbiA+IDApXHJcblx0XHRcdFx0REJHIFwiI3tsZW59IGNoYXJzIHNraXBwZWRcIlxyXG5cdFx0XHRyZXR1cm4gcG9zICsgbGVuXHJcblx0XHRlbHNlXHJcblx0XHRcdHJldHVybiBwb3NcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFJlZ0V4cCA9PiBSdWxlXHJcblxyXG5cdFJlZ2V4TWF0Y2hlciA6PSAocmU6IFJlZ0V4cCk6IFJ1bGUgPT5cclxuXHJcblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3InLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cclxuXHJcblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXHJcblxyXG5cdFx0XHRsTWF0Y2hlcyA6PSByZS5leGVjKHN0ci5zdWJzdHJpbmcoc2tpcFBvcykpXHJcblx0XHRcdGlmIChsTWF0Y2hlcyA9PSBudWxsKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiUmVnRXhwIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0bGVuIDo9IGxNYXRjaGVzWzBdLmxlbmd0aFxyXG5cdFx0XHRhc3NlcnQgKGxlbiA+IDApLCBcIlplcm8gbGVuZ3RoIGluIHJlZ2V4IG1hdGNoXCJcclxuXHRcdFx0bmV3UG9zIDo9IHNraXBQb3MgKyBsZW5cclxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3NcclxuXHRcdFx0XHRjYihydWxlLCBsTWF0Y2hlcylcclxuXHRcdFx0cmV0dXJuIG5ld1Bvc1xyXG5cdFx0XHQpXHJcblxyXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxyXG5cdCMgLS0tIGZ1bmN0aW9uIHRoYXQgbWFwcyBzdHJpbmcgPT4gUnVsZVxyXG5cclxuXHRTdHJpbmdNYXRjaGVyIDo9IChzdWJzdHI6IHN0cmluZyk6IFJ1bGUgPT5cclxuXHJcblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ3MnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cclxuXHJcblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXHJcblxyXG5cdFx0XHRpZiBub3Qgc3RyLnN0YXJ0c1dpdGgoc3Vic3RyLCBza2lwUG9zKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiU3RyaW5nIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0bGVuIDo9IHN1YnN0ci5sZW5ndGhcclxuXHRcdFx0YXNzZXJ0IChsZW4gPiAwKSwgXCJaZXJvIGxlbmd0aCBpbiByZWdleCBtYXRjaFwiXHJcblx0XHRcdG5ld1BvcyA6PSBza2lwUG9zICsgbGVuXHJcblx0XHRcdGZvciBjYiBvZiBsQ2FsbGJhY2tzXHJcblx0XHRcdFx0Y2IocnVsZSwgW3N1YnN0cl0pXHJcblx0XHRcdHJldHVybiBuZXdQb3NcclxuXHRcdFx0KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIC0tLSBmdW5jdGlvbiB0aGF0IG1hcHMgVFJ1bGVGdW5jID0+IFJ1bGVcclxuXHJcblx0RnVuY01hdGNoZXIgOj0gKGZ1bmM6IFRSdWxlRnVuYyk6IFJ1bGUgPT5cclxuXHJcblx0XHRyZXR1cm4gbmV3IFJ1bGUoJ2YnLCAoc3RyLCBwb3MpOiBudW1iZXIgPT5cclxuXHJcblx0XHRcdHNraXBQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBwb3MpXHJcblx0XHRcdG5ld1BvcyA6PSBmdW5jKHN0ciwgc2tpcFBvcylcclxuXHRcdFx0YXNzZXJ0IChuZXdQb3MgPiBwb3MpLCBcIlplcm8gbGVuZ3RoIGluIHJ1bGUgbWF0Y2hcIlxyXG5cdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xyXG5cdFx0XHRcdGNiKHJ1bGUsIFtzdHIuc3Vic3RyaW5nKHBvcywgbmV3UG9zKV0pXHJcblx0XHRcdHJldHVybiBuZXdQb3NcclxuXHRcdFx0KVxyXG5cclxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cclxuXHQjIC0tLSBmdW5jdGlvbiB0aGF0IG1hcHMgVExheFJ1bGUgPT4gUnVsZVxyXG5cclxuXHRnZXRSdWxlIDo9IChsYXhSdWxlOiBUTGF4UnVsZSk6IFJ1bGUgPT5cclxuXHJcblx0XHRpZiBpc1JlZ0V4cChsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gUmVnZXhNYXRjaGVyKGxheFJ1bGUpXHJcblxyXG5cdFx0ZWxzZSBpZiBpc1N0cmluZyhsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gU3RyaW5nTWF0Y2hlcihsYXhSdWxlKVxyXG5cclxuXHRcdGVsc2UgaWYgaXNSdWxlRnVuYyhsYXhSdWxlKVxyXG5cdFx0XHRyZXR1cm4gRnVuY01hdGNoZXIobGF4UnVsZSlcclxuXHJcblx0XHRlbHNlIGlmIGlzQXJyYXkobGF4UnVsZSlcclxuXHRcdFx0cmV0dXJuIEFsbCBsYXhSdWxlXHJcblxyXG5cdFx0ZWxzZVxyXG5cdFx0XHRyZXR1cm4gQW55IGxheFJ1bGVcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxyXG5cclxuXHRBbnkgOj0gKGhJdGVtczogaGFzaG9mPFRMYXhSdWxlPik6IFJ1bGUgPT5cclxuXHJcblx0XHRsUnVsZXMgOj0gZm9yIGtleSx2YWwgaW4gaEl0ZW1zXHJcblx0XHRcdHJ1bGUgOj0gZ2V0UnVsZSh2YWwgYXMgVExheFJ1bGUpXHJcblx0XHRcdHJ1bGUubGFiZWwgPSBrZXlcclxuXHRcdFx0cnVsZVxyXG5cclxuXHRcdHJldHVybiBuZXcgUnVsZSgnfCcsIChzdHIsIHBvcyk6IG51bWJlciA9PlxyXG5cdFx0XHQjIC0tLSBUcnkgZWFjaCBydWxlXHJcblx0XHRcdCMgICAgIGlmIGFueSBzdWNjZWVkLCBzdWNjZWVkICYgcmV0dXJuIG5ldyBwb3NcclxuXHRcdFx0IyAgICAgZWxzZSB0aHJvdyBlcnJvclxyXG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcclxuXHRcdFx0XHR0cnlcclxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXHJcblx0XHRcdFx0XHRmb3IgY2Igb2YgbENhbGxiYWNrc1xyXG5cdFx0XHRcdFx0XHRjYihydWxlLCBbc3RyLnN1YnN0cmluZyhwb3MsIG5ld1BvcyldKVxyXG5cdFx0XHRcdFx0cmV0dXJuIG5ld1Bvc1xyXG5cclxuXHRcdFx0dGhyb3cgbmV3IFBhcnNlRXJyb3IgXCJBbnkgUnVsZSBub3QgbWF0Y2hlZFwiXHJcblx0XHRcdClcclxuXHJcblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXHJcblx0IyAtLS0gZnVuY3Rpb24gdGhhdCBtYXBzIFRMYXhSdWxlW10gPT4gUnVsZVxyXG5cclxuXHRBbGwgOj0gKGxMYXhSdWxlczogVExheFJ1bGVbXSk6IFJ1bGUgPT5cclxuXHJcblx0XHRsUnVsZXMgOj0gZm9yIGxheFJ1bGUgb2YgbExheFJ1bGVzXHJcblx0XHRcdGdldFJ1bGUgbGF4UnVsZVxyXG5cclxuXHRcdHJldHVybiBuZXcgUnVsZSgnJicsIChzdHIsIHBvcyk6IG51bWJlciA9PlxyXG5cdFx0XHRmb3IgcnVsZSBvZiBsUnVsZXNcclxuXHRcdFx0XHR0cnlcclxuXHRcdFx0XHRcdG5ld1BvcyA6PSBydWxlLm5leHQoc3RyLCBwb3MpXHJcblx0XHRcdFx0XHRwb3MgPSBuZXdQb3NcclxuXHRcdFx0XHRjYXRjaCBlcnJcclxuXHRcdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yIFwiQWxsIFJ1bGUgbm90IG1hdGNoZWRcIlxyXG5cclxuXHRcdFx0Zm9yIGNiIG9mIGxDYWxsYmFja3NcclxuXHRcdFx0XHRjYihydWxlLCBbXSlcclxuXHRcdFx0cmV0dXJuIHBvc1xyXG5cdFx0XHQpXHJcblxyXG5cdCMgLS0tIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgdGhyb3dzIGFuIGVycm9yXHJcblx0IyAgICAgaWYgc3RyaW5nIGRvZXNuJ3QgcGFyc2VcclxuXHJcblx0cnVsZSA6PSBnZXRSdWxlIGxheFJ1bGVcclxuXHRyZXR1cm4gKHN0cikgPT5cclxuXHRcdERCRyBcIlBhcnNlICN7ZXNjYXBlU3RyKHN0cil9XCIsIElOREVOVFxyXG5cdFx0dHJ5XHJcblx0XHRcdGVuZFBvcyA6PSBydWxlLm5leHQoc3RyLCAwKVxyXG5cdFx0XHREQkcgXCJlbmRQb3MgPSAje2VuZFBvc31cIlxyXG5cdFx0XHRpZiAoZW5kUG9zID09IHN0ci5sZW5ndGgpIHx8IHBhcnRpYWxcclxuXHRcdFx0XHREQkcgVU5ERU5UXHJcblx0XHRcdFx0cmV0dXJuIHRydWVcclxuXHRcdFx0ZmluYWxQb3MgOj0gc2tpcElnbm9yZWQoc3RyLCBlbmRQb3MpXHJcblx0XHRcdERCRyBcImZpbmFsUG9zID0gI3tmaW5hbFBvc31cIiwgVU5ERU5UXHJcblx0XHRcdGlmIChmaW5hbFBvcyAhPSBzdHIubGVuZ3RoKVxyXG5cdFx0XHRcdHRocm93IG5ldyBQYXJzZUVycm9yKFwiTm90IGFsbCBpbnB1dCBleGhhdXN0ZWRcIilcclxuXHRcdFx0cmV0dXJuXHJcblx0XHRjYXRjaCBlcnJcclxuXHRcdFx0REJHIFVOREVOVFxyXG5cdFx0XHR0aHJvdyBlcnJcclxuIl19