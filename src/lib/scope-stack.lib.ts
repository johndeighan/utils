"use strict";
// scope-stack.lib.civet

import {
	undef, defined, notdefined, assert, croak, hash,
	} from 'datatypes'
import {hasKey} from 'llutils'

// ---------------------------------------------------------------------------

export class CScope {
	sDefined = new Set<string>()
	sUsed = new Set<string>()

	addDefined(name: string): void {
		this.sDefined.add(name)
		return
	}

	addUsed(name: string): void {
		this.sUsed.add(name)
		return
	}

	isDefined(name: string): boolean {
		return this.sDefined.has(name)
	}

	isUsed(name: string): boolean {
		return this.sUsed.has(name)
	}
}

// ---------------------------------------------------------------------------

export class CScopeStack {

	lScopes: CScope[]
	curScope: CScope
	finished: boolean   // --- set when last scope is ended

	// ..........................................................

	constructor(s: CScope = new CScope()) {

		this.curScope = s
		this.lScopes = [s]
		this.finished = false
	}

	// ..........................................................

	newScope(s: CScope = new CScope()): void {

		assert(!this.finished, "finished = true")
		this.curScope = s
		this.lScopes.push(s)
		return
	}

	// ..........................................................

	endScope(): CScope {

		switch(this.lScopes.length) {
			case 0: {
				croak("endScope() with no scopes");break;
			}
			case 1: {
				this.finished = true;break;
			}
			default: {
				this.curScope = this.lScopes.at(-2) as CScope
			}
		}
		return this.lScopes.pop() as CScope
	}

	// ..........................................................

	addDefined(name: string): void {

		assert(!this.finished, "finished = true")
		this.curScope.addDefined(name)
		return
	}

	// ..........................................................

	addUsed(name: string): void {

		assert(!this.finished, "finished = true")
		this.curScope.addUsed(name)
		return
	}

	// ..........................................................

	isDefined(name: string): boolean {

		for (const scope of [...this.lScopes].reverse()) {
			if (scope.isDefined(name)) {
				return true
			}
		}
		return false
	}

	// ..........................................................

	isUsed(name: string): boolean {

		for (const scope of [...this.lScopes].reverse()) {
			if (scope.isUsed(name)) {
				return true
			}
		}
		return false
	}
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzovVXNlcnMvam9obmQvdXRpbHMvc3JjL2xpYi9zY29wZS1zdGFjay5saWIuY2l2ZXQudHN4Iiwic291cmNlcyI6WyJDOi9Vc2Vycy9qb2huZC91dGlscy9zcmMvbGliL3Njb3BlLXN0YWNrLmxpYi5jaXZldCJdLCJtYXBwaW5ncyI6IjtBQUFBLHdCQUF1QjtBQUN2QixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2pELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXO0FBQ25CLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUM5QixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQSxDQUFBO0FBQ25CLEFBQUEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUM3QixBQUFBLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDMUIsQUFBQTtBQUNBLEFBQUEsQyxVQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUEsQ0FBQTtBQUMvQixBQUFBLEVBQUUsSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUEsQUFBQyxJQUFJLENBQUE7QUFDcEIsQUFBQSxFQUFFLE07Q0FBTSxDQUFBO0FBQ1IsQUFBQTtBQUNBLEFBQUEsQyxPQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUEsQ0FBQTtBQUM1QixBQUFBLEVBQUUsSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUEsQUFBQyxJQUFJLENBQUE7QUFDakIsQUFBQSxFQUFFLE07Q0FBTSxDQUFBO0FBQ1IsQUFBQTtBQUNBLEFBQUEsQyxTQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUEsQ0FBQTtBQUNqQyxBQUFBLEVBQUUsTUFBTSxDQUFDLEksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFBLEFBQUMsSUFBSSxDO0NBQUEsQ0FBQTtBQUMzQixBQUFBO0FBQ0EsQUFBQSxDLE1BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQSxDQUFBO0FBQzlCLEFBQUEsRUFBRSxNQUFNLENBQUMsSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUEsQUFBQyxJQUFJLEM7Q0FBQSxDO0FBQUEsQ0FBQTtBQUN4QixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQSxDQUFBO0FBQ3hCLEFBQUE7QUFDQSxBQUFBLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbEIsQUFBQSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU07QUFDakIsQUFBQSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sR0FBRyxtQ0FBa0M7QUFDdkQsQUFBQTtBQUNBLEFBQUEsQ0FBQyw2REFBNEQ7QUFDN0QsQUFBQTtBQUNBLEFBQUEsQyxXQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUE7QUFDdEMsQUFBQTtBQUNBLEFBQUEsRUFBRSxJLENBQUMsUUFBUSxDLENBQUUsQ0FBQyxDQUFDO0FBQ2YsQUFBQSxFQUFFLEksQ0FBQyxPQUFPLEMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hCLEFBQUEsRUFBRSxJLENBQUMsUUFBUSxDLENBQUUsQ0FBQyxLO0NBQUssQ0FBQTtBQUNuQixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDLFFBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUEsQ0FBQTtBQUN6QyxBQUFBO0FBQ0EsQUFBQSxFQUFFLE1BQU0sQ0FBQSxBQUFDLENBQUksSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGlCQUFpQixDQUFBO0FBQ3pDLEFBQUEsRUFBRSxJLENBQUMsUUFBUSxDLENBQUUsQ0FBQyxDQUFDO0FBQ2YsQUFBQSxFQUFFLEksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFBLEFBQUMsQ0FBQyxDQUFBO0FBQ2pCLEFBQUEsRUFBRSxNO0NBQU0sQ0FBQTtBQUNSLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUE7QUFDQSxBQUFBLEMsUUFBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQSxDQUFBO0FBQ25CLEFBQUE7QUFDQSxBQUFBLEVBQUUsTUFBTSxDQUFBLEFBQUMsSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUEsQ0FBQSxDQUFBO0FBQ3hCLEFBQUEsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUNULEFBQUEsSUFBSSxLQUFLLENBQUEsQUFBQywyQkFBMkIsQ0FBQSxPO0dBQUEsQ0FBQTtBQUNyQyxBQUFBLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDVCxBQUFBLElBQUksSSxDQUFDLFFBQVEsQyxDQUFFLENBQUMsSUFBSSxPO0dBQUEsQ0FBQTtBQUNwQixBQUFBLEdBQUcsT0FBSSxDQUFBLENBQUEsQ0FBQTtBQUNQLEFBQUEsSUFBSSxJLENBQUMsUUFBUSxDLENBQUUsQ0FBQyxJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNO0dBQU0sQztFQUFBLENBQUE7QUFDekMsQUFBQSxFQUFFLE1BQU0sQ0FBQyxJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE07Q0FBTSxDQUFBO0FBQ2pDLEFBQUE7QUFDQSxBQUFBLENBQUMsNkRBQTREO0FBQzdELEFBQUE7QUFDQSxBQUFBLEMsVUFBVyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBLENBQUE7QUFDL0IsQUFBQTtBQUNBLEFBQUEsRUFBRSxNQUFNLENBQUEsQUFBQyxDQUFJLEksQ0FBQyxRQUFRLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQTtBQUN6QyxBQUFBLEVBQUUsSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUEsQUFBQyxJQUFJLENBQUE7QUFDM0IsQUFBQSxFQUFFLE07Q0FBTSxDQUFBO0FBQ1IsQUFBQTtBQUNBLEFBQUEsQ0FBQyw2REFBNEQ7QUFDN0QsQUFBQTtBQUNBLEFBQUEsQyxPQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUEsQ0FBQTtBQUM1QixBQUFBO0FBQ0EsQUFBQSxFQUFFLE1BQU0sQ0FBQSxBQUFDLENBQUksSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGlCQUFpQixDQUFBO0FBQ3pDLEFBQUEsRUFBRSxJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQSxBQUFDLElBQUksQ0FBQTtBQUN4QixBQUFBLEVBQUUsTTtDQUFNLENBQUE7QUFDUixBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDLFNBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQSxDQUFBO0FBQ2pDLEFBQUE7QUFDQSxBQUFBLEVBQUUsR0FBRyxDQUFDLENBQUEsTUFBQSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQVMsR0FBUixJLENBQUMsT0FBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDdEMsQUFBQSxHQUFHLEdBQUcsQ0FBQSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUMzQixBQUFBLElBQUksTUFBTSxDQUFDLEk7R0FBSSxDO0VBQUEsQ0FBQTtBQUNmLEFBQUEsRUFBRSxNQUFNLENBQUMsSztDQUFLLENBQUE7QUFDZCxBQUFBO0FBQ0EsQUFBQSxDQUFDLDZEQUE0RDtBQUM3RCxBQUFBO0FBQ0EsQUFBQSxDLE1BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQSxDQUFBO0FBQzlCLEFBQUE7QUFDQSxBQUFBLEVBQUUsR0FBRyxDQUFDLENBQUEsTUFBQSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQVMsR0FBUixJLENBQUMsT0FBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQSxDQUFBLENBQUE7QUFDdEMsQUFBQSxHQUFHLEdBQUcsQ0FBQSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUEsQ0FBQTtBQUN4QixBQUFBLElBQUksTUFBTSxDQUFDLEk7R0FBSSxDO0VBQUEsQ0FBQTtBQUNmLEFBQUEsRUFBRSxNQUFNLENBQUMsSztDQUFLLEM7QUFBQSxDQUFBO0FBQ2QiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgc2NvcGUtc3RhY2subGliLmNpdmV0XG5cbmltcG9ydCB7XG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLCBhc3NlcnQsIGNyb2FrLCBoYXNoLFxuXHR9IGZyb20gJ2RhdGF0eXBlcydcbmltcG9ydCB7aGFzS2V5fSBmcm9tICdsbHV0aWxzJ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgY2xhc3MgQ1Njb3BlXG5cdHNEZWZpbmVkID0gbmV3IFNldDxzdHJpbmc+KClcblx0c1VzZWQgPSBuZXcgU2V0PHN0cmluZz4oKVxuXG5cdGFkZERlZmluZWQobmFtZTogc3RyaW5nKTogdm9pZFxuXHRcdEBzRGVmaW5lZC5hZGQgbmFtZVxuXHRcdHJldHVyblxuXG5cdGFkZFVzZWQobmFtZTogc3RyaW5nKTogdm9pZFxuXHRcdEBzVXNlZC5hZGQgbmFtZVxuXHRcdHJldHVyblxuXG5cdGlzRGVmaW5lZChuYW1lOiBzdHJpbmcpOiBib29sZWFuXG5cdFx0cmV0dXJuIEBzRGVmaW5lZC5oYXMgbmFtZVxuXG5cdGlzVXNlZChuYW1lOiBzdHJpbmcpOiBib29sZWFuXG5cdFx0cmV0dXJuIEBzVXNlZC5oYXMgbmFtZVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgY2xhc3MgQ1Njb3BlU3RhY2tcblxuXHRsU2NvcGVzOiBDU2NvcGVbXVxuXHRjdXJTY29wZTogQ1Njb3BlXG5cdGZpbmlzaGVkOiBib29sZWFuICAgIyAtLS0gc2V0IHdoZW4gbGFzdCBzY29wZSBpcyBlbmRlZFxuXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuXG5cdGNvbnN0cnVjdG9yKHM6IENTY29wZSA9IG5ldyBDU2NvcGUoKSlcblxuXHRcdEBjdXJTY29wZSA9IHNcblx0XHRAbFNjb3BlcyA9IFtzXVxuXHRcdEBmaW5pc2hlZCA9IGZhbHNlXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cblx0bmV3U2NvcGUoczogQ1Njb3BlID0gbmV3IENTY29wZSgpKTogdm9pZFxuXG5cdFx0YXNzZXJ0IG5vdCBAZmluaXNoZWQsIFwiZmluaXNoZWQgPSB0cnVlXCJcblx0XHRAY3VyU2NvcGUgPSBzXG5cdFx0QGxTY29wZXMucHVzaCBzXG5cdFx0cmV0dXJuXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cblx0ZW5kU2NvcGUoKTogQ1Njb3BlXG5cblx0XHRzd2l0Y2ggQGxTY29wZXMubGVuZ3RoXG5cdFx0XHR3aGVuIDBcblx0XHRcdFx0Y3JvYWsgXCJlbmRTY29wZSgpIHdpdGggbm8gc2NvcGVzXCJcblx0XHRcdHdoZW4gMVxuXHRcdFx0XHRAZmluaXNoZWQgPSB0cnVlXG5cdFx0XHRlbHNlXG5cdFx0XHRcdEBjdXJTY29wZSA9IEBsU2NvcGVzLmF0KC0yKSBhcyBDU2NvcGVcblx0XHRyZXR1cm4gQGxTY29wZXMucG9wKCkgYXMgQ1Njb3BlXG5cblx0IyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5cblx0YWRkRGVmaW5lZChuYW1lOiBzdHJpbmcpOiB2b2lkXG5cblx0XHRhc3NlcnQgbm90IEBmaW5pc2hlZCwgXCJmaW5pc2hlZCA9IHRydWVcIlxuXHRcdEBjdXJTY29wZS5hZGREZWZpbmVkIG5hbWVcblx0XHRyZXR1cm5cblxuXHQjIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblxuXHRhZGRVc2VkKG5hbWU6IHN0cmluZyk6IHZvaWRcblxuXHRcdGFzc2VydCBub3QgQGZpbmlzaGVkLCBcImZpbmlzaGVkID0gdHJ1ZVwiXG5cdFx0QGN1clNjb3BlLmFkZFVzZWQgbmFtZVxuXHRcdHJldHVyblxuXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuXG5cdGlzRGVmaW5lZChuYW1lOiBzdHJpbmcpOiBib29sZWFuXG5cblx0XHRmb3Igc2NvcGUgb2YgW0BsU2NvcGVzLi4uXS5yZXZlcnNlKClcblx0XHRcdGlmIHNjb3BlLmlzRGVmaW5lZChuYW1lKVxuXHRcdFx0XHRyZXR1cm4gdHJ1ZVxuXHRcdHJldHVybiBmYWxzZVxuXG5cdCMgLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuXG5cdGlzVXNlZChuYW1lOiBzdHJpbmcpOiBib29sZWFuXG5cblx0XHRmb3Igc2NvcGUgb2YgW0BsU2NvcGVzLi4uXS5yZXZlcnNlKClcblx0XHRcdGlmIHNjb3BlLmlzVXNlZChuYW1lKVxuXHRcdFx0XHRyZXR1cm4gdHJ1ZVxuXHRcdHJldHVybiBmYWxzZVxuIl19