"use strict";
// typescript.lib.civet

import {existsSync} from '@std/fs'
import {statSync} from 'node:fs'
import {
	SourceFile, Node, ScriptTarget, SyntaxKind, ModuleKind,
	NewLineKind, EmitHint, CompilerOptions, ModuleResolutionKind,
	createSourceFile, createPrinter, createProgram, transpileModule,
	getPreEmitDiagnostics, flattenDiagnosticMessageText,
	getLineAndCharacterOfPosition, forEachChild,
	} from "npm:typescript"

import {hash, isHash} from 'datatypes'
import {truncStr, hasKey, getOptions} from 'llutils'
import {DBG, LOGVALUE} from 'logger'
import {TNodeInfo, getAstWalker} from 'ast-walker'

const decoder = new TextDecoder("utf-8")

// ---------------------------------------------------------------------------

/**
 * getCode(str) - return contents of file if str is a file path
 *    else return str
 */

export const getCode = (str: string): string => {

	if ((str.indexOf('\n') === -1)
			&& str.match(/\.[A-Za-z0-9]+$/)
			&& existsSync(str)
			&& statSync(str).isFile()
			) {
		const data = Deno.readFileSync(str)
		return decoder.decode(data)
	}
	else {
		return str
	}
}

// ---------------------------------------------------------------------------

/**
 * ts2ast() - convert TypeScript code to an AST
 */

export const ts2ast = (
		str: string,
		hOptions: hash = {}
		): SourceFile => {

	type opt = {
		addNames: boolean
		}
	const {addNames} = getOptions<opt>(hOptions, {
		addNames: true
		})

	const tsCode = getCode(str)
	const hAst = createSourceFile("temp.ts", tsCode, ScriptTarget.Latest)
	const filter = (x: any) => {
		return (
			   (typeof x === 'object')
			&& (x !== null)
			&& hasKey(x, 'kind')
			&& (typeof x.kind === 'number')
			)
	}
	if (addNames) {
		const walker = getAstWalker(hAst, filter)
		for (const item of walker()) {
			const {node} = item
			if ((typeof node === 'object') && (node !== null) && ('kind' in node)) {
				const {kind} = node
				if (typeof kind === 'number') {
					item.kindStr = SyntaxKind[kind]
				}
			}
		}
	}
	return hAst
}

// ---------------------------------------------------------------------------

/**
 * ts2js() - convert TypeScript code to JavaScript code
 */

export const ts2js = (str: string): string => {

	const tsCode = getCode(str)
	const hOptions = {
		compilerOptions: {
			module: ModuleKind.ES2022
			}
		}
	return transpileModule(tsCode, hOptions).outputText.trim()
}

// ---------------------------------------------------------------------------

export const ast2ts = (node: SourceFile): string => {

	const printer = createPrinter({newLine: NewLineKind.LineFeed})
	return printer.printNode(EmitHint.Unspecified, node, node)
}

// ---------------------------------------------------------------------------

export const ast2js = (node: SourceFile): string => {

	return ts2js(ast2ts(node))
}

// ---------------------------------------------------------------------------

export const typeCheckFiles = (
		lFileNames: string | string[],
		hOptions: CompilerOptions = hDefConfig
		): string[] => {

	if (typeof lFileNames === 'string') {
		lFileNames = [lFileNames]
	}
	const program = createProgram(lFileNames, hOptions)
	const emitResult = program.emit()

	const lMsgs: string[] = []
	getPreEmitDiagnostics(program).forEach((diag) => {
		const {file, start, messageText} = diag
		const msg = flattenDiagnosticMessageText(messageText, "\n")
		if (file) {
			const {fileName} = file
			const {line, character} = getLineAndCharacterOfPosition(file, start!)
			lMsgs.push(`${fileName}:(${line+1}:${character+1}): ${msg}`)
		}
		else {
			lMsgs.push(msg)
		}
	})
	return lMsgs
}

export var typeCheckFile = typeCheckFiles   // --- synonym

// ---------------------------------------------------------------------------

type TNodePrinter = (src: SourceFile, n: Node, depth: number) => string

const pprintNode = (
		source: SourceFile,
		node: Node,
		depth: number
		): string => {

	const kind = SyntaxKind[node.kind]
	const text = node.getText(source).replaceAll('\n', '\\n')
	const pre = ' '.repeat(3 * depth)
	return `${pre}${kind} - '${truncStr(text, 32)}'`
}

// ---------------------------------------------------------------------------

export const pprintAST = (
		source: SourceFile,
		pprint: TNodePrinter = pprintNode
		): string => {

	const lLines: string[] = []

	const traverse = (node: Node, depth=0): void => {
		const line = pprint(source, node, depth)
		lLines.push(line)
		forEachChild(node, (childNode) => traverse(childNode, depth + 1))
		return
	}

	traverse(source)
	return lLines.join('\n')
}

// ---------------------------------------------------------------------------

const hDefConfig: CompilerOptions = {
	"allowJs": false,
	"allowUmdGlobalAccess": false,
	"allowUnreachableCode": false,
	"allowUnusedLabels": false,
	"alwaysStrict": true,
	"assumeChangesOnlyAffectDirectDependencies": false,
	"checkJs": false,
	"composite": false,
	"declaration": false,
	"declarationDir": undefined,
	"declarationMap": false,
	"emitBOM": false,
	"emitDeclarationOnly": false,
	"exactOptionalPropertyTypes": false,
	"experimentalDecorators": false,
	"forceConsistentCasingInFileNames": true,
	"generateCpuProfile": null,
	"generateTrace": null,
	"ignoreDeprecations": "5.0",
	"importHelpers": false,
	"inlineSourceMap": false,
	"inlineSources": false,
	"isolatedModules": false,
//	"jsx": "react-jsx",
//	"jsxFactory": "React.createElement",
//	"jsxFragmentFactory": "React.Fragment",
//	"jsxImportSource": "react",
	"lib": [
		"esnext",
		"dom",
		"dom.iterable"
	],
	"mapRoot": undefined,
	"maxNodeModuleJsDepth": 0,
	"module": ModuleKind.ESNext,
	"moduleDetection": undefined,
	"moduleResolution": ModuleResolutionKind.NodeNext,
	"newLine": NewLineKind.LineFeed,
	"noEmit": true,
	"noEmitHelpers": false,
	"noEmitOnError": false,
	"noErrorTruncation": false,
	"noFallthroughCasesInSwitch": true,
	"noImplicitAny": true,
	"noImplicitOverride": true,
	"noImplicitReturns": true,
	"noImplicitThis": true,
	"noPropertyAccessFromIndexSignature": true,
	"noUncheckedIndexedAccess": true,
	"noUnusedLocals": true,
	"noUnusedParameters": true,
	"outDir": undefined,
	"outFile": undefined,
	"paths": {},
	"preserveConstEnums": false,
	"preserveSymlinks": false,
	"preserveValueImports": false,
	"reactNamespace": "React",
	"removeComments": false,
	"resolveJsonModule": true,
	"rootDir": undefined,
	"rootDirs": [],
	"skipDefaultLibCheck": false,
	"skipLibCheck": false,
	"sourceMap": false,
	"sourceRoot": undefined,
	"strict": true,
	"strictBindCallApply": true,
	"strictFunctionTypes": true,
	"strictNullChecks": true,
	"strictPropertyInitialization": true,
	"stripInternal": false,
	"suppressExcessPropertyErrors": false,
	"suppressImplicitAnyIndexErrors": false,
	"target": ScriptTarget.ES2022,
	"traceResolution": false,
	"tsBuildInfoFile": undefined,
	"typeRoots": [],
	"useDefineForClassFields": true,
	"useUnknownInCatchVariables": true
	}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi90eXBlc2NyaXB0LmxpYi5jaXZldC50c3giLCJzb3VyY2VzIjpbInNyYy9saWIvdHlwZXNjcmlwdC5saWIuY2l2ZXQiXSwibWFwcGluZ3MiOiI7QUFBQSx1QkFBc0I7QUFDdEIsQUFBQTtBQUNBLEFBQUEsTUFBTSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7QUFDbEMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQ2hDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ3hELENBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsb0JBQW9CLENBQUM7QUFDOUQsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLGVBQWUsQ0FBQztBQUNqRSxDQUFDLHFCQUFxQixDQUFDLENBQUMsNEJBQTRCLENBQUM7QUFDckQsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLFlBQVksQ0FBQztBQUM3QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCO0FBQ3hCLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDdEMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQ3BELEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNwQyxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUMsU0FB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LENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDMUIsQUFBQSxDQUFDLDhCQUE4QixDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ3RDLEFBQUEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDeEIsQUFBQSxDQUFDLDhCQUE4QixDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3ZDLEFBQUEsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUN6QyxBQUFBLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztBQUMvQixBQUFBLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDMUIsQUFBQSxDQUFDLGlCQUFpQixDQUFDLENBQUMsU0FBUyxDQUFDO0FBQzlCLEFBQUEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNqQixBQUFBLENBQUMseUJBQXlCLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDakMsQUFBQSxDQUFDLDRCQUE0QixDQUFDLENBQUMsSUFBSTtBQUNuQyxDQUFDLENBQUM7QUFDRiIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyB0eXBlc2NyaXB0LmxpYi5jaXZldFxuXG5pbXBvcnQge2V4aXN0c1N5bmN9IGZyb20gJ0BzdGQvZnMnXG5pbXBvcnQge3N0YXRTeW5jfSBmcm9tICdub2RlOmZzJ1xuaW1wb3J0IHtcblx0U291cmNlRmlsZSwgTm9kZSwgU2NyaXB0VGFyZ2V0LCBTeW50YXhLaW5kLCBNb2R1bGVLaW5kLFxuXHROZXdMaW5lS2luZCwgRW1pdEhpbnQsIENvbXBpbGVyT3B0aW9ucywgTW9kdWxlUmVzb2x1dGlvbktpbmQsXG5cdGNyZWF0ZVNvdXJjZUZpbGUsIGNyZWF0ZVByaW50ZXIsIGNyZWF0ZVByb2dyYW0sIHRyYW5zcGlsZU1vZHVsZSxcblx0Z2V0UHJlRW1pdERpYWdub3N0aWNzLCBmbGF0dGVuRGlhZ25vc3RpY01lc3NhZ2VUZXh0LFxuXHRnZXRMaW5lQW5kQ2hhcmFjdGVyT2ZQb3NpdGlvbiwgZm9yRWFjaENoaWxkLFxuXHR9IGZyb20gXCJucG06dHlwZXNjcmlwdFwiXG5cbmltcG9ydCB7aGFzaCwgaXNIYXNofSBmcm9tICdkYXRhdHlwZXMnXG5pbXBvcnQge3RydW5jU3RyLCBoYXNLZXksIGdldE9wdGlvbnN9IGZyb20gJ2xsdXRpbHMnXG5pbXBvcnQge0RCRywgTE9HVkFMVUV9IGZyb20gJ2xvZ2dlcidcbmltcG9ydCB7VE5vZGVJbmZvLCBnZXRBc3RXYWxrZXJ9IGZyb20gJ2FzdC13YWxrZXInXG5cbmRlY29kZXIgOj0gbmV3IFRleHREZWNvZGVyKFwidXRmLThcIilcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBnZXRDb2RlKHN0cikgLSByZXR1cm4gY29udGVudHMgb2YgZmlsZSBpZiBzdHIgaXMgYSBmaWxlIHBhdGhcbiAqICAgIGVsc2UgcmV0dXJuIHN0clxuICovXG5cbmV4cG9ydCBnZXRDb2RlIDo9IChzdHI6IHN0cmluZyk6IHN0cmluZyA9PlxuXG5cdGlmICgoc3RyLmluZGV4T2YoJ1xcbicpID09IC0xKVxuXHRcdFx0JiYgc3RyLm1hdGNoKC9cXC5bQS1aYS16MC05XSskLylcblx0XHRcdCYmIGV4aXN0c1N5bmMoc3RyKVxuXHRcdFx0JiYgc3RhdFN5bmMoc3RyKS5pc0ZpbGUoKVxuXHRcdFx0KVxuXHRcdGRhdGEgOj0gRGVuby5yZWFkRmlsZVN5bmMoc3RyKVxuXHRcdHJldHVybiBkZWNvZGVyLmRlY29kZShkYXRhKVxuXHRlbHNlXG5cdFx0cmV0dXJuIHN0clxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIHRzMmFzdCgpIC0gY29udmVydCBUeXBlU2NyaXB0IGNvZGUgdG8gYW4gQVNUXG4gKi9cblxuZXhwb3J0IHRzMmFzdCA6PSAoXG5cdFx0c3RyOiBzdHJpbmcsXG5cdFx0aE9wdGlvbnM6IGhhc2ggPSB7fVxuXHRcdCk6IFNvdXJjZUZpbGUgPT5cblxuXHR0eXBlIG9wdCA9IHtcblx0XHRhZGROYW1lczogYm9vbGVhblxuXHRcdH1cblx0e2FkZE5hbWVzfSA6PSBnZXRPcHRpb25zPG9wdD4gaE9wdGlvbnMsIHtcblx0XHRhZGROYW1lczogdHJ1ZVxuXHRcdH1cblxuXHR0c0NvZGUgOj0gZ2V0Q29kZSBzdHJcblx0aEFzdCA6PSBjcmVhdGVTb3VyY2VGaWxlKFwidGVtcC50c1wiLCB0c0NvZGUsIFNjcmlwdFRhcmdldC5MYXRlc3QpXG5cdGZpbHRlciA6PSAoeDogYW55KSA9PlxuXHRcdHJldHVybiAoXG5cdFx0XHQgICAodHlwZW9mIHggPT0gJ29iamVjdCcpXG5cdFx0XHQmJiAoeCAhPSBudWxsKVxuXHRcdFx0JiYgaGFzS2V5KHgsICdraW5kJylcblx0XHRcdCYmICh0eXBlb2YgeC5raW5kID09ICdudW1iZXInKVxuXHRcdFx0KVxuXHRpZiBhZGROYW1lc1xuXHRcdHdhbGtlciA6PSBnZXRBc3RXYWxrZXIoaEFzdCwgZmlsdGVyKVxuXHRcdGZvciBpdGVtIG9mIHdhbGtlcigpXG5cdFx0XHR7bm9kZX0gOj0gaXRlbVxuXHRcdFx0aWYgKHR5cGVvZiBub2RlID09ICdvYmplY3QnKSAmJiAobm9kZSAhPSBudWxsKSAmJiAoJ2tpbmQnIGluIG5vZGUpXG5cdFx0XHRcdHtraW5kfSA6PSBub2RlXG5cdFx0XHRcdGlmICh0eXBlb2Yga2luZCA9PSAnbnVtYmVyJylcblx0XHRcdFx0XHRpdGVtLmtpbmRTdHIgPSBTeW50YXhLaW5kW2tpbmRdXG5cdHJldHVybiBoQXN0XG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogdHMyanMoKSAtIGNvbnZlcnQgVHlwZVNjcmlwdCBjb2RlIHRvIEphdmFTY3JpcHQgY29kZVxuICovXG5cbmV4cG9ydCB0czJqcyA6PSAoc3RyOiBzdHJpbmcpOiBzdHJpbmcgPT5cblxuXHR0c0NvZGUgOj0gZ2V0Q29kZSBzdHJcblx0aE9wdGlvbnMgOj0ge1xuXHRcdGNvbXBpbGVyT3B0aW9uczoge1xuXHRcdFx0bW9kdWxlOiBNb2R1bGVLaW5kLkVTMjAyMlxuXHRcdFx0fVxuXHRcdH1cblx0cmV0dXJuIHRyYW5zcGlsZU1vZHVsZSh0c0NvZGUsIGhPcHRpb25zKS5vdXRwdXRUZXh0LnRyaW0oKVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgYXN0MnRzIDo9IChub2RlOiBTb3VyY2VGaWxlKTogc3RyaW5nID0+XG5cblx0cHJpbnRlciA6PSBjcmVhdGVQcmludGVyIHtuZXdMaW5lOiBOZXdMaW5lS2luZC5MaW5lRmVlZH1cblx0cmV0dXJuIHByaW50ZXIucHJpbnROb2RlIEVtaXRIaW50LlVuc3BlY2lmaWVkLCBub2RlLCBub2RlXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBhc3QyanMgOj0gKG5vZGU6IFNvdXJjZUZpbGUpOiBzdHJpbmcgPT5cblxuXHRyZXR1cm4gdHMyanMoYXN0MnRzKG5vZGUpKVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgdHlwZUNoZWNrRmlsZXMgOj0gKFxuXHRcdGxGaWxlTmFtZXM6IHN0cmluZyB8IHN0cmluZ1tdLFxuXHRcdGhPcHRpb25zOiBDb21waWxlck9wdGlvbnMgPSBoRGVmQ29uZmlnXG5cdFx0KTogc3RyaW5nW10gPT5cblxuXHRpZiAodHlwZW9mIGxGaWxlTmFtZXMgPT0gJ3N0cmluZycpXG5cdFx0bEZpbGVOYW1lcyA9IFtsRmlsZU5hbWVzXVxuXHRwcm9ncmFtIDo9IGNyZWF0ZVByb2dyYW0obEZpbGVOYW1lcywgaE9wdGlvbnMpXG5cdGVtaXRSZXN1bHQgOj0gcHJvZ3JhbS5lbWl0KClcblxuXHRsTXNnczogc3RyaW5nW10gOj0gW11cblx0Z2V0UHJlRW1pdERpYWdub3N0aWNzKHByb2dyYW0pLmZvckVhY2ggKGRpYWcpID0+XG5cdFx0e2ZpbGUsIHN0YXJ0LCBtZXNzYWdlVGV4dH0gOj0gZGlhZ1xuXHRcdG1zZyA6PSBmbGF0dGVuRGlhZ25vc3RpY01lc3NhZ2VUZXh0IG1lc3NhZ2VUZXh0LCBcIlxcblwiXG5cdFx0aWYgKGZpbGUpXG5cdFx0XHR7ZmlsZU5hbWV9IDo9IGZpbGVcblx0XHRcdHtsaW5lLCBjaGFyYWN0ZXJ9IDo9IGdldExpbmVBbmRDaGFyYWN0ZXJPZlBvc2l0aW9uIGZpbGUsIHN0YXJ0IVxuXHRcdFx0bE1zZ3MucHVzaCBcIiN7ZmlsZU5hbWV9Oigje2xpbmUrMX06I3tjaGFyYWN0ZXIrMX0pOiAje21zZ31cIlxuXHRcdGVsc2Vcblx0XHRcdGxNc2dzLnB1c2ggbXNnXG5cdHJldHVybiBsTXNnc1xuXG5leHBvcnQgdHlwZUNoZWNrRmlsZSA9IHR5cGVDaGVja0ZpbGVzICAgIyAtLS0gc3lub255bVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG50eXBlIFROb2RlUHJpbnRlciA9IChzcmM6IFNvdXJjZUZpbGUsIG46IE5vZGUsIGRlcHRoOiBudW1iZXIpID0+IHN0cmluZ1xuXG5wcHJpbnROb2RlIDo9IChcblx0XHRzb3VyY2U6IFNvdXJjZUZpbGUsXG5cdFx0bm9kZTogTm9kZSxcblx0XHRkZXB0aDogbnVtYmVyXG5cdFx0KTogc3RyaW5nID0+XG5cblx0a2luZCA6PSBTeW50YXhLaW5kW25vZGUua2luZF1cblx0dGV4dCA6PSBub2RlLmdldFRleHQoc291cmNlKS5yZXBsYWNlQWxsKCdcXG4nLCAnXFxcXG4nKVxuXHRwcmUgOj0gJyAnLnJlcGVhdCgzICogZGVwdGgpXG5cdHJldHVybiBcIiN7cHJlfSN7a2luZH0gLSAnI3t0cnVuY1N0cih0ZXh0LCAzMil9J1wiXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBwcHJpbnRBU1QgOj0gKFxuXHRcdHNvdXJjZTogU291cmNlRmlsZSxcblx0XHRwcHJpbnQ6IFROb2RlUHJpbnRlciA9IHBwcmludE5vZGVcblx0XHQpOiBzdHJpbmcgPT5cblxuXHRsTGluZXM6IHN0cmluZ1tdIDo9IFtdXG5cblx0dHJhdmVyc2UgOj0gKG5vZGU6IE5vZGUsIGRlcHRoPTApOiB2b2lkID0+XG5cdFx0bGluZSA6PSBwcHJpbnQoc291cmNlLCBub2RlLCBkZXB0aClcblx0XHRsTGluZXMucHVzaCBsaW5lXG5cdFx0Zm9yRWFjaENoaWxkIG5vZGUsIChjaGlsZE5vZGUpID0+IHRyYXZlcnNlKGNoaWxkTm9kZSwgZGVwdGggKyAxKVxuXHRcdHJldHVyblxuXG5cdHRyYXZlcnNlIHNvdXJjZVxuXHRyZXR1cm4gbExpbmVzLmpvaW4oJ1xcbicpXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmhEZWZDb25maWc6IENvbXBpbGVyT3B0aW9ucyA6PSB7XG5cdFwiYWxsb3dKc1wiOiBmYWxzZSxcblx0XCJhbGxvd1VtZEdsb2JhbEFjY2Vzc1wiOiBmYWxzZSxcblx0XCJhbGxvd1VucmVhY2hhYmxlQ29kZVwiOiBmYWxzZSxcblx0XCJhbGxvd1VudXNlZExhYmVsc1wiOiBmYWxzZSxcblx0XCJhbHdheXNTdHJpY3RcIjogdHJ1ZSxcblx0XCJhc3N1bWVDaGFuZ2VzT25seUFmZmVjdERpcmVjdERlcGVuZGVuY2llc1wiOiBmYWxzZSxcblx0XCJjaGVja0pzXCI6IGZhbHNlLFxuXHRcImNvbXBvc2l0ZVwiOiBmYWxzZSxcblx0XCJkZWNsYXJhdGlvblwiOiBmYWxzZSxcblx0XCJkZWNsYXJhdGlvbkRpclwiOiB1bmRlZmluZWQsXG5cdFwiZGVjbGFyYXRpb25NYXBcIjogZmFsc2UsXG5cdFwiZW1pdEJPTVwiOiBmYWxzZSxcblx0XCJlbWl0RGVjbGFyYXRpb25Pbmx5XCI6IGZhbHNlLFxuXHRcImV4YWN0T3B0aW9uYWxQcm9wZXJ0eVR5cGVzXCI6IGZhbHNlLFxuXHRcImV4cGVyaW1lbnRhbERlY29yYXRvcnNcIjogZmFsc2UsXG5cdFwiZm9yY2VDb25zaXN0ZW50Q2FzaW5nSW5GaWxlTmFtZXNcIjogdHJ1ZSxcblx0XCJnZW5lcmF0ZUNwdVByb2ZpbGVcIjogbnVsbCxcblx0XCJnZW5lcmF0ZVRyYWNlXCI6IG51bGwsXG5cdFwiaWdub3JlRGVwcmVjYXRpb25zXCI6IFwiNS4wXCIsXG5cdFwiaW1wb3J0SGVscGVyc1wiOiBmYWxzZSxcblx0XCJpbmxpbmVTb3VyY2VNYXBcIjogZmFsc2UsXG5cdFwiaW5saW5lU291cmNlc1wiOiBmYWxzZSxcblx0XCJpc29sYXRlZE1vZHVsZXNcIjogZmFsc2UsXG4jXHRcImpzeFwiOiBcInJlYWN0LWpzeFwiLFxuI1x0XCJqc3hGYWN0b3J5XCI6IFwiUmVhY3QuY3JlYXRlRWxlbWVudFwiLFxuI1x0XCJqc3hGcmFnbWVudEZhY3RvcnlcIjogXCJSZWFjdC5GcmFnbWVudFwiLFxuI1x0XCJqc3hJbXBvcnRTb3VyY2VcIjogXCJyZWFjdFwiLFxuXHRcImxpYlwiOiBbXG5cdFx0XCJlc25leHRcIixcblx0XHRcImRvbVwiLFxuXHRcdFwiZG9tLml0ZXJhYmxlXCJcblx0XSxcblx0XCJtYXBSb290XCI6IHVuZGVmaW5lZCxcblx0XCJtYXhOb2RlTW9kdWxlSnNEZXB0aFwiOiAwLFxuXHRcIm1vZHVsZVwiOiBNb2R1bGVLaW5kLkVTTmV4dCxcblx0XCJtb2R1bGVEZXRlY3Rpb25cIjogdW5kZWZpbmVkLFxuXHRcIm1vZHVsZVJlc29sdXRpb25cIjogTW9kdWxlUmVzb2x1dGlvbktpbmQuTm9kZU5leHQsXG5cdFwibmV3TGluZVwiOiBOZXdMaW5lS2luZC5MaW5lRmVlZCxcblx0XCJub0VtaXRcIjogdHJ1ZSxcblx0XCJub0VtaXRIZWxwZXJzXCI6IGZhbHNlLFxuXHRcIm5vRW1pdE9uRXJyb3JcIjogZmFsc2UsXG5cdFwibm9FcnJvclRydW5jYXRpb25cIjogZmFsc2UsXG5cdFwibm9GYWxsdGhyb3VnaENhc2VzSW5Td2l0Y2hcIjogdHJ1ZSxcblx0XCJub0ltcGxpY2l0QW55XCI6IHRydWUsXG5cdFwibm9JbXBsaWNpdE92ZXJyaWRlXCI6IHRydWUsXG5cdFwibm9JbXBsaWNpdFJldHVybnNcIjogdHJ1ZSxcblx0XCJub0ltcGxpY2l0VGhpc1wiOiB0cnVlLFxuXHRcIm5vUHJvcGVydHlBY2Nlc3NGcm9tSW5kZXhTaWduYXR1cmVcIjogdHJ1ZSxcblx0XCJub1VuY2hlY2tlZEluZGV4ZWRBY2Nlc3NcIjogdHJ1ZSxcblx0XCJub1VudXNlZExvY2Fsc1wiOiB0cnVlLFxuXHRcIm5vVW51c2VkUGFyYW1ldGVyc1wiOiB0cnVlLFxuXHRcIm91dERpclwiOiB1bmRlZmluZWQsXG5cdFwib3V0RmlsZVwiOiB1bmRlZmluZWQsXG5cdFwicGF0aHNcIjoge30sXG5cdFwicHJlc2VydmVDb25zdEVudW1zXCI6IGZhbHNlLFxuXHRcInByZXNlcnZlU3ltbGlua3NcIjogZmFsc2UsXG5cdFwicHJlc2VydmVWYWx1ZUltcG9ydHNcIjogZmFsc2UsXG5cdFwicmVhY3ROYW1lc3BhY2VcIjogXCJSZWFjdFwiLFxuXHRcInJlbW92ZUNvbW1lbnRzXCI6IGZhbHNlLFxuXHRcInJlc29sdmVKc29uTW9kdWxlXCI6IHRydWUsXG5cdFwicm9vdERpclwiOiB1bmRlZmluZWQsXG5cdFwicm9vdERpcnNcIjogW10sXG5cdFwic2tpcERlZmF1bHRMaWJDaGVja1wiOiBmYWxzZSxcblx0XCJza2lwTGliQ2hlY2tcIjogZmFsc2UsXG5cdFwic291cmNlTWFwXCI6IGZhbHNlLFxuXHRcInNvdXJjZVJvb3RcIjogdW5kZWZpbmVkLFxuXHRcInN0cmljdFwiOiB0cnVlLFxuXHRcInN0cmljdEJpbmRDYWxsQXBwbHlcIjogdHJ1ZSxcblx0XCJzdHJpY3RGdW5jdGlvblR5cGVzXCI6IHRydWUsXG5cdFwic3RyaWN0TnVsbENoZWNrc1wiOiB0cnVlLFxuXHRcInN0cmljdFByb3BlcnR5SW5pdGlhbGl6YXRpb25cIjogdHJ1ZSxcblx0XCJzdHJpcEludGVybmFsXCI6IGZhbHNlLFxuXHRcInN1cHByZXNzRXhjZXNzUHJvcGVydHlFcnJvcnNcIjogZmFsc2UsXG5cdFwic3VwcHJlc3NJbXBsaWNpdEFueUluZGV4RXJyb3JzXCI6IGZhbHNlLFxuXHRcInRhcmdldFwiOiBTY3JpcHRUYXJnZXQuRVMyMDIyLFxuXHRcInRyYWNlUmVzb2x1dGlvblwiOiBmYWxzZSxcblx0XCJ0c0J1aWxkSW5mb0ZpbGVcIjogdW5kZWZpbmVkLFxuXHRcInR5cGVSb290c1wiOiBbXSxcblx0XCJ1c2VEZWZpbmVGb3JDbGFzc0ZpZWxkc1wiOiB0cnVlLFxuXHRcInVzZVVua25vd25JbkNhdGNoVmFyaWFibGVzXCI6IHRydWVcblx0fVxuIl19