"use strict";
// civet.lib.civet

type AutoPromise<T> = Promise<Awaited<T>>;
import {SourceFile} from 'npm:typescript'

import {
	undef, defined, notdefined, hash, assert,
	isString, isHash,
	} from 'datatypes'
import {OL, ML, getOptions, o} from 'llutils'
import {DBG, DBGVALUE} from 'logger'
import {
	isFile, fileExt, withExt, slurp, barf, barfTempFile,
	parsePath, findSrcFile,
	} from 'fsys'
import {
	TCmdDesc, TExecResult, execCmdSync, execCmd, execCmds,
	} from 'exec'
import {ts2ast} from 'typescript'

// ---------------------------------------------------------------------------
// ASYNC

export const compileCivetFiles = async (
		lNames: string[],
		purpose: string = 'lib'
		): AutoPromise<TExecResult[]> => {

	const lCmds: TCmdDesc[] = []
	for (const name of lNames) {
		const path = findSrcFile(`${name}.${purpose}.civet`)
		assert(defined(path), `No such file: ${OL(path)}`)
		if (defined(path)) {
			lCmds.push(['civet', [
				'--inline-map',
				'-o', '.ts',
				'-c', path
				]])
		}
	}

	const lResults = await execCmds(lCmds)
	return lResults
}

// ---------------------------------------------------------------------------

export const civet2tsFile = (
		path: string,
		tsPath: string = withExt(path, '.ts'),
		hOptions: hash = {}
		): string => {

	assert(isFile(path), `No such file: ${OL(path)} (civet2tsFile)`)
	assert((fileExt(path) === '.civet'), `Not a civet file: ${OL(path)}`)

	type opt = {
		inlineMap: boolean
		}
	const {inlineMap} = getOptions<opt>(hOptions, {
		inlineMap: true
		})
	if (inlineMap) {
		execCmdSync('civet', [
			'--inline-map',
			'-o',
			tsPath,
			'-c',
			path
			])
	}
	else {
		execCmdSync('civet', [
			'-o',
			tsPath,
			'-c',
			path
			])
	}
	assert(isFile(tsPath), `File not created: ${OL(tsPath)}`)
	return tsPath
}

// ---------------------------------------------------------------------------

export const civet2ts = (civetCode: string): string => {

	const tempFilePath = barfTempFile(civetCode)
	const tsFilePath = withExt(tempFilePath, '.ts')
	civet2tsFile(tempFilePath, tsFilePath, o`!inlineMap`)
	return slurp(tsFilePath)
}

// ---------------------------------------------------------------------------

export const civet2ast = (civetCode: string): SourceFile => {

	return ts2ast(civet2ts(civetCode))
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxjaXZldC5saWIuY2l2ZXQudHN4Iiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGpvaG5kXFx1dGlsc1xcc3JjXFxsaWJcXGNpdmV0LmxpYi5jaXZldCJdLCJtYXBwaW5ncyI6IjtBQUFBLGtCQUFpQjtBQUNqQixBQUFBO0FBQ0EsSyxXLHlCO0FBQUEsTUFBTSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQjtBQUN6QyxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDMUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVc7QUFDbkIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO0FBQzdDLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUNwQyxBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQztBQUNyRCxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztBQUN4QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTTtBQUNkLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMs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NkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQVMsTUFBUixRQUFRLENBQUMsQ0FBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDakQsQUFBQTtBQUNBLEFBQUEsQ0FBYSxNQUFaLFlBQVksQ0FBQyxDQUFFLENBQUMsWUFBWSxDQUFBLEFBQUMsU0FBUyxDQUFBO0FBQ3ZDLEFBQUEsQ0FBVyxNQUFWLFVBQVUsQ0FBQyxDQUFFLENBQUMsT0FBTyxDQUFBLEFBQUMsWUFBWSxDQUFDLENBQUMsS0FBSyxDQUFBO0FBQzFDLEFBQUEsQ0FBQyxZQUFZLENBQUEsQUFBQyxZQUFZLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDLFlBQWEsQ0FBQTtBQUNyRCxBQUFBLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQSxBQUFDLFVBQVUsQztBQUFBLENBQUE7QUFDeEIsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFVLE1BQVQsU0FBUyxDQUFDLENBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ3RELEFBQUE7QUFDQSxBQUFBLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEM7QUFBQyxDQUFBO0FBQ25DIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIGNpdmV0LmxpYi5jaXZldFxuXG5pbXBvcnQge1NvdXJjZUZpbGV9IGZyb20gJ25wbTp0eXBlc2NyaXB0J1xuXG5pbXBvcnQge1xuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCwgaGFzaCwgYXNzZXJ0LFxuXHRpc1N0cmluZywgaXNIYXNoLFxuXHR9IGZyb20gJ2RhdGF0eXBlcydcbmltcG9ydCB7T0wsIE1MLCBnZXRPcHRpb25zLCBvfSBmcm9tICdsbHV0aWxzJ1xuaW1wb3J0IHtEQkcsIERCR1ZBTFVFfSBmcm9tICdsb2dnZXInXG5pbXBvcnQge1xuXHRpc0ZpbGUsIGZpbGVFeHQsIHdpdGhFeHQsIHNsdXJwLCBiYXJmLCBiYXJmVGVtcEZpbGUsXG5cdHBhcnNlUGF0aCwgZmluZFNyY0ZpbGUsXG5cdH0gZnJvbSAnZnN5cydcbmltcG9ydCB7XG5cdFRDbWREZXNjLCBURXhlY1Jlc3VsdCwgZXhlY0NtZFN5bmMsIGV4ZWNDbWQsIGV4ZWNDbWRzLFxuXHR9IGZyb20gJ2V4ZWMnXG5pbXBvcnQge3RzMmFzdH0gZnJvbSAndHlwZXNjcmlwdCdcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgQVNZTkNcblxuZXhwb3J0IGNvbXBpbGVDaXZldEZpbGVzIDo9IChcblx0XHRsTmFtZXM6IHN0cmluZ1tdXG5cdFx0cHVycG9zZTogc3RyaW5nID0gJ2xpYidcblx0XHQpOiBURXhlY1Jlc3VsdFtdID0+XG5cblx0bENtZHM6IFRDbWREZXNjW10gOj0gW11cblx0Zm9yIG5hbWUgb2YgbE5hbWVzXG5cdFx0cGF0aCA6PSBmaW5kU3JjRmlsZSBcIiN7bmFtZX0uI3twdXJwb3NlfS5jaXZldFwiXG5cdFx0YXNzZXJ0IGRlZmluZWQocGF0aCksIFwiTm8gc3VjaCBmaWxlOiAje09MKHBhdGgpfVwiXG5cdFx0aWYgZGVmaW5lZChwYXRoKVxuXHRcdFx0bENtZHMucHVzaCBbJ2NpdmV0JywgW1xuXHRcdFx0XHQnLS1pbmxpbmUtbWFwJyxcblx0XHRcdFx0Jy1vJywgJy50cycsXG5cdFx0XHRcdCctYycsIHBhdGhcblx0XHRcdFx0XV1cblxuXHRsUmVzdWx0cyA6PSBhd2FpdCBleGVjQ21kcyBsQ21kc1xuXHRyZXR1cm4gbFJlc3VsdHNcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGNpdmV0MnRzRmlsZSA6PSAoXG5cdFx0cGF0aDogc3RyaW5nXG5cdFx0dHNQYXRoOiBzdHJpbmcgPSB3aXRoRXh0KHBhdGgsICcudHMnKVxuXHRcdGhPcHRpb25zOiBoYXNoID0ge31cblx0XHQpOiBzdHJpbmcgPT5cblxuXHRhc3NlcnQgaXNGaWxlKHBhdGgpLCBcIk5vIHN1Y2ggZmlsZTogI3tPTChwYXRoKX0gKGNpdmV0MnRzRmlsZSlcIlxuXHRhc3NlcnQgKGZpbGVFeHQocGF0aCkgPT0gJy5jaXZldCcpLCBcIk5vdCBhIGNpdmV0IGZpbGU6ICN7T0wocGF0aCl9XCJcblxuXHR0eXBlIG9wdCA9IHtcblx0XHRpbmxpbmVNYXA6IGJvb2xlYW5cblx0XHR9XG5cdHtpbmxpbmVNYXB9IDo9IGdldE9wdGlvbnM8b3B0PiBoT3B0aW9ucywge1xuXHRcdGlubGluZU1hcDogdHJ1ZVxuXHRcdH1cblx0aWYgaW5saW5lTWFwXG5cdFx0ZXhlY0NtZFN5bmMgJ2NpdmV0JywgW1xuXHRcdFx0Jy0taW5saW5lLW1hcCcsXG5cdFx0XHQnLW8nLFxuXHRcdFx0dHNQYXRoLFxuXHRcdFx0Jy1jJyxcblx0XHRcdHBhdGhcblx0XHRcdF1cblx0ZWxzZVxuXHRcdGV4ZWNDbWRTeW5jICdjaXZldCcsIFtcblx0XHRcdCctbycsXG5cdFx0XHR0c1BhdGgsXG5cdFx0XHQnLWMnLFxuXHRcdFx0cGF0aFxuXHRcdFx0XVxuXHRhc3NlcnQgaXNGaWxlKHRzUGF0aCksIFwiRmlsZSBub3QgY3JlYXRlZDogI3tPTCh0c1BhdGgpfVwiXG5cdHJldHVybiB0c1BhdGhcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGNpdmV0MnRzIDo9IChjaXZldENvZGU6IHN0cmluZyk6IHN0cmluZyA9PlxuXG5cdHRlbXBGaWxlUGF0aCA6PSBiYXJmVGVtcEZpbGUgY2l2ZXRDb2RlXG5cdHRzRmlsZVBhdGggOj0gd2l0aEV4dCB0ZW1wRmlsZVBhdGgsICcudHMnXG5cdGNpdmV0MnRzRmlsZSB0ZW1wRmlsZVBhdGgsIHRzRmlsZVBhdGgsIG8nIWlubGluZU1hcCdcblx0cmV0dXJuIHNsdXJwIHRzRmlsZVBhdGhcblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGNpdmV0MmFzdCA6PSAoY2l2ZXRDb2RlOiBzdHJpbmcpOiBTb3VyY2VGaWxlID0+XG5cblx0cmV0dXJuIHRzMmFzdChjaXZldDJ0cyhjaXZldENvZGUpKVxuIl19