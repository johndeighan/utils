"use strict";
// tokens.lib.civet

import {undef, isEmpty, nonEmpty} from './datatypes.lib.ts'
import {allLinesInBlock, escapeStr} from './llutils.lib.ts'
import {DBG} from './logger.lib.ts'
import {indentLevel, splitLine} from './indent.lib.ts'
import {TextTable} from './text-table.lib.ts'

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
// --- Common token types:
//        'line', 'empty', 'indent', 'undent'

export type Token = {
	kind: string
	str: string
	}

// ---------------------------------------------------------------------------

export type tokenGenerator = (line: string) => Generator<Token, void, void>

const identTokenGen: tokenGenerator = function*(line: string) {
	yield {kind: 'line', str: line}
	return
}

export const allTokensIn = function*(
		iterable: Iterable<string>,
		gen: tokenGenerator = identTokenGen
		): Generator<Token, void, void> {

	let level = 0
	for (const str of iterable) {
		DBG(`LINE: '${escapeStr(str)}'`)
		if (isEmpty(str)) {
			yield {kind: 'empty', str}
		}
		else {
			const [indent, line] = splitLine(str)
			while (indent > level) {
				level += 1
				yield {kind: 'indent', str: ''}
			}
			while (indent < level) {
				level -= 1
				yield {kind: 'undent', str: ''}
			}
			for (const tok of gen(line)) {
				yield tok
			}
		}
	}
	while (level > 0) {
		yield {kind: 'undent', str: ''}
		level -= 1
	}
	return
}

// ---------------------------------------------------------------------------

export const allTokensInBlock = function*(
		block: string,
		gen: tokenGenerator = identTokenGen
		): Generator<Token, void, void> {

	for (const tok of allTokensIn(allLinesInBlock(block), gen)) {
		yield tok
	}
	return
}

// ---------------------------------------------------------------------------

export const tokenTable = (
		lTokens: Token[],
		title='Tokens'
		): string => {

	const table = new TextTable('l l')
	table.fullsep('=')
	table.title(title)
	table.fullsep('=')
	table.labels(['kind', 'str'])
	table.sep()
	for (const tok of lTokens) {
		table.data([tok.kind, tok.str])
	}
	table.fullsep('=')
	return table.asString()
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi90b2tlbnMubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2xpYi90b2tlbnMubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0I7QUFDM0QsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0I7QUFDM0QsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDbkMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDdEQsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUI7QUFDN0MsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUEsMEJBQXlCO0FBQ3pCLEFBQUEsNkNBQTRDO0FBQzVDLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckIsQUFBQSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07QUFDYixBQUFBLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTtBQUNaLENBQUMsQ0FBQztBQUNGLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsSUFB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QUFBLEFBQUMsR0FBRyxDQUFBO0FBQ2xCLEFBQUEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFBLEFBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUM3QixBQUFBLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ1osQUFBQSxDQUFDLEdBQUcsQ0FBQyxDQUFBLE1BQUEsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUEsQ0FBQSxDQUFBO0FBQ25CLEFBQUEsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFBLEFBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDO0NBQUEsQ0FBQTtBQUNoQyxBQUFBLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQSxBQUFDLEdBQUcsQ0FBQTtBQUNsQixBQUFBLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQztBQUFDLENBQUE7QUFDeEIiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgdG9rZW5zLmxpYi5jaXZldFxuXG5pbXBvcnQge3VuZGVmLCBpc0VtcHR5LCBub25FbXB0eX0gZnJvbSAnLi9kYXRhdHlwZXMubGliLnRzJ1xuaW1wb3J0IHthbGxMaW5lc0luQmxvY2ssIGVzY2FwZVN0cn0gZnJvbSAnLi9sbHV0aWxzLmxpYi50cydcbmltcG9ydCB7REJHfSBmcm9tICcuL2xvZ2dlci5saWIudHMnXG5pbXBvcnQge2luZGVudExldmVsLCBzcGxpdExpbmV9IGZyb20gJy4vaW5kZW50LmxpYi50cydcbmltcG9ydCB7VGV4dFRhYmxlfSBmcm9tICcuL3RleHQtdGFibGUubGliLnRzJ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgLS0tIENvbW1vbiB0b2tlbiB0eXBlczpcbiMgICAgICAgICdsaW5lJywgJ2VtcHR5JywgJ2luZGVudCcsICd1bmRlbnQnXG5cbmV4cG9ydCB0eXBlIFRva2VuID0ge1xuXHRraW5kOiBzdHJpbmdcblx0c3RyOiBzdHJpbmdcblx0fVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgdHlwZSB0b2tlbkdlbmVyYXRvciA9IChsaW5lOiBzdHJpbmcpID0+IEdlbmVyYXRvcjxUb2tlbiwgdm9pZCwgdm9pZD5cblxuaWRlbnRUb2tlbkdlbjogdG9rZW5HZW5lcmF0b3IgOj0gKGxpbmU6IHN0cmluZykgLT5cblx0eWllbGQge2tpbmQ6ICdsaW5lJywgc3RyOiBsaW5lfVxuXHRyZXR1cm5cblxuZXhwb3J0IGFsbFRva2Vuc0luIDo9IChcblx0XHRpdGVyYWJsZTogSXRlcmFibGU8c3RyaW5nPixcblx0XHRnZW46IHRva2VuR2VuZXJhdG9yID0gaWRlbnRUb2tlbkdlblxuXHRcdCk6IEdlbmVyYXRvcjxUb2tlbiwgdm9pZCwgdm9pZD4gLT5cblxuXHRsZXQgbGV2ZWwgPSAwXG5cdGZvciBzdHIgb2YgaXRlcmFibGVcblx0XHREQkcgXCJMSU5FOiAnI3tlc2NhcGVTdHIoc3RyKX0nXCJcblx0XHRpZiBpc0VtcHR5KHN0cilcblx0XHRcdHlpZWxkIHtraW5kOiAnZW1wdHknLCBzdHJ9XG5cdFx0ZWxzZVxuXHRcdFx0W2luZGVudCwgbGluZV0gOj0gc3BsaXRMaW5lKHN0cilcblx0XHRcdHdoaWxlIChpbmRlbnQgPiBsZXZlbClcblx0XHRcdFx0bGV2ZWwgKz0gMVxuXHRcdFx0XHR5aWVsZCB7a2luZDogJ2luZGVudCcsIHN0cjogJyd9XG5cdFx0XHR3aGlsZSAoaW5kZW50IDwgbGV2ZWwpXG5cdFx0XHRcdGxldmVsIC09IDFcblx0XHRcdFx0eWllbGQge2tpbmQ6ICd1bmRlbnQnLCBzdHI6ICcnfVxuXHRcdFx0Zm9yIHRvayBvZiBnZW4obGluZSlcblx0XHRcdFx0eWllbGQgdG9rXG5cdHdoaWxlIChsZXZlbCA+IDApXG5cdFx0eWllbGQge2tpbmQ6ICd1bmRlbnQnLCBzdHI6ICcnfVxuXHRcdGxldmVsIC09IDFcblx0cmV0dXJuXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBhbGxUb2tlbnNJbkJsb2NrIDo9IChcblx0XHRibG9jazogc3RyaW5nXG5cdFx0Z2VuOiB0b2tlbkdlbmVyYXRvciA9IGlkZW50VG9rZW5HZW5cblx0XHQpOiBHZW5lcmF0b3I8VG9rZW4sIHZvaWQsIHZvaWQ+IC0+XG5cblx0Zm9yIHRvayBvZiBhbGxUb2tlbnNJbihhbGxMaW5lc0luQmxvY2soYmxvY2spLCBnZW4pXG5cdFx0eWllbGQgdG9rXG5cdHJldHVyblxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgdG9rZW5UYWJsZSA6PSAoXG5cdFx0bFRva2VuczogVG9rZW5bXVxuXHRcdHRpdGxlPSdUb2tlbnMnXG5cdFx0KTogc3RyaW5nID0+XG5cblx0dGFibGUgOj0gbmV3IFRleHRUYWJsZSAnbCBsJ1xuXHR0YWJsZS5mdWxsc2VwICc9J1xuXHR0YWJsZS50aXRsZSB0aXRsZVxuXHR0YWJsZS5mdWxsc2VwICc9J1xuXHR0YWJsZS5sYWJlbHMgWydraW5kJywgJ3N0ciddXG5cdHRhYmxlLnNlcCgpXG5cdGZvciB0b2sgb2YgbFRva2Vuc1xuXHRcdHRhYmxlLmRhdGEgW3Rvay5raW5kLCB0b2suc3RyXVxuXHR0YWJsZS5mdWxsc2VwICc9J1xuXHRyZXR1cm4gdGFibGUuYXNTdHJpbmcoKVxuIl19