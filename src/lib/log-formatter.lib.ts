"use strict";
// log-formatter.lib.civet

import {LogRecord} from '@std/log'
import {LogLevels} from "@std/log/levels"

import {
	spaces, sinceLoadStr, interpolate,
	} from './llutils.lib.ts'
import {getLogLevel} from './log-levels.lib.ts'

export let logIndent: number = 0
const prefix = () => spaces(3).repeat(logIndent)

// --- Everything returned by a formatter is also
//     appended to this string

const lConsoleLog: string[] = []

// ---------------------------------------------------------------------------

export const clearConsoleLog = () => {

	lConsoleLog.length = 0
	return
}

// ---------------------------------------------------------------------------

export const getConsoleLog = () => {

	return lConsoleLog.join('\n')
}

// ---------------------------------------------------------------------------

const levelStr = (level: number): string => {

	switch(level) {
		case LogLevels.DEBUG: { return 'D'
		}
		case LogLevels.INFO: { return 'I'
		}
		case LogLevels.WARN: { return 'W'
		}
		case LogLevels.ERROR: { return 'E'
		}
		default: { return 'UNKNOWN' }
	}
}

// ---------------------------------------------------------------------------

const msgStr = (msg: string): string => {

	if (msg.startsWith('=====') || msg.startsWith('-----')) {
		return msg
	}
	else {
		return prefix() + msg
	}
}

// ---------------------------------------------------------------------------
// --- str may contain:
//        $ts  - num milliseconds since start
//        $tt  - num milliseconds since last formatting
//        $ll  - log level as a single character
//        $msg - the message
// --- returns a function (rec: LogRecord) => string

export const getFormatter = (str: string, dest: string) => {

	return (rec: LogRecord): string => {
		const {datetime, level, msg} = rec
		const result = interpolate(str, {
			'$ts':  sinceLoadStr(datetime),
			'$tt':  sinceLoadStr(datetime),
			'$ll':  levelStr(level),
			'$msg': msgStr(msg)
			})
		if (dest === 'console') {
			lConsoleLog.push(result)
		}
		return result
	}
}

// ---------------------------------------------------------------------------

export const indentLog = (): void => {

	logIndent += 1
	return
}

// ---------------------------------------------------------------------------

export const undentLog = (): void => {

	if (logIndent > 0) {
		logIndent -= 1
	}
	return
}

// ---------------------------------------------------------------------------

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9sb2ctZm9ybWF0dGVyLmxpYi5jaXZldC50c3giLCJzb3VyY2VzIjpbInNyYy9saWIvbG9nLWZvcm1hdHRlci5saWIuY2l2ZXQiXSwibWFwcGluZ3MiOiI7QUFBQSwwQkFBeUI7QUFDekIsQUFBQTtBQUNBLEFBQUEsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVU7QUFDbEMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDekMsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ25DLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0I7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUI7QUFDL0MsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoQyxBQUFBLEFBQU0sTUFBTixNQUFNLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztBQUMzQyxBQUFBO0FBQ0EsQUFBQSxpREFBZ0Q7QUFDaEQsQUFBQSw4QkFBNkI7QUFDN0IsQUFBQTtBQUNBLEFBQUEsQUFBcUIsTUFBckIsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzNCLEFBQUE7QUFDQSxBQUFBLDhFQUE2RTtBQUM3RSxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBZ0IsTUFBZixlQUFlLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFB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LEM7Q0FBQyxDQUFBO0FBQ2hCLEFBQUEsQ0FBQyxNO0FBQU0sQ0FBQTtBQUNQO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgbG9nLWZvcm1hdHRlci5saWIuY2l2ZXRcblxuaW1wb3J0IHtMb2dSZWNvcmR9IGZyb20gJ0BzdGQvbG9nJ1xuaW1wb3J0IHtMb2dMZXZlbHN9IGZyb20gXCJAc3RkL2xvZy9sZXZlbHNcIlxuXG5pbXBvcnQge1xuXHRzcGFjZXMsIHNpbmNlTG9hZFN0ciwgaW50ZXJwb2xhdGUsXG5cdH0gZnJvbSAnLi9sbHV0aWxzLmxpYi50cydcbmltcG9ydCB7Z2V0TG9nTGV2ZWx9IGZyb20gJy4vbG9nLWxldmVscy5saWIudHMnXG5cbmV4cG9ydCBsZXQgbG9nSW5kZW50OiBudW1iZXIgPSAwXG5wcmVmaXggOj0gKCkgPT4gc3BhY2VzKDMpLnJlcGVhdChsb2dJbmRlbnQpXG5cbiMgLS0tIEV2ZXJ5dGhpbmcgcmV0dXJuZWQgYnkgYSBmb3JtYXR0ZXIgaXMgYWxzb1xuIyAgICAgYXBwZW5kZWQgdG8gdGhpcyBzdHJpbmdcblxubENvbnNvbGVMb2c6IHN0cmluZ1tdIDo9IFtdXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBjbGVhckNvbnNvbGVMb2cgOj0gKCkgPT5cblxuXHRsQ29uc29sZUxvZy5sZW5ndGggPSAwXG5cdHJldHVyblxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgZ2V0Q29uc29sZUxvZyA6PSAoKSA9PlxuXG5cdHJldHVybiBsQ29uc29sZUxvZy5qb2luKCdcXG4nKVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5sZXZlbFN0ciA6PSAobGV2ZWw6IG51bWJlcik6IHN0cmluZyA9PlxuXG5cdHN3aXRjaCBsZXZlbFxuXHRcdHdoZW4gTG9nTGV2ZWxzLkRFQlVHICAgdGhlbiByZXR1cm4gJ0QnXG5cdFx0d2hlbiBMb2dMZXZlbHMuSU5GTyAgICB0aGVuIHJldHVybiAnSSdcblx0XHR3aGVuIExvZ0xldmVscy5XQVJOICAgIHRoZW4gcmV0dXJuICdXJ1xuXHRcdHdoZW4gTG9nTGV2ZWxzLkVSUk9SICAgdGhlbiByZXR1cm4gJ0UnXG5cdFx0ZWxzZSByZXR1cm4gJ1VOS05PV04nXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbm1zZ1N0ciA6PSAobXNnOiBzdHJpbmcpOiBzdHJpbmcgPT5cblxuXHRpZiBtc2cuc3RhcnRzV2l0aCgnPT09PT0nKSB8fCBtc2cuc3RhcnRzV2l0aCgnLS0tLS0nKVxuXHRcdHJldHVybiBtc2dcblx0ZWxzZVxuXHRcdHJldHVybiBwcmVmaXgoKSArIG1zZ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIyAtLS0gc3RyIG1heSBjb250YWluOlxuIyAgICAgICAgJHRzICAtIG51bSBtaWxsaXNlY29uZHMgc2luY2Ugc3RhcnRcbiMgICAgICAgICR0dCAgLSBudW0gbWlsbGlzZWNvbmRzIHNpbmNlIGxhc3QgZm9ybWF0dGluZ1xuIyAgICAgICAgJGxsICAtIGxvZyBsZXZlbCBhcyBhIHNpbmdsZSBjaGFyYWN0ZXJcbiMgICAgICAgICRtc2cgLSB0aGUgbWVzc2FnZVxuIyAtLS0gcmV0dXJucyBhIGZ1bmN0aW9uIChyZWM6IExvZ1JlY29yZCkgPT4gc3RyaW5nXG5cbmV4cG9ydCBnZXRGb3JtYXR0ZXIgOj0gKHN0cjogc3RyaW5nLCBkZXN0OiBzdHJpbmcpID0+XG5cblx0cmV0dXJuIChyZWM6IExvZ1JlY29yZCk6IHN0cmluZyA9PlxuXHRcdHtkYXRldGltZSwgbGV2ZWwsIG1zZ30gOj0gcmVjXG5cdFx0cmVzdWx0IDo9IGludGVycG9sYXRlKHN0ciwge1xuXHRcdFx0JyR0cyc6ICBzaW5jZUxvYWRTdHIoZGF0ZXRpbWUpXG5cdFx0XHQnJHR0JzogIHNpbmNlTG9hZFN0cihkYXRldGltZSlcblx0XHRcdCckbGwnOiAgbGV2ZWxTdHIobGV2ZWwpXG5cdFx0XHQnJG1zZyc6IG1zZ1N0cihtc2cpXG5cdFx0XHR9KVxuXHRcdGlmIChkZXN0ID09ICdjb25zb2xlJylcblx0XHRcdGxDb25zb2xlTG9nLnB1c2ggcmVzdWx0XG5cdFx0cmV0dXJuIHJlc3VsdFxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgaW5kZW50TG9nIDo9ICgpOiB2b2lkID0+XG5cblx0bG9nSW5kZW50ICs9IDFcblx0cmV0dXJuXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCB1bmRlbnRMb2cgOj0gKCk6IHZvaWQgPT5cblxuXHRpZiAobG9nSW5kZW50ID4gMClcblx0XHRsb2dJbmRlbnQgLT0gMVxuXHRyZXR1cm5cblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiJdfQ==