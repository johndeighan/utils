"use strict";
// log-formatter.lib.civet

import {LogRecord} from '@std/log'
import {LogLevels} from "@std/log/levels"

import {
	spaces, sinceLoadStr, interpolate,
	} from './llutils.lib.ts'
import {getLogLevel} from './log-levels.lib.ts'

let indent: number = 0
const prefix = () => spaces(3).repeat(indent)

// --- Everything returned by a formatter is also
//     appended to this string

const lConsoleLog: string[] = []

// ---------------------------------------------------------------------------

export const clearConsoleLog = () => {

	lConsoleLog.length = 0
	return
}

// ---------------------------------------------------------------------------

export const getConsoleLog = () => {

	return lConsoleLog.join('\n')
}

// ---------------------------------------------------------------------------

const levelStr = (level: number): string => {

	switch(level) {
		case LogLevels.DEBUG: { return 'D'
		}
		case LogLevels.INFO: { return 'I'
		}
		case LogLevels.WARN: { return 'W'
		}
		case LogLevels.ERROR: { return 'E'
		}
		default: { return 'UNKNOWN' }
	}
}

// ---------------------------------------------------------------------------

const msgStr = (msg: string): string => {

	if (msg.startsWith('=====') || msg.startsWith('-----')) {
		return msg
	}
	else {
		return prefix() + msg
	}
}

// ---------------------------------------------------------------------------
// --- str may contain:
//        $ts  - num milliseconds since start
//        $tt  - num milliseconds since last formatting
//        $ll  - log level as a single character
//        $msg - the message
// --- returns a function (rec: LogRecord) => string

export const getFormatter = (str: string, dest: string) => {

	return (rec: LogRecord): string => {
		const {datetime, level, msg} = rec
		const result = interpolate(str, {
			'$ts':  sinceLoadStr(datetime),
			'$tt':  sinceLoadStr(datetime),
			'$ll':  levelStr(level),
			'$msg': msgStr(msg)
			})
		if (dest === 'console') {
			lConsoleLog.push(result)
		}
		return result
	}
}

// ---------------------------------------------------------------------------

export const indentLog = (): void => {

	indent += 1
	return
}

// ---------------------------------------------------------------------------

export const undentLog = (): void => {

	if (indent > 0) {
		indent -= 1
	}
	return
}

// ---------------------------------------------------------------------------

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9sb2ctZm9ybWF0dGVyLmxpYi5jaXZldC50c3giLCJzb3VyY2VzIjpbInNyYy9saWIvbG9nLWZvcm1hdHRlci5saWIuY2l2ZXQiXSwibWFwcGluZ3MiOiI7QUFBQSwwQkFBeUI7QUFDekIsQUFBQTtBQUNBLEFBQUEsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVU7QUFDbEMsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDekMsQUFBQTtBQUNBLEFBQUEsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ25DLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0I7QUFDMUIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUI7QUFDL0MsQUFBQTtBQUNBLEFBQUEsQUFBQSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RCLEFBQUEsQUFBTSxNQUFOLE1BQU0sQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ3hDLEFBQUE7QUFDQSxBQUFBLGlEQUFnRDtBQUNoRCxBQUFBLDhCQUE2QjtBQUM3QixBQUFBO0FBQ0EsQUFBQSxBQUFxQixNQUFyQixXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQyxDQUFDLENBQUM7QUFDM0IsQUFBQTtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFLEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFnQixNQUFmLGVBQWUsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDL0IsQUFB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QUE7QUFDYixBQUFBLENBQUMsTTtBQUFNLENBQUE7QUFDUDtBQUNBLEFBQUEsOEVBQTZFO0FBQzdFIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIGxvZy1mb3JtYXR0ZXIubGliLmNpdmV0XG5cbmltcG9ydCB7TG9nUmVjb3JkfSBmcm9tICdAc3RkL2xvZydcbmltcG9ydCB7TG9nTGV2ZWxzfSBmcm9tIFwiQHN0ZC9sb2cvbGV2ZWxzXCJcblxuaW1wb3J0IHtcblx0c3BhY2VzLCBzaW5jZUxvYWRTdHIsIGludGVycG9sYXRlLFxuXHR9IGZyb20gJy4vbGx1dGlscy5saWIudHMnXG5pbXBvcnQge2dldExvZ0xldmVsfSBmcm9tICcuL2xvZy1sZXZlbHMubGliLnRzJ1xuXG5sZXQgaW5kZW50OiBudW1iZXIgPSAwXG5wcmVmaXggOj0gKCkgPT4gc3BhY2VzKDMpLnJlcGVhdChpbmRlbnQpXG5cbiMgLS0tIEV2ZXJ5dGhpbmcgcmV0dXJuZWQgYnkgYSBmb3JtYXR0ZXIgaXMgYWxzb1xuIyAgICAgYXBwZW5kZWQgdG8gdGhpcyBzdHJpbmdcblxubENvbnNvbGVMb2c6IHN0cmluZ1tdIDo9IFtdXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBjbGVhckNvbnNvbGVMb2cgOj0gKCkgPT5cblxuXHRsQ29uc29sZUxvZy5sZW5ndGggPSAwXG5cdHJldHVyblxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgZ2V0Q29uc29sZUxvZyA6PSAoKSA9PlxuXG5cdHJldHVybiBsQ29uc29sZUxvZy5qb2luKCdcXG4nKVxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5sZXZlbFN0ciA6PSAobGV2ZWw6IG51bWJlcik6IHN0cmluZyA9PlxuXG5cdHN3aXRjaCBsZXZlbFxuXHRcdHdoZW4gTG9nTGV2ZWxzLkRFQlVHICAgdGhlbiByZXR1cm4gJ0QnXG5cdFx0d2hlbiBMb2dMZXZlbHMuSU5GTyAgICB0aGVuIHJldHVybiAnSSdcblx0XHR3aGVuIExvZ0xldmVscy5XQVJOICAgIHRoZW4gcmV0dXJuICdXJ1xuXHRcdHdoZW4gTG9nTGV2ZWxzLkVSUk9SICAgdGhlbiByZXR1cm4gJ0UnXG5cdFx0ZWxzZSByZXR1cm4gJ1VOS05PV04nXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbm1zZ1N0ciA6PSAobXNnOiBzdHJpbmcpOiBzdHJpbmcgPT5cblxuXHRpZiBtc2cuc3RhcnRzV2l0aCgnPT09PT0nKSB8fCBtc2cuc3RhcnRzV2l0aCgnLS0tLS0nKVxuXHRcdHJldHVybiBtc2dcblx0ZWxzZVxuXHRcdHJldHVybiBwcmVmaXgoKSArIG1zZ1xuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIyAtLS0gc3RyIG1heSBjb250YWluOlxuIyAgICAgICAgJHRzICAtIG51bSBtaWxsaXNlY29uZHMgc2luY2Ugc3RhcnRcbiMgICAgICAgICR0dCAgLSBudW0gbWlsbGlzZWNvbmRzIHNpbmNlIGxhc3QgZm9ybWF0dGluZ1xuIyAgICAgICAgJGxsICAtIGxvZyBsZXZlbCBhcyBhIHNpbmdsZSBjaGFyYWN0ZXJcbiMgICAgICAgICRtc2cgLSB0aGUgbWVzc2FnZVxuIyAtLS0gcmV0dXJucyBhIGZ1bmN0aW9uIChyZWM6IExvZ1JlY29yZCkgPT4gc3RyaW5nXG5cbmV4cG9ydCBnZXRGb3JtYXR0ZXIgOj0gKHN0cjogc3RyaW5nLCBkZXN0OiBzdHJpbmcpID0+XG5cblx0cmV0dXJuIChyZWM6IExvZ1JlY29yZCk6IHN0cmluZyA9PlxuXHRcdHtkYXRldGltZSwgbGV2ZWwsIG1zZ30gOj0gcmVjXG5cdFx0cmVzdWx0IDo9IGludGVycG9sYXRlKHN0ciwge1xuXHRcdFx0JyR0cyc6ICBzaW5jZUxvYWRTdHIoZGF0ZXRpbWUpXG5cdFx0XHQnJHR0JzogIHNpbmNlTG9hZFN0cihkYXRldGltZSlcblx0XHRcdCckbGwnOiAgbGV2ZWxTdHIobGV2ZWwpXG5cdFx0XHQnJG1zZyc6IG1zZ1N0cihtc2cpXG5cdFx0XHR9KVxuXHRcdGlmIChkZXN0ID09ICdjb25zb2xlJylcblx0XHRcdGxDb25zb2xlTG9nLnB1c2ggcmVzdWx0XG5cdFx0cmV0dXJuIHJlc3VsdFxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5leHBvcnQgaW5kZW50TG9nIDo9ICgpOiB2b2lkID0+XG5cblx0aW5kZW50ICs9IDFcblx0cmV0dXJuXG5cbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCB1bmRlbnRMb2cgOj0gKCk6IHZvaWQgPT5cblxuXHRpZiAoaW5kZW50ID4gMClcblx0XHRpbmRlbnQgLT0gMVxuXHRyZXR1cm5cblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiJdfQ==