"use strict";
// indent.lib.civet

import {
	undef, defined, notdefined, assert, croak, array,
	isString, isArray, isArrayOfStrings, isHash,
	integer, isInteger,
	} from 'datatypes'
import {
	rtrim, countChars, escapeStr,
	blockToArray, arrayToBlock, toArray, toBlock,
	} from 'llutils'

/**
 * @module indent - indent level utilities
 */

export let oneIndent: (string | undefined) = undef

// ---------------------------------------------------------------------------

/**
 * Reset the text for one indent level
 */

export const resetOneIndent = (str: (string | undefined)=undef): void => {

	oneIndent = str
	return
}

// ---------------------------------------------------------------------------

/**
 * indentLevel - determine indent level of a string
 *               it's OK if the string is ONLY indentation
 */

export const indentLevel = (line: string): number => {

	// --- This will always match, and it's greedy
	//     (but TypeScript doesn't know that)
	const [prefix] = line.match(/^\s*/) || ['']

	if (prefix.length === 0) {
		return 0
	}

	// --- Check if we're using TABs or spaces
	const numTABs = countChars(prefix, "\t")
	const numSpaces = countChars(prefix, " ")
	assert((numTABs===0) || (numSpaces===0),
		`Invalid mix of TABs and spaces in ${escapeStr(line)}`)

	// --- oneIndent must be one of:
	//        undef
	//        a single TAB character
	//        some number of space characters

	// --- Set variables oneIndent & level
	switch(oneIndent) {
		case undef: {
			if (numTABs > 0) {
				oneIndent = "\t"
				return numTABs
			}
			else {
				oneIndent = ' '.repeat(numSpaces)
				return 1
			}
		}
		case "\t": {
			assert((numSpaces===0), "Expecting TABs, found spaces")
			return numTABs
		}
		default: {
			// --- using some number of spaces
			assert((numTABs === 0), "Expecting spaces, found TABs")
			assert((numSpaces % oneIndent.length === 0), `Invalid num spaces: ${numSpaces},
oneIndent = ${escapeStr(oneIndent)}`)
			return numSpaces / oneIndent.length
		}
	}
}

// ---------------------------------------------------------------------------

/**
 * splitLine - separate a line into [level, line]
 */

export type lineDesc = [
	level: number,
	text: string
	]

export const splitLine = (line: string): lineDesc => {

	const [_, prefix, str] = line.match(/^(\s*)(.*)$/) || ['', '', '']
	return [indentLevel(prefix), str.trim()]
}

// ---------------------------------------------------------------------------

/**
 * indented - add indentation to each string in a block or array
 *          - returns the same type as input, i.e. array or string
 */

export function indented(
		input: string,
		level?: number
		): string
export function indented(
		input: string[],
		level?: number
		): string[]
export function indented(
		input: string | string[],
		level: number=1
		): string | string[] {
	if (notdefined(oneIndent)) {
		oneIndent = '\t'
	}
	const lLines: string[] = isArray(input) ? input : input.split('\n')
	const results=[];for (const line of lLines) {
		results.push(oneIndent.repeat(level) + line)
	};const lNewLines: string[] =results
	return isArray(input) ? lNewLines : lNewLines.join('\n')
	}

// ---------------------------------------------------------------------------

/**
 * undented - string with 1st line indentation removed for each line
 *          - returns same type as input, i.e. either string or array
 */

export const undented = (input: string | string[]): string | string[] => {

	// --- input must be either a string or array of strings
	const lLines = toArray(input)

	// --- NOTE: leave empty lines empty

	let toRemove: (string | undefined)  = undef
	let nToRemove: number = 0
	const lNewLines = lLines.map((line) => {
		line = rtrim(line)
		if (line === '') {
			return ''
		}
		else if (notdefined(toRemove)) {
			const [_, prefix, rest] = line.match(/^(\s*)(.*)$/) || ['','','']
			if (prefix.length === 0) {
				return line
			}
			else {
				toRemove = prefix
				nToRemove = prefix.length
				return rest
			}
		}
		else {
			assert((line.indexOf(toRemove)===0),
				`can't remove ${escapeStr(toRemove)} from ${escapeStr(line)}`)
			return line.substr(nToRemove)
		}
	}
		)

	return isString(input) ? arrayToBlock(lNewLines) : lNewLines
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2xpYi9pbmRlbnQubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2xpYi9pbmRlbnQubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEQsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUM3QyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNwQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVztBQUNuQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUM5QixDQUFDLFlBQVksQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBO0FBQ0EsQUFBQTtBQUNBO0FBQ0EsR0FBRztBQUNILEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEMsQyxDQUFDLEFBQUMsTSxZLENBQU8sQ0FBQyxDQUFDLENBQUMsS0FBSztBQUNyQyxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUE7QUFDQTtBQUNBLEdBQUc7QUFDSCxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBZSxNQUFkLGNBQWMsQ0FBQyxDQUFFLENBQUMsQ0FBQyxHQUFHLEMsQyxDQUFDLEFBQUMsTSxZLENBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUEs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QSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQztFQUFDLEM7Q0FBQSxDQUFBO0FBQ2hDLEVBQUUsQ0FBQztBQUNILEFBQUE7QUFDQSxBQUFBLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTO0FBQVMsQ0FBQTtBQUM3RCIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBpbmRlbnQubGliLmNpdmV0XHJcblxyXG5pbXBvcnQge1xyXG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLCBhc3NlcnQsIGNyb2FrLCBhcnJheSxcclxuXHRpc1N0cmluZywgaXNBcnJheSwgaXNBcnJheU9mU3RyaW5ncywgaXNIYXNoLFxyXG5cdGludGVnZXIsIGlzSW50ZWdlcixcclxuXHR9IGZyb20gJ2RhdGF0eXBlcydcclxuaW1wb3J0IHtcclxuXHRydHJpbSwgY291bnRDaGFycywgZXNjYXBlU3RyLFxyXG5cdGJsb2NrVG9BcnJheSwgYXJyYXlUb0Jsb2NrLCB0b0FycmF5LCB0b0Jsb2NrLFxyXG5cdH0gZnJvbSAnbGx1dGlscydcclxuXHJcbi8qKlxyXG4gKiBAbW9kdWxlIGluZGVudCAtIGluZGVudCBsZXZlbCB1dGlsaXRpZXNcclxuICovXHJcblxyXG5leHBvcnQgbGV0IG9uZUluZGVudDogc3RyaW5nPyA9IHVuZGVmXHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuLyoqXHJcbiAqIFJlc2V0IHRoZSB0ZXh0IGZvciBvbmUgaW5kZW50IGxldmVsXHJcbiAqL1xyXG5cclxuZXhwb3J0IHJlc2V0T25lSW5kZW50IDo9IChzdHI6IHN0cmluZz89dW5kZWYpOiB2b2lkID0+XHJcblxyXG5cdG9uZUluZGVudCA9IHN0clxyXG5cdHJldHVyblxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbi8qKlxyXG4gKiBpbmRlbnRMZXZlbCAtIGRldGVybWluZSBpbmRlbnQgbGV2ZWwgb2YgYSBzdHJpbmdcclxuICogICAgICAgICAgICAgICBpdCdzIE9LIGlmIHRoZSBzdHJpbmcgaXMgT05MWSBpbmRlbnRhdGlvblxyXG4gKi9cclxuXHJcbmV4cG9ydCBpbmRlbnRMZXZlbCA6PSAobGluZTogc3RyaW5nKTogbnVtYmVyID0+XHJcblxyXG5cdCMgLS0tIFRoaXMgd2lsbCBhbHdheXMgbWF0Y2gsIGFuZCBpdCdzIGdyZWVkeVxyXG5cdCMgICAgIChidXQgVHlwZVNjcmlwdCBkb2Vzbid0IGtub3cgdGhhdClcclxuXHRbcHJlZml4XSA6PSBsaW5lLm1hdGNoKC9eXFxzKi8pIHx8IFsnJ11cclxuXHJcblx0aWYgKHByZWZpeC5sZW5ndGggPT0gMClcclxuXHRcdHJldHVybiAwXHJcblxyXG5cdCMgLS0tIENoZWNrIGlmIHdlJ3JlIHVzaW5nIFRBQnMgb3Igc3BhY2VzXHJcblx0bnVtVEFCcyA6PSBjb3VudENoYXJzKHByZWZpeCwgXCJcXHRcIilcclxuXHRudW1TcGFjZXMgOj0gY291bnRDaGFycyhwcmVmaXgsIFwiIFwiKVxyXG5cdGFzc2VydCAobnVtVEFCcz09MCkgfHwgKG51bVNwYWNlcz09MCksXHJcblx0XHRcIkludmFsaWQgbWl4IG9mIFRBQnMgYW5kIHNwYWNlcyBpbiAje2VzY2FwZVN0cihsaW5lKX1cIlxyXG5cclxuXHQjIC0tLSBvbmVJbmRlbnQgbXVzdCBiZSBvbmUgb2Y6XHJcblx0IyAgICAgICAgdW5kZWZcclxuXHQjICAgICAgICBhIHNpbmdsZSBUQUIgY2hhcmFjdGVyXHJcblx0IyAgICAgICAgc29tZSBudW1iZXIgb2Ygc3BhY2UgY2hhcmFjdGVyc1xyXG5cclxuXHQjIC0tLSBTZXQgdmFyaWFibGVzIG9uZUluZGVudCAmIGxldmVsXHJcblx0c3dpdGNoIG9uZUluZGVudFxyXG5cdFx0d2hlbiB1bmRlZlxyXG5cdFx0XHRpZiAobnVtVEFCcyA+IDApXHJcblx0XHRcdFx0b25lSW5kZW50ID0gXCJcXHRcIlxyXG5cdFx0XHRcdHJldHVybiBudW1UQUJzXHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHRvbmVJbmRlbnQgPSAnICcucmVwZWF0KG51bVNwYWNlcylcclxuXHRcdFx0XHRyZXR1cm4gMVxyXG5cdFx0d2hlbiBcIlxcdFwiXHJcblx0XHRcdGFzc2VydCAobnVtU3BhY2VzPT0wKSwgXCJFeHBlY3RpbmcgVEFCcywgZm91bmQgc3BhY2VzXCJcclxuXHRcdFx0cmV0dXJuIG51bVRBQnNcclxuXHRcdGVsc2VcclxuXHRcdFx0IyAtLS0gdXNpbmcgc29tZSBudW1iZXIgb2Ygc3BhY2VzXHJcblx0XHRcdGFzc2VydCAobnVtVEFCcyA9PSAwKSwgXCJFeHBlY3Rpbmcgc3BhY2VzLCBmb3VuZCBUQUJzXCJcclxuXHRcdFx0YXNzZXJ0IChudW1TcGFjZXMgJSBvbmVJbmRlbnQubGVuZ3RoID09IDApLCBcIlwiXCJcclxuXHRcdFx0XHRcdEludmFsaWQgbnVtIHNwYWNlczogI3tudW1TcGFjZXN9LFxyXG5cdFx0XHRcdFx0b25lSW5kZW50ID0gI3tlc2NhcGVTdHIob25lSW5kZW50KX1cclxuXHRcdFx0XHRcdFwiXCJcIlxyXG5cdFx0XHRyZXR1cm4gbnVtU3BhY2VzIC8gb25lSW5kZW50Lmxlbmd0aFxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbi8qKlxyXG4gKiBzcGxpdExpbmUgLSBzZXBhcmF0ZSBhIGxpbmUgaW50byBbbGV2ZWwsIGxpbmVdXHJcbiAqL1xyXG5cclxuZXhwb3J0IHR5cGUgbGluZURlc2MgPSBbXHJcblx0bGV2ZWw6IG51bWJlclxyXG5cdHRleHQ6IHN0cmluZ1xyXG5cdF1cclxuXHJcbmV4cG9ydCBzcGxpdExpbmUgOj0gKGxpbmU6IHN0cmluZyk6IGxpbmVEZXNjID0+XHJcblxyXG5cdFtfLCBwcmVmaXgsIHN0cl0gOj0gbGluZS5tYXRjaCgvXihcXHMqKSguKikkLykgfHwgWycnLCAnJywgJyddXHJcblx0cmV0dXJuIFtpbmRlbnRMZXZlbChwcmVmaXgpLCBzdHIudHJpbSgpXVxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbi8qKlxyXG4gKiBpbmRlbnRlZCAtIGFkZCBpbmRlbnRhdGlvbiB0byBlYWNoIHN0cmluZyBpbiBhIGJsb2NrIG9yIGFycmF5XHJcbiAqICAgICAgICAgIC0gcmV0dXJucyB0aGUgc2FtZSB0eXBlIGFzIGlucHV0LCBpLmUuIGFycmF5IG9yIHN0cmluZ1xyXG4gKi9cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbmRlbnRlZChcclxuXHRcdGlucHV0OiBzdHJpbmcsXHJcblx0XHRsZXZlbD86IG51bWJlclxyXG5cdFx0KTogc3RyaW5nXHJcbmV4cG9ydCBmdW5jdGlvbiBpbmRlbnRlZChcclxuXHRcdGlucHV0OiBzdHJpbmdbXSxcclxuXHRcdGxldmVsPzogbnVtYmVyXHJcblx0XHQpOiBzdHJpbmdbXVxyXG5leHBvcnQgZnVuY3Rpb24gaW5kZW50ZWQoXHJcblx0XHRpbnB1dDogc3RyaW5nIHwgc3RyaW5nW10sXHJcblx0XHRsZXZlbDogbnVtYmVyPTFcclxuXHRcdCk6IHN0cmluZyB8IHN0cmluZ1tdIHtcclxuXHRpZiBub3RkZWZpbmVkKG9uZUluZGVudClcclxuXHRcdG9uZUluZGVudCA9ICdcXHQnXHJcblx0bExpbmVzOiBzdHJpbmdbXSA6PSBpc0FycmF5KGlucHV0KSA/IGlucHV0IDogaW5wdXQuc3BsaXQoJ1xcbicpXHJcblx0bE5ld0xpbmVzOiBzdHJpbmdbXSA6PSBmb3IgbGluZSBvZiBsTGluZXNcclxuXHRcdG9uZUluZGVudC5yZXBlYXQobGV2ZWwpICsgbGluZVxyXG5cdHJldHVybiBpc0FycmF5KGlucHV0KSA/IGxOZXdMaW5lcyA6IGxOZXdMaW5lcy5qb2luKCdcXG4nKVxyXG5cdH1cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4vKipcclxuICogdW5kZW50ZWQgLSBzdHJpbmcgd2l0aCAxc3QgbGluZSBpbmRlbnRhdGlvbiByZW1vdmVkIGZvciBlYWNoIGxpbmVcclxuICogICAgICAgICAgLSByZXR1cm5zIHNhbWUgdHlwZSBhcyBpbnB1dCwgaS5lLiBlaXRoZXIgc3RyaW5nIG9yIGFycmF5XHJcbiAqL1xyXG5cclxuZXhwb3J0IHVuZGVudGVkIDo9IChpbnB1dDogc3RyaW5nIHwgc3RyaW5nW10pOiBzdHJpbmcgfCBzdHJpbmdbXSA9PlxyXG5cclxuXHQjIC0tLSBpbnB1dCBtdXN0IGJlIGVpdGhlciBhIHN0cmluZyBvciBhcnJheSBvZiBzdHJpbmdzXHJcblx0bExpbmVzIDo9IHRvQXJyYXkoaW5wdXQpXHJcblxyXG5cdCMgLS0tIE5PVEU6IGxlYXZlIGVtcHR5IGxpbmVzIGVtcHR5XHJcblxyXG5cdGxldCB0b1JlbW92ZTogc3RyaW5nPyAgPSB1bmRlZlxyXG5cdGxldCBuVG9SZW1vdmU6IG51bWJlciA9IDBcclxuXHRsTmV3TGluZXMgOj0gbExpbmVzLm1hcCgobGluZSkgPT5cclxuXHRcdGxpbmUgPSBydHJpbShsaW5lKVxyXG5cdFx0aWYgKGxpbmUgPT0gJycpXHJcblx0XHRcdHJldHVybiAnJ1xyXG5cdFx0ZWxzZSBpZiBub3RkZWZpbmVkKHRvUmVtb3ZlKVxyXG5cdFx0XHRbXywgcHJlZml4LCByZXN0XSA6PSBsaW5lLm1hdGNoKC9eKFxccyopKC4qKSQvKSB8fCBbJycsJycsJyddXHJcblx0XHRcdGlmIChwcmVmaXgubGVuZ3RoID09IDApXHJcblx0XHRcdFx0cmV0dXJuIGxpbmVcclxuXHRcdFx0ZWxzZVxyXG5cdFx0XHRcdHRvUmVtb3ZlID0gcHJlZml4XHJcblx0XHRcdFx0blRvUmVtb3ZlID0gcHJlZml4Lmxlbmd0aFxyXG5cdFx0XHRcdHJldHVybiByZXN0XHJcblx0XHRlbHNlXHJcblx0XHRcdGFzc2VydCAobGluZS5pbmRleE9mKHRvUmVtb3ZlKT09MCksXHJcblx0XHRcdFx0XCJjYW4ndCByZW1vdmUgI3tlc2NhcGVTdHIodG9SZW1vdmUpfSBmcm9tICN7ZXNjYXBlU3RyKGxpbmUpfVwiXHJcblx0XHRcdHJldHVybiBsaW5lLnN1YnN0cihuVG9SZW1vdmUpXHJcblx0XHQpXHJcblxyXG5cdHJldHVybiBpc1N0cmluZyhpbnB1dCkgPyBhcnJheVRvQmxvY2sobE5ld0xpbmVzKSA6IGxOZXdMaW5lc1xyXG4iXX0=