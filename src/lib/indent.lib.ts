"use strict";
// indent.lib.civet

import {
	undef, defined, notdefined, assert, croak, array,
	isString, isArray, isArrayOfStrings, hash, isHash,
	integer, isInteger,
	} from 'datatypes'
import {
	rtrim, countChars, escapeStr, getOptions,
	blockToArray, arrayToBlock, toArray, toBlock,
	} from 'llutils'

/**
 * @module indent - indent level utilities
 */

export let oneIndent: (string | undefined) = undef

// ---------------------------------------------------------------------------

/**
 * Reset the text for one indent level
 */

export const resetOneIndent = (str: (string | undefined)=undef): void => {

	oneIndent = str
	return
}

// ---------------------------------------------------------------------------

/**
 * indentLevel - determine indent level of a string
 *               it's OK if the string is ONLY indentation
 */

export const indentLevel = (line: string): number => {

	// --- This will always match, and it's greedy
	//     (but TypeScript doesn't know that)
	const [prefix] = line.match(/^\s*/) || ['']

	if (prefix.length === 0) {
		return 0
	}

	// --- Check if we're using TABs or spaces
	const numTABs = countChars(prefix, "\t")
	const numSpaces = countChars(prefix, " ")
	assert((numTABs===0) || (numSpaces===0),
		`Invalid mix of TABs and spaces in ${escapeStr(line)}`)

	// --- oneIndent must be one of:
	//        undef
	//        a single TAB character
	//        some number of space characters

	// --- Set variables oneIndent & level
	switch(oneIndent) {
		case undef: {
			if (numTABs > 0) {
				oneIndent = "\t"
				return numTABs
			}
			else {
				oneIndent = ' '.repeat(numSpaces)
				return 1
			}
		}
		case "\t": {
			assert((numSpaces===0), "Expecting TABs, found spaces")
			return numTABs
		}
		default: {
			// --- using some number of spaces
			assert((numTABs === 0), "Expecting spaces, found TABs")
			assert((numSpaces % oneIndent.length === 0), `Invalid num spaces: ${numSpaces},
oneIndent = ${escapeStr(oneIndent)}`)
			return numSpaces / oneIndent.length
		}
	}
}

// ---------------------------------------------------------------------------

/**
 * splitLine - separate a line into [level, line]
 */

export type lineDesc = [
	level: number,
	text: string
	]

export const splitLine = (line: string): lineDesc => {

	const [_, prefix, str] = line.match(/^(\s*)(.*)$/) || ['', '', '']
	return [indentLevel(prefix), str.trim()]
}

// ---------------------------------------------------------------------------

/**
 * indented - add indentation to each string in a block or array
 *          - returns the same type as input, i.e. array or string
 */

export function indented(
		input: string,
		level?: number,
		hOptions?: hash
		): string
export function indented(
		input: string[],
		level?: number,
		hOptions?: hash
		): string[]
export function indented(
		input: string | string[],
		level: number = 1,
		hOptions: hash = {}
		): string | string[] {

	// --- Because there's a global named oneIndent,
	//     we have to put the option in a new variable, i.e. 'ind'
	type opt = {
		oneIndent: (string | undefined)
		}
	const {oneIndent: ind} = getOptions<opt>(hOptions, {
		oneIndent: undef
		})

	const useIndent: string = (
		  defined(ind) ? ind
		: defined(oneIndent) ? oneIndent
		: '\t'
		)

	const lLines: string[] = isArray(input) ? input : input.split('\n')
	const results=[];for (const line of lLines) {
		results.push(useIndent.repeat(level) + line)
	};const lNewLines: string[] =results
	return isArray(input) ? lNewLines : lNewLines.join('\n')
	}

// ---------------------------------------------------------------------------

/**
 * undented - string with 1st line indentation removed for each line
 *          - returns same type as input, i.e. either string or array
 */

export const undented = (input: string | string[]): string | string[] => {

	// --- input must be either a string or array of strings
	const lLines = toArray(input)

	// --- NOTE: leave empty lines empty

	let toRemove: (string | undefined)  = undef
	let nToRemove: number = 0
	const lNewLines: string[] = []
	for (const line of lLines) {
		const trimmed = rtrim(line)
		if (trimmed === '') {
			lNewLines.push('')
		}
		else if (notdefined(toRemove)) {
			const [_, prefix, rest] = trimmed.match(/^(\s*)(.*)$/) || ['','','']
			if (prefix.length === 0) {
				lNewLines.push(trimmed)
			}
			else {
				toRemove = prefix
				nToRemove = prefix.length
				lNewLines.push(rest)
			}
		}
		else {
			assert((line.indexOf(toRemove)===0),
				`can't remove ${escapeStr(toRemove)} from ${escapeStr(line)}`)
			lNewLines.push(trimmed.substr(nToRemove))
		}
	}

	return isString(input) ? arrayToBlock(lNewLines) : lNewLines
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxpbmRlbnQubGliLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxqb2huZFxcdXRpbHNcXHNyY1xcbGliXFxpbmRlbnQubGliLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsbUJBQWtCO0FBQ2xCLEFBQUE7QUFDQSxBQUFBLE1BQU0sQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEQsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNuRCxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNwQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVztBQUNuQixBQUFBLEFBQUEsTUFBTSxDQUFDLENBQUM7QUFDUixDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUMxQyxDQUFDLFlBQVksQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUNqQixBQUFBO0FBQ0EsQUFBQTtBQUNBO0FBQ0EsR0FBRztBQUNILEFBQUE7QUFDQSxBQUFBLEFBQUEsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEMsQyxDQUFDLEFBQUMsTSxZLENBQU8sQ0FBQyxDQUFDLENBQUMsS0FBSztBQUNyQyxBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUE7QUFDQTtBQUNBLEdBQUc7QUFDSCxBQUFBO0FBQ0EsQUFBQSxBQUFBLE1BQU0sQ0FBZSxNQUFkLGNBQWMsQ0FBQyxDQUFF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LENBQUMsU0FBUyxDQUFDLEM7RUFBQSxDO0NBQUEsQ0FBQTtBQUMzQyxBQUFBO0FBQ0EsQUFBQSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsUztBQUFTLENBQUE7QUFDN0QiLCJuYW1lcyI6W10sInNvdXJjZXNDb250ZW50IjpbIiMgaW5kZW50LmxpYi5jaXZldFxyXG5cclxuaW1wb3J0IHtcclxuXHR1bmRlZiwgZGVmaW5lZCwgbm90ZGVmaW5lZCwgYXNzZXJ0LCBjcm9haywgYXJyYXksXHJcblx0aXNTdHJpbmcsIGlzQXJyYXksIGlzQXJyYXlPZlN0cmluZ3MsIGhhc2gsIGlzSGFzaCxcclxuXHRpbnRlZ2VyLCBpc0ludGVnZXIsXHJcblx0fSBmcm9tICdkYXRhdHlwZXMnXHJcbmltcG9ydCB7XHJcblx0cnRyaW0sIGNvdW50Q2hhcnMsIGVzY2FwZVN0ciwgZ2V0T3B0aW9ucyxcclxuXHRibG9ja1RvQXJyYXksIGFycmF5VG9CbG9jaywgdG9BcnJheSwgdG9CbG9jayxcclxuXHR9IGZyb20gJ2xsdXRpbHMnXHJcblxyXG4vKipcclxuICogQG1vZHVsZSBpbmRlbnQgLSBpbmRlbnQgbGV2ZWwgdXRpbGl0aWVzXHJcbiAqL1xyXG5cclxuZXhwb3J0IGxldCBvbmVJbmRlbnQ6IHN0cmluZz8gPSB1bmRlZlxyXG5cclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbi8qKlxyXG4gKiBSZXNldCB0aGUgdGV4dCBmb3Igb25lIGluZGVudCBsZXZlbFxyXG4gKi9cclxuXHJcbmV4cG9ydCByZXNldE9uZUluZGVudCA6PSAoc3RyOiBzdHJpbmc/PXVuZGVmKTogdm9pZCA9PlxyXG5cclxuXHRvbmVJbmRlbnQgPSBzdHJcclxuXHRyZXR1cm5cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4vKipcclxuICogaW5kZW50TGV2ZWwgLSBkZXRlcm1pbmUgaW5kZW50IGxldmVsIG9mIGEgc3RyaW5nXHJcbiAqICAgICAgICAgICAgICAgaXQncyBPSyBpZiB0aGUgc3RyaW5nIGlzIE9OTFkgaW5kZW50YXRpb25cclxuICovXHJcblxyXG5leHBvcnQgaW5kZW50TGV2ZWwgOj0gKGxpbmU6IHN0cmluZyk6IG51bWJlciA9PlxyXG5cclxuXHQjIC0tLSBUaGlzIHdpbGwgYWx3YXlzIG1hdGNoLCBhbmQgaXQncyBncmVlZHlcclxuXHQjICAgICAoYnV0IFR5cGVTY3JpcHQgZG9lc24ndCBrbm93IHRoYXQpXHJcblx0W3ByZWZpeF0gOj0gbGluZS5tYXRjaCgvXlxccyovKSB8fCBbJyddXHJcblxyXG5cdGlmIChwcmVmaXgubGVuZ3RoID09IDApXHJcblx0XHRyZXR1cm4gMFxyXG5cclxuXHQjIC0tLSBDaGVjayBpZiB3ZSdyZSB1c2luZyBUQUJzIG9yIHNwYWNlc1xyXG5cdG51bVRBQnMgOj0gY291bnRDaGFycyhwcmVmaXgsIFwiXFx0XCIpXHJcblx0bnVtU3BhY2VzIDo9IGNvdW50Q2hhcnMocHJlZml4LCBcIiBcIilcclxuXHRhc3NlcnQgKG51bVRBQnM9PTApIHx8IChudW1TcGFjZXM9PTApLFxyXG5cdFx0XCJJbnZhbGlkIG1peCBvZiBUQUJzIGFuZCBzcGFjZXMgaW4gI3tlc2NhcGVTdHIobGluZSl9XCJcclxuXHJcblx0IyAtLS0gb25lSW5kZW50IG11c3QgYmUgb25lIG9mOlxyXG5cdCMgICAgICAgIHVuZGVmXHJcblx0IyAgICAgICAgYSBzaW5nbGUgVEFCIGNoYXJhY3RlclxyXG5cdCMgICAgICAgIHNvbWUgbnVtYmVyIG9mIHNwYWNlIGNoYXJhY3RlcnNcclxuXHJcblx0IyAtLS0gU2V0IHZhcmlhYmxlcyBvbmVJbmRlbnQgJiBsZXZlbFxyXG5cdHN3aXRjaCBvbmVJbmRlbnRcclxuXHRcdHdoZW4gdW5kZWZcclxuXHRcdFx0aWYgKG51bVRBQnMgPiAwKVxyXG5cdFx0XHRcdG9uZUluZGVudCA9IFwiXFx0XCJcclxuXHRcdFx0XHRyZXR1cm4gbnVtVEFCc1xyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0b25lSW5kZW50ID0gJyAnLnJlcGVhdChudW1TcGFjZXMpXHJcblx0XHRcdFx0cmV0dXJuIDFcclxuXHRcdHdoZW4gXCJcXHRcIlxyXG5cdFx0XHRhc3NlcnQgKG51bVNwYWNlcz09MCksIFwiRXhwZWN0aW5nIFRBQnMsIGZvdW5kIHNwYWNlc1wiXHJcblx0XHRcdHJldHVybiBudW1UQUJzXHJcblx0XHRlbHNlXHJcblx0XHRcdCMgLS0tIHVzaW5nIHNvbWUgbnVtYmVyIG9mIHNwYWNlc1xyXG5cdFx0XHRhc3NlcnQgKG51bVRBQnMgPT0gMCksIFwiRXhwZWN0aW5nIHNwYWNlcywgZm91bmQgVEFCc1wiXHJcblx0XHRcdGFzc2VydCAobnVtU3BhY2VzICUgb25lSW5kZW50Lmxlbmd0aCA9PSAwKSwgXCJcIlwiXHJcblx0XHRcdFx0XHRJbnZhbGlkIG51bSBzcGFjZXM6ICN7bnVtU3BhY2VzfSxcclxuXHRcdFx0XHRcdG9uZUluZGVudCA9ICN7ZXNjYXBlU3RyKG9uZUluZGVudCl9XHJcblx0XHRcdFx0XHRcIlwiXCJcclxuXHRcdFx0cmV0dXJuIG51bVNwYWNlcyAvIG9uZUluZGVudC5sZW5ndGhcclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4vKipcclxuICogc3BsaXRMaW5lIC0gc2VwYXJhdGUgYSBsaW5lIGludG8gW2xldmVsLCBsaW5lXVxyXG4gKi9cclxuXHJcbmV4cG9ydCB0eXBlIGxpbmVEZXNjID0gW1xyXG5cdGxldmVsOiBudW1iZXJcclxuXHR0ZXh0OiBzdHJpbmdcclxuXHRdXHJcblxyXG5leHBvcnQgc3BsaXRMaW5lIDo9IChsaW5lOiBzdHJpbmcpOiBsaW5lRGVzYyA9PlxyXG5cclxuXHRbXywgcHJlZml4LCBzdHJdIDo9IGxpbmUubWF0Y2goL14oXFxzKikoLiopJC8pIHx8IFsnJywgJycsICcnXVxyXG5cdHJldHVybiBbaW5kZW50TGV2ZWwocHJlZml4KSwgc3RyLnRyaW0oKV1cclxuXHJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4vKipcclxuICogaW5kZW50ZWQgLSBhZGQgaW5kZW50YXRpb24gdG8gZWFjaCBzdHJpbmcgaW4gYSBibG9jayBvciBhcnJheVxyXG4gKiAgICAgICAgICAtIHJldHVybnMgdGhlIHNhbWUgdHlwZSBhcyBpbnB1dCwgaS5lLiBhcnJheSBvciBzdHJpbmdcclxuICovXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5kZW50ZWQoXHJcblx0XHRpbnB1dDogc3RyaW5nLFxyXG5cdFx0bGV2ZWw/OiBudW1iZXJcclxuXHRcdGhPcHRpb25zPzogaGFzaFxyXG5cdFx0KTogc3RyaW5nXHJcbmV4cG9ydCBmdW5jdGlvbiBpbmRlbnRlZChcclxuXHRcdGlucHV0OiBzdHJpbmdbXSxcclxuXHRcdGxldmVsPzogbnVtYmVyXHJcblx0XHRoT3B0aW9ucz86IGhhc2hcclxuXHRcdCk6IHN0cmluZ1tdXHJcbmV4cG9ydCBmdW5jdGlvbiBpbmRlbnRlZChcclxuXHRcdGlucHV0OiBzdHJpbmcgfCBzdHJpbmdbXSxcclxuXHRcdGxldmVsOiBudW1iZXIgPSAxXHJcblx0XHRoT3B0aW9uczogaGFzaCA9IHt9XHJcblx0XHQpOiBzdHJpbmcgfCBzdHJpbmdbXSB7XHJcblxyXG5cdCMgLS0tIEJlY2F1c2UgdGhlcmUncyBhIGdsb2JhbCBuYW1lZCBvbmVJbmRlbnQsXHJcblx0IyAgICAgd2UgaGF2ZSB0byBwdXQgdGhlIG9wdGlvbiBpbiBhIG5ldyB2YXJpYWJsZSwgaS5lLiAnaW5kJ1xyXG5cdHR5cGUgb3B0ID0ge1xyXG5cdFx0b25lSW5kZW50OiBzdHJpbmc/XHJcblx0XHR9XHJcblx0e29uZUluZGVudDogaW5kfSA6PSBnZXRPcHRpb25zPG9wdD4gaE9wdGlvbnMsIHtcclxuXHRcdG9uZUluZGVudDogdW5kZWZcclxuXHRcdH1cclxuXHJcblx0dXNlSW5kZW50OiBzdHJpbmcgOj0gKFxyXG5cdFx0ICBkZWZpbmVkKGluZCkgPyBpbmRcclxuXHRcdDogZGVmaW5lZChvbmVJbmRlbnQpID8gb25lSW5kZW50XHJcblx0XHQ6ICdcXHQnXHJcblx0XHQpXHJcblxyXG5cdGxMaW5lczogc3RyaW5nW10gOj0gaXNBcnJheShpbnB1dCkgPyBpbnB1dCA6IGlucHV0LnNwbGl0KCdcXG4nKVxyXG5cdGxOZXdMaW5lczogc3RyaW5nW10gOj0gZm9yIGxpbmUgb2YgbExpbmVzXHJcblx0XHR1c2VJbmRlbnQucmVwZWF0KGxldmVsKSArIGxpbmVcclxuXHRyZXR1cm4gaXNBcnJheShpbnB1dCkgPyBsTmV3TGluZXMgOiBsTmV3TGluZXMuam9pbignXFxuJylcclxuXHR9XHJcblxyXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuLyoqXHJcbiAqIHVuZGVudGVkIC0gc3RyaW5nIHdpdGggMXN0IGxpbmUgaW5kZW50YXRpb24gcmVtb3ZlZCBmb3IgZWFjaCBsaW5lXHJcbiAqICAgICAgICAgIC0gcmV0dXJucyBzYW1lIHR5cGUgYXMgaW5wdXQsIGkuZS4gZWl0aGVyIHN0cmluZyBvciBhcnJheVxyXG4gKi9cclxuXHJcbmV4cG9ydCB1bmRlbnRlZCA6PSAoaW5wdXQ6IHN0cmluZyB8IHN0cmluZ1tdKTogc3RyaW5nIHwgc3RyaW5nW10gPT5cclxuXHJcblx0IyAtLS0gaW5wdXQgbXVzdCBiZSBlaXRoZXIgYSBzdHJpbmcgb3IgYXJyYXkgb2Ygc3RyaW5nc1xyXG5cdGxMaW5lcyA6PSB0b0FycmF5KGlucHV0KVxyXG5cclxuXHQjIC0tLSBOT1RFOiBsZWF2ZSBlbXB0eSBsaW5lcyBlbXB0eVxyXG5cclxuXHRsZXQgdG9SZW1vdmU6IHN0cmluZz8gID0gdW5kZWZcclxuXHRsZXQgblRvUmVtb3ZlOiBudW1iZXIgPSAwXHJcblx0bE5ld0xpbmVzOiBzdHJpbmdbXSA6PSBbXVxyXG5cdGZvciBsaW5lIG9mIGxMaW5lc1xyXG5cdFx0dHJpbW1lZCA6PSBydHJpbShsaW5lKVxyXG5cdFx0aWYgKHRyaW1tZWQgPT0gJycpXHJcblx0XHRcdGxOZXdMaW5lcy5wdXNoICcnXHJcblx0XHRlbHNlIGlmIG5vdGRlZmluZWQodG9SZW1vdmUpXHJcblx0XHRcdFtfLCBwcmVmaXgsIHJlc3RdIDo9IHRyaW1tZWQubWF0Y2goL14oXFxzKikoLiopJC8pIHx8IFsnJywnJywnJ11cclxuXHRcdFx0aWYgKHByZWZpeC5sZW5ndGggPT0gMClcclxuXHRcdFx0XHRsTmV3TGluZXMucHVzaCB0cmltbWVkXHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHR0b1JlbW92ZSA9IHByZWZpeFxyXG5cdFx0XHRcdG5Ub1JlbW92ZSA9IHByZWZpeC5sZW5ndGhcclxuXHRcdFx0XHRsTmV3TGluZXMucHVzaCByZXN0XHJcblx0XHRlbHNlXHJcblx0XHRcdGFzc2VydCAobGluZS5pbmRleE9mKHRvUmVtb3ZlKT09MCksXHJcblx0XHRcdFx0XCJjYW4ndCByZW1vdmUgI3tlc2NhcGVTdHIodG9SZW1vdmUpfSBmcm9tICN7ZXNjYXBlU3RyKGxpbmUpfVwiXHJcblx0XHRcdGxOZXdMaW5lcy5wdXNoIHRyaW1tZWQuc3Vic3RyKG5Ub1JlbW92ZSlcclxuXHJcblx0cmV0dXJuIGlzU3RyaW5nKGlucHV0KSA/IGFycmF5VG9CbG9jayhsTmV3TGluZXMpIDogbE5ld0xpbmVzXHJcbiJdfQ==