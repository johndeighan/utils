"use strict";
// compile.civet

import {
	undef, defined, notdefined, pass, OL, assert, croak,
	getCmdArgs, compileAllFiles, watchFiles,
	DBG, LOG, WARN, ERR,
	isDirSpec, compileFile,
	compileResult,
	} from '../lib/utils.ts'

const {_, path, w: watch} = getCmdArgs({
	path: "one or more file paths",
	w:    "watch for and recompile files if they change",
	_: `files to compile, as one of the following:
	'test/<stub>' - file <stub>.<ext> in ./test folder
	'lib/<stub>'  - file <stub>.<ext> in ./src/lib folder
	'bin/<stub>'  - file <stub>.<ext> in ./src/bin folder
	'<stub>'      - search the above 3 for <stub>.<ext>
where <ext> is a valid extension to compile`
	})

let numCompiled = 0

// ---------------------------------------------------------------------------

const logResult = (hResult: compileResult): void => {

	const {relPath, status, outPath} = hResult
	switch(status) {
		case 'compiled': {
			LOG(`==> ${OL(relPath)}`)
			numCompiled += 1;break;
		}
		case 'exists': {
			pass();break;
		}
		default: {
			ERR(`Not compiled: ${OL(relPath)}`)
		}
	}
	return
}

// ---------------------------------------------------------------------------

if (_.length === 0) {
	DBG("=====  Compiling all files  =====")
	for (const hResult of compileAllFiles()) {
		logResult(hResult)
	}
}

else {
	// --- Files must be specified as <stub>, or <dirspec>/<stub>

	for (const str of _) {
		DBG(`non-option: ${OL(str)}`)
		if (str.includes('/')) {
			const [dirspec, stubStr] = str.split('/')
			assert(isDirSpec(dirspec), `Bad dirspec: ${OL(dirspec)}`)
			for (const stub of stubStr.split(',')) {
				DBG(`compile ${OL(dirspec)}/${OL(stub)}`)
				const hResult = compileFile([dirspec, stub])
				logResult(hResult)
			}
		}
		else {
			for (const stub of str.split(',')) {
				DBG(`compile stub ${OL(stub)}`)
				const hResult = compileFile([undef, stub])
				logResult(hResult)
			}
		}
	}
}

if (defined(path)) {
	for (const filePath of path.split(',')) {
		const hResult = compileFile(filePath)
		logResult(hResult)
	}
}

LOG(`(${numCompiled} files compiled)`)

if (watch) {
	watchFiles(Deno.cwd(), ({kind, path}) => {
		console.log(`EVENT: ${kind} ${path}`)
		return false
	})
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2Jpbi9jb21waWxlLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2Jpbi9jb21waWxlLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsZ0JBQWU7QUFDZixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3JELENBQUMsVUFBVSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ3pDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ3JCLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3hCLENBQUMsYUFBYSxDQUFDO0FBQ2YsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQjtBQUN6QixBQUFBO0FBQ0EsQUFBQSxBQUFtQixNQUFuQixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUUsQ0FBQyxVQUFVLENBQUEsQUFBQyxDQUFDO0FBQ25DLEFBQUEsQ0FBQyxJQUFJLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQTtBQUMvQixBQUFBLENBQUMsQ0FBQyxDQUFDLElBQUksOENBQThDLENBQUE7QUFDckQsQUFBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUc7QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJDQUVFLENBQUc7QUFDTCxDQUFDLENBQUMsQ0FBQTtBQUNGLEFBQUE7QUFDQSxBQUFBLEFBQUEsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQixBQUFBO0FBQ0EsQUFBQSw4RUFBNkU7QUFDN0UsQUFBQTtBQUNBLEFBQUEsQUFBUyxNQUFULFNBQVMsQ0FBQyxD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QyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBLENBQUE7QUFDekMsQUFBQSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUEsQUFBQyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDdEMsQUFBQSxFQUFFLE1BQU0sQ0FBQyxLO0NBQUssQ0FBQSxDO0FBQUEsQ0FBQTtBQUNkIiwibmFtZXMiOltdLCJzb3VyY2VzQ29udGVudCI6WyIjIGNvbXBpbGUuY2l2ZXRcblxuaW1wb3J0IHtcblx0dW5kZWYsIGRlZmluZWQsIG5vdGRlZmluZWQsIHBhc3MsIE9MLCBhc3NlcnQsIGNyb2FrLFxuXHRnZXRDbWRBcmdzLCBjb21waWxlQWxsRmlsZXMsIHdhdGNoRmlsZXMsXG5cdERCRywgTE9HLCBXQVJOLCBFUlIsXG5cdGlzRGlyU3BlYywgY29tcGlsZUZpbGUsXG5cdGNvbXBpbGVSZXN1bHQsXG5cdH0gZnJvbSAnLi4vbGliL3V0aWxzLnRzJ1xuXG57XywgcGF0aCwgdzogd2F0Y2h9IDo9IGdldENtZEFyZ3Mge1xuXHRwYXRoOiBcIm9uZSBvciBtb3JlIGZpbGUgcGF0aHNcIlxuXHR3OiAgICBcIndhdGNoIGZvciBhbmQgcmVjb21waWxlIGZpbGVzIGlmIHRoZXkgY2hhbmdlXCJcblx0XzogXCJcIlwiXG5cdFx0ZmlsZXMgdG8gY29tcGlsZSwgYXMgb25lIG9mIHRoZSBmb2xsb3dpbmc6XG5cdFx0XHQndGVzdC88c3R1Yj4nIC0gZmlsZSA8c3R1Yj4uPGV4dD4gaW4gLi90ZXN0IGZvbGRlclxuXHRcdFx0J2xpYi88c3R1Yj4nICAtIGZpbGUgPHN0dWI+LjxleHQ+IGluIC4vc3JjL2xpYiBmb2xkZXJcblx0XHRcdCdiaW4vPHN0dWI+JyAgLSBmaWxlIDxzdHViPi48ZXh0PiBpbiAuL3NyYy9iaW4gZm9sZGVyXG5cdFx0XHQnPHN0dWI+JyAgICAgIC0gc2VhcmNoIHRoZSBhYm92ZSAzIGZvciA8c3R1Yj4uPGV4dD5cblx0XHR3aGVyZSA8ZXh0PiBpcyBhIHZhbGlkIGV4dGVuc2lvbiB0byBjb21waWxlXG5cdFx0XCJcIlwiXG5cdH1cblxubGV0IG51bUNvbXBpbGVkID0gMFxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5sb2dSZXN1bHQgOj0gKGhSZXN1bHQ6IGNvbXBpbGVSZXN1bHQpOiB2b2lkID0+XG5cblx0e3JlbFBhdGgsIHN0YXR1cywgb3V0UGF0aH0gOj0gaFJlc3VsdFxuXHRzd2l0Y2ggc3RhdHVzXG5cdFx0d2hlbiAnY29tcGlsZWQnXG5cdFx0XHRMT0cgXCI9PT4gI3tPTChyZWxQYXRoKX1cIlxuXHRcdFx0bnVtQ29tcGlsZWQgKz0gMVxuXHRcdHdoZW4gJ2V4aXN0cydcblx0XHRcdHBhc3MoKVxuXHRcdGVsc2Vcblx0XHRcdEVSUiBcIk5vdCBjb21waWxlZDogI3tPTChyZWxQYXRoKX1cIlxuXHRyZXR1cm5cblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuaWYgKF8ubGVuZ3RoID09IDApXG5cdERCRyBcIj09PT09ICBDb21waWxpbmcgYWxsIGZpbGVzICA9PT09PVwiXG5cdGZvciBoUmVzdWx0IG9mIGNvbXBpbGVBbGxGaWxlcygpXG5cdFx0bG9nUmVzdWx0IGhSZXN1bHRcblxuZWxzZVxuXHQjIC0tLSBGaWxlcyBtdXN0IGJlIHNwZWNpZmllZCBhcyA8c3R1Yj4sIG9yIDxkaXJzcGVjPi88c3R1Yj5cblxuXHRmb3Igc3RyIG9mIF9cblx0XHREQkcgXCJub24tb3B0aW9uOiAje09MKHN0cil9XCJcblx0XHRpZiBzdHIuaW5jbHVkZXMoJy8nKVxuXHRcdFx0W2RpcnNwZWMsIHN0dWJTdHJdIDo9IHN0ci5zcGxpdCgnLycpXG5cdFx0XHRhc3NlcnQgaXNEaXJTcGVjKGRpcnNwZWMpLCBcIkJhZCBkaXJzcGVjOiAje09MKGRpcnNwZWMpfVwiXG5cdFx0XHRmb3Igc3R1YiBvZiBzdHViU3RyLnNwbGl0KCcsJylcblx0XHRcdFx0REJHIFwiY29tcGlsZSAje09MKGRpcnNwZWMpfS8je09MKHN0dWIpfVwiXG5cdFx0XHRcdGhSZXN1bHQgOj0gY29tcGlsZUZpbGUgW2RpcnNwZWMsIHN0dWJdXG5cdFx0XHRcdGxvZ1Jlc3VsdCBoUmVzdWx0XG5cdFx0ZWxzZVxuXHRcdFx0Zm9yIHN0dWIgb2Ygc3RyLnNwbGl0KCcsJylcblx0XHRcdFx0REJHIFwiY29tcGlsZSBzdHViICN7T0woc3R1Yil9XCJcblx0XHRcdFx0aFJlc3VsdCA6PSBjb21waWxlRmlsZSBbdW5kZWYsIHN0dWJdXG5cdFx0XHRcdGxvZ1Jlc3VsdCBoUmVzdWx0XG5cbmlmIGRlZmluZWQocGF0aClcblx0Zm9yIGZpbGVQYXRoIG9mIHBhdGguc3BsaXQoJywnKVxuXHRcdGhSZXN1bHQgOj0gY29tcGlsZUZpbGUgZmlsZVBhdGhcblx0XHRsb2dSZXN1bHQgaFJlc3VsdFxuXG5MT0cgXCIoI3tudW1Db21waWxlZH0gZmlsZXMgY29tcGlsZWQpXCJcblxuaWYgd2F0Y2hcblx0d2F0Y2hGaWxlcyBEZW5vLmN3ZCgpLCAoe2tpbmQsIHBhdGh9KSA9PlxuXHRcdGNvbnNvbGUubG9nIFwiRVZFTlQ6ICN7a2luZH0gI3twYXRofVwiXG5cdFx0cmV0dXJuIGZhbHNlXG4iXX0=