"use strict";
// compile.civet

import {
	undef, defined, notdefined, pass, OL, assert, croak,
	getCmdArgs, compileAllFiles, watchDir,
	DBG, LOG, WARN, ERR,
	isDirSpec, compileFile,
	} from '../lib/utils.ts'
import type {compileResult} from '../lib/utils.ts'

const {_, path, w: watch} = getCmdArgs({
	path: "one or more file paths",
	w:    "watch for and recompile files if they change",
	_: `files to compile, as one of the following:
	'test/<stub>' - file <stub>.<ext> in ./test folder
	'lib/<stub>'  - file <stub>.<ext> in ./src/lib folder
	'bin/<stub>'  - file <stub>.<ext> in ./src/bin folder
	'<stub>'      - search the above 3 for <stub>.<ext>
where <ext> is a valid extension to compile`
	})

let numCompiled = 0

// ---------------------------------------------------------------------------

const logResult = (hResult: compileResult): void => {

	const {relPath, status, outPath} = hResult
	switch(status) {
		case 'compiled': {
			LOG(`==> ${OL(relPath)}`)
			numCompiled += 1;break;
		}
		case 'exists': {
			pass();break;
		}
		default: {
			ERR(`Not compiled: ${OL(relPath)}`)
		}
	}
	return
}

// ---------------------------------------------------------------------------

if (_.length === 0) {
	DBG("=====  Compiling all files  =====")
	for (const hResult of compileAllFiles()) {
		logResult(hResult)
	}
}

else {
	// --- Files must be specified as <stub>, or <dirspec>/<stub>

	for (const str of _) {
		DBG(`non-option: ${OL(str)}`)
		if (str.includes('/')) {
			const [dirspec, stubStr] = str.split('/')
			assert(isDirSpec(dirspec), `Bad dirspec: ${OL(dirspec)}`)
			for (const stub of stubStr.split(',')) {
				DBG(`compile ${OL(dirspec)}/${OL(stub)}`)
				const hResult = compileFile([dirspec, stub])
				logResult(hResult)
			}
		}
		else {
			for (const stub of str.split(',')) {
				DBG(`compile stub ${OL(stub)}`)
				const hResult = compileFile([undef, stub])
				logResult(hResult)
			}
		}
	}
}

if (defined(path)) {
	for (const filePath of path.split(',')) {
		const hResult = compileFile(filePath)
		logResult(hResult)
	}
}

LOG(`(${numCompiled} files compiled)`)

if (watch) {
	watchDir(Deno.cwd(), (kind, path) => {
		console.log(`EVENT: ${kind} ${path}`)
	})
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjL2Jpbi9jb21waWxlLmNpdmV0LnRzeCIsInNvdXJjZXMiOlsic3JjL2Jpbi9jb21waWxlLmNpdmV0Il0sIm1hcHBpbmdzIjoiO0FBQUEsZ0JBQWU7QUFDZixBQUFBO0FBQ0EsQUFBQSxNQUFNLENBQUMsQ0FBQztBQUNSLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3JELENBQUMsVUFBVSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQ3ZDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ3JCLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3hCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUI7QUFDekIsQUFBQSxBQUFBLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCO0FBQ2xELEFBQUE7QUFDQSxBQUFBLEFBQW1CLE1BQW5CLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBRSxDQUFDLFVBQVUsQ0FBQSxBQUFDLENBQUM7QUFDbkMsQUFBQSxDQUFDLElBQUksQ0FBQyxDQUFDLHdCQUF3QixDQUFBO0FBQy9CLEFBQUEsQ0FBQyxDQUFDLENBQUMsSUFBSSw4Q0FBOEMsQ0FBQTtBQUNyRCxBQUFBLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBRztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBRUUsQ0FBRztBQUNMLENBQUMsQ0FBQyxDQUFBO0FBQ0YsQUFBQTtBQUNBLEFBQUEsQUFBQSxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25CLEFBQUE7QUFDQSxB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SUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFBO0FBQ3JDLEFBQUEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFBLEFBQUMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDO0NBQUEsQ0FBQSxDO0FBQUEsQ0FBQTtBQUN0QyIsIm5hbWVzIjpbXSwic291cmNlc0NvbnRlbnQiOlsiIyBjb21waWxlLmNpdmV0XG5cbmltcG9ydCB7XG5cdHVuZGVmLCBkZWZpbmVkLCBub3RkZWZpbmVkLCBwYXNzLCBPTCwgYXNzZXJ0LCBjcm9hayxcblx0Z2V0Q21kQXJncywgY29tcGlsZUFsbEZpbGVzLCB3YXRjaERpcixcblx0REJHLCBMT0csIFdBUk4sIEVSUixcblx0aXNEaXJTcGVjLCBjb21waWxlRmlsZSxcblx0fSBmcm9tICcuLi9saWIvdXRpbHMudHMnXG5pbXBvcnQgdHlwZSB7Y29tcGlsZVJlc3VsdH0gZnJvbSAnLi4vbGliL3V0aWxzLnRzJ1xuXG57XywgcGF0aCwgdzogd2F0Y2h9IDo9IGdldENtZEFyZ3Mge1xuXHRwYXRoOiBcIm9uZSBvciBtb3JlIGZpbGUgcGF0aHNcIlxuXHR3OiAgICBcIndhdGNoIGZvciBhbmQgcmVjb21waWxlIGZpbGVzIGlmIHRoZXkgY2hhbmdlXCJcblx0XzogXCJcIlwiXG5cdFx0ZmlsZXMgdG8gY29tcGlsZSwgYXMgb25lIG9mIHRoZSBmb2xsb3dpbmc6XG5cdFx0XHQndGVzdC88c3R1Yj4nIC0gZmlsZSA8c3R1Yj4uPGV4dD4gaW4gLi90ZXN0IGZvbGRlclxuXHRcdFx0J2xpYi88c3R1Yj4nICAtIGZpbGUgPHN0dWI+LjxleHQ+IGluIC4vc3JjL2xpYiBmb2xkZXJcblx0XHRcdCdiaW4vPHN0dWI+JyAgLSBmaWxlIDxzdHViPi48ZXh0PiBpbiAuL3NyYy9iaW4gZm9sZGVyXG5cdFx0XHQnPHN0dWI+JyAgICAgIC0gc2VhcmNoIHRoZSBhYm92ZSAzIGZvciA8c3R1Yj4uPGV4dD5cblx0XHR3aGVyZSA8ZXh0PiBpcyBhIHZhbGlkIGV4dGVuc2lvbiB0byBjb21waWxlXG5cdFx0XCJcIlwiXG5cdH1cblxubGV0IG51bUNvbXBpbGVkID0gMFxuXG4jIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5sb2dSZXN1bHQgOj0gKGhSZXN1bHQ6IGNvbXBpbGVSZXN1bHQpOiB2b2lkID0+XG5cblx0e3JlbFBhdGgsIHN0YXR1cywgb3V0UGF0aH0gOj0gaFJlc3VsdFxuXHRzd2l0Y2ggc3RhdHVzXG5cdFx0d2hlbiAnY29tcGlsZWQnXG5cdFx0XHRMT0cgXCI9PT4gI3tPTChyZWxQYXRoKX1cIlxuXHRcdFx0bnVtQ29tcGlsZWQgKz0gMVxuXHRcdHdoZW4gJ2V4aXN0cydcblx0XHRcdHBhc3MoKVxuXHRcdGVsc2Vcblx0XHRcdEVSUiBcIk5vdCBjb21waWxlZDogI3tPTChyZWxQYXRoKX1cIlxuXHRyZXR1cm5cblxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuaWYgKF8ubGVuZ3RoID09IDApXG5cdERCRyBcIj09PT09ICBDb21waWxpbmcgYWxsIGZpbGVzICA9PT09PVwiXG5cdGZvciBoUmVzdWx0IG9mIGNvbXBpbGVBbGxGaWxlcygpXG5cdFx0bG9nUmVzdWx0IGhSZXN1bHRcblxuZWxzZVxuXHQjIC0tLSBGaWxlcyBtdXN0IGJlIHNwZWNpZmllZCBhcyA8c3R1Yj4sIG9yIDxkaXJzcGVjPi88c3R1Yj5cblxuXHRmb3Igc3RyIG9mIF9cblx0XHREQkcgXCJub24tb3B0aW9uOiAje09MKHN0cil9XCJcblx0XHRpZiBzdHIuaW5jbHVkZXMoJy8nKVxuXHRcdFx0W2RpcnNwZWMsIHN0dWJTdHJdIDo9IHN0ci5zcGxpdCgnLycpXG5cdFx0XHRhc3NlcnQgaXNEaXJTcGVjKGRpcnNwZWMpLCBcIkJhZCBkaXJzcGVjOiAje09MKGRpcnNwZWMpfVwiXG5cdFx0XHRmb3Igc3R1YiBvZiBzdHViU3RyLnNwbGl0KCcsJylcblx0XHRcdFx0REJHIFwiY29tcGlsZSAje09MKGRpcnNwZWMpfS8je09MKHN0dWIpfVwiXG5cdFx0XHRcdGhSZXN1bHQgOj0gY29tcGlsZUZpbGUgW2RpcnNwZWMsIHN0dWJdXG5cdFx0XHRcdGxvZ1Jlc3VsdCBoUmVzdWx0XG5cdFx0ZWxzZVxuXHRcdFx0Zm9yIHN0dWIgb2Ygc3RyLnNwbGl0KCcsJylcblx0XHRcdFx0REJHIFwiY29tcGlsZSBzdHViICN7T0woc3R1Yil9XCJcblx0XHRcdFx0aFJlc3VsdCA6PSBjb21waWxlRmlsZSBbdW5kZWYsIHN0dWJdXG5cdFx0XHRcdGxvZ1Jlc3VsdCBoUmVzdWx0XG5cbmlmIGRlZmluZWQocGF0aClcblx0Zm9yIGZpbGVQYXRoIG9mIHBhdGguc3BsaXQoJywnKVxuXHRcdGhSZXN1bHQgOj0gY29tcGlsZUZpbGUgZmlsZVBhdGhcblx0XHRsb2dSZXN1bHQgaFJlc3VsdFxuXG5MT0cgXCIoI3tudW1Db21waWxlZH0gZmlsZXMgY29tcGlsZWQpXCJcblxuaWYgd2F0Y2hcblx0d2F0Y2hEaXIgRGVuby5jd2QoKSwgKGtpbmQsIHBhdGgpID0+XG5cdFx0Y29uc29sZS5sb2cgXCJFVkVOVDogI3traW5kfSAje3BhdGh9XCJcbiJdfQ==