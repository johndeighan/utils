# v8-stack.lib.test.civet

import {undef, assert, croak} from 'datatypes'
import {o} from 'llutils'
import {DBG} from 'logger'
import {relpath} from 'fsys'
import {setDirTree} from 'pllfile'
import {getCmdArgs} from 'cmd-args'
import {execCmd, execCmdSync} from 'exec'
import {
	TStackFrame, getV8Stack, getMyCaller,
	getMyOutsideCaller, getV8StackStr,
	} from 'v8-stack'
import {
	equal, like, succeeds, isType, notType, objListLike,
	} from 'unit-test'

getCmdArgs()

# ---------------------------------------------------------------------------

setup := (): void =>

	DBG "setDirTree()"

	setDirTree 'src/test/v8-stack', """
			v8-module.ts
				"use strict";
				// v8-module.civet

				import {getMyCaller, TStackFrame} from 'v8-stack'

				// ---------------------------------------------------------------------------

				type bothFrames = ((TStackFrame?))[]

				const isBothFrames = (x: unknown): x is bothFrames => {
					return Array.isArray(x) && (x.length === 2)
				}

				// ---------------------------------------------------------------------------

				export const getBoth = function(): bothFrames {

					const result = secondFunc('both')
					if (Array.isArray(result)) {
						return result
					}
					else {
						throw new Error("Expected array, got TStackFrame")
					}
				}

				// ---------------------------------------------------------------------------

				export const getDirect = function(): (TStackFrame?) {

					const result = secondFunc('direct')
					if (Array.isArray(result)) {
						throw new Error("Got unexpected array")
					}
					return result
				}

				// ---------------------------------------------------------------------------

				export const getOutside = function(): (TStackFrame?) {

					const result = secondFunc('outside')
					if (Array.isArray(result)) {
						throw new Error("Got unexpected array")
					}
					return result
				}

				// ---------------------------------------------------------------------------

				const secondFunc = function(type: string): bothFrames | (TStackFrame?) {

					return thirdFunc(type)
				}

				// ---------------------------------------------------------------------------

				const thirdFunc = function(type: string): bothFrames | (TStackFrame?) {

					// --- direct caller should be 'secondFunc'
					//     outside caller should be the function
					//        that called getCaller()
					switch(type) {
						case 'both': {
							return [getMyCaller(), getMyCaller()]
						}
						case 'direct': {
							return getMyCaller()
						}
						case 'outside': {
							return getMyCaller()
						}
						default: {
							throw new Error(`Unknown type: ${type}`)
						}
					}
				}
		""", o'clear'

	return

setup()

# ---------------------------------------------------------------------------

DBG "type TStackFrame"

isType 'TStackFrame', {
	type: 'function'
	source: 'temp.civet'
	line: 5
	column: 5
	name: 'func'
	isConstructor: false
	isAsync: false
	objType: undefined
	}

DBG "getV8Stack()"

(() ->
	let stack1: TStackFrame[] = []
	let stack2: TStackFrame[] = []

	main := () =>
		func1()
		func2()

	func1 := () ->
		stack1 = getV8Stack()
		return

	func2 := () ->
		stack2 = getV8Stack()
		return

	main()
	objListLike stack1, [
		{
			type: 'function'
			name: 'func1'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 136
			}
		{
			type: 'function'
			name: 'main'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 132
			}
		{
			type: 'function'
			name: '<anon>'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 143
			}
		{
			type: 'script'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 195
			}
		]

	objListLike stack2, [
		{
			type: 'function'
			name: 'func2'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 140
			}
		{
			type: 'function'
			name: 'main'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 133
			}
		{
			type: 'function'
			name: '<anon>'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 143
			}
		{
			type: 'script'
			source: 'src/test/v8-stack.lib.test.civet'
			line: 195
			}
		]
	)()

# ---------------------------------------------------------------------------

DBG "getV8StackStr()"

(() ->
	let stack1: string = ''
	let stack2: string = ''

	main := () ->
		func1()
		func2()

	func1 := () ->
		stack1 = getV8StackStr()
		return

	func2 := () ->
		stack2 = getV8StackStr()
		return

	main()
	equal stack1, """
		[function func1    ] src/test/v8-stack.lib.test.civet:211:11
		[function main     ] src/test/v8-stack.lib.test.civet:207:2
		[function <anon>   ] src/test/v8-stack.lib.test.civet:218:1
		[script            ] src/test/v8-stack.lib.test.civet:232:2
		"""

	equal stack2, """
		[function func2    ] src/test/v8-stack.lib.test.civet:215:11
		[function main     ] src/test/v8-stack.lib.test.civet:208:2
		[function <anon>   ] src/test/v8-stack.lib.test.civet:218:1
		[script            ] src/test/v8-stack.lib.test.civet:232:2
		"""
	)()

# ---------------------------------------------------------------------------

DBG "getMyCaller()"

(() ->
	let caller1: TStackFrame? = undef
	let caller2: TStackFrame? = undef

	main := () ->
		func1()
		func2()

	func1 := () ->
		caller1 = getMyCaller()

	func2 := () ->
		caller2 = getMyCaller()
		return

	main()
	like caller1, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}
	like caller2, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}
	)()

# ---------------------------------------------------------------------------

(() ->
	let hCaller: TStackFrame? = undef

	main := () ->
		func1()
		func2()

	func1 := () ->
		return

	func2 := () ->
		hCaller = getMyCaller()
		return

	# ------------------------------------------------------------------------

	main()

	like hCaller, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}

	)()

# ---------------------------------------------------------------------------

(() ->
	await execCmd 'civet', [
		'--inline-map'
		'-o'
		'.ts'
		'-c'
		'src/test/v8-stack/v8-module.civet'
		]
	{getBoth} := await import('./v8-stack/v8-module.ts')
	let lCallers1: (TStackFrame?)[] = []
	let lCallers2: (TStackFrame?)[] = []

	main := () ->
		func1()
		func2()

	func1 := () ->
		lCallers1 = getBoth()

	func2 := () ->
		lCallers2 = getBoth()
		return

	main()
	like lCallers1[0], {
		type: 'function'
		name: 'secondFunc'
		source: 'src/test/v8-stack/v8-module.civet'
		}
	like lCallers1[1], {
		type: 'function'
		name: 'secondFunc'
		source: 'src/test/v8-stack/v8-module.civet'
		}
	like lCallers2[0], {
		type: 'function'
		name: 'secondFunc'
		source: 'src/test/v8-stack/v8-module.civet'
		}
	like lCallers2[1], {
		type: 'function'
		name: 'secondFunc'
		source: 'src/test/v8-stack/v8-module.civet'
		}
	)()

# ---------------------------------------------------------------------------

(() =>
	func1 := () =>
		return await func2()

	func2 := () =>
		return await getV8StackStr()

	equal await func1(), """
		[function func2    ] src/test/v8-stack.lib.test.civet:349:15
		[function func1    ] src/test/v8-stack.lib.test.civet:346:15
		[function <anon>   ] src/test/v8-stack.lib.test.civet:351:13
		[script            ] src/test/v8-stack.lib.test.civet:358:2
		"""

	)()

# ---------------------------------------------------------------------------

(() =>
	func1 := () =>
		func2()
		return await getV8StackStr()

	func2 := () =>
		return 2 * 2

	equal await func1(), """
		[function func1    ] src/test/v8-stack.lib.test.civet:365:15
		[function <anon>   ] src/test/v8-stack.lib.test.civet:370:13
		[script            ] src/test/v8-stack.lib.test.civet:375:2
		"""
	)()

# ---------------------------------------------------------------------------

(() ->
	let caller1: TStackFrame? = undef
	let caller2: TStackFrame? = undef

	main := () ->
		func1()
		func2()

	func1 := () ->
		caller1 = getMyCaller()

	func2 := () ->
		caller2 = getMyCaller()
		return

	main()
	like caller1, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}
	like caller2, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}
	)()

# ---------------------------------------------------------------------------

DBG "getMyOutsideCaller()"

(() ->
	let caller1: TStackFrame? = undef
	let caller2: TStackFrame? = undef

	main := () ->
		func1()
		func2()

	func1 := () ->
		caller1 = getMyOutsideCaller()

	func2 := () ->
		caller2 = getMyOutsideCaller()
		return

	main()
	like caller1, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}
	like caller2, {
		type: 'function'
		name: 'main'
		source: 'src/test/v8-stack.lib.test.civet'
		}
	)()
